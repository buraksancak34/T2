<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bizim Bütçe | Finansal Asistan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- FIREBASE SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .glass-card { background: rgba(255, 255, 255, 0.98); border: 1px solid rgba(255,255,255,0.6); box-shadow: 0 4px 20px -5px rgba(0,0,0,0.05); }
        .hidden { display: none !important; }
        .overlay { background: rgba(0,0,0,0.6); opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .overlay.active { opacity: 1; pointer-events: auto; }
        
        /* Drawer (Yan Panel) */
        .drawer { transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .drawer.open { transform: translateX(0); }

        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .health-detail { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .health-detail.open { max-height: 2000px; transition: max-height 0.5s ease-in; }
        
        /* Input Range Style */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #2563eb; margin-top: -8px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #e2e8f0; border-radius: 2px; }
        
        .fade-item { opacity: 0.5; filter: grayscale(100%); }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center bg-slate-50 text-gray-800">

    <div id="overlay" class="overlay fixed inset-0 z-40" onclick="closeDrawer()"></div>
    
    <div id="saveIndicator" class="fixed bottom-6 right-6 bg-white px-4 py-3 rounded-xl shadow-xl border border-green-100 flex items-center gap-3 text-sm font-bold text-gray-600 opacity-0 transition-opacity duration-500 pointer-events-none z-50">
        <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div> Kaydedildi
    </div>

    <!-- SIDE DRAWER -->
    <div id="sideDrawer" class="drawer fixed inset-y-0 right-0 w-full max-w-md bg-white shadow-2xl z-50 overflow-y-auto flex flex-col h-full">
        <div class="p-6 flex justify-between items-center border-b border-gray-100 sticky top-0 bg-white z-10">
            <h4 id="drawerTitle" class="font-black text-xl text-gray-800">Başlık</h4>
            <button onclick="closeDrawer()" class="w-10 h-10 flex items-center justify-center bg-gray-50 rounded-full text-gray-400 hover:text-red-500 hover:bg-red-50 transition-colors"><i class="fas fa-times text-lg"></i></button>
        </div>
        <div id="drawerContent" class="p-6 flex-1 overflow-y-auto pb-24">
            <!-- İçerik JS ile -->
        </div>
    </div>

    <!-- 1. GİRİŞ EKRANI -->
    <div id="loginScreen" class="w-full max-w-md p-6 animate-fade-in flex flex-col items-center">
        <!-- Logo ve Uygulama Adı -->
        <div class="text-center mb-6">
            <div class="w-16 h-16 bg-blue-50 rounded-2xl flex items-center justify-center mx-auto mb-3 text-blue-600 shadow-sm transform hover:rotate-6 transition-transform">
                <i class="fas fa-cloud text-3xl"></i>
            </div>
            <!-- Yukarıdaki logo altındaki küçük başlıkları kaldırdım çünkü aşağıda büyük başlıklar var -->
        </div>

        <div class="glass-card w-full p-8 rounded-[2.5rem] shadow-2xl space-y-6 bg-white relative overflow-hidden">
            
            <div id="mainLoginContent">
                <div class="text-center mb-6">
                    <!-- GÜNCELLENEN KISIM BURASI -->
                    <h2 class="text-2xl font-black text-gray-900 tracking-tight" id="loginFormTitle">Bizim Bütçe</h2>
                    <p class="text-gray-400 text-[10px] font-bold uppercase tracking-widest mt-1" id="loginFormSubtitle">Finansal Asistan</p>
                </div>
                
                <div class="space-y-3">
                    <input type="text" id="emailInput" class="w-full p-4 bg-white border border-gray-200 rounded-2xl focus:ring-4 focus:ring-blue-100 outline-none font-bold text-gray-700 transition-all text-sm" placeholder="E-posta veya Kullanıcı Adı">
                    <input type="password" id="passwordInput" class="w-full p-4 bg-white border border-gray-200 rounded-2xl focus:ring-4 focus:ring-blue-100 outline-none font-bold text-gray-700 transition-all text-sm" placeholder="Şifre">
                    
                    <button id="loginBtn" onclick="firebaseLogin()" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl shadow-lg shadow-blue-200 active:scale-95 transition-all hover:bg-blue-700 flex justify-center items-center gap-2">
                        <span>Giriş Yap</span>
                    </button>
                    
                    <p class="text-center text-[11px] font-bold text-blue-400 cursor-pointer hover:text-blue-600 pt-2" onclick="forgotPassword()">Şifremi Unuttum?</p>
                </div>

                <div class="relative py-4">
                    <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-100"></div></div>
                    <div class="relative flex justify-center"><span class="bg-white px-4 text-xs font-bold text-gray-300 uppercase tracking-widest">VEYA</span></div>
                </div>

                <div class="space-y-3">
                    <button onclick="startWizard(false)" class="w-full bg-green-500 text-white font-black py-4 rounded-2xl shadow-lg shadow-green-100 active:scale-95 transition-all hover:bg-green-600 flex items-center justify-center gap-2">
                        <i class="fas fa-pen"></i> <span>Plana Başla</span>
                    </button>
                    
                    <button onclick="showQuickRegisterMode()" class="w-full bg-slate-800 text-white font-bold py-3 px-4 rounded-2xl active:scale-95 transition-all hover:bg-slate-900 shadow-md flex items-center justify-center gap-3 text-xs leading-tight">
                        <i class="fas fa-bolt text-yellow-400 text-lg"></i> <span class="text-left">Veri girmek istemiyorum,<br>sadece günlük harcama hesaplayacağım</span>
                    </button>

                    <p class="text-[9px] text-center text-gray-400 px-4 mt-2">Bütçeni oluşturmaya başla, en son adımda kaydedip üye ol.</p>
                    
                    <button onclick="showJoinPlanMode()" class="w-full bg-white border-2 border-gray-100 text-gray-600 font-bold py-3 rounded-2xl active:scale-95 transition-all hover:border-indigo-200 hover:text-indigo-600 mt-2">
                        Bir Plana Dahil Ol
                    </button>
                </div>
            </div>

            <!-- Gizli Modlar (Register / Quick / Join) -->
            <div id="subModeContent" class="hidden">
                 <button onclick="backToMainLogin()" class="mb-4 text-gray-400 hover:text-gray-600 text-xs font-bold flex items-center gap-1"><i class="fas fa-arrow-left"></i> Geri Dön</button>
                 <h2 class="text-xl font-black text-gray-900 mb-1" id="subModeTitle">Başlık</h2>
                 <p class="text-gray-400 text-xs font-bold mb-4" id="subModeSubtitle">Alt Başlık</p>
                 
                 <div id="registerFields" class="space-y-3">
                    <input type="text" id="regUsernameInput" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-2xl font-bold text-sm" placeholder="Adınız Soyadınız">
                    
                    <!-- Join Plan Specific -->
                    <input type="text" id="regInviteCode" class="hidden w-full p-4 bg-gray-50 border border-gray-200 rounded-2xl font-bold text-sm" placeholder="Davet Kodu (Zorunlu)">
                    
                    <!-- Quick Mode Specific -->
                    <input type="number" id="regDailyLimit" class="hidden w-full p-4 bg-blue-50 border border-blue-200 rounded-2xl font-black text-blue-700 text-sm placeholder-blue-400" placeholder="Hedef Günlük Limit (TL)">

                    <input type="text" id="regEmailInput" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-2xl font-bold text-sm" placeholder="E-posta Adresi">
                    <input type="password" id="regPasswordInput" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-2xl font-bold text-sm" placeholder="Şifre Belirle">
                    
                    <button id="subModeBtn" onclick="firebaseRegister()" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl shadow-xl active:scale-95 transition-all hover:bg-blue-700 mt-2">
                        Tamamla
                    </button>
                 </div>
            </div>

        </div>
    </div>

    <!-- 2. SİHİRBAZ (WIZARD) -->
    <div id="wizardScreen" class="w-full max-w-xl p-4 hidden animate-fade-in">
        <div class="glass-card p-8 rounded-[2.5rem] shadow-2xl relative">
            <div class="flex justify-between items-center mb-6">
                <div id="wizardProgress" class="flex gap-1 flex-1 mr-4"></div>
                <span class="text-xs font-bold text-gray-400" id="stepCount">1/6</span>
            </div>
            <h2 id="wizardStepTitle" class="text-2xl font-black text-gray-800 mb-6">Başlayalım</h2>
            <div id="wizardContent" class="min-h-[300px] flex flex-col relative">
                <!-- Wizard Adımları JS ile gelecek -->
            </div>
            <div class="flex gap-3 mt-8">
                 <button onclick="wizardBack()" id="wizBackBtn" class="flex-1 bg-gray-100 text-gray-600 font-bold py-4 rounded-2xl hover:bg-gray-200 transition-all hidden">Geri</button>
                 <button onclick="wizardNext()" id="wizNextBtn" class="flex-[2] bg-blue-600 text-white font-black py-4 rounded-2xl shadow-xl active:scale-95 transition-all hover:bg-blue-700">Devam Et</button>
            </div>
        </div>
    </div>

    <!-- 3. DASHBOARD -->
    <div id="dashboardScreen" class="w-full max-w-4xl p-4 hidden space-y-6 pb-24 animate-fade-in">
        
        <!-- Üst Bar -->
        <div class="flex justify-between items-center px-2">
            <div>
                <h2 class="text-2xl font-black text-gray-800 tracking-tight" id="dashWelcome">Panelim</h2>
                <span id="roleBadge" class="text-[10px] font-black bg-blue-100 text-blue-600 px-2 py-0.5 rounded uppercase tracking-wide">Yönetici</span>
            </div>
            <div class="flex gap-2">
                <button onclick="showSettingsDrawer()" class="w-10 h-10 bg-white rounded-full shadow-sm text-gray-500 border border-gray-100 flex items-center justify-center hover:bg-gray-50"><i class="fas fa-cog"></i></button>
                <button onclick="handleLogout()" class="w-10 h-10 bg-white rounded-full shadow-sm text-red-500 border border-gray-100 flex items-center justify-center hover:bg-red-50"><i class="fas fa-power-off"></i></button>
            </div>
        </div>

        <!-- Ana Kart (Daily Limit) -->
        <div class="glass-card p-8 rounded-[2.5rem] bg-gradient-to-br from-slate-800 to-slate-900 text-white shadow-2xl relative overflow-hidden">
             <div class="absolute top-0 right-0 w-64 h-64 bg-blue-500 rounded-full mix-blend-overlay filter blur-3xl opacity-20 -mr-16 -mt-16"></div>
             <div class="relative z-10">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest opacity-80">Bugünün Limiti</p>
                            <button onclick="showCalcDrawer()" class="text-blue-300 hover:text-white text-[9px] font-bold underline decoration-dashed transition-colors">Nasıl?</button>
                        </div>
                        <h2 id="displayDailyLimit" class="text-6xl font-black tracking-tighter leading-none">₺0</h2>
                    </div>
                    <div class="text-right">
                        <p class="text-blue-400 text-[10px] font-bold uppercase tracking-widest mb-1">Biriken</p>
                        <h4 id="displayCumulativeLimit" class="text-3xl font-black text-white tracking-tight">₺0</h4>
                    </div>
                </div>
                <div class="flex items-center gap-2 mt-8">
                     <div class="flex-1 bg-white/10 px-4 py-3 rounded-2xl backdrop-blur-md border border-white/5">
                        <span class="text-[9px] text-slate-300 font-bold uppercase block">Maaşa Kalan</span>
                        <span id="displayRemainingDays" class="text-xl font-black text-white">-- Gün</span>
                    </div>
                    <button onclick="startWizard(true)" class="bg-white/10 w-14 h-[68px] rounded-2xl backdrop-blur-md border border-white/5 hover:bg-white/20 transition-all flex items-center justify-center">
                        <i class="fas fa-pen text-slate-300"></i>
                    </button>
                </div>
             </div>
        </div>
        
        <!-- Harcama Ekle -->
        <div class="glass-card p-6 rounded-[2rem] bg-white border border-gray-100 shadow-lg">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-black text-lg text-gray-800">Harcama Ekle</h3>
                <span id="todayTotal" class="text-[10px] font-bold bg-blue-50 text-blue-600 px-3 py-1 rounded-lg">Bugün: ₺0</span>
            </div>
            <div class="flex gap-2">
                <input type="number" id="expAmt" placeholder="Tutar" class="w-1/3 p-4 bg-gray-50 rounded-2xl font-black text-lg outline-none focus:ring-2 focus:ring-blue-100">
                <input type="text" id="expDesc" placeholder="Nereye?" class="flex-1 p-4 bg-gray-50 rounded-2xl font-bold text-gray-600 outline-none focus:ring-2 focus:ring-blue-100">
                <button onclick="addExpense()" class="bg-blue-600 text-white w-16 rounded-2xl shadow-lg shadow-blue-200 active:scale-95 transition-all flex items-center justify-center text-xl font-bold">+</button>
            </div>
        </div>

        <!-- Finansal Sağlık & Varlık/Borç -->
        <div id="financialHealthSection" class="glass-card p-8 rounded-[2.5rem] space-y-8 bg-white border border-blue-50">
             <div class="flex justify-between items-center border-b pb-4">
                <h3 class="font-black text-2xl text-gray-800">Finansal Sağlık</h3>
                <div class="text-right">
                    <p class="text-[9px] text-gray-400 font-bold uppercase">Net Varlık</p>
                    <span id="netStatusVal" class="text-xl font-black text-gray-800">₺0</span>
                </div>
             </div>

             <!-- Sabit Giderler Accordion -->
             <div id="fixedExpensesContainer"></div>

             <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Borçlar -->
                <div>
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                            <span class="text-xs font-black text-red-600 uppercase tracking-widest">Borçlar</span>
                        </div>
                        <button onclick="toggleInlineAdd('dashDebt')" class="text-[10px] font-bold bg-red-50 text-red-500 px-3 py-1 rounded-full hover:bg-red-100">+ Ekle</button>
                    </div>
                    
                    <!-- Inline Ekleme Formu -->
                    <div id="inlineAdddashDebtContainer" class="hidden mb-4 p-4 bg-red-50 rounded-xl border border-red-100 animate-fade-in">
                        <select id="dashDebtType" onchange="handleInlineTypeChange('dashDebt')" class="w-full p-2 mb-2 rounded-lg text-xs font-bold border border-red-200 outline-none">
                            <option value="Kredi">Kredi</option>
                            <option value="Kredi Kartı">Kredi Kartı</option>
                            <option value="Diğer">Diğer Borç</option>
                        </select>
                        <div id="dashDebtFields" class="space-y-2"></div>
                        <div class="flex gap-2 mt-2">
                            <button onclick="cancelInlineAdd('dashDebt')" class="flex-1 bg-white text-gray-500 py-2 rounded-lg text-xs font-bold">İptal</button>
                            <button onclick="saveInlineAdd('dashDebt')" class="flex-1 bg-red-500 text-white py-2 rounded-lg text-xs font-bold">Kaydet</button>
                        </div>
                    </div>
                    
                    <div id="detailedDebtsList" class="space-y-2"></div>
                </div>

                <!-- Varlıklar -->
                <div>
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                            <span class="text-xs font-black text-green-600 uppercase tracking-widest">Varlıklar</span>
                        </div>
                        <button onclick="toggleInlineAdd('dashAsset')" class="text-[10px] font-bold bg-green-50 text-green-500 px-3 py-1 rounded-full hover:bg-green-100">+ Ekle</button>
                    </div>

                    <div id="inlineAdddashAssetContainer" class="hidden mb-4 p-4 bg-green-50 rounded-xl border border-green-100 animate-fade-in">
                        <select id="dashAssetType" onchange="handleInlineTypeChange('dashAsset')" class="w-full p-2 mb-2 rounded-lg text-xs font-bold border border-green-200 outline-none">
                            <option value="Diğer">Nakit / Diğer</option>
                            <option value="Altın">Altın</option>
                            <option value="Döviz">Döviz</option>
                            <option value="BES">BES (Toplu Para)</option>
                        </select>
                        <div id="dashAssetFields" class="space-y-2"></div>
                        <div class="flex gap-2 mt-2">
                            <button onclick="cancelInlineAdd('dashAsset')" class="flex-1 bg-white text-gray-500 py-2 rounded-lg text-xs font-bold">İptal</button>
                            <button onclick="saveInlineAdd('dashAsset')" class="flex-1 bg-green-500 text-white py-2 rounded-lg text-xs font-bold">Kaydet</button>
                        </div>
                    </div>

                    <div id="detailedAssetsList" class="space-y-2"></div>
                </div>
             </div>
        </div>

        <!-- Geçmiş -->
        <div class="glass-card p-6 rounded-[2rem] bg-white border border-gray-100">
            <h3 class="font-black text-gray-800 mb-4 text-sm uppercase tracking-widest">Son Harcamalar</h3>
            <div id="historyList" class="space-y-2"></div>
        </div>

    </div>

    <script>
        // --- KONFIGURASYON ---
        const firebaseConfig = {
            apiKey: "AIzaSyAyUQaeoVWnT4AuzSwD2M17-z1g2optqdA",
            authDomain: "hesapguvende-b07ca.firebaseapp.com",
            projectId: "hesapguvende-b07ca",
            storageBucket: "hesapguvende-b07ca.firebasestorage.app",
            messagingSenderId: "710002620092",
            appId: "1:710002620092:web:94f3ebb8dd2461af29c2b9"
        };

        // --- GLOBAL STATE ---
        let db, auth, currentUser;
        let state = {
            salaryDay: 15,
            incomes: [], 
            bills: [
                { name: 'Kira', val: null }, { name: 'Elektrik', val: null }, { name: 'Su', val: null }, 
                { name: 'Doğalgaz', val: null }, { name: 'İnternet', val: null }, { name: 'Telefon', val: null },
                { name: 'Dijital Platformlar', val: null }, // Talep 1: Geri eklendi
                { name: 'Bireysel Emeklilik (Aylık)', val: null }, // BES Sabit
                { name: 'Aidat', val: null }
            ],
            loans: [], debts: [], otherDebts: [], assets: [], expenses: [], familyMembers: [],
            manualDailyLimit: null
        };
        
        let subModeType = null; // 'join', 'quick'

        // --- INITIALIZATION ---
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            
            auth.onAuthStateChanged(async user => {
                if (user) {
                    currentUser = user;
                    await loadUserData();
                } else {
                    document.getElementById('loginScreen').classList.remove('hidden');
                    document.getElementById('dashboardScreen').classList.add('hidden');
                }
            });
        } catch(e) { console.error("Firebase Hatası:", e); alert("Bağlantı hatası. İnternetinizi kontrol edin."); }

        // --- AUTH UI HANDLERS ---
        function forgotPassword() {
            const email = document.getElementById('emailInput').value;
            if(!email) return alert("E-posta adresinizi girin.");
            auth.sendPasswordResetEmail(email)
                .then(() => alert("Şifre sıfırlama bağlantısı gönderildi."))
                .catch(e => alert(e.message));
        }

        function showJoinPlanMode() {
            document.getElementById('mainLoginContent').classList.add('hidden');
            document.getElementById('subModeContent').classList.remove('hidden');
            
            document.getElementById('subModeTitle').innerText = "Bir Plana Dahil Ol";
            document.getElementById('subModeSubtitle').innerText = "Davet Kodu İle Bağlan";
            document.getElementById('subModeBtn').innerText = "Plana Katıl";
            
            document.getElementById('regInviteCode').classList.remove('hidden');
            document.getElementById('regDailyLimit').classList.add('hidden');
            
            subModeType = 'join';
        }

        function showQuickRegisterMode() {
            document.getElementById('mainLoginContent').classList.add('hidden');
            document.getElementById('subModeContent').classList.remove('hidden');
            
            document.getElementById('subModeTitle').innerText = "Hızlı Başlangıç";
            document.getElementById('subModeSubtitle').innerText = "Sadece Limit Takibi";
            document.getElementById('subModeBtn').innerText = "Hemen Başla";
            
            document.getElementById('regInviteCode').classList.add('hidden');
            document.getElementById('regDailyLimit').classList.remove('hidden');
            
            subModeType = 'quick';
        }

        function backToMainLogin() {
            document.getElementById('mainLoginContent').classList.remove('hidden');
            document.getElementById('subModeContent').classList.add('hidden');
            subModeType = null;
        }

        // --- AUTH ACTIONS ---
        async function firebaseLogin() {
            const email = document.getElementById('emailInput').value;
            const pass = document.getElementById('passwordInput').value;
            if(!email || !pass) return alert("Bilgileri girin.");
            try { await auth.signInWithEmailAndPassword(email, pass); } 
            catch(e) { alert("Giriş başarısız: " + e.message); }
        }

        async function firebaseRegister() {
            // Hangi modda olduğumuza göre inputları alalım
            // subModeType: 'join', 'quick' ya da null (bu durumda Plana Başla -> wizard sonunda kayıt yapılıyor)
            // Ama buradaki fonksiyon 'subModeContent' içindeki butona bağlı
            
            const email = document.getElementById('regEmailInput').value;
            const pass = document.getElementById('regPasswordInput').value;
            const name = document.getElementById('regUsernameInput').value;
            
            if(!email || !pass || !name) return alert("Tüm alanları doldurun.");
            
            let code = null;
            let dailyLimit = null;

            if (subModeType === 'join') {
                code = document.getElementById('regInviteCode').value.trim();
                if(!code) return alert("Davet kodu gerekli.");
            } else if (subModeType === 'quick') {
                dailyLimit = parseFloat(document.getElementById('regDailyLimit').value);
                if(!dailyLimit) return alert("Günlük limit hedefi gerekli.");
            }
            
            try {
                const cred = await auth.createUserWithEmailAndPassword(email, pass);
                await cred.user.updateProfile({ displayName: name });
                
                let newState = JSON.parse(JSON.stringify(state));
                newState.email = email;
                
                if (subModeType === 'join') {
                    const snap = await db.collection('users').where('inviteCode', '==', code).get();
                    if (!snap.empty) {
                        const ownerId = snap.docs[0].id;
                        const ownerData = snap.docs[0].data();
                        
                        let members = ownerData.familyMembers || [];
                        members.push({ uid: cred.user.uid, name: name, role: 'full' });
                        await db.collection('users').doc(ownerId).update({ familyMembers: members });
                        
                        newState.connectedPlanId = ownerId;
                        alert("Plana başarıyla dahil oldunuz!");
                    } else {
                        alert("Davet kodu geçersiz, kendi planınız oluşturuldu.");
                    }
                } else if (subModeType === 'quick') {
                    newState.manualDailyLimit = dailyLimit;
                    // Hızlı modda wizardı atlayıp direkt dashboard'a atacağız ama veri olmadığı için boş gözükecek.
                    // Bu yüzden varsayılan boş bir gelir ekleyelim ki dashboard açılsın
                    newState.incomes.push({ name: 'Hızlı Başlangıç Bütçesi', val: dailyLimit * 30 }); 
                }
                
                await db.collection('users').doc(cred.user.uid).set(newState);
                
                // Login sonrası yönlendirme loadUserData ile olacak
                
            } catch(e) { alert("Kayıt hatası: " + e.message); }
        }

        // --- VERİ YÖNETİMİ ---
        async function loadUserData() {
            const doc = await db.collection('users').doc(currentUser.uid).get();
            if (!doc.exists) return startWizard(false);
            
            let data = doc.data();
            // Eğer bir plana bağlıysa, o planın verisini çek
            if (data.connectedPlanId) {
                const planDoc = await db.collection('users').doc(data.connectedPlanId).get();
                if (planDoc.exists) data = { ...planDoc.data(), role: 'member' }; 
            }
            
            state = { ...state, ...data };
            
            document.getElementById('loginScreen').classList.add('hidden');
            
            // Eğer income yoksa ve hızlı mod değilse sihirbazı aç
            // Hızlı modda manualDailyLimit set edilmiş olur
            if ((!state.incomes || state.incomes.length === 0) && !state.manualDailyLimit) {
                startWizard(false);
            } else {
                document.getElementById('dashboardScreen').classList.remove('hidden');
                updateDashboardUI();
            }
        }

        async function saveToCloud() {
            if(!currentUser) return;
            const targetId = state.connectedPlanId || currentUser.uid;
            await db.collection('users').doc(targetId).set(state, { merge: true });
            
            const ind = document.getElementById('saveIndicator');
            ind.style.opacity = '1';
            setTimeout(() => ind.style.opacity = '0', 2000);
        }

        // --- SİHİRBAZ (WIZARD) ---
        let wizStep = 0;
        const wizSteps = [
            { id: 'income', title: 'Gelirler', render: () => renderWizList('incomes', 'Maaş / Ek Gelir') },
            { id: 'bills', title: 'Sabit Giderler', render: () => renderWizList('bills', 'Kira, Fatura vb.') },
            { id: 'loans', title: 'Krediler', render: () => `<div class="space-y-3"><button onclick="toggleInlineAdd('wizLoan')" class="w-full py-3 border border-dashed border-gray-300 rounded-xl text-gray-500 font-bold">+ Kredi Ekle</button><div id="inlineAddwizLoanContainer" class="hidden bg-gray-50 p-4 rounded-xl space-y-2"><input type="text" id="wizLoan_name" placeholder="Kredi Adı" class="w-full p-2 rounded-lg border"><div class="flex gap-2"><input type="number" id="wizLoan_monthly" placeholder="Taksit" class="w-1/2 p-2 rounded-lg border"><input type="number" id="wizLoan_months" placeholder="Kalan Ay" class="w-1/2 p-2 rounded-lg border"></div><button onclick="saveInlineAdd('wizLoan')" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold">Ekle</button></div><div id="wizList_loans" class="mt-2 space-y-2"></div></div>` },
            { id: 'debts', title: 'Kart & Borçlar', render: () => `<div class="space-y-3"><button onclick="toggleInlineAdd('wizDebt')" class="w-full py-3 border border-dashed border-gray-300 rounded-xl text-gray-500 font-bold">+ Borç/Kart Ekle</button><div id="inlineAddwizDebtContainer" class="hidden bg-gray-50 p-4 rounded-xl space-y-2"><input type="text" id="wizDebt_name" placeholder="Adı" class="w-full p-2 rounded-lg border"><input type="number" id="wizDebt_total" placeholder="Toplam Borç" class="w-full p-2 rounded-lg border"><button onclick="saveInlineAdd('wizDebt')" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold">Ekle</button></div><div id="wizList_debts" class="mt-2 space-y-2"></div></div>` },
            { id: 'assets', title: 'Varlıklar', render: () => `<div class="space-y-3"><button onclick="toggleInlineAdd('wizAsset')" class="w-full py-3 border border-dashed border-gray-300 rounded-xl text-gray-500 font-bold">+ Varlık Ekle</button><div id="inlineAddwizAssetContainer" class="hidden bg-gray-50 p-4 rounded-xl space-y-2"><input type="text" id="wizAsset_name" placeholder="Varlık Adı" class="w-full p-2 rounded-lg border"><input type="number" id="wizAsset_total" placeholder="Değer (TL)" class="w-full p-2 rounded-lg border"><button onclick="saveInlineAdd('wizAsset')" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold">Ekle</button></div><div id="wizList_assets" class="mt-2 space-y-2"></div></div>` },
            { id: 'finish', title: 'Tamamlandı', render: () => `<div class="text-center py-10"><i class="fas fa-check-circle text-6xl text-green-500 mb-4"></i><p class="font-bold text-gray-600">Planın hazır!</p></div>` }
        ];

        function startWizard(isEdit = false) {
            document.getElementById('loginScreen').classList.add('hidden'); // Login gizle
            document.getElementById('dashboardScreen').classList.add('hidden');
            document.getElementById('wizardScreen').classList.remove('hidden');
            wizStep = 0; renderWizardStep();
        }

        function renderWizardStep() {
            const step = wizSteps[wizStep];
            document.getElementById('wizardStepTitle').innerText = step.title;
            document.getElementById('stepCount').innerText = `${wizStep + 1}/${wizSteps.length}`;
            document.getElementById('wizardProgress').innerHTML = wizSteps.map((_, i) => `<div class="h-1 flex-1 rounded-full ${i <= wizStep ? 'bg-blue-600' : 'bg-gray-200'}"></div>`).join('');
            document.getElementById('wizardContent').innerHTML = step.render();
            
            // Listeleri doldur
            if(step.id === 'income' || step.id === 'bills') {
                step.render(); 
            } else {
               updateWizListUI(step.id);
            }
            
            document.getElementById('wizBackBtn').classList.toggle('hidden', wizStep === 0);
            
            // Son adımda butonun ne yapacağını belirle
            if (wizStep === wizSteps.length - 1) {
                // Eğer zaten giriş yapmışsa "Kaydet ve Başla", değilse "Kayıt Ol ve Başla"
                document.getElementById('wizNextBtn').innerText = currentUser ? "Kaydet ve Bitir" : "Kayıt Ol ve Bitir";
            } else {
                document.getElementById('wizNextBtn').innerText = "Devam Et";
            }
        }

        function renderWizList(type, placeholder) {
            return `<div id="wizList_${type}" class="space-y-3">` + 
                state[type].map((item, i) => `
                <div class="flex items-center gap-2">
                    <span class="w-1/3 text-xs font-bold text-gray-500 truncate">${item.name}</span>
                    <input type="number" placeholder="0" value="${item.val || ''}" onchange="updateWizVal('${type}', ${i}, this.value)" class="flex-1 p-3 bg-gray-50 rounded-xl border border-gray-100 font-bold outline-none focus:border-blue-300">
                </div>`).join('') + 
                `</div>
                <button onclick="addNewWizItem('${type}')" class="mt-4 text-xs font-bold text-blue-500">+ Başka Ekle</button>`;
        }
        
        function updateWizVal(type, index, val) {
            const numVal = parseFloat(val);
            state[type][index].val = numVal;
            
            if (type === 'bills' && state[type][index].name.includes('Bireysel Emeklilik') && numVal > 0) {
                const existingBesAsset = state.assets.find(a => a.name === 'BES (Birikim)');
                if (!existingBesAsset) {
                    const totalBes = prompt("Harika! Peki şu ana kadar BES'te ne kadar birikti? (Varlıklarınıza eklenecek ancak hesaplamaya katılmayacak)");
                    if (totalBes) {
                        state.assets.unshift({
                            name: 'BES (Birikim)',
                            val: parseFloat(totalBes),
                            excludeFromAsset: true 
                        });
                    }
                }
            }
        }

        function addNewWizItem(type) {
            const name = prompt("Kalem Adı:");
            if(name) {
                state[type].push({ name, val: null });
                renderWizardStep();
            }
        }
        
        function updateWizListUI(type) {
            const container = document.getElementById(`wizList_${type}`);
            if(!container) return;
            const items = type === 'loans' ? state.loans : type === 'debts' ? state.debts : state.assets;
            
            container.innerHTML = items.map((item, i) => `
                <div class="flex justify-between items-center p-3 bg-white border border-gray-100 rounded-xl shadow-sm">
                    <div>
                        <p class="font-bold text-sm">${item.name}</p>
                        <p class="text-xs text-gray-400">₺${(item.val || item.totalDebt).toLocaleString()}</p>
                    </div>
                    <button onclick="removeWizItem('${type}', ${i})" class="text-red-400"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');
        }
        
        function removeWizItem(type, index) {
            if(type==='loans') state.loans.splice(index, 1);
            else if(type==='debts') state.debts.splice(index, 1);
            else state.assets.splice(index, 1);
            updateWizListUI(type);
        }

        function wizardNext() {
            if(wizStep < wizSteps.length - 1) {
                wizStep++;
                renderWizardStep();
            } else {
                state.incomes = state.incomes.filter(i => i.val > 0);
                state.bills = state.bills.filter(b => b.val > 0);
                
                if (currentUser) {
                    // Zaten giriş yapmışsa direkt kaydet
                    saveToCloud();
                    document.getElementById('wizardScreen').classList.add('hidden');
                    document.getElementById('dashboardScreen').classList.remove('hidden');
                    updateDashboardUI();
                } else {
                    // Giriş yapmamışsa kayıt formunu aç (Wizard bitişi)
                    // Burada basitleştirip direkt prompt ile sorabiliriz veya modal açabiliriz
                    // Ama en temizi gizli bir kayıt ekranı göstermek.
                    // Şimdilik basit bir prompt ile email/pass alıp kayıt edelim.
                    const email = prompt("Planınızı kaydetmek için E-posta adresiniz:");
                    const pass = prompt("Şifreniz:");
                    const name = prompt("Adınız:");
                    if(email && pass && name) {
                        auth.createUserWithEmailAndPassword(email, pass).then(cred => {
                            cred.user.updateProfile({ displayName: name });
                            state.email = email;
                            db.collection('users').doc(cred.user.uid).set(state);
                            // Sayfa yenilenip auth state değişince dashboard açılır.
                        }).catch(e => alert(e.message));
                    }
                }
            }
        }
        function wizardBack() { if(wizStep > 0) { wizStep--; renderWizardStep(); } }

        // --- DASHBOARD UI ---
        function updateDashboardUI() {
            const now = new Date();
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate(); // Talep 2: Gerçek gün sayısı
            
            document.getElementById('dashWelcome').innerText = `Hoşgeldin, ${currentUser.displayName || 'Kullanıcı'}`;
            
            // Hesaplamalar
            const totalIncome = state.incomes.reduce((s, i) => s + (i.val||0), 0);
            const totalBills = state.bills.reduce((s, b) => s + (b.val||0), 0);
            const totalLoanPayments = state.loans.filter(l => !l.excludeFromDebt).reduce((s, l) => s + (l.monthly||0), 0);
            
            const disposableIncome = totalIncome - (totalBills + totalLoanPayments);
            
            // Günlük Limit
            const daily = state.manualDailyLimit ? state.manualDailyLimit : Math.max(0, disposableIncome / daysInMonth);
            
            // Harcanan
            const todayStr = new Date().toLocaleDateString('tr-TR');
            const todaySpent = state.expenses.filter(e => e.date === todayStr).reduce((s, e) => s + e.amount, 0);
            const totalSpentMonth = state.expenses.reduce((s, e) => s + e.amount, 0); 
            
            // Biriken (Kümülatif) Logic:
            const dayOfMonth = now.getDate();
            const cumulative = (daily * dayOfMonth) - totalSpentMonth;

            // UI Update
            document.getElementById('displayDailyLimit').innerText = `₺${Math.floor(daily - todaySpent).toLocaleString()}`;
            document.getElementById('displayCumulativeLimit').innerText = `₺${Math.floor(cumulative).toLocaleString()}`;
            document.getElementById('todayTotal').innerText = `Bugün: ₺${Math.floor(todaySpent).toLocaleString()}`;
            
            // Maaşa Kalan
            let targetDate = new Date(now.getFullYear(), now.getMonth(), state.salaryDay);
            if (now.getDate() >= state.salaryDay) targetDate.setMonth(targetDate.getMonth() + 1);
            const remainingDays = Math.ceil((targetDate - now) / (1000 * 60 * 60 * 24));
            document.getElementById('displayRemainingDays').innerText = `${remainingDays} Gün`;

            // Net Varlık
            const totalAssets = state.assets.filter(a => !a.excludeFromAsset).reduce((s,a) => s + (a.val||0), 0);
            const totalDebts = state.debts.filter(d => !d.excludeFromDebt).reduce((s,d) => s + (d.val||0), 0) + 
                               state.loans.filter(l => !l.excludeFromDebt).reduce((s,l) => s + (l.totalDebt||0), 0);
            const netWorth = totalAssets - totalDebts;
            document.getElementById('netStatusVal').innerText = `₺${Math.floor(netWorth).toLocaleString()}`;
            document.getElementById('netStatusVal').className = `text-xl font-black ${netWorth >= 0 ? 'text-green-600' : 'text-red-600'}`;

            renderLists();
        }

        function renderLists() {
            // Sabit Giderler
            const billsHtml = state.bills.map(b => 
                `<div class="flex justify-between p-3 bg-blue-50/50 rounded-xl mb-2 text-xs font-bold text-gray-600 border border-blue-100">
                    <span>${b.name}</span>
                    <span class="text-gray-900">₺${b.val.toLocaleString()}</span>
                 </div>`
            ).join('');
            
            document.getElementById('fixedExpensesContainer').innerHTML = 
                `<div class="border border-blue-100 rounded-2xl overflow-hidden mb-6">
                    <div onclick="this.nextElementSibling.classList.toggle('hidden')" class="flex justify-between items-center p-4 bg-blue-50 cursor-pointer">
                        <span class="text-xs font-black text-blue-800 uppercase">Sabit Giderler</span>
                        <i class="fas fa-chevron-down text-blue-400"></i>
                    </div>
                    <div class="p-4 hidden">${billsHtml || '<span class="text-xs text-gray-400">Gider yok</span>'}</div>
                 </div>`;

            // Talep 4: Büyük rakam üst sırada yer alsın.
            // Borçlar Listesi
            const allDebts = [
                ...state.loans.map((l, i) => ({...l, type: 'loan', idx: i, val: l.totalDebt})),
                ...state.debts.map((d, i) => ({...d, type: 'debt', idx: i}))
            ].sort((a, b) => b.val - a.val);

            document.getElementById('detailedDebtsList').innerHTML = allDebts.map(d => {
                const isExcluded = d.excludeFromDebt;
                return `
                <div onclick="openEditDrawer('${d.type === 'loan' ? 'loans' : 'debts'}', ${d.idx})" class="flex justify-between items-center p-3 rounded-xl border ${isExcluded ? 'bg-gray-50 border-gray-100 fade-item' : 'bg-white border-red-100'} mb-2 cursor-pointer relative group">
                    <div>
                        <p class="font-bold text-xs text-gray-700">${d.name} ${isExcluded ? '<i class="fas fa-eye-slash text-[8px] ml-1"></i>' : ''}</p>
                        ${d.type === 'loan' ? `<p class="text-[9px] text-gray-400">Taksit: ₺${Math.floor(d.monthly)}</p>` : ''}
                    </div>
                    <span class="font-black text-sm text-gray-800">₺${Math.floor(d.val).toLocaleString()}</span>
                </div>`;
            }).join('');

            // Varlıklar Listesi (Talep: Büyük üstte)
            const sortedAssets = [...state.assets].sort((a, b) => b.val - a.val);
            document.getElementById('detailedAssetsList').innerHTML = sortedAssets.map((a, i) => {
                const originalIndex = state.assets.indexOf(a);
                const isExcluded = a.excludeFromAsset;
                return `
                <div onclick="openEditDrawer('assets', ${originalIndex})" class="flex justify-between items-center p-3 rounded-xl border ${isExcluded ? 'bg-gray-50 border-gray-100 fade-item' : 'bg-white border-green-100'} mb-2 cursor-pointer">
                    <span class="font-bold text-xs text-gray-700">${a.name} ${isExcluded ? '<i class="fas fa-eye-slash text-[8px] ml-1"></i>' : ''}</span>
                    <span class="font-black text-sm text-gray-800">₺${Math.floor(a.val).toLocaleString()}</span>
                </div>`;
            }).join('');
            
            renderHistory();
        }
        
        function renderHistory() {
            const list = document.getElementById('historyList');
            if(state.expenses.length === 0) return list.innerHTML = '<p class="text-center text-gray-300 text-xs py-2">Henüz harcama yok.</p>';
            
            list.innerHTML = [...state.expenses].reverse().slice(0, 5).map(e => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl border border-gray-100">
                    <div>
                        <p class="font-bold text-xs text-gray-700">${e.desc}</p>
                        <p class="text-[9px] text-gray-400">${e.date}</p>
                    </div>
                    <span class="font-black text-sm text-red-500">-₺${e.amount}</span>
                </div>
            `).join('');
        }

        // --- HARCAMA EKLEME ---
        function addExpense() {
            const amt = parseFloat(document.getElementById('expAmt').value);
            const desc = document.getElementById('expDesc').value || 'Genel';
            if (!amt) return;
            
            state.expenses.push({
                amount: amt,
                desc: desc,
                date: new Date().toLocaleDateString('tr-TR'),
                ts: Date.now(),
                user: currentUser.displayName
            });
            
            document.getElementById('expAmt').value = '';
            document.getElementById('expDesc').value = '';
            saveToCloud();
            updateDashboardUI();
        }

        // --- INLINE EKLEME & MODAL LOGIC ---
        function toggleInlineAdd(prefix) {
            const el = document.getElementById(`inlineAdd${prefix}Container`);
            el.classList.toggle('hidden');
            if(prefix.startsWith('wiz')) return; // Wizard'da iptal butonu yok, sadece toggle
        }
        function cancelInlineAdd(prefix) { document.getElementById(`inlineAdd${prefix}Container`).classList.add('hidden'); }

        function handleInlineTypeChange(prefix) {
            const type = document.getElementById(`${prefix}Type`).value;
            const container = document.getElementById(`${prefix}Fields`);
            let html = '';
            const cls = "w-full p-2 rounded-lg border border-gray-200 text-xs font-bold mb-2";
            
            if (type === 'Kredi') {
                html = `<input id="${prefix}_name" placeholder="Kredi Adı" class="${cls}">
                        <div class="flex gap-2"><input type="number" id="${prefix}_monthly" placeholder="Aylık" class="${cls}"><input type="number" id="${prefix}_months" placeholder="Ay" class="${cls}"></div>`;
            } else if (type === 'BES') {
                html = `<div class="p-2 bg-yellow-50 rounded text-[10px] text-yellow-700 mb-2">BES birikiminiz varlıklara silik olarak eklenir.</div>
                        <input type="number" id="${prefix}_total" placeholder="Toplam Birikim (TL)" class="${cls}">`;
            } else {
                html = `<input id="${prefix}_name" placeholder="Adı" class="${cls}"><input type="number" id="${prefix}_total" placeholder="Tutar (TL)" class="${cls}">`;
            }
            container.innerHTML = html;
        }

        function saveInlineAdd(prefix) {
            let itemObj = {};
            let targetArray = '';
            let unshift = true; // Talep 4: En üste ekle

            if (prefix === 'dashDebt') {
                const type = document.getElementById('dashDebtType').value;
                if (type === 'Kredi') {
                    const name = document.getElementById(`${prefix}_name`).value || 'Kredi';
                    const monthly = parseFloat(document.getElementById(`${prefix}_monthly`).value) || 0;
                    const months = parseFloat(document.getElementById(`${prefix}_months`).value) || 0;
                    itemObj = { name, monthly, totalMonths: months, totalDebt: monthly * months, excludeFromDebt: false };
                    targetArray = 'loans';
                } else {
                    const name = document.getElementById(`${prefix}_name`).value || type;
                    const val = parseFloat(document.getElementById(`${prefix}_total`).value) || 0;
                    itemObj = { name, val, excludeFromDebt: false };
                    targetArray = 'debts';
                }
            } else if (prefix === 'dashAsset') {
                 const type = document.getElementById('dashAssetType').value;
                 targetArray = 'assets';
                 if (type === 'BES') {
                     const val = parseFloat(document.getElementById(`${prefix}_total`).value) || 0;
                     itemObj = { name: 'BES (Birikim)', val, excludeFromAsset: true }; // Talep 3: Silik ekle
                 } else {
                     const name = document.getElementById(`${prefix}_name`).value || type;
                     const val = parseFloat(document.getElementById(`${prefix}_total`).value) || 0;
                     itemObj = { name, val, excludeFromAsset: false };
                 }
            } else if (prefix.startsWith('wiz')) {
                // Wizard mantığı
                return;
            }

            if (targetArray) {
                // Talep 4: En üste ekle (unshift)
                state[targetArray].unshift(itemObj);
                saveToCloud();
                updateDashboardUI();
                cancelInlineAdd(prefix);
                
                // Form temizliği
                if(document.getElementById(`${prefix}_name`)) document.getElementById(`${prefix}_name`).value = '';
                if(document.getElementById(`${prefix}_total`)) document.getElementById(`${prefix}_total`).value = '';
            }
        }

        // --- DRAWER (DÜZENLEME & AYARLAR) ---
        function openDrawer(title, html) {
            document.getElementById('drawerTitle').innerText = title;
            document.getElementById('drawerContent').innerHTML = html;
            document.getElementById('sideDrawer').classList.add('open');
            document.getElementById('overlay').classList.add('active');
        }
        function closeDrawer() {
            document.getElementById('sideDrawer').classList.remove('open');
            document.getElementById('overlay').classList.remove('active');
        }

        function openEditDrawer(type, index) {
            const item = state[type][index];
            const isLoan = type === 'loans';
            const val = isLoan ? item.totalDebt : item.val;
            
            // Talep: Hesaba katılıp katılmama (Silik) ayarı
            // Assets için excludeFromAsset, Borçlar için excludeFromDebt
            const isExcluded = isLoan ? item.excludeFromDebt : (type === 'assets' ? item.excludeFromAsset : item.excludeFromDebt);
            
            const content = `
                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">Adı</label>
                        <input id="editName" value="${item.name}" class="w-full p-3 bg-gray-50 rounded-xl font-bold border border-gray-200">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">Değer (TL)</label>
                        <input id="editVal" type="number" value="${val}" class="w-full p-3 bg-gray-50 rounded-xl font-black text-lg border border-gray-200">
                    </div>
                    ${isLoan ? `
                    <div class="flex gap-2">
                        <div class="flex-1">
                            <label class="text-xs font-bold text-gray-500 uppercase">Aylık</label>
                            <input id="editMonthly" type="number" value="${item.monthly}" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                        </div>
                        <div class="flex-1">
                            <label class="text-xs font-bold text-gray-500 uppercase">Kalan Ay</label>
                            <input id="editMonths" type="number" value="${item.totalMonths}" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                        </div>
                    </div>` : ''}
                    
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                        <span class="text-sm font-bold">Hesaplamaya Dahil Et</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="editInclude" class="sr-only peer" ${!isExcluded ? 'checked' : ''}>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    
                    <button onclick="saveEdit('${type}', ${index})" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg mt-4">Kaydet</button>
                    <button onclick="deleteItem('${type}', ${index})" class="w-full text-red-500 font-bold py-3 rounded-xl hover:bg-red-50">Sil</button>
                </div>
            `;
            openDrawer('Düzenle', content);
        }

        function saveEdit(type, index) {
            const name = document.getElementById('editName').value;
            const val = parseFloat(document.getElementById('editVal').value);
            const include = document.getElementById('editInclude').checked;
            
            state[type][index].name = name;
            
            if (type === 'loans') {
                state[type][index].monthly = parseFloat(document.getElementById('editMonthly').value);
                state[type][index].totalMonths = parseFloat(document.getElementById('editMonths').value);
                state[type][index].totalDebt = val; // Kullanıcı toplamı manuel değiştirebilir
                state[type][index].excludeFromDebt = !include;
            } else {
                state[type][index].val = val;
                if (type === 'assets') state[type][index].excludeFromAsset = !include;
                else state[type][index].excludeFromDebt = !include;
            }
            
            saveToCloud();
            updateDashboardUI();
            closeDrawer();
        }

        function deleteItem(type, index) {
            if(confirm("Silmek istediğine emin misin?")) {
                state[type].splice(index, 1);
                saveToCloud();
                updateDashboardUI();
                closeDrawer();
            }
        }

        function showSettingsDrawer() {
            const code = state.inviteCode || "Oluşturulmadı";
            const html = `
                <div class="space-y-6">
                    <div class="p-4 bg-blue-50 rounded-xl border border-blue-100 text-center">
                        <p class="text-xs font-bold text-gray-500 mb-1">PLAN DAVET KODU</p>
                        <p class="text-2xl font-black text-blue-600 tracking-widest">${state.inviteCode || '-----'}</p>
                        <button onclick="createInviteCode()" class="mt-2 text-xs font-bold underline text-blue-400">Kod Oluştur</button>
                    </div>
                    
                    <div>
                        <h4 class="font-bold text-sm mb-2">Aile Üyeleri</h4>
                        <div class="space-y-2">
                             ${state.familyMembers && state.familyMembers.length > 0 ? state.familyMembers.map(m => `
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                    <span class="font-bold text-sm">${m.name}</span>
                                    <span class="text-xs bg-white px-2 py-1 rounded border">${m.role}</span>
                                </div>
                             `).join('') : '<p class="text-xs text-gray-400">Henüz kimse yok.</p>'}
                        </div>
                    </div>
                    
                    <div class="pt-4 border-t">
                        <button onclick="handleLogout()" class="w-full py-3 bg-red-50 text-red-500 font-bold rounded-xl">Çıkış Yap</button>
                    </div>
                </div>
            `;
            openDrawer('Ayarlar', html);
        }

        function createInviteCode() {
            const code = Math.random().toString(36).substring(2, 7).toUpperCase();
            state.inviteCode = code;
            saveToCloud();
            showSettingsDrawer(); // Refresh
        }
        
        function showCalcDrawer() {
             const now = new Date();
             const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
             
             // Hesaplar
             const income = state.incomes.reduce((s,i)=>s+(i.val||0),0);
             const bills = state.bills.reduce((s,b)=>s+(b.val||0),0);
             const loans = state.loans.filter(l=>!l.excludeFromDebt).reduce((s,l)=>s+(l.monthly||0),0);
             const net = income - (bills + loans);
             
             const html = `
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-gray-500">Toplam Gelir</span>
                        <span class="font-black text-green-600">+₺${income.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-gray-500">Sabit Giderler</span>
                        <span class="font-black text-red-500">-₺${bills.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between items-center pb-4 border-b">
                        <span class="font-bold text-gray-500">Kredi Taksitleri</span>
                        <span class="font-black text-red-500">-₺${loans.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between items-center text-lg">
                        <span class="font-bold text-gray-800">Harcanabilir</span>
                        <span class="font-black text-gray-900">₺${net.toLocaleString()}</span>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-xl text-center">
                        <p class="text-xs font-bold text-gray-500 mb-1">GÜNLÜK LİMİT (${daysInMonth} gün)</p>
                        <p class="text-3xl font-black text-blue-600">₺${Math.floor(net / daysInMonth).toLocaleString()}</p>
                    </div>
                </div>
             `;
             openDrawer('Nasıl Hesaplandı?', html);
        }

        function handleLogout() { auth.signOut().then(() => window.location.reload()); }
    </script>
</body>
</html>
