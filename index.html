<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bizim BÃ¼tÃ§e | Finansal Asistan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- FIREBASE SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .glass-card { background: rgba(255, 255, 255, 0.95); border: 1px solid rgba(255,255,255,0.6); box-shadow: 0 10px 30px -10px rgba(0,0,0,0.1); backdrop-filter: blur(10px); }
        .hidden { display: none !important; }
        input[type="range"] { accent-color: #2563eb; }
        .overlay { background: rgba(0,0,0,0.6); opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .overlay.active { opacity: 1; pointer-events: auto; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .health-detail { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .health-detail.open { max-height: 1000px; transition: max-height 0.5s ease-in; }
        
        .fade-text { animation: textFade 0.5s ease-in-out; }
        @keyframes textFade { 0% { opacity: 0; } 100% { opacity: 1; } }

        /* YanÄ±p SÃ¶nme Efektleri */
        @keyframes pulse-red { 0%, 100% { color: #ef4444; text-shadow: 0 0 5px rgba(239, 68, 68, 0.2); } 50% { color: #fca5a5; text-shadow: 0 0 15px rgba(239, 68, 68, 0.6); } }
        @keyframes pulse-green { 0%, 100% { color: #16a34a; text-shadow: 0 0 5px rgba(22, 163, 74, 0.2); } 50% { color: #86efac; text-shadow: 0 0 15px rgba(22, 163, 74, 0.6); } }
        .animate-pulse-red { animation: pulse-red 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .animate-pulse-green { animation: pulse-green 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }

        /* Side Panel AnimasyonlarÄ± */
        .side-panel {
            position: fixed; top: 0; right: 0; height: 100%; width: 100%; max-width: 28rem; 
            background: white; z-index: 60; box-shadow: -10px 0 30px rgba(0,0,0,0.1);
            transform: translateX(100%); transition: transform 0.3s ease-in-out;
            display: flex; flex-direction: column;
        }
        .side-panel.open { transform: translateX(0); }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col items-center justify-center bg-slate-50">

    <div id="overlay" class="overlay fixed inset-0 z-40" onclick="closeAllPopups()"></div>
    
    <div id="saveIndicator" class="fixed bottom-4 right-4 bg-white px-4 py-2 rounded-full shadow-lg border border-gray-100 flex items-center gap-2 text-xs font-bold text-gray-500 opacity-0 transition-opacity duration-500 pointer-events-none z-50">
        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div> Kaydedildi
    </div>

    <!-- 1. GÄ°RÄ°Åž EKRANI -->
    <div id="loginScreen" class="max-w-md w-full glass-card p-10 rounded-[2.5rem] shadow-2xl space-y-6 my-auto relative overflow-hidden animate-fade-in">
        <div class="text-center">
            <div class="w-16 h-16 bg-blue-50 rounded-2xl flex items-center justify-center mx-auto mb-4 text-blue-600 shadow-sm transform hover:rotate-12 transition-transform duration-300">
                <i class="fas fa-cloud text-2xl"></i>
            </div>
            <h1 class="text-2xl font-black text-gray-900 tracking-tight" id="loginTitle">GiriÅŸ Yap</h1>
            <p class="text-gray-400 text-[10px] font-bold uppercase tracking-widest mt-1" id="loginSubtitle">HesabÄ±na EriÅŸ</p>
        </div>
        
        <div class="space-y-3" id="authFormContainer">
            <div id="registerFields" class="hidden space-y-3">
                <input type="text" id="regUsernameInput" class="w-full p-4 bg-white border border-gray-200 rounded-2xl focus:ring-4 focus:ring-blue-100 outline-none font-bold text-gray-700 transition-all text-sm" placeholder="KullanÄ±cÄ± AdÄ± Belirle (Zorunlu)">
                <input type="text" id="regInviteCode" class="w-full p-4 bg-white border border-gray-200 rounded-2xl focus:ring-4 focus:ring-blue-100 outline-none font-bold text-gray-700 transition-all text-sm" placeholder="Davet Kodu (Varsa)">
                <input type="number" id="regDailyLimit" class="w-full p-4 bg-blue-50 border border-blue-200 rounded-2xl focus:ring-4 focus:ring-blue-100 outline-none font-black text-blue-700 transition-all text-sm hidden placeholder-blue-400" placeholder="GÃ¼nlÃ¼k Harcama Hedefiniz (TL)">
            </div>
            
            <input type="text" id="emailInput" class="w-full p-4 bg-white border border-gray-200 rounded-2xl focus:ring-4 focus:ring-blue-100 outline-none font-bold text-gray-700 transition-all text-sm" placeholder="E-posta veya KullanÄ±cÄ± AdÄ±">
            <input type="password" id="passwordInput" class="w-full p-4 bg-white border border-gray-200 rounded-2xl focus:ring-4 focus:ring-blue-100 outline-none font-bold text-gray-700 transition-all text-sm" placeholder="Åžifre">
            
            <button id="loginBtn" onclick="firebaseLogin()" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl shadow-xl shadow-blue-200 active:scale-95 transition-all hover:bg-blue-700 flex justify-center items-center gap-2">
                <span>GiriÅŸ Yap</span>
            </button>
            
            <button id="registerBtn" onclick="firebaseRegister()" class="w-full bg-indigo-600 text-white font-black py-4 rounded-2xl shadow-xl hidden active:scale-95 transition-all hover:bg-indigo-700 flex justify-center items-center gap-2">
                <span>Ãœye Ol ve KatÄ±l</span>
            </button>
            
            <p id="forgotPassText" class="text-center text-[11px] font-bold text-blue-400 cursor-pointer hover:text-blue-600 pt-2" onclick="forgotPassword()">Åžifremi Unuttum?</p>

            <p id="backToLoginText" class="text-center text-xs font-bold text-gray-400 cursor-pointer hover:text-blue-500 hidden pt-2" onclick="showLoginMode()">
                <i class="fas fa-arrow-left mr-1"></i> GiriÅŸ ekranÄ±na dÃ¶n
            </p>
        </div>
        
        <div class="relative py-2">
            <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-200"></div></div>
            <div class="relative flex justify-center"><span class="bg-white px-4 text-xs font-bold text-gray-400 uppercase">veya</span></div>
        </div>

        <div class="space-y-3" id="actionButtons">
            <button onclick="startWizard(false)" class="w-full bg-green-500 text-white font-black py-4 rounded-2xl shadow-lg shadow-green-100 active:scale-95 transition-all hover:bg-green-600 flex items-center justify-center gap-2">
                <i class="fas fa-magic"></i> <span>Plana BaÅŸla</span>
            </button>
            
            <button onclick="showQuickRegisterMode()" class="w-full bg-slate-800 text-white font-bold py-3 px-4 rounded-2xl active:scale-95 transition-all hover:bg-slate-900 shadow-md flex items-center justify-center gap-3 text-xs leading-tight">
                <i class="fas fa-bolt text-yellow-400 text-lg"></i> <span class="text-left">Veri girmek istemiyorum,<br>sadece gÃ¼nlÃ¼k harcama hesaplayacaÄŸÄ±m</span>
            </button>

            <p class="text-[10px] text-center text-gray-400 px-4 mt-2">BÃ¼tÃ§eni oluÅŸturmaya baÅŸla, en son adÄ±mda kaydedip Ã¼ye ol.</p>
            <button onclick="showRegisterMode()" class="w-full bg-white border-2 border-gray-100 text-gray-600 font-bold py-3 rounded-2xl active:scale-95 transition-all hover:border-indigo-200 hover:text-indigo-600 mt-2">
                Bir Plana Dahil Ol
            </button>
        </div>
    </div>

    <!-- 2. SÄ°HÄ°RBAZ (WIZARD) -->
    <div id="wizardScreen" class="max-w-xl w-full glass-card p-8 rounded-[2.5rem] shadow-2xl hidden space-y-6 my-auto relative animate-fade-in">
        <div class="flex justify-between items-center mb-4">
            <div id="wizardProgress" class="flex gap-1 flex-1 mr-4"></div>
            <span class="text-xs font-bold text-gray-300" id="stepCount">1/8</span>
        </div>
        <div id="wizardContent" class="min-h-[420px] flex flex-col relative"></div>
        <div class="flex gap-3 mt-4" id="wizardNavBtns">
             <button onclick="wizardBack()" class="flex-1 bg-gray-100 text-gray-600 font-bold py-4 rounded-2xl hover:bg-gray-200 transition-all">Geri</button>
             <button onclick="wizardNext()" id="wizNextBtn" class="flex-[2] bg-blue-600 text-white font-black py-4 rounded-2xl shadow-xl active:scale-95 transition-all hover:bg-blue-700">Devam Et</button>
        </div>
    </div>

    <!-- 3. DASHBOARD -->
    <div id="dashboardScreen" class="max-w-4xl w-full hidden space-y-8 pb-32 animate-fade-in">
        
        <!-- Esprili Mesaj AlanÄ± -->
        <div id="motivationArea" class="hidden w-full p-4 rounded-3xl bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 text-white shadow-lg animate-fade-in">
            <div class="flex items-start gap-3">
                <div class="text-2xl mt-1">ðŸ¤–</div>
                <div>
                    <p class="text-[10px] font-bold uppercase tracking-widest opacity-80 mb-1">Durum Raporu</p>
                    <p class="font-black text-sm md:text-base leading-tight" id="motivationText">...</p>
                </div>
            </div>
        </div>

        <!-- Davet Bildirim AfiÅŸi -->
        <div id="inviteBanner" class="hidden bg-indigo-600 text-white p-4 rounded-3xl shadow-lg flex flex-col sm:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center"><i class="fas fa-envelope-open-text"></i></div>
                <div>
                    <p class="text-[10px] text-indigo-200 font-bold uppercase tracking-widest">Yeni Plan Daveti</p>
                    <p class="font-black text-sm" id="inviteBannerText">Sizi planÄ±na davet ediyor.</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="rejectInvite()" class="px-5 py-2 bg-white/10 hover:bg-white/20 rounded-xl text-xs font-bold transition-colors">Reddet</button>
                <button onclick="acceptInvite()" class="px-5 py-2 bg-white text-indigo-600 hover:bg-indigo-50 rounded-xl text-xs font-black transition-colors shadow-sm">Kabul Et</button>
            </div>
        </div>

        <div class="flex justify-between items-center">
            <div>
                <h2 class="text-2xl font-black text-gray-800 tracking-tight" id="dashWelcome">Panelim</h2>
                <div class="flex items-center gap-2">
                    <span id="roleBadge" class="text-[9px] font-black bg-blue-100 text-blue-600 px-2 py-0.5 rounded uppercase tracking-wide">YÃ¶netici</span>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="showAnalysisScreen()" id="btnAnalysis" class="text-[10px] font-black bg-white text-indigo-500 border border-indigo-200 px-4 py-2 rounded-full uppercase tracking-widest shadow-sm hover:bg-indigo-50"><i class="fas fa-chart-pie"></i></button>
                <button onclick="showSettingsModal()" class="text-[10px] font-black bg-white text-gray-500 border border-gray-200 px-4 py-2 rounded-full uppercase tracking-widest shadow-sm hover:bg-gray-50"><i class="fas fa-cog"></i></button>
                <button onclick="handleLogout()" class="text-[10px] font-black bg-white text-red-500 border border-red-50 px-4 py-2 rounded-full uppercase tracking-widest shadow-sm hover:bg-red-50">Ã‡Ä±kÄ±ÅŸ</button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-2 glass-card p-8 rounded-[3rem] bg-gradient-to-br from-slate-800 to-slate-900 text-white shadow-2xl relative overflow-hidden group">
                <div class="absolute top-0 right-0 w-64 h-64 bg-blue-500 rounded-full mix-blend-overlay filter blur-3xl opacity-20 -mr-16 -mt-16"></div>
                <div class="relative z-10">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest opacity-80">BugÃ¼nÃ¼n Limiti</p>
                                <button onclick="openCalcModal()" class="text-blue-300 hover:text-white text-[9px] font-bold underline decoration-dashed underline-offset-2 transition-colors cursor-pointer relative z-20">NasÄ±l HesaplandÄ±?</button>
                            </div>
                            <h2 id="displayDailyLimit" class="text-6xl font-black tracking-tighter leading-none">â‚º0</h2>
                        </div>
                        <div class="text-right">
                            <p onclick="openBalanceModal()" class="text-blue-400 text-[10px] font-bold uppercase tracking-widest mb-1 underline decoration-dashed underline-offset-4 cursor-pointer hover:text-blue-200 transition-colors" title="Detay iÃ§in tÄ±kla">GerÃ§ek Bakiye</p>
                            <h4 id="displayCumulativeLimit" onclick="openBalanceModal()" class="text-4xl font-black text-white tracking-tight cursor-pointer">â‚º0</h4>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 mt-8 pt-6 border-t border-white/10">
                        <div class="bg-white/10 px-4 py-2 rounded-xl backdrop-blur-md border border-white/5">
                            <span class="text-[9px] text-slate-300 font-bold uppercase block">MaaÅŸa Kalan</span>
                            <span id="displayRemainingDays" class="text-lg font-black text-white">-- GÃ¼n</span>
                        </div>
                         <div class="bg-white/10 px-4 py-2 rounded-xl backdrop-blur-md border border-white/5">
                            <span class="text-[9px] text-slate-300 font-bold uppercase block">Hedef Birikim</span>
                            <span id="sumSavings" class="text-lg font-black text-green-400">â‚º0</span>
                        </div>
                        <button onclick="startWizard(true)" id="btnEditPlan" class="bg-white/10 px-4 py-2 rounded-xl backdrop-blur-md border border-white/5 hover:bg-white/20 transition-all flex flex-col items-center justify-center min-w-[80px]">
                            <i class="fas fa-pen text-sm mb-1 text-slate-300"></i>
                            <span class="text-[9px] text-slate-300 font-bold uppercase block">DÃ¼zenle</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Aile YÃ¶netimi Paneli -->
            <div id="familyPanel" class="glass-card p-6 rounded-[3rem] flex flex-col bg-white border border-blue-50">
                <div class="flex justify-between items-center mb-4 border-b pb-4">
                    <h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Aile Sistemi</h4>
                    <button onclick="createInviteCode()" class="text-[9px] font-bold text-blue-500 bg-blue-50 px-2 py-1 rounded-md hover:bg-blue-100 transition-colors">Kod: <span id="displayInviteCode">-----</span></button>
                </div>
                <div class="flex flex-col gap-2 mb-2">
                    <input type="text" id="famInput" class="w-full p-2 bg-gray-50 rounded-lg font-bold text-xs outline-none border border-gray-100" placeholder="KullanÄ±cÄ± AdÄ±/E-posta">
                    <div class="flex gap-2">
                        <select id="famRole" class="flex-1 p-2 bg-white border border-gray-100 rounded-lg text-xs font-bold text-gray-600 outline-none">
                            <option value="full">Tam Yetki</option>
                            <option value="limited">SÄ±nÄ±rlÄ±</option>
                        </select>
                        <button onclick="addFamilyMember()" class="bg-orange-500 text-white font-black px-4 rounded-lg hover:bg-orange-600 transition-all text-xs">Ekle</button>
                    </div>
                </div>
                <div id="familyList" class="space-y-2 flex-1 overflow-y-auto max-h-[120px] custom-scrollbar pr-1 mt-2"></div>
            </div>
        </div>

        <div class="glass-card p-8 rounded-[2.5rem] bg-white border border-gray-100 shadow-lg">
            <div class="flex items-center justify-between mb-6">
                <h3 class="font-black text-xl text-gray-800">Harcama Ekle</h3>
                <span id="todayTotal" class="text-[10px] font-bold bg-blue-100 text-blue-700 px-3 py-1 rounded-lg uppercase tracking-wide">BugÃ¼n: â‚º0</span>
            </div>
            
            <div class="flex flex-col gap-3">
                <div class="flex gap-2 items-center">
                    <div class="w-1/3 relative">
                        <select id="expCat" class="w-full p-4 bg-gray-50 rounded-l-2xl font-bold text-xs text-gray-700 outline-none focus:ring-4 focus:ring-blue-100 transition-all border-r border-gray-200 appearance-none">
                             <!-- Categories will be injected here -->
                        </select>
                        <button onclick="openCategoryModal()" class="absolute right-0 top-0 h-full px-2 text-gray-400 hover:text-blue-500 rounded-r-2xl bg-white border-l border-gray-100" title="Kategorileri DÃ¼zenle">
                            <i class="fas fa-pencil-alt text-xs"></i>
                        </button>
                    </div>
                    <input type="text" id="expDesc" value="" placeholder="AÃ§Ä±klama (Opsiyonel)" onkeyup="if(event.key === 'Enter') addExpense()" class="flex-1 p-4 bg-gray-50 rounded-2xl font-bold text-gray-600 outline-none focus:ring-2 focus:ring-blue-500 transition-all text-sm">
                </div>
                
                <div class="flex gap-2 items-center">
                     <input type="number" id="expAmt" placeholder="Tutar (â‚º)" onkeyup="if(event.key === 'Enter') addExpense()" class="flex-1 p-4 bg-gray-50 rounded-2xl font-black text-lg outline-none focus:ring-4 focus:ring-blue-100 transition-all">
                     <input type="hidden" id="editExpIndex" value="-1">
                     <button id="addExpBtn" onclick="addExpense()" class="bg-blue-600 text-white w-16 rounded-2xl hover:bg-blue-700 active:scale-90 transition-all shadow-lg shadow-blue-200 flex items-center justify-center shrink-0 p-4"><i class="fas fa-plus text-xl"></i></button>
                </div>
                
                <!-- HÄ±zlÄ± Tarih SeÃ§ici -->
                <div class="flex items-center gap-2 bg-gray-50 p-2 rounded-xl border border-gray-100 w-full md:w-auto self-start mt-1">
                    <button onclick="changeExpenseDate(1)" class="w-8 h-8 flex items-center justify-center bg-white rounded-lg text-gray-500 hover:text-blue-600 shadow-sm transition-colors border border-gray-200"><i class="fas fa-chevron-left"></i></button>
                    <div class="relative flex-1 text-center min-w-[160px]">
                        <span id="expenseDateLabel" class="text-xs font-bold text-gray-600 cursor-pointer hover:text-blue-500 select-none" onclick="document.getElementById('expDateInputHidden').showPicker()">BugÃ¼n</span>
                        <input type="date" id="expDateInputHidden" class="absolute inset-0 opacity-0 cursor-pointer" onchange="setSpecificDate(this.value)">
                    </div>
                    <button onclick="changeExpenseDate(-1)" class="w-8 h-8 flex items-center justify-center bg-white rounded-lg text-gray-500 hover:text-blue-600 shadow-sm transition-colors border border-gray-200"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        </div>

        <div class="glass-card p-8 rounded-[3rem] shadow-xl bg-white border border-gray-100">
            <h3 class="font-black text-xl text-gray-800 uppercase tracking-widest text-[11px] mb-4">Harcama GeÃ§miÅŸi</h3>
            <div id="historyList" class="pb-4"></div>
        </div>

        <div id="financialHealthSection" class="glass-card p-10 rounded-[3rem] space-y-8 bg-white border border-blue-50 shadow-xl">
            <div class="flex flex-col items-center border-b pb-8">
                <h3 class="font-black text-3xl text-gray-800 mb-2">Finansal SaÄŸlÄ±k</h3>
                <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mb-4">Net VarlÄ±k (VarlÄ±k - BorÃ§)</p>
                <div id="netStatusBadge" class="text-4xl font-black text-gray-800 px-8 py-4 bg-gray-50 rounded-[2rem] transition-colors">
                    <span id="netStatusVal">â‚º0</span>
                </div>
                
                <div class="flex items-center justify-center mt-6">
                    <div class="text-center"><span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">AylÄ±k Sabit Gider</span><br><span id="sumGiderTotalHealth" class="text-xl font-black text-red-600">â‚º0</span></div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- BORÃ‡LAR -->
                <div class="space-y-4">
                    <div class="flex items-center gap-2 mb-2 pb-2 border-b border-red-100">
                        <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                        <span class="text-xs font-black text-red-600 uppercase tracking-widest">BorÃ§lar & Krediler</span>
                    </div>
                    <div id="detailedDebtsList" class="space-y-3 min-h-[50px]"></div>
                    
                    <div class="mt-4">
                        <button id="btnShowdashDebtForm" onclick="toggleInlineAdd('dashDebt')" class="w-full py-2 text-[10px] font-bold text-gray-400 hover:text-gray-600 border border-dashed border-gray-300 rounded-lg transition-colors">+ Yeni BorÃ§ Ekle</button>
                        <div id="inlineAdddashDebtContainer" class="hidden mt-2 p-4 border border-red-100 bg-red-50/50 rounded-xl space-y-3 shadow-inner">
                            <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">BorÃ§ TÃ¼rÃ¼</label>
                            <select id="dashDebtType" onchange="handleInlineTypeChange('dashDebt')" class="w-full p-2.5 bg-white rounded-lg text-xs font-bold border border-gray-200 outline-none focus:ring-2 focus:ring-blue-100">
                                <option value="Kredi">Kredi</option>
                                <option value="Kredi KartÄ±">Kredi KartÄ±</option>
                                <option value="AltÄ±n">AltÄ±n</option>
                                <option value="DÃ¶viz">DÃ¶viz</option>
                                <option value="GÃ¼mÃ¼ÅŸ">GÃ¼mÃ¼ÅŸ</option>
                                <option value="DiÄŸer">DiÄŸer</option>
                            </select>
                            <div id="dashDebtFields" class="space-y-2"></div>
                            <div class="flex gap-2 pt-2">
                                <button onclick="cancelInlineAdd('dashDebt')" class="flex-1 bg-white border border-gray-200 text-gray-600 rounded-lg py-2 text-xs font-bold hover:bg-gray-50">Ä°ptal</button>
                                <button onclick="saveInlineAdd('dashDebt')" class="flex-1 bg-red-500 text-white rounded-lg py-2 text-xs font-black hover:bg-red-600">Kaydet</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VARLIKLAR -->
                <div class="space-y-4">
                    <div class="flex items-center gap-2 mb-2 pb-2 border-b border-green-100">
                        <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                        <span class="text-xs font-black text-green-600 uppercase tracking-widest">VarlÄ±klar & Birikim</span>
                    </div>
                    <div id="detailedAssetsList" class="space-y-3 min-h-[50px]"></div>

                    <div class="mt-4">
                        <button id="btnShowdashAssetForm" onclick="toggleInlineAdd('dashAsset')" class="w-full py-2 text-[10px] font-bold text-gray-400 hover:text-gray-600 border border-dashed border-gray-300 rounded-lg transition-colors">+ Yeni VarlÄ±k Ekle</button>
                        <div id="inlineAdddashAssetContainer" class="hidden mt-2 p-4 border border-green-100 bg-green-50/50 rounded-xl space-y-3 shadow-inner">
                            <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">VarlÄ±k TÃ¼rÃ¼</label>
                            <select id="dashAssetType" onchange="handleInlineTypeChange('dashAsset')" class="w-full p-2.5 bg-white rounded-lg text-xs font-bold border border-gray-200 outline-none focus:ring-2 focus:ring-blue-100">
                                <option value="DiÄŸer">DiÄŸer (Standart TL)</option>
                                <option value="AltÄ±n">AltÄ±n</option>
                                <option value="DÃ¶viz">DÃ¶viz</option>
                                <option value="GÃ¼mÃ¼ÅŸ">GÃ¼mÃ¼ÅŸ</option>
                            </select>
                            <div id="dashAssetFields" class="space-y-2"></div>
                            <div class="flex gap-2 pt-2">
                                <button onclick="cancelInlineAdd('dashAsset')" class="flex-1 bg-white border border-gray-200 text-gray-600 rounded-lg py-2 text-xs font-bold hover:bg-gray-50">Ä°ptal</button>
                                <button onclick="saveInlineAdd('dashAsset')" class="flex-1 bg-green-500 text-white rounded-lg py-2 text-xs font-black hover:bg-green-600">Kaydet</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- SABÄ°T GÄ°DERLER AKORDÄ°YONU -->
            <div id="fixedExpensesSection" class="w-full pt-4"></div>
        </div>
    </div>

    <!-- 4. ANALÄ°Z EKRANI -->
    <div id="analysisScreen" class="max-w-4xl w-full hidden space-y-8 pb-32 animate-fade-in my-auto">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-2xl font-black text-gray-800 tracking-tight">Finansal Analiz</h2>
                <div class="flex items-center gap-3 mt-2">
                     <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Analiz DÃ¶nemi:</p>
                     <input type="month" id="analysisDateFilter" class="bg-gray-100 text-gray-700 text-xs font-bold p-1 rounded-lg border-none outline-none" onchange="renderCharts()">
                </div>
                <p id="analysisPeriodLabel" class="text-[10px] text-blue-500 font-bold mt-1"></p>
            </div>
            <button onclick="showDashboard()" class="text-[10px] font-black bg-gray-100 text-gray-600 border border-gray-200 px-4 py-2 rounded-full uppercase tracking-widest shadow-sm hover:bg-gray-200">Geri DÃ¶n</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="glass-card p-6 rounded-[2.5rem] bg-white border border-gray-100 shadow-lg"><h3 class="font-black text-lg text-gray-800 mb-4 text-center">VarlÄ±k vs BorÃ§</h3><div class="h-64"><canvas id="assetsChart"></canvas></div></div>
            <div class="glass-card p-6 rounded-[2.5rem] bg-white border border-gray-100 shadow-lg"><h3 class="font-black text-lg text-gray-800 mb-4 text-center">Harcama DaÄŸÄ±lÄ±mÄ±</h3><div class="h-64"><canvas id="expensesChart"></canvas></div></div>
        </div>
        <div class="glass-card p-8 rounded-[2.5rem] bg-white border border-gray-100 shadow-lg">
            <h3 class="font-black text-xl text-gray-800 mb-4 border-b pb-2">GeÃ§miÅŸ KayÄ±t Ekle</h3>
            <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 items-end">
                <div><label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">DÃ¶nem</label><input type="month" id="histDate" class="w-full p-3 bg-gray-50 rounded-xl font-bold text-sm outline-none"></div>
                <div><label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">VarlÄ±k</label><input type="number" id="histAssets" placeholder="0" class="w-full p-3 bg-gray-50 rounded-xl font-bold text-sm outline-none text-green-600"></div>
                <div><label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">BorÃ§</label><input type="number" id="histDebts" placeholder="0" class="w-full p-3 bg-gray-50 rounded-xl font-bold text-sm outline-none text-red-600"></div>
                <button onclick="addHistoryRecord()" class="bg-indigo-600 text-white font-black py-3 rounded-xl shadow-lg hover:bg-indigo-700 active:scale-95 transition-all">Kaydet</button>
            </div>
            <div id="historyTable" class="mt-6 space-y-2"></div>
        </div>
    </div>

    <!-- AYARLAR MODALI -->
    <div id="settingsModal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-sm glass-card p-8 rounded-[2rem] z-50 shadow-2xl hidden border-2 border-gray-100 animate-fade-in">
        <div class="flex justify-between items-center mb-6">
            <h4 class="font-black text-xl text-gray-800 tracking-tight">Ayarlar</h4>
            <button onclick="closeSettingsModal()" class="text-gray-300 hover:text-red-500"><i class="fas fa-times"></i></button>
        </div>

        <div class="space-y-6">
            <div class="p-4 bg-gray-50 rounded-xl border border-gray-100 text-center">
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Mevcut Plan StatÃ¼sÃ¼</p>
                <p class="font-black text-blue-600 text-sm" id="settingsCurrentPlanLabel">Kendi PlanÄ±nÄ±z (YÃ¶netici)</p>
                <button id="btnLeavePlan" onclick="leaveCurrentPlan()" class="hidden mt-3 text-[10px] font-bold text-red-500 bg-red-50 px-3 py-1.5 rounded-lg w-full hover:bg-red-100 transition-colors">Ortak Plandan AyrÄ±l</button>
            </div>

            <div class="space-y-2">
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Davet Kodu Ä°le BaÅŸka Plana KatÄ±l</p>
                <input type="text" id="settingsInviteCode" class="w-full p-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-100 outline-none font-bold text-gray-700 transition-all text-sm" placeholder="Davet Kodunu Girin">
                <button onclick="joinPlanByCode()" class="w-full bg-blue-600 text-white font-black py-3 rounded-xl shadow-lg hover:bg-blue-700 active:scale-95 transition-all text-sm">KatÄ±l</button>
            </div>
        </div>
    </div>

    <!-- DÃœZENLEME MODALI (YAN PANEL) -->
    <div id="editItemModal" class="side-panel">
        <div class="p-6 h-full flex flex-col">
            <div class="flex justify-between items-center mb-6 pb-4 border-b">
                <h4 class="font-black text-xl text-gray-800 tracking-tight">DÃ¼zenle</h4>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto custom-scrollbar pb-10">
                <div class="space-y-4">
                    <input type="text" id="editItemName" class="w-full p-4 bg-gray-50 rounded-xl font-bold text-sm border border-gray-100" placeholder="Ä°sim">
                    <input type="number" id="editItemVal" class="w-full p-4 bg-gray-50 rounded-xl font-bold text-sm border border-gray-100" placeholder="Toplam Tutar">
                    
                    <div class="p-4 bg-blue-50 rounded-xl border border-blue-100 flex items-center gap-3">
                         <input type="checkbox" id="editExcludeNetWorth" class="w-5 h-5 rounded text-blue-600 focus:ring-blue-500">
                         <label for="editExcludeNetWorth" class="text-xs font-bold text-gray-600">Net VarlÄ±k HesabÄ±na Katma</label>
                    </div>
                    
                    <input type="hidden" id="editItemType"><input type="hidden" id="editItemIndex">
                    <div class="flex gap-2 pt-4">
                        <button onclick="closeEditModal()" class="flex-1 py-3 bg-gray-100 text-gray-600 font-bold rounded-xl border border-gray-200">Ä°ptal</button>
                        <button onclick="saveEditedItem()" class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg shadow-blue-200">Kaydet</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- HESAPLAMA DETAY YAN PANELÄ° -->
    <div id="calcModal" class="side-panel">
        <div class="p-6 h-full flex flex-col">
            <div class="flex justify-between items-center mb-6 pb-4 border-b">
                <h4 class="font-black text-xl text-gray-800 tracking-tight">NasÄ±l HesaplandÄ±?</h4>
                <button onclick="closeCalcModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="calcModalContent" class="space-y-4 text-sm flex-1 overflow-y-auto custom-scrollbar pb-10"></div>
        </div>
    </div>

    <!-- GERÃ‡EK BAKÄ°YE DETAY YAN PANELÄ° -->
    <div id="balanceModal" class="side-panel">
        <div class="p-6 h-full flex flex-col">
            <div class="flex justify-between items-center mb-6 pb-4 border-b">
                <h4 class="font-black text-xl text-gray-800 tracking-tight">GerÃ§ek Bakiye</h4>
                <button onclick="closeBalanceModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="balanceModalContent" class="space-y-4 text-sm flex-1 overflow-y-auto custom-scrollbar pb-10"></div>
        </div>
    </div>

    <!-- KREDÄ° Ã–DEME PLANI YAN PANELÄ° -->
    <div id="loanPlanModal" class="side-panel">
        <div class="p-6 h-full flex flex-col">
            <div class="flex justify-between items-center mb-6 pb-4 border-b">
                <div>
                    <span class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Kredi DetayÄ±</span>
                    <h4 class="font-black text-xl text-gray-800 tracking-tight leading-none" id="loanPlanTitle">Ã–deme PlanÄ±</h4>
                </div>
                <button onclick="closeLoanPlanModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto custom-scrollbar pb-10">
                 <table class="w-full text-xs text-left">
                     <thead class="text-gray-400 font-bold uppercase border-b sticky top-0 bg-white"><tr><th class="pb-3 pl-2">Tak.</th><th class="pb-3">Tarih</th><th class="pb-3 text-right">Tutar</th><th class="pb-3 text-center">Durum</th></tr></thead>
                     <tbody id="loanPlanBody" class="font-bold text-gray-600"></tbody>
                 </table>
            </div>
        </div>
    </div>

    <!-- KATEGORÄ° DÃœZENLEME PANELÄ° -->
    <div id="categoryModal" class="side-panel">
        <div class="p-6 h-full flex flex-col">
             <div class="flex justify-between items-center mb-6 pb-4 border-b">
                <h4 class="font-black text-xl text-gray-800 tracking-tight">Kategoriler</h4>
                <button onclick="closeCategoryModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="flex gap-2 mb-4">
                <input type="text" id="newCatName" placeholder="Yeni Kategori Ekle" class="flex-1 p-3 bg-gray-50 border rounded-xl text-sm font-bold outline-none" onkeyup="if(event.key==='Enter') addNewCategory()">
                <button onclick="addNewCategory()" class="bg-blue-600 text-white w-12 rounded-xl flex items-center justify-center hover:bg-blue-700 shadow-lg"><i class="fas fa-plus"></i></button>
            </div>
            <div id="categoryList" class="flex-1 overflow-y-auto custom-scrollbar space-y-2 pb-10"></div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAyUQaeoVWnT4AuzSwD2M17-z1g2optqdA",
            authDomain: "hesapguvende-b07ca.firebaseapp.com",
            projectId: "hesapguvende-b07ca",
            storageBucket: "hesapguvende-b07ca.firebasestorage.app",
            messagingSenderId: "710002620092",
            appId: "1:710002620092:web:94f3ebb8dd2461af29c2b9",
            measurementId: "G-VE0EVVBM0V"
        };

        const financialTips = [
            "Finansal saÄŸlÄ±k, gelir ve giderler arasÄ±nda sÃ¼rdÃ¼rÃ¼lebilir bir denge kurabilme becerisidir.",
            "KÃ¼Ã§Ã¼k ama sÄ±k harcamalar bÃ¼tÃ§eyi sessizce tÃ¼ketir.",
            "Tasarruf geleceÄŸe yapÄ±lmÄ±ÅŸ bilinÃ§li bir yatÄ±rÄ±mdÄ±r.",
            "PlanlÄ± hareket eden kiÅŸi finansal kontrolÃ¼ elinde tutar.",
            "BÃ¼tÃ§e yapmak kÄ±sÄ±tlama deÄŸil yÃ¶nlendirmedir."
        ];

        // --- MOTÄ°VASYON MESAJLARI ---
        const messages_highSpend = [
            "CÃ¼zdan bugÃ¼n cardio yaptÄ±â€¦ nabÄ±z 180.", "Limit: â€˜Ben bu filmde yokumâ€™ dedi.", "BugÃ¼n harcama deÄŸil, sanat eseri Ã§Ä±karmÄ±ÅŸsÄ±n.", "KartÄ±n POS cihazÄ±yla duygusal baÄŸ kurmuÅŸ olabilir.", "BÃ¼tÃ§e planÄ±: â€˜Ben yarÄ±n geliyorumâ€™ diye kaÃ§tÄ±.",
            "Harcama grafiÄŸi roket gibiâ€¦ NASA aradÄ±.", "BugÃ¼n â€˜kÃ¼Ã§Ã¼k kaÃ§amakâ€™ deÄŸil, mini tatil olmuÅŸ.", "CÃ¼zdanÄ±n iÃ§ sesi: â€˜Ben aslÄ±nda inceydimâ€¦â€™", "Limitleri test ettin, tebrikler: stres testi baÅŸarÄ±lÄ±.", "BÃ¼tÃ§eye â€˜sÃ¼rpriz yumurtaâ€™ yaptÄ±n: iÃ§inden masraf Ã§Ä±ktÄ±.",
            "BugÃ¼n para â€˜ben gidiyorumâ€™ deyip valiz topladÄ±.", "Harcama modun: â€˜Bir tane daha sepet!â€™", "Kart ekstresi ÅŸu an sana bakÄ±p gÃ¶z kÄ±rpÄ±yor.", "BÃ¼tÃ§e: â€˜Ben ÅŸaka mÄ±ydÄ±m?â€™", "BugÃ¼n â€˜indirimâ€™ deÄŸil, â€˜iknaâ€™ kazanmÄ±ÅŸ.",
            "Harcamalar: â€˜Biz bir aile oldukâ€™ demiÅŸ.", "Limit Ã§izgisi aÅŸÄ±ldÄ±â€¦ uyarÄ± konisi koyuyorum ðŸš§", "BugÃ¼n cÃ¼zdan deÄŸil, sponsorluk anlaÅŸmasÄ± var sanki.", "Harcama sayacÄ± â€˜durâ€™ dedi, sen â€˜devamâ€™ dedin.", "BugÃ¼n paranÄ±n Ã¶zgÃ¼r iradesi elinden alÄ±nmÄ±ÅŸ olabilir."
        ];
        const messages_lowSavings = [
            "Hedefle arana mesafe girmiÅŸâ€¦ iliÅŸki terapisine gidelim mi?", "Birikim hedefi seni Ã¶zlemiÅŸ. Mesaj atayÄ±m mÄ±?", "Hedef uzakta ama imkÃ¢nsÄ±z deÄŸil: yÃ¼rÃ¼yÃ¼ÅŸe Ã§Ä±kÄ±yoruz.", "Birikim planÄ± â€˜neredesin?â€™ diye son gÃ¶rÃ¼lme attÄ±.", "Hedefe ÅŸu an Wi-Fi Ã§ekmiyor gibiâ€¦ yaklaÅŸalÄ±m.",
            "BugÃ¼n â€˜yaklaÅŸma gÃ¼nÃ¼â€™: hedefle barÄ±ÅŸ Ã§ubuÄŸu uzatÄ±yoruz.", "Birikim hedefin: â€˜Ben hÃ¢lÃ¢ buradayÄ±mâ€™ diye el sallÄ±yor.", "Mesafe moral bozmasÄ±n; kÃ¼Ã§Ã¼k adÄ±mlar bÃ¼yÃ¼k iÅŸler yapar.", "Hedefe uzaklÄ±k Ã¶lÃ§Ã¼mÃ¼: â€˜Bir tÄ±kâ€™ deÄŸil, birkaÃ§ tÄ±kâ€¦", "BugÃ¼n birikim deÄŸilse bile, en azÄ±ndan niyet artÄ± puan.",
            "Hedefe giden yol: â€˜Az harcaâ€™ tabelasÄ±yla baÅŸlÄ±yor.", "Birikim hedefinle arana â€˜kargo Ã¼cretiâ€™ girmiÅŸ olabilir.", "Hedef kaÃ§madÄ±; sadece sen biraz oyalanmÄ±ÅŸsÄ±n.", "BÃ¼tÃ§e pusulasÄ± ÅŸaÅŸmÄ±ÅŸ; kuzeyi yeniden buluyoruz.", "Birikim: â€˜Ben senin iyiliÄŸini dÃ¼ÅŸÃ¼nÃ¼yorumâ€™ modunda.",
            "Hedefe yaklaÅŸma challengeâ€™Ä±: bugÃ¼n kÃ¼Ã§Ã¼k bir zafer?", "Hedefle arayÄ± kapatmak iÃ§in â€˜mini resetâ€™ zamanÄ±.", "Birikim hedefi: â€˜Konum paylaÅŸâ€™ diyor.", "Mesafe var ama rota Ã§izilebilir: baÅŸlÄ±yoruz.", "BugÃ¼n hedefe 1 adÄ±m: bÃ¼yÃ¼k kahramanlÄ±klar bÃ¶yle baÅŸlar."
        ];
        const messages_streak = [
            "ÃœÃ§ gÃ¼n Ã¼st Ã¼ste! BÃ¼tÃ§e disiplini DLCâ€™si aÃ§Ä±ldÄ±.", "Sende bir â€˜finans ninjaâ€™ enerjisi var.", "Hedef serisi baÅŸladÄ±: streak mode ON ðŸ”¥", "CÃ¼zdanÄ±n bugÃ¼n sana gururla bakÄ±yor.", "BÃ¼tÃ§e planÄ±: â€˜Ä°ÅŸte aradÄ±ÄŸÄ±m insan!â€™",
            "ÃœÃ§ gÃ¼nâ€¦ bu artÄ±k tesadÃ¼f deÄŸil, karakter geliÅŸimi.", "Tasarruf kaslarÄ±n ÅŸiÅŸiyor, devam!", "Hedef tutturan insan aurasÄ±: %100 parlak.", "BÃ¼tÃ§e grafiÄŸi nihayet sakin bir diziye geÃ§ti.", "Bu gidiÅŸle paran seni iÅŸe alacak.",
            "Kontrol sende. Kart bile saygÄ± duyuyor.", "Disiplinin o kadar iyi ki Excel bile alkÄ±ÅŸlÄ±yor.", "Hedef serin â€˜efsaneâ€™ kategorisine gÃ¶z kÄ±rptÄ±.", "ÃœÃ§ gÃ¼n Ã¼st Ã¼ste: â€˜Ben yaparÄ±mâ€™ kanÄ±tÄ±.", "BÃ¼tÃ§enin direksiyonunda sen varsÄ±n. Korna Ã§alma, ilerle.",
            "Finansal zen: harcama dÃ¼rtÃ¼sÃ¼ sakinleÅŸtirildi.", "BugÃ¼n de tutturduysan, artÄ±k â€˜alÄ±ÅŸkanlÄ±kâ€™ oldu bu.", "CÃ¼zdanÄ±n hafiflediÄŸi iÃ§in deÄŸilâ€”rahatladÄ±ÄŸÄ± iÃ§in.", "Streak bozulmasÄ±n diye cÃ¼zdana nazar boncuÄŸu takÄ±yorum.", "Tebrikler: â€˜Hedef TutarlÄ± Ä°nsanâ€™ rozeti sende."
        ];

        let db, auth, currentUser = null;
        let currentPlanId = null; 
        let currentUserRole = 'owner';
        let isFirebaseReady = false;
        let isRegistering = false; 
        let assetsChartInstance = null;
        let expensesChartInstance = null;
        let adviceInterval = null;
        window.userInvites = [];
        window.currentHistoryDateIndex = 0;
        let currentExpenseDateOffset = 0;

        const defaultState = {
            step: 1, salaryDay: 15,
            registrationDate: new Date().toISOString(),
            incomes: [{ name: 'MaaÅŸ', val: null }], 
            bills: [
                { name: 'Kira', val: null }, { name: 'Aidat', val: null }, { name: 'Elektrik', val: null },
                { name: 'Su', val: null }, { name: 'DoÄŸalgaz', val: null }, { name: 'Ä°nternet', val: null },
                { name: 'Telefon', val: null }, { name: 'Bireysel Emeklilik (AylÄ±k)', val: null }
            ], 
            loans: [], debts: [], 
            otherDebts: [{ name: 'KMH / Avans Hesap (- Bakiye)', val: null }], 
            assets: [
                { name: 'Bankadaki Para', val: null }, { name: 'Cepteki Para', val: null }, { name: 'Bireysel Emeklilik (Toplam)', val: null }
            ],
            categories: ["Market / Manav", "Kasap", "AkaryakÄ±t", "Eczane / SaÄŸlÄ±k", "EÄŸlence", "EÄŸitim Ã–demeleri", "Vergi / HarÃ§ / Sigorta", "DiÄŸer"],
            manualDailyLimit: null, expenses: [], monthlyHistory: [], familyMembers: [], inviteCode: null
        };
        let state = JSON.parse(JSON.stringify(defaultState));

        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            isFirebaseReady = true;
            
            auth.onAuthStateChanged(async user => {
                if (user) {
                    currentUser = user;
                    const name = user.displayName || user.email.split('@')[0];
                    document.getElementById('dashWelcome').innerText = `HoÅŸgeldin, ${name}`;
                    
                    try {
                        const userDoc = await db.collection("users").doc(user.uid).get();
                        if(userDoc.exists && userDoc.data().pendingInvites) {
                            window.userInvites = userDoc.data().pendingInvites;
                        }
                    } catch(e) {}
                    
                    await initUserPlan(); 
                    startAdviceRotator();
                } else {
                    currentUser = null;
                    clearInterval(adviceInterval);
                    showLoginScreen();
                }
            });
        } catch(e) { console.error("Firebase Init Error:", e); }

        function hideAll() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('wizardScreen').classList.add('hidden');
            document.getElementById('dashboardScreen').classList.add('hidden');
            document.getElementById('analysisScreen').classList.add('hidden');
        }

        function showLoginScreen() { hideAll(); document.getElementById('loginScreen').classList.remove('hidden'); }
        function showDashboard() { hideAll(); document.getElementById('dashboardScreen').classList.remove('hidden'); updateDashboardUI(); }
        function showAnalysisScreen() { 
            hideAll(); 
            document.getElementById('analysisScreen').classList.remove('hidden'); 
            
            // Set default date for analysis filter to current month
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            document.getElementById('analysisDateFilter').value = `${yyyy}-${mm}`;
            
            renderCharts(); 
        }

        function startAdviceRotator() {
            // Rotator yerine Gamification sistemi Ã§alÄ±ÅŸacak
        }

        function getRandomMessage(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

        function checkGamificationStatus() {
            const todayStr = new Date().toLocaleDateString('tr-TR');
            const dailyLimit = state.manualDailyLimit || 0;
            const spentToday = state.expenses.filter(e => e.date === todayStr).reduce((s,e)=>s+e.amount,0);
            
            if (spentToday > dailyLimit && dailyLimit > 0) {
                return getRandomMessage(messages_highSpend);
            }

            let streak = 0;
            const now = new Date();
            for (let i = 1; i < 30; i++) {
                const d = new Date(); d.setDate(now.getDate() - i);
                const dStr = d.toLocaleDateString('tr-TR');
                const spentThatDay = state.expenses.filter(e => e.date === dStr).reduce((s,e)=>s+e.amount,0);
                if (spentThatDay <= dailyLimit) streak++;
                else break; 
            }
            if (streak >= 3) return getRandomMessage(messages_streak);

            const nowTime = new Date();
            let startCalc = new Date(state.registrationDate);
            if(isNaN(startCalc.getTime())) startCalc = new Date();
            
            if (state.expenses.length > 0) {
                let minExpDate = new Date();
                state.expenses.forEach(e => {
                    let dParts = e.date.split('.');
                    if(dParts.length === 3) {
                        let d = new Date(dParts[2], dParts[1]-1, dParts[0]);
                        if (d < minExpDate) minExpDate = d;
                    }
                });
                
                if (minExpDate.getTime() < startCalc.getTime() - (1000 * 60 * 60 * 24)) {
                    const salaryDay = state.salaryDay || 15;
                    let lastSalaryDate = new Date(nowTime.getFullYear(), nowTime.getMonth(), salaryDay);
                    if (nowTime.getDate() < salaryDay) {
                        lastSalaryDate.setMonth(lastSalaryDate.getMonth() - 1);
                    }
                    startCalc = lastSalaryDate;
                }
            }

            const daysPassed = Math.max(1, Math.ceil(Math.abs(nowTime - startCalc) / (1000 * 60 * 60 * 24)));
            const totalSpent = state.expenses.reduce((s,e)=>s+e.amount,0);
            const cumulative = (dailyLimit * daysPassed) - totalSpent;
            
            if (cumulative < -(dailyLimit * 2)) {
                return getRandomMessage(messages_lowSavings);
            }

            return "Finansal yolculuÄŸunda baÅŸarÄ±lar dilerim! ðŸš€";
        }

        async function initUserPlan() {
            if (!currentUser) return;
            try {
                currentPlanId = currentUser.uid;
                currentUserRole = 'owner';
                
                const userDoc = await db.collection("users").doc(currentUser.uid).get();
                if(!userDoc.exists) {
                    await saveToCloud();
                } else {
                    const userData = userDoc.data();
                    if (userData.connectedPlanId) {
                        currentPlanId = userData.connectedPlanId;
                        if(currentPlanId !== currentUser.uid) {
                            const planDoc = await db.collection("users").doc(currentPlanId).get();
                            if(planDoc.exists) {
                                const planData = planDoc.data();
                                const member = planData.familyMembers ? planData.familyMembers.find(m => m.uid === currentUser.uid) : null;
                                currentUserRole = member ? member.role : 'limited';
                            } else {
                                currentPlanId = currentUser.uid;
                                currentUserRole = 'owner';
                                await db.collection("users").doc(currentUser.uid).update({ connectedPlanId: null });
                            }
                        }
                    }
                }
                loadFromCloud();
            } catch (e) { console.error("Plan Error:", e); }
        }

        function showLoginMode() {
            document.getElementById('loginTitle').innerText = "GiriÅŸ Yap";
            document.getElementById('loginSubtitle').innerText = "HesabÄ±na EriÅŸ";
            document.getElementById('loginBtn').classList.remove('hidden');
            document.getElementById('registerBtn').classList.add('hidden');
            document.getElementById('registerFields').classList.add('hidden');
            document.getElementById('regDailyLimit').classList.add('hidden');
            document.getElementById('emailInput').placeholder = "E-posta veya KullanÄ±cÄ± AdÄ±";
            document.getElementById('actionButtons').classList.remove('hidden');
            document.getElementById('backToLoginText').classList.add('hidden');
            document.getElementById('forgotPassText').classList.remove('hidden');
        }

        function showRegisterMode() {
            document.getElementById('loginTitle').innerText = "Ailene KatÄ±l";
            document.getElementById('loginSubtitle').innerText = "Davet Kodu Ä°le BaÄŸlan";
            document.getElementById('loginBtn').classList.add('hidden');
            document.getElementById('registerBtn').classList.remove('hidden');
            document.getElementById('registerFields').classList.remove('hidden');
            document.getElementById('regInviteCode').classList.remove('hidden');
            document.getElementById('regDailyLimit').classList.add('hidden');
            document.getElementById('emailInput').placeholder = "E-posta Adresi";
            document.getElementById('actionButtons').classList.add('hidden');
            document.getElementById('backToLoginText').classList.remove('hidden');
            document.getElementById('forgotPassText').classList.add('hidden');
        }

        function showQuickRegisterMode() {
            document.getElementById('loginTitle').innerText = "HÄ±zlÄ± BaÅŸlangÄ±Ã§";
            document.getElementById('loginSubtitle').innerText = "Sadece GÃ¼nlÃ¼k Harcama Takibi";
            document.getElementById('loginBtn').classList.add('hidden');
            document.getElementById('registerBtn').classList.remove('hidden');
            document.getElementById('registerFields').classList.remove('hidden');
            document.getElementById('regInviteCode').classList.add('hidden');
            document.getElementById('regDailyLimit').classList.remove('hidden');
            document.getElementById('emailInput').placeholder = "E-posta Adresi";
            document.getElementById('actionButtons').classList.add('hidden');
            document.getElementById('backToLoginText').classList.remove('hidden');
            document.getElementById('forgotPassText').classList.add('hidden');
        }

        async function firebaseLogin() {
            if(!isFirebaseReady) return;
            const emailInp = document.getElementById('emailInput').value.trim();
            const pass = document.getElementById('passwordInput').value;
            if(!emailInp || !pass) return alert("AlanlarÄ± doldurun.");
            const btn = document.getElementById('loginBtn');
            const orig = btn.innerHTML; btn.innerHTML = '<div class="loader"></div>';
            
            try {
                let email = emailInp;
                if (!email.includes('@')) {
                    const s = await db.collection('users').where('username', '==', email.toLowerCase()).limit(1).get();
                    if (s.empty) {
                        alert("KullanÄ±cÄ± adÄ± bulunamadÄ±. LÃ¼tfen e-posta adresinizi deneyin veya kontrol edin.");
                        btn.innerHTML = orig;
                        return;
                    }
                    email = s.docs[0].data().email;
                }
                await auth.signInWithEmailAndPassword(email, pass);
            } catch (e) { alert("Hata: " + e.message); btn.innerHTML = orig; }
        }

        async function firebaseRegister() {
            if(!isFirebaseReady) return;
            const user = document.getElementById('regUsernameInput').value.trim().toLowerCase();
            const email = document.getElementById('emailInput').value.trim();
            const pass = document.getElementById('passwordInput').value;
            const invite = document.getElementById('regInviteCode').value.trim().toUpperCase();
            
            const isQuickMode = !document.getElementById('regDailyLimit').classList.contains('hidden');
            const dailyLimitVal = parseFloat(document.getElementById('regDailyLimit').value);

            if(!email.includes('@') || !user || !pass) return alert("AlanlarÄ± doÄŸru doldurun.");
            if(isQuickMode && (!dailyLimitVal || dailyLimitVal <= 0)) return alert("LÃ¼tfen gÃ¼nlÃ¼k harcama hedefinizi girin.");
            
            const btn = document.getElementById('registerBtn');
            btn.innerHTML = '<div class="loader"></div> LÃ¼tfen Bekleyin...';
            isRegistering = true;
            
            try {
                const cred = await auth.createUserWithEmailAndPassword(email, pass);
                await cred.user.updateProfile({ displayName: user });

                const initState = JSON.parse(JSON.stringify(state)); 
                initState.email = email; initState.username = user;
                if(initState.registrationDate instanceof Date) initState.registrationDate = initState.registrationDate.toISOString();

                if (isQuickMode) {
                    initState.manualDailyLimit = dailyLimitVal;
                    initState.calculatedMonthlyPool = dailyLimitVal * 30;
                    initState.remainingAfterFixed = dailyLimitVal * 30;
                    initState.incomes = [{ name: 'Sanal BÃ¼tÃ§e (HÄ±zlÄ± BaÅŸlangÄ±Ã§)', val: dailyLimitVal * 30 }];
                } else if (invite) {
                    const snap = await db.collection('users').where('inviteCode', '==', invite).get();
                    if (!snap.empty) {
                        const owner = snap.docs[0];
                        initState.connectedPlanId = owner.id;
                        let members = owner.data().familyMembers || [];
                        members.push({ uid: cred.user.uid, name: user, role: 'full' });
                        await db.collection('users').doc(owner.id).update({ familyMembers: members });
                        alert("Davet kodunuz doÄŸrulandÄ±, plana eklendiniz.");
                    } else alert("GeÃ§ersiz davet kodu, kendi yeni planÄ±nÄ±z oluÅŸturuldu.");
                }

                await db.collection("users").doc(cred.user.uid).set(initState);
                isRegistering = false; 

                currentUser = cred.user;
                const userDoc = await db.collection("users").doc(cred.user.uid).get();
                if(userDoc.exists && userDoc.data().pendingInvites) window.userInvites = userDoc.data().pendingInvites;
                await initUserPlan();

            } catch (e) { isRegistering = false; alert("Hata: " + e.message); btn.innerHTML = "Ãœye Ol ve KatÄ±l"; }
        }

        function registerFromWizard() {
            const u = document.getElementById('wizRegName').value.trim();
            const e = document.getElementById('wizRegEmail').value.trim();
            const p = document.getElementById('wizRegPass').value;
            if(!u || !e || !p) return alert("TÃ¼m alanlarÄ± doldurun.");
            document.getElementById('regUsernameInput').value = u;
            document.getElementById('emailInput').value = e;
            document.getElementById('passwordInput').value = p;
            document.getElementById('regInviteCode').value = ""; 
            firebaseRegister();
        }

        function forgotPassword() {
            const email = document.getElementById('emailInput').value.trim();
            if (!email || !email.includes('@')) return alert("LÃ¼tfen geÃ§erli bir e-posta giriniz.");
            auth.sendPasswordResetEmail(email).then(() => alert("BaÄŸlantÄ± gÃ¶nderildi.")).catch(e => alert(e.message));
        }

        function handleLogout() {
            if(auth.currentUser) auth.signOut().then(() => window.location.reload());
            else window.location.reload();
        }

        // --- AYARLAR MODALI ---
        function showSettingsModal() {
            if(currentUserRole === 'owner') {
                document.getElementById('settingsCurrentPlanLabel').innerText = "Kendi PlanÄ±nÄ±z (YÃ¶netici)";
                document.getElementById('btnLeavePlan').classList.add('hidden');
            } else {
                document.getElementById('settingsCurrentPlanLabel').innerText = "Ortak Plan (Davetli Ãœye)";
                document.getElementById('btnLeavePlan').classList.remove('hidden');
            }
            document.getElementById('settingsInviteCode').value = '';
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('overlay').classList.add('active');
        }
        function closeSettingsModal() { document.getElementById('settingsModal').classList.add('hidden'); document.getElementById('overlay').classList.remove('active'); }
        
        async function joinPlanByCode() {
            const code = document.getElementById('settingsInviteCode').value.trim().toUpperCase();
            if(!code) return;
            const snap = await db.collection('users').where('inviteCode', '==', code).get();
            if(snap.empty) return alert("GeÃ§ersiz davet kodu!");
            const ownerDoc = snap.docs[0];
            if(ownerDoc.id === currentUser.uid) return alert("Kendi planÄ±nÄ±za katÄ±lamazsÄ±nÄ±z.");
            
            let members = ownerDoc.data().familyMembers || [];
            members = members.filter(m => m.uid !== currentUser.uid);
            members.push({ uid: currentUser.uid, name: currentUser.displayName || currentUser.email.split('@')[0], role: 'full' });
            await db.collection('users').doc(ownerDoc.id).update({ familyMembers: members });
            await db.collection('users').doc(currentUser.uid).update({ connectedPlanId: ownerDoc.id });
            
            alert("Plana baÅŸarÄ±yla katÄ±ldÄ±nÄ±z!"); window.location.reload();
        }
        async function leaveCurrentPlan() {
            if(!confirm("Mevcut plandan ayrÄ±lmak istediÄŸinize emin misiniz?")) return;
            const ownerDoc = await db.collection('users').doc(currentPlanId).get();
            if(ownerDoc.exists) {
                let members = ownerDoc.data().familyMembers || [];
                members = members.filter(m => m.uid !== currentUser.uid);
                await db.collection('users').doc(currentPlanId).update({ familyMembers: members });
            }
            await db.collection('users').doc(currentUser.uid).update({ connectedPlanId: null });
            alert("Plandan ayrÄ±ldÄ±nÄ±z."); window.location.reload();
        }

        // --- AÄ°LE YÃ–NETÄ°MÄ° & DAVET SÄ°STEMÄ° ---
        function createInviteCode() {
            if(currentUserRole !== 'owner' && currentUserRole !== 'full') return alert("Yetkiniz yok.");
            const code = Math.random().toString(36).substring(2, 7).toUpperCase();
            state.inviteCode = code; saveToCloud();
            document.getElementById('displayInviteCode').innerText = code;
        }

        async function addFamilyMember() {
            if(currentUserRole !== 'owner' && currentUserRole !== 'full') return alert("Yetkiniz yok.");
            const input = document.getElementById('famInput').value.trim().toLowerCase();
            const role = document.getElementById('famRole').value;
            if(!input) return;

            let snap = await db.collection('users').where('username', '==', input).limit(1).get();
            if(snap.empty) snap = await db.collection('users').where('email', '==', input).limit(1).get();
            if(snap.empty) return alert("KullanÄ±cÄ± sistemde bulunamadÄ±. LÃ¼tfen kayÄ±tlÄ± olduÄŸuna emin olun.");
            
            const target = snap.docs[0];
            if(target.id === currentUser.uid) return alert("Kendinizi ekleyemezsiniz.");

            // Davet GÃ¶nder
            await db.collection('users').doc(target.id).update({
                pendingInvites: firebase.firestore.FieldValue.arrayUnion({
                    planId: currentUser.uid,
                    planName: currentUser.displayName || currentUser.email.split('@')[0],
                    role: role
                })
            });
            
            document.getElementById('famInput').value = ''; 
            alert(`KullanÄ±cÄ±ya davet gÃ¶nderildi! Sisteme giriÅŸ yaptÄ±klarÄ±nda karÅŸÄ±larÄ±na Ã§Ä±kacaktÄ±r.`);
        }

        async function acceptInvite() {
            if(!window.userInvites || window.userInvites.length === 0) return;
            const invite = window.userInvites[0];
            
            const ownerDoc = await db.collection('users').doc(invite.planId).get();
            if(ownerDoc.exists) {
                let members = ownerDoc.data().familyMembers || [];
                members = members.filter(m => m.uid !== currentUser.uid);
                members.push({ uid: currentUser.uid, name: currentUser.displayName || currentUser.email.split('@')[0], role: invite.role });
                await db.collection('users').doc(invite.planId).update({ familyMembers: members });
            }
            
            await db.collection('users').doc(currentUser.uid).update({
                connectedPlanId: invite.planId,
                pendingInvites: firebase.firestore.FieldValue.arrayRemove(invite)
            });
            window.location.reload();
        }

        async function rejectInvite() {
            if(!window.userInvites || window.userInvites.length === 0) return;
            const invite = window.userInvites[0];
            await db.collection('users').doc(currentUser.uid).update({
                pendingInvites: firebase.firestore.FieldValue.arrayRemove(invite)
            });
            window.userInvites.shift();
            updateDashboardUI();
        }

        function renderFamilyList() {
            const list = document.getElementById('familyList');
            if(!state.familyMembers || state.familyMembers.length === 0) {
                list.innerHTML = '<p class="text-gray-400 text-[10px] text-center py-2">HenÃ¼z Ã¼ye yok.</p>'; return;
            }
            
            const canEdit = currentUserRole === 'owner';
            list.innerHTML = state.familyMembers.map((m, i) => `
                <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg text-xs">
                    <p class="font-bold text-gray-800">${m.name}</p>
                    <div class="flex items-center gap-2">
                        ${canEdit ? `
                        <select onchange="changeFamilyRole(${i}, this.value)" class="text-[10px] text-blue-600 font-bold bg-transparent outline-none cursor-pointer">
                            <option value="full" ${m.role==='full'?'selected':''}>Tam Yetki</option>
                            <option value="limited" ${m.role==='limited'?'selected':''}>SÄ±nÄ±rlÄ±</option>
                        </select>
                        <button onclick="removeFamilyMember(${i})" class="text-red-400 hover:text-red-600 ml-1"><i class="fas fa-trash"></i></button>
                        ` : `
                        <span class="text-[10px] text-blue-500 font-bold">${m.role === 'full' ? 'Tam' : 'SÄ±nÄ±rlÄ±'}</span>
                        `}
                    </div>
                </div>`).join('');
        }
        
        function changeFamilyRole(idx, newRole) { state.familyMembers[idx].role = newRole; saveToCloud(); }

        async function removeFamilyMember(idx) {
             const m = state.familyMembers[idx];
             if(confirm(`${m.name} plandan Ã§Ä±karÄ±lacak?`)) {
                 await db.collection('users').doc(m.uid).update({ connectedPlanId: null });
                 state.familyMembers.splice(idx, 1);
                 saveToCloud(); renderFamilyList();
             }
        }

        // --- BULUT Ä°ÅžLEMLERÄ° ---
        function loadFromCloud() {
            if(!currentUser || !currentPlanId) return;
            db.collection("users").doc(currentPlanId).get().then((doc) => {
                if (doc.exists) {
                    state = doc.data();
                    if(!state.incomes) state.incomes = [];
                    if(!state.bills) state.bills = [];
                    if(!state.loans) state.loans = [];
                    if(!state.debts) state.debts = [];
                    if(!state.otherDebts) state.otherDebts = [];
                    if(!state.assets) state.assets = [];
                    if(!state.expenses) state.expenses = [];
                    if(!state.monthlyHistory) state.monthlyHistory = [];
                    if(!state.familyMembers) state.familyMembers = [];
                    
                    // Kategori verisi yoksa default ile baÅŸlat
                    if(!state.categories || state.categories.length === 0) {
                        state.categories = ["Market / Manav", "Kasap", "AkaryakÄ±t", "Eczane / SaÄŸlÄ±k", "EÄŸlence", "EÄŸitim Ã–demeleri", "Vergi / HarÃ§ / Sigorta", "DiÄŸer"];
                    }
                    
                    showDashboard();
                }
            });
        }

        function saveToCloud() {
            if(!currentUser || !currentPlanId) return Promise.resolve();
            return db.collection("users").doc(currentPlanId).set(JSON.parse(JSON.stringify(state)), { merge: true }).then(() => {
                const ind = document.getElementById('saveIndicator');
                ind.style.opacity = '1'; setTimeout(() => ind.style.opacity = '0', 2000);
            });
        }
        function saveState() { if(currentUser && !isRegistering) saveToCloud(); }

        // --- DASHBOARD GÃœNCELLEME ---
        function applyPermissions() {
            const lbl = currentUserRole === 'owner' ? 'Plan Sahibi' : currentUserRole === 'full' ? 'Tam Yetki' : 'SÄ±nÄ±rlÄ± Yetki';
            document.getElementById('roleBadge').innerText = lbl;
            
            const dis = (currentUserRole === 'limited');
            document.getElementById('financialHealthSection').classList.toggle('hidden', dis);
            document.getElementById('btnAnalysis').classList.toggle('hidden', dis);
            document.getElementById('familyPanel').classList.toggle('hidden', dis);
            document.getElementById('btnEditPlan').classList.toggle('hidden', dis);
        }

        function updateDashboardUI() {
            applyPermissions();
            
            const inviteBanner = document.getElementById('inviteBanner');
            if (window.userInvites && window.userInvites.length > 0) {
                inviteBanner.classList.remove('hidden');
                document.getElementById('inviteBannerText').innerText = `${window.userInvites[0].planName} sizi planÄ±na davet ediyor.`;
            } else {
                inviteBanner.classList.add('hidden');
            }

            const now = new Date(); const todayStr = now.toLocaleDateString('tr-TR');
            let startCalc = new Date(state.registrationDate);
            if(isNaN(startCalc.getTime())) startCalc = new Date();
            
            if (state.expenses.length > 0) {
                let minExpDate = new Date();
                state.expenses.forEach(e => {
                    let dParts = e.date.split('.');
                    if(dParts.length === 3) {
                        let d = new Date(dParts[2], dParts[1]-1, dParts[0]);
                        if (d < minExpDate) minExpDate = d;
                    }
                });
                
                if (minExpDate.getTime() < startCalc.getTime() - (1000 * 60 * 60 * 24)) {
                    const salaryDay = state.salaryDay || 15;
                    let lastSalaryDate = new Date(now.getFullYear(), now.getMonth(), salaryDay);
                    if (now.getDate() < salaryDay) {
                        lastSalaryDate.setMonth(lastSalaryDate.getMonth() - 1);
                    }
                    startCalc = lastSalaryDate;
                }
            }
            
            const daysPassed = Math.max(1, Math.ceil(Math.abs(now - startCalc) / (1000 * 60 * 60 * 24))); 
            
            const spentToday = state.expenses.filter(e => e.date === todayStr).reduce((s,e)=>s+e.amount,0);
            const totalSpent = state.expenses.reduce((s,e)=>s+e.amount,0);
            const cumulative = ((state.manualDailyLimit||0) * daysPassed) - totalSpent;
            
            document.getElementById('displayDailyLimit').innerText = `â‚º${Math.floor((state.manualDailyLimit||0) - spentToday).toLocaleString()}`;
            const cumEl = document.getElementById('displayCumulativeLimit');
            cumEl.innerText = `â‚º${Math.floor(cumulative).toLocaleString()}`;
            
            // Efekt KontrolÃ¼
            cumEl.classList.remove('animate-pulse-red', 'animate-pulse-green');
            if (cumulative < 0) cumEl.classList.add('animate-pulse-red');
            else if (cumulative > (state.manualDailyLimit||0)) cumEl.classList.add('animate-pulse-green');

            document.getElementById('todayTotal').innerText = `BugÃ¼n: â‚º${Math.floor(spentToday).toLocaleString()}`;
            
            let targetDate = new Date(now.getFullYear(), now.getMonth(), state.salaryDay||15);
            if (now.getDate() >= (state.salaryDay||15)) targetDate.setMonth(targetDate.getMonth()+1);
            document.getElementById('displayRemainingDays').innerText = `${Math.ceil((targetDate - now)/(1000*60*60*24))} GÃ¼n`;

            const assets = state.assets.filter(a => !a.excludeFromNetWorth).reduce((s,a)=>s+(a.val||0),0);
            const loans = state.loans.filter(l=>!l.excludeFromDebt).reduce((s,l)=>s+(l.totalDebt||0),0);
            const cards = state.debts.filter(d => !d.excludeFromNetWorth).reduce((s,d)=>s+(d.val||0),0);
            const others = state.otherDebts.filter(d => !d.excludeFromNetWorth).reduce((s,d)=>s+(d.val||0),0);
            const totalDebt = loans + cards + others;
            const net = assets - totalDebt;
            
            const daysInCurrentMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            const normalBills = state.bills.reduce((s, b) => s + (b.val||0), 0);
            const loansTreatedAsBills = state.loans.filter(l => l.excludeFromDebt && !l.excludeFromBudget).reduce((s, l) => s + (l.monthly || 0), 0);
            const standardLoans = state.loans.filter(l => !l.excludeFromDebt && !l.excludeFromBudget).reduce((s, l) => s + (l.monthly || 0), 0);
            const totalFix = normalBills + loansTreatedAsBills;
            const totalInc = state.incomes.reduce((s, i) => s + (i.val||0), 0);
            
            const grossNet = totalInc - totalFix; 
            const realNet = grossNet - standardLoans;
            let monthlySpend = (state.manualDailyLimit || 0) * daysInCurrentMonth;
            
            const calcSavings = Math.max(0, realNet - monthlySpend);
            const totalMonthlyOutflow = totalFix + standardLoans;

            document.getElementById('sumSavings').innerText = `â‚º${Math.floor(calcSavings).toLocaleString()}`;
            document.getElementById('sumGiderTotalHealth').innerText = `â‚º${Math.floor(totalMonthlyOutflow).toLocaleString()}`;
            document.getElementById('netStatusVal').innerText = `${net>=0?'+':'-'}â‚º${Math.abs(Math.floor(net)).toLocaleString()}`;
            document.getElementById('netStatusBadge').className = `text-4xl font-black px-8 py-4 rounded-[2rem] ${net>=0?'text-green-600 bg-green-50':'text-red-600 bg-red-50'}`;

            document.getElementById('displayInviteCode').innerText = state.inviteCode || '-----';
            
            const motivationalMsg = checkGamificationStatus();
            document.getElementById('motivationText').innerText = motivationalMsg;
            document.getElementById('motivationArea').classList.remove('hidden');

            renderFamilyList();
            renderDetailedHealthLists();
            
            window.currentHistoryDateIndex = 0; 
            renderHistoryList();
            
            updateExpenseDateLabel();
            renderCategoryOptions(); // Ensure categories are rendered
        }

        // --- TARÄ°H NAVÄ°GASYON MANTIÄžI ---
        function changeExpenseDate(delta) {
            // Delta 1 -> SaÄŸ Buton -> BugÃ¼ne gel -> Offset azalmalÄ±
            // Delta -1 -> Sol Buton -> GeÃ§miÅŸe git -> Offset artmalÄ±
            // TALEBE GÃ–RE: Sol eski tarihe gÃ¶tÃ¼rmeli, yani offset artmalÄ±.
            // Bu durumda: Sol buton (-1 parametreli) -> Offset ARTAR.
            // SaÄŸ buton (+1 parametreli) -> Offset AZALIR.
            
            if (delta === -1) {
                currentExpenseDateOffset += 1;
            } else {
                currentExpenseDateOffset -= 1;
            }
            
            if (currentExpenseDateOffset < 0) currentExpenseDateOffset = 0;
            updateExpenseDateLabel();
        }

        function updateExpenseDateLabel() {
            const lbl = document.getElementById('expenseDateLabel');
            const d = new Date();
            d.setDate(d.getDate() - currentExpenseDateOffset);
            
            const options = { day: 'numeric', month: 'long', weekday: 'long' };
            const formattedDate = d.toLocaleDateString('tr-TR', options);
            
            if (currentExpenseDateOffset === 0) {
                lbl.innerText = `BugÃ¼n (${formattedDate})`;
            } else if (currentExpenseDateOffset === 1) {
                lbl.innerText = `DÃ¼n (${formattedDate})`;
            } else {
                lbl.innerText = `${currentExpenseDateOffset} GÃ¼n Ã–nce (${formattedDate})`;
            }
            
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            document.getElementById('expDateInputHidden').value = `${yyyy}-${mm}-${dd}`;
        }
        
        function setSpecificDate(val) {
            if (!val) return;
            const selected = new Date(val);
            const today = new Date();
            selected.setHours(0,0,0,0);
            today.setHours(0,0,0,0);
            
            const diffTime = today - selected;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            
            if (diffDays >= 0) {
                currentExpenseDateOffset = diffDays;
                updateExpenseDateLabel();
            } else {
                alert("GeleceÄŸe harcama giremezsiniz!");
                currentExpenseDateOffset = 0;
                updateExpenseDateLabel();
            }
        }

        // --- KATEGORÄ° YÃ–NETÄ°MÄ° ---
        function renderCategoryOptions() {
            const sel = document.getElementById('expCat');
            // Check if categories exist in state, if not use defaults
            if (!state.categories) {
                state.categories = ["Market / Manav", "Kasap", "AkaryakÄ±t", "Eczane / SaÄŸlÄ±k", "EÄŸlence", "EÄŸitim Ã–demeleri", "Vergi / HarÃ§ / Sigorta", "DiÄŸer"];
            }
            
            sel.innerHTML = state.categories.map(c => `<option value="${c}">${c}</option>`).join('');
            
            // Render modal list as well
            const list = document.getElementById('categoryList');
            list.innerHTML = state.categories.map((c, i) => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl">
                    <span class="text-sm font-bold text-gray-700">${c}</span>
                    <button onclick="deleteCategory(${i})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');
        }

        function openCategoryModal() {
            renderCategoryOptions();
            const modal = document.getElementById('categoryModal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('open'), 10);
            document.getElementById('overlay').classList.add('active');
        }

        function closeCategoryModal() {
            const modal = document.getElementById('categoryModal');
            modal.classList.remove('open');
            setTimeout(() => modal.classList.add('hidden'), 300);
            document.getElementById('overlay').classList.remove('active');
        }

        function addNewCategory() {
            const inp = document.getElementById('newCatName');
            const val = inp.value.trim();
            if (val && !state.categories.includes(val)) {
                state.categories.push(val);
                inp.value = '';
                saveToCloud();
                renderCategoryOptions();
            }
        }

        function deleteCategory(idx) {
            if (confirm("Bu kategoriyi silmek istediÄŸinize emin misiniz?")) {
                state.categories.splice(idx, 1);
                saveToCloud();
                renderCategoryOptions();
            }
        }

        // --- SATIR Ä°Ã‡Ä° (INLINE) EKLEME SÄ°STEMÄ° ---
        const subTypes = {
            'AltÄ±n': ['Gr. (24 Ayar)', 'Gr & Ajda (22 Ayar)', 'Ã‡eyrek', 'YarÄ±m', 'Tam'],
            'DÃ¶viz': ['Dolar', 'Euro', 'GBP', 'Ä°sviÃ§re FrangÄ±'],
            'GÃ¼mÃ¼ÅŸ': ['GÃ¼mÃ¼ÅŸ']
        };

        function toggleInlineAdd(prefix) {
            const container = document.getElementById(`inlineAdd${prefix}Container`);
            const btn = document.getElementById(`btnShow${prefix}Form`);
            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                btn.classList.add('hidden');
                
                if (prefix === 'dashDebt' || prefix === 'wiz_debt') document.getElementById(`${prefix}Type`).value = 'Kredi';
                if (prefix === 'dashAsset' || prefix === 'wiz_asset') document.getElementById(`${prefix}Type`).value = 'DiÄŸer';
                if (prefix === 'wiz_loan') document.getElementById(`${prefix}Type`).value = 'Kredi';
                if (prefix === 'wiz_card') document.getElementById(`${prefix}Type`).value = 'Kredi KartÄ±';
                
                handleInlineTypeChange(prefix);
            }
        }

        function cancelInlineAdd(prefix) {
            document.getElementById(`inlineAdd${prefix}Container`).classList.add('hidden');
            document.getElementById(`btnShow${prefix}Form`).classList.remove('hidden');
        }

        function handleInlineTypeChange(prefix) {
            const typeEl = document.getElementById(`${prefix}Type`);
            const type = typeEl ? typeEl.value : 'DiÄŸer';
            const fieldsDiv = document.getElementById(`${prefix}Fields`);
            if(!fieldsDiv) return;
            
            const cmnCls = "w-full p-2.5 bg-white rounded-lg text-xs font-bold border border-gray-200 outline-none focus:ring-2 focus:ring-blue-100";
            
            let html = '';
            if (type === 'Kredi') {
                html = `<input type="text" id="${prefix}_name" placeholder="Kredi AdÄ±" class="${cmnCls} mb-2">
                        <div class="flex gap-2 mb-2">
                            <input type="number" id="${prefix}_monthly" placeholder="AylÄ±k Taksit" class="${cmnCls} w-1/2" oninput="calcInlineLoan('${prefix}')">
                            <input type="number" id="${prefix}_months" placeholder="Kalan Ay" class="${cmnCls} w-1/2" oninput="calcInlineLoan('${prefix}')">
                        </div>
                        <div class="mb-2">
                            <label class="text-[9px] font-bold text-gray-400 uppercase">SÄ±radaki Taksit Tarihi</label>
                            <input type="date" id="${prefix}_date" class="${cmnCls}">
                        </div>
                        <input type="number" id="${prefix}_total" placeholder="Toplam BorÃ§" class="${cmnCls}">`;
            } else if (type === 'Kredi KartÄ±') {
                html = `<input type="text" id="${prefix}_name" placeholder="Kart AdÄ± (Ã–rn: Bonus)" class="${cmnCls} mb-2">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Hesaplama Modu</span>
                            <select id="${prefix}_cc_mode" onchange="toggleInlineCCMode('${prefix}')" class="p-1 bg-blue-50 text-blue-600 rounded text-xs font-bold outline-none border border-blue-100">
                                <option value="manual">Direkt BorÃ§ Gir</option>
                                <option value="limit">Limit - KullanÄ±labilir</option>
                            </select>
                        </div>
                        <div id="${prefix}_cc_manual_div">
                            <input type="number" id="${prefix}_total" placeholder="GÃ¼ncel BorÃ§ (TL)" class="${cmnCls}">
                        </div>
                        <div id="${prefix}_cc_limit_div" class="hidden space-y-2">
                            <div class="flex gap-2">
                                <input type="number" id="${prefix}_cc_limit" placeholder="Kart Limiti" class="${cmnCls} w-1/2" oninput="calcInlineCC('${prefix}')">
                                <input type="number" id="${prefix}_cc_avail" placeholder="KullanÄ±labilir" class="${cmnCls} w-1/2" oninput="calcInlineCC('${prefix}')">
                            </div>
                            <div class="text-right text-xs font-bold text-gray-500">Hesaplanan: <span id="${prefix}_cc_debt_display" class="text-purple-600">0</span> TL</div>
                            <input type="hidden" id="${prefix}_cc_calc_total" value="0">
                        </div>`;
            } else if (type === 'DiÄŸer') {
                html = `<input type="text" id="${prefix}_name" placeholder="Kalem AdÄ±" class="${cmnCls} mb-2">
                        <input type="number" id="${prefix}_total" placeholder="Tutar (TL)" class="${cmnCls}">`;
            } else {
                const options = subTypes[type].map(s => `<option value="${s}">${s}</option>`).join('');
                html = `<select id="${prefix}_sub" class="${cmnCls} mb-2" onchange="fetchInlineRate('${prefix}', '${type}')">${options}</select>
                        <input type="text" id="${prefix}_name" placeholder="Ã–zel Ä°sim (Opsiyonel)" class="${cmnCls} mb-2">
                        <div class="flex gap-2 mb-2">
                            <input type="number" id="${prefix}_amount" placeholder="Miktar (Adet/Gr)" class="${cmnCls} w-1/2" oninput="calcInlineMarket('${prefix}')">
                            <input type="number" step="any" id="${prefix}_rate" placeholder="Birim Kur" class="${cmnCls} w-1/2 border-blue-200" title="Kur" oninput="calcInlineMarket('${prefix}')">
                        </div>
                        <div class="mb-2">
                            <label class="text-[9px] font-bold text-gray-400 uppercase block mb-1">Veya Direkt Toplam Tutar Girin (TL)</label>
                            <input type="number" id="${prefix}_total" placeholder="Toplam Tutar (TL)" class="${cmnCls} border-green-200">
                        </div>`;
                setTimeout(() => fetchInlineRate(prefix, type), 50);
            }
            fieldsDiv.innerHTML = html;
        }

        function toggleInlineCCMode(prefix) {
            const mode = document.getElementById(`${prefix}_cc_mode`).value;
            const manDiv = document.getElementById(`${prefix}_cc_manual_div`);
            const limDiv = document.getElementById(`${prefix}_cc_limit_div`);
            if (mode === 'limit') { manDiv.classList.add('hidden'); limDiv.classList.remove('hidden'); } 
            else { limDiv.classList.add('hidden'); manDiv.classList.remove('hidden'); }
        }

        function calcInlineCC(prefix) {
            const limit = parseFloat(document.getElementById(`${prefix}_cc_limit`).value) || 0;
            const avail = parseFloat(document.getElementById(`${prefix}_cc_avail`).value) || 0;
            const debt = Math.max(0, limit - avail);
            document.getElementById(`${prefix}_cc_calc_total`).value = debt;
            document.getElementById(`${prefix}_cc_debt_display`).innerText = debt.toLocaleString(undefined, {maximumFractionDigits:2});
        }

        function calcInlineLoan(prefix) {
            const monthly = parseFloat(document.getElementById(`${prefix}_monthly`).value) || 0;
            const months = parseFloat(document.getElementById(`${prefix}_months`).value) || 0;
            document.getElementById(`${prefix}_total`).value = monthly * months;
        }

        function calcInlineMarket(prefix) {
            const amount = parseFloat(document.getElementById(`${prefix}_amount`).value) || 0;
            const rate = parseFloat(document.getElementById(`${prefix}_rate`).value) || 0;
            const totalInput = document.getElementById(`${prefix}_total`);
            if(totalInput && amount > 0 && rate > 0) {
                totalInput.value = (amount * rate).toFixed(2);
            }
        }

        const apiMapping = {
            'Gr. (24 Ayar)': 'Gram AltÄ±n', 'Gr & Ajda (22 Ayar)': '22 Ayar Bilezik', 'Ã‡eyrek': 'Ã‡eyrek AltÄ±n', 'YarÄ±m': 'YarÄ±m AltÄ±n', 'Tam': 'Tam AltÄ±n',
            'Dolar': 'USD', 'Euro': 'EUR', 'GBP': 'GBP', 'Ä°sviÃ§re FrangÄ±': 'CHF', 'GÃ¼mÃ¼ÅŸ': 'GÃ¼mÃ¼ÅŸ'
        };

        async function fetchInlineRate(prefix, mainType) {
            const subInput = document.getElementById(`${prefix}_sub`);
            const sub = subInput ? subInput.value : mainType;
            const rateInput = document.getElementById(`${prefix}_rate`);
            if(!rateInput) return;

            rateInput.placeholder = "Kur Ã§ekiliyor...";
            try {
                const res = await fetch('https://finans.truncgil.com/today.json');
                const data = await res.json();
                let rateData = data[apiMapping[sub]]; 
                if(rateData) {
                    let rateStr = rateData.AlÄ±ÅŸ || rateData.SatÄ±ÅŸ; 
                    let rate = parseFloat(rateStr.toString().replace(/\./g, '').replace(',', '.'));
                    rateInput.value = rate;
                    calcInlineMarket(prefix);
                } else {
                    rateInput.placeholder = "Kur bilgisi bulunamadÄ±";
                }
            } catch(e) { rateInput.placeholder = "Kur alÄ±namadÄ±, elle girin"; }
        }

        function saveInlineAdd(prefix) {
            const typeEl = document.getElementById(`${prefix}Type`);
            const type = typeEl ? typeEl.value : 'DiÄŸer';
            
            let finalVal = 0;
            let finalName = document.getElementById(`${prefix}_name`) ? document.getElementById(`${prefix}_name`).value.trim() : '';

            let targetArray = 'otherDebts';
            if (prefix.includes('Asset') || prefix.includes('asset')) targetArray = 'assets';
            if (type === 'Kredi') targetArray = 'loans';
            if (type === 'Kredi KartÄ±') targetArray = 'debts';

            let itemObj = {};

            if (type === 'Kredi') {
                finalName = finalName || 'Kredi';
                const monthly = parseFloat(document.getElementById(`${prefix}_monthly`).value) || 0;
                const months = parseFloat(document.getElementById(`${prefix}_months`).value) || 0;
                finalVal = parseFloat(document.getElementById(`${prefix}_total`).value) || (monthly * months);
                const lDate = document.getElementById(`${prefix}_date`).value || new Date().toISOString().slice(0,10);
                itemObj = { name: finalName, totalDebt: finalVal, monthly: monthly, totalMonths: months, startDate: lDate, excludeFromBudget: false, excludeFromDebt: false };
            } else if (type === 'Kredi KartÄ±') {
                const mode = document.getElementById(`${prefix}_cc_mode`).value;
                if (mode === 'limit') {
                    let limit = parseFloat(document.getElementById(`${prefix}_cc_limit`).value) || 0;
                    let avail = parseFloat(document.getElementById(`${prefix}_cc_avail`).value) || 0;
                    finalVal = Math.max(0, limit - avail);
                    itemObj = { name: finalName || 'Kredi KartÄ±', val: finalVal, calcMode: true, limit: limit, avail: avail };
                } else {
                    finalVal = parseFloat(document.getElementById(`${prefix}_total`).value) || 0;
                    itemObj = { name: finalName || 'Kredi KartÄ±', val: finalVal, calcMode: false };
                }
            } else if (type === 'DiÄŸer') {
                finalVal = parseFloat(document.getElementById(`${prefix}_total`).value) || 0;
                itemObj = { name: finalName || 'DiÄŸer Kalem', val: finalVal };
            } else {
                const sub = document.getElementById(`${prefix}_sub`).value;
                const amount = parseFloat(document.getElementById(`${prefix}_amount`).value) || 0;
                finalVal = parseFloat(document.getElementById(`${prefix}_total`).value) || 0;
                
                if (!finalName) {
                    finalName = amount > 0 ? `${amount} ${sub}` : `${sub}`;
                }
                itemObj = { name: finalName, val: finalVal };
            }

            state[targetArray].unshift(itemObj); // Listenin baÅŸÄ±na ekle
            saveToCloud();
            
            cancelInlineAdd(prefix);
            if (prefix.startsWith('dash')) updateDashboardUI();
            else renderWizardLists();
        }

        // --- HARCAMA Ä°ÅžLEMLERÄ° ---
        function addExpense() {
            const amtInp = document.getElementById('expAmt');
            const descInp = document.getElementById('expDesc');
            const catInp = document.getElementById('expCat'); // Yeni kategori seÃ§imi
            const editIndex = parseInt(document.getElementById('editExpIndex').value);
            const amt = parseFloat(amtInp.value);
            
            if(!amt) return amtInp.focus();

            const myStr = currentUser?.displayName || currentUser?.email?.split('@')[0] || 'Ben';
            
            // HÄ±zlÄ± Tarih SeÃ§ici DeÄŸerini Kullan
            const d = new Date();
            d.setDate(d.getDate() - currentExpenseDateOffset);
            let finalDate = d.toLocaleDateString('tr-TR');
            
            // Kategori ve AÃ§Ä±klama MantÄ±ÄŸÄ±
            const selectedCat = catInp.value;
            let finalDesc = descInp.value.trim();
            // EÄŸer aÃ§Ä±klama boÅŸsa ve kategori "DiÄŸer" deÄŸilse, aÃ§Ä±klamayÄ± kategori yap
            if (!finalDesc && selectedCat !== 'DiÄŸer') {
                finalDesc = selectedCat;
            } else if (!finalDesc) {
                finalDesc = 'DiÄŸer';
            }

            if(editIndex > -1 && currentUserRole === 'limited') {
                if(state.expenses[editIndex].addedBy !== myStr && state.expenses[editIndex].addedBy !== 'Ben') {
                    return alert("Sadece kendi harcamalarÄ±nÄ±zÄ± dÃ¼zenleyebilirsiniz.");
                }
            }

            if(editIndex > -1) {
                state.expenses[editIndex].amount = amt;
                state.expenses[editIndex].desc = finalDesc;
                state.expenses[editIndex].category = selectedCat; // Kategoriyi gÃ¼ncelle
                
                document.getElementById('editExpIndex').value = "-1";
                document.getElementById('addExpBtn').innerHTML = '<i class="fas fa-plus text-xl"></i>';
                document.getElementById('addExpBtn').classList.replace('bg-green-600', 'bg-blue-600');
            } else {
                state.expenses.unshift({ 
                    amount: amt, 
                    desc: finalDesc,
                    category: selectedCat, // Kategoriyi kaydet
                    date: finalDate, 
                    addedBy: myStr, ts: Date.now()
                });
            }
            
            amtInp.value = ''; descInp.value = ''; 
            currentExpenseDateOffset = 0; 
            updateExpenseDateLabel();
            
            saveToCloud(); updateDashboardUI();
        }
        
        function editExpense(idx) {
            const exp = state.expenses[idx];
            document.getElementById('expAmt').value = exp.amount;
            document.getElementById('expDesc').value = exp.desc;
            // Kategoriyi de yÃ¼kle (eÄŸer varsa)
            const catInp = document.getElementById('expCat');
            if (exp.category) {
                catInp.value = exp.category;
            } else {
                catInp.value = 'DiÄŸer';
            }
            
            document.getElementById('editExpIndex').value = idx;
            document.getElementById('addExpBtn').innerHTML = '<i class="fas fa-check text-xl"></i>';
            document.getElementById('addExpBtn').classList.replace('bg-blue-600', 'bg-green-600');
            document.querySelector('.glass-card').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteExpense(idx) {
            if(confirm("Bu harcamayÄ± silmek istediÄŸinize emin misiniz?")) { 
                state.expenses.splice(idx, 1); saveToCloud(); updateDashboardUI(); 
            }
        }

        function changeHistoryDate(step) {
            window.currentHistoryDateIndex += step;
            renderHistoryList();
        }

        function renderHistoryList() {
            const list = document.getElementById('historyList');
            if(!list) return;
            if(state.expenses.length === 0) { list.innerHTML = '<div class="text-center text-gray-400 text-xs py-4">Harcama yok.</div>'; return; }
            
            const myName = currentUser?.displayName || currentUser?.email?.split('@')[0] || 'Ben';
            
            const sortedExpenses = [...state.expenses].sort((a, b) => b.ts - a.ts);
            const grouped = {};
            sortedExpenses.forEach((e) => {
                const origIdx = state.expenses.indexOf(e);
                if(!grouped[e.date]) grouped[e.date] = [];
                grouped[e.date].push({ ...e, originalIndex: origIdx });
            });

            // Benzersiz ve sÄ±ralÄ± tarihleri Ã§Ä±kar
            const sortedDates = [...new Set(sortedExpenses.map(e => e.date))];

            if (window.currentHistoryDateIndex >= sortedDates.length) window.currentHistoryDateIndex = sortedDates.length - 1;
            if (window.currentHistoryDateIndex < 0) window.currentHistoryDateIndex = 0;

            const currentDate = sortedDates[window.currentHistoryDateIndex];
            const expensesForDate = grouped[currentDate];

            const hasPrev = window.currentHistoryDateIndex > 0; // Index 0 is newest, so > 0 means there are newer dates
            const hasNext = window.currentHistoryDateIndex < sortedDates.length - 1; // Means there are older dates

            let html = `
            <div class="mb-5">
                <div class="flex items-center justify-between gap-4 mb-4 bg-blue-50 p-2 rounded-xl border border-blue-100">
                    <button onclick="changeHistoryDate(1)" class="w-8 h-8 flex items-center justify-center rounded-lg bg-white text-blue-600 shadow-sm hover:bg-blue-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" ${!hasNext ? 'disabled' : ''}><i class="fas fa-chevron-left"></i></button>
                    <div class="text-blue-800 px-3 py-1 rounded-lg text-sm font-black tracking-widest text-center flex-1">${currentDate}</div>
                    <button onclick="changeHistoryDate(-1)" class="w-8 h-8 flex items-center justify-center rounded-lg bg-white text-blue-600 shadow-sm hover:bg-blue-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" ${!hasPrev ? 'disabled' : ''}><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="space-y-2">`;
            
            expensesForDate.forEach(e => {
                const canEdit = currentUserRole === 'owner' || currentUserRole === 'full' || e.addedBy === myName || e.addedBy === 'Ben';
                const initials = e.addedBy.substring(0, 2).toUpperCase();
                html += `
                    <div class="flex justify-between items-center p-3 bg-white border border-gray-100 rounded-xl hover:shadow-md transition-all group">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 font-black text-xs uppercase border border-gray-200">
                                ${initials}
                            </div>
                            <div>
                                <p class="font-black text-gray-800 text-sm">${e.desc}</p>
                                <p class="text-[9px] text-gray-400 font-bold uppercase tracking-wide">
                                    ${e.category && e.category !== 'DiÄŸer' ? `<span class="bg-blue-50 text-blue-600 px-1 rounded mr-1">${e.category}</span>` : ''} 
                                    ${e.addedBy}
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-black text-red-500 text-base">-â‚º${Math.floor(e.amount).toLocaleString()}</span>
                            ${canEdit ? `<div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="editExpense(${e.originalIndex})" class="text-blue-300 hover:text-blue-500"><i class="fas fa-pen"></i></button><button onclick="deleteExpense(${e.originalIndex})" class="text-gray-200 hover:text-red-500"><i class="fas fa-trash-alt"></i></button></div>` : ''}
                        </div>
                    </div>`;
            });
            html += `</div></div>`;
            list.innerHTML = html;
        }

        function renderDetailedHealthLists() { 
            const createRow = (name, amount, type, idx, extraClass='', clickAction='', isExcluded=false) => `
                <div class="flex justify-between items-center p-3 rounded-xl text-xs font-bold text-gray-600 bg-gray-50 border border-gray-100 shadow-sm group ${extraClass} ${isExcluded ? 'opacity-50 grayscale' : ''}" ${clickAction ? `onclick="${clickAction}" style="cursor:pointer"` : ''}>
                    <span>${name}</span>
                    <div class="flex items-center gap-3">
                        <span class="font-black text-gray-800">â‚º${Math.floor(amount).toLocaleString()}</span>
                        <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="event.stopPropagation(); openEditModal('${type}', ${idx})" class="text-blue-400 hover:text-blue-600"><i class="fas fa-pen"></i></button>
                            ${idx !== 'total' ? `<button onclick="event.stopPropagation(); deleteHealthItem('${type}', ${idx})" class="text-red-300 hover:text-red-500"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                    </div>
                </div>`; 
            
            // SABÄ°T GÄ°DERLER (BILLS)
            const activeBills = state.bills.filter(b => b.val > 0);
            const totalBills = activeBills.reduce((s, b) => s + b.val, 0);
            const billsHTML = activeBills.map((b) => createRow(b.name, b.val, 'bills', state.bills.indexOf(b), 'bg-white')).join('');
            const billsAccordion = `
            <div class="border border-blue-100 rounded-2xl overflow-hidden bg-blue-50/50 shadow-sm mb-6">
                <div onclick="document.getElementById('billsDetails').classList.toggle('open');" class="flex justify-between items-center p-4 cursor-pointer hover:bg-blue-100/50 transition-colors">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center"><i class="fas fa-file-invoice-dollar"></i></div>
                        <span class="text-sm font-black text-blue-900 uppercase tracking-wide">AylÄ±k Sabit Giderler</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-black text-blue-900 text-lg">â‚º${totalBills.toLocaleString()}</span>
                        <i class="fas fa-chevron-down text-blue-400"></i>
                    </div>
                </div>
                <div id="billsDetails" class="health-detail space-y-2 px-4 pb-4">
                    ${billsHTML || '<div class="text-xs text-gray-400 text-center py-2">KayÄ±tlÄ± sabit gider yok.</div>'}
                    <button onclick="addNewHealthItem('bills')" class="w-full py-3 text-xs font-bold text-blue-500 hover:text-blue-700 bg-white border border-dashed border-blue-200 rounded-xl transition-colors">+ Yeni Sabit Gider Ekle</button>
                </div>
            </div>`;
            document.getElementById('fixedExpensesSection').innerHTML = billsAccordion;

            // BORÃ‡LAR BÃ–LÃœMÃœ (SIRALAMA: KREDÄ°LER > KARTLAR > DÄ°ÄžER)
            let debtHTML = ''; 
            
            // 1. Krediler (YENÄ° AKORDÄ°YON)
            const activeLoans = state.loans.filter(l => l.totalDebt > 0);
            const totalLoanDebt = activeLoans.reduce((s,l) => s + (l.excludeFromDebt ? 0 : l.totalDebt), 0);
            
            if (activeLoans.length > 0) {
                 const loansHTML = activeLoans.map(l => {
                    const isExcluded = l.excludeFromDebt;
                    return createRow(l.name + (isExcluded ? ' <span class="text-[8px] text-red-400 font-bold ml-1 bg-red-50 px-1 rounded">(Dahil DeÄŸil)</span>' : ''), l.totalDebt, 'loans', state.loans.indexOf(l), 'bg-white', `openLoanPlanModal(${state.loans.indexOf(l)})`, isExcluded);
                 }).join('');

                 debtHTML += `
                 <div class="border border-red-100 rounded-2xl overflow-hidden bg-red-50/50 shadow-sm mb-2">
                    <div onclick="document.getElementById('loanDetails').classList.toggle('open');" class="flex justify-between items-center p-3 cursor-pointer hover:bg-red-100/50 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-red-100 text-red-600 rounded-full flex items-center justify-center"><i class="fas fa-hand-holding-usd"></i></div>
                            <span class="text-xs font-black text-red-900 uppercase tracking-wide">Toplam Kredi Borcu</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-black text-red-900 text-sm">â‚º${totalLoanDebt.toLocaleString()}</span>
                            <i class="fas fa-chevron-down text-red-400"></i>
                        </div>
                    </div>
                    <div id="loanDetails" class="health-detail space-y-2 px-3 pb-3">
                        ${loansHTML}
                    </div>
                </div>`;
            }

            // 2. Kredi KartlarÄ± (AKORDÄ°YON)
            const activeCards = state.debts.filter(d => d.val > 0);
            const totalCardDebt = activeCards.reduce((s,d) => s + (d.excludeFromNetWorth ? 0 : d.val), 0);
            
            if (activeCards.length > 0) {
                 const cardsHTML = activeCards.map(d => createRow(d.name + (d.excludeFromNetWorth ? ' <span class="text-[8px] text-red-400 font-bold ml-1 bg-red-50 px-1 rounded">(Dahil DeÄŸil)</span>' : ''), d.val, 'debts', state.debts.indexOf(d), 'bg-white', '', d.excludeFromNetWorth)).join('');
                 
                 debtHTML += `
                 <div class="border border-purple-100 rounded-2xl overflow-hidden bg-purple-50/50 shadow-sm mb-2">
                    <div onclick="document.getElementById('cardDetails').classList.toggle('open');" class="flex justify-between items-center p-3 cursor-pointer hover:bg-purple-100/50 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center"><i class="fas fa-credit-card"></i></div>
                            <span class="text-xs font-black text-purple-900 uppercase tracking-wide">Kredi KartlarÄ± ToplamÄ±</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-black text-purple-900 text-sm">â‚º${totalCardDebt.toLocaleString()}</span>
                            <i class="fas fa-chevron-down text-purple-400"></i>
                        </div>
                    </div>
                    <div id="cardDetails" class="health-detail space-y-2 px-3 pb-3">
                        ${cardsHTML}
                    </div>
                </div>`;
            }

            // 3. DiÄŸer BorÃ§lar (BÃ¼yÃ¼kten KÃ¼Ã§Ã¼ÄŸe)
            const sortedOtherDebts = [...state.otherDebts].filter(d => d.val > 0).sort((a,b) => b.val - a.val);
            sortedOtherDebts.forEach((d) => {
                 const originalIndex = state.otherDebts.indexOf(d);
                 debtHTML += createRow(d.name + (d.excludeFromNetWorth ? ' <span class="text-[8px] text-red-400 font-bold ml-1 bg-red-50 px-1 rounded">(Dahil DeÄŸil)</span>' : ''), d.val, 'otherDebts', originalIndex, '', '', d.excludeFromNetWorth);
            }); 
            
            document.getElementById('detailedDebtsList').innerHTML = debtHTML || '<span class="text-gray-300 text-xs">KayÄ±tlÄ± borÃ§ yok</span>'; 
            
            // VARLIKLAR (SÄ±ralama: BÃ¼yÃ¼kten KÃ¼Ã§Ã¼ÄŸe)
            const sortedAssets = [...state.assets].filter(a => a.val > 0).sort((a,b) => b.val - a.val);
            let assetHTML = sortedAssets.map((a) => {
                const originalIndex = state.assets.indexOf(a);
                return createRow(a.name + (a.excludeFromNetWorth ? ' <span class="text-[8px] text-red-400 font-bold ml-1 bg-red-50 px-1 rounded">(Dahil DeÄŸil)</span>' : ''), a.val, 'assets', originalIndex, '', '', a.excludeFromNetWorth);
            }).join(''); 
            document.getElementById('detailedAssetsList').innerHTML = assetHTML || '<span class="text-gray-300 text-xs">KayÄ±tlÄ± varlÄ±k yok</span>'; 
        }

        function addNewHealthItem(type) { 
            const name = prompt("Yeni Kalem AdÄ±:"); 
            if(name) { 
                const val = parseFloat(prompt("Tutar:")) || 0; 
                let newItem = {name, val:val};
                if(type === 'loans') newItem = {name, totalDebt:val, monthly:0, totalMonths:1, startDate: new Date().toISOString().slice(0,10)};
                else if(type === 'debts') newItem = {name, val:val, calcMode: false};
                
                state[type].unshift(newItem); 
                saveToCloud(); updateDashboardUI(); 
            } 
        }
        
        function openEditModal(type, index) { 
            const item = state[type][index]; 
            document.getElementById('editItemName').value = item.name; 
            document.getElementById('editItemVal').value = item.val || item.totalDebt || 0; 
            document.getElementById('editItemType').value = type; 
            document.getElementById('editItemIndex').value = index; 
            
            const chk = document.getElementById('editExcludeNetWorth');
            if (type === 'loans') chk.checked = item.excludeFromDebt || false;
            else chk.checked = item.excludeFromNetWorth || false;
            
            // YENÄ°: Side Panel olarak aÃ§
            const modal = document.getElementById('editItemModal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('open'), 10);
            document.getElementById('overlay').classList.add('active'); 
        }
        
        function saveEditedItem() { 
            const type = document.getElementById('editItemType').value; 
            const idx = parseInt(document.getElementById('editItemIndex').value); 
            const name = document.getElementById('editItemName').value; 
            const val = parseFloat(document.getElementById('editItemVal').value); 
            const excluded = document.getElementById('editExcludeNetWorth').checked;

            if(state[type][idx]) { 
                state[type][idx].name = name; 
                if(type === 'loans') {
                    state[type][idx].totalDebt = val; 
                    state[type][idx].excludeFromDebt = excluded;
                } else { 
                    state[type][idx].val = val; 
                    state[type][idx].excludeFromNetWorth = excluded;
                    if (type === 'debts' && state[type][idx].calcMode) state[type][idx].calcMode = false; 
                }
                saveToCloud(); updateDashboardUI(); closeEditModal(); 
            } 
        }
        function closeEditModal() { 
            // YENÄ°: Side Panel kapatma mantÄ±ÄŸÄ±
            const modal = document.getElementById('editItemModal');
            modal.classList.remove('open');
            setTimeout(() => modal.classList.add('hidden'), 300);
            document.getElementById('overlay').classList.remove('active'); 
        }
        function deleteHealthItem(type, idx) { if(confirm('Bu kalemi tamamen silmek istediÄŸinize emin misiniz?')) { state[type].splice(idx, 1); saveToCloud(); updateDashboardUI(); } }

        function renderCharts() {
            const ctx1 = document.getElementById('assetsChart').getContext('2d');
            const ctx2 = document.getElementById('expensesChart').getContext('2d');
            if(assetsChartInstance) assetsChartInstance.destroy();
            if(expensesChartInstance) expensesChartInstance.destroy();
            
            // DÃ–NEMLÄ°K ANALÄ°Z MANTIÄžI
            const filterVal = document.getElementById('analysisDateFilter').value; // YYYY-MM
            let filteredExpenses = state.expenses;
            
            if (filterVal) {
                const [year, month] = filterVal.split('-').map(Number);
                const salaryDay = state.salaryDay || 15;
                
                // BaÅŸlangÄ±Ã§: SeÃ§ilen Ay, MaaÅŸ GÃ¼nÃ¼
                const startDate = new Date(year, month - 1, salaryDay);
                // BitiÅŸ: Bir sonraki ay, MaaÅŸ GÃ¼nÃ¼
                const endDate = new Date(year, month, salaryDay);
                
                // DÃ¶nem Bilgisini Ekrana Yaz
                const startStr = startDate.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
                const endStr = new Date(endDate - 1).toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
                document.getElementById('analysisPeriodLabel').innerText = `DÃ¶nem: ${startStr} - ${endStr}`;
                
                filteredExpenses = state.expenses.filter(e => {
                    const parts = e.date.split('.'); // DD.MM.YYYY
                    // JS Date objesi oluÅŸtur (Ay indeksi 0-11)
                    const d = new Date(parts[2], parts[1] - 1, parts[0]);
                    return d >= startDate && d < endDate;
                });
            }

            const assets = state.assets.reduce((s,a)=>s+(a.val||0),0);
            const debts = state.loans.filter(l=>!l.excludeFromDebt).reduce((s,l)=>s+(l.totalDebt||0),0) + state.debts.reduce((s,d)=>s+(d.val||0),0) + state.otherDebts.reduce((s,d)=>s+(d.val||0),0);
            
            // Group expenses by Category
            const expenseMap = {};
            filteredExpenses.forEach(e => {
                let key = e.category; 
                if (!key || key === 'DiÄŸer') {
                    key = 'DiÄŸer / Ã–zel';
                }
                expenseMap[key] = (expenseMap[key] || 0) + e.amount; 
            });

            // Sort by value
            const sortedKeys = Object.keys(expenseMap).sort((a,b) => expenseMap[b] - expenseMap[a]);
            const sortedData = sortedKeys.map(k => expenseMap[k]);

            assetsChartInstance = new Chart(ctx1, { type: 'doughnut', data: { labels: ['VarlÄ±klar', 'BorÃ§lar'], datasets: [{ data: [assets, debts], backgroundColor: ['#22c55e', '#ef4444'], borderWidth: 0 }] }, options: { cutout: '70%', plugins: { legend: { position: 'bottom' } } } });
            expensesChartInstance = new Chart(ctx2, { 
                type: 'bar', 
                data: { 
                    labels: sortedKeys.slice(0, 8), 
                    datasets: [{ 
                        label: 'Harcama', 
                        data: sortedData.slice(0, 8), 
                        backgroundColor: '#3b82f6', 
                        borderRadius: 5 
                    }] 
                }, 
                options: { 
                    scales: { y: { beginAtZero: true } }, 
                    plugins: { legend: { display: false } } 
                } 
            });
        }
        function addHistoryRecord() {
            const date = document.getElementById('histDate').value; const assets = parseFloat(document.getElementById('histAssets').value); const debts = parseFloat(document.getElementById('histDebts').value);
            if(!date) return alert("Tarih seÃ§in");
            state.monthlyHistory.push({date, assets: assets||0, debts: debts||0}); saveToCloud(); alert("KayÄ±t Eklendi");
        }

        // --- KREDÄ° PLAN MODALI (SIDE PANEL) ---
        function openLoanPlanModal(loanIndex) {
            const loan = state.loans[loanIndex];
            if (!loan) return;
            document.getElementById('loanPlanTitle').innerText = loan.name;
            const tbody = document.getElementById('loanPlanBody');
            tbody.innerHTML = '';
            
            let currentDate = new Date(loan.startDate || new Date());
            const monthly = loan.monthly || 0;
            const totalMonths = loan.totalMonths || 0;
            const now = new Date();

            for(let i=1; i<=totalMonths; i++) {
                const dateStr = currentDate.toLocaleDateString('tr-TR', { month: 'long', year: 'numeric', day: 'numeric' });
                const isPaid = currentDate < now && (currentDate.getMonth() !== now.getMonth() || currentDate.getFullYear() !== now.getFullYear());
                
                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-100 last:border-0 hover:bg-red-50 transition-colors";
                tr.innerHTML = `
                    <td class="py-3 pl-2">${i}/${totalMonths}</td>
                    <td class="py-3">${dateStr}</td>
                    <td class="py-3 text-right">â‚º${Math.floor(monthly).toLocaleString()}</td>
                    <td class="py-3 text-center"><span class="${isPaid ? 'text-green-500 bg-green-50' : 'text-gray-400 bg-gray-100'} px-2 py-1 rounded text-[10px] uppercase font-black tracking-wider">${isPaid ? 'Ã–dendi' : 'Bekliyor'}</span></td>
                `;
                tbody.appendChild(tr);
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
            
            const modal = document.getElementById('loanPlanModal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('open'), 10);
            document.getElementById('overlay').classList.add('active');
        }

        function closeLoanPlanModal() {
            const modal = document.getElementById('loanPlanModal');
            modal.classList.remove('open');
            setTimeout(() => modal.classList.add('hidden'), 300);
            document.getElementById('overlay').classList.remove('active'); 
        }

        // --- GERÃ‡EK BAKÄ°YE MODALI ---
        function openBalanceModal() {
            const now = new Date(); const todayStr = now.toLocaleDateString('tr-TR');
            let startCalc = new Date(state.registrationDate);
            if(isNaN(startCalc.getTime())) startCalc = new Date();
            
            // Hibrit MantÄ±k (MaaÅŸ GÃ¼nÃ¼ KontrolÃ¼)
            let isSalaryBased = false;
            if (state.expenses.length > 0) {
                let minExpDate = new Date();
                state.expenses.forEach(e => {
                    let dParts = e.date.split('.');
                    if(dParts.length === 3) {
                        let d = new Date(dParts[2], dParts[1]-1, dParts[0]);
                        if (d < minExpDate) minExpDate = d;
                    }
                });
                if (minExpDate.getTime() < startCalc.getTime() - (1000 * 60 * 60 * 24)) {
                    const salaryDay = state.salaryDay || 15;
                    let lastSalaryDate = new Date(now.getFullYear(), now.getMonth(), salaryDay);
                    if (now.getDate() < salaryDay) {
                        lastSalaryDate.setMonth(lastSalaryDate.getMonth() - 1);
                    }
                    startCalc = lastSalaryDate;
                    isSalaryBased = true;
                }
            }
            
            const daysPassed = Math.max(1, Math.ceil(Math.abs(now - startCalc) / (1000 * 60 * 60 * 24))); 
            const dailyLimit = state.manualDailyLimit || 0;
            const accumulatedLimit = dailyLimit * daysPassed;
            const totalSpent = state.expenses.reduce((s,e)=>s+e.amount,0);
            const balance = accumulatedLimit - totalSpent;

            const html = `
                <div class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100 text-center">
                        <p class="text-[10px] font-bold text-blue-400 uppercase tracking-widest mb-1">Åžu Anki Durum</p>
                        <p class="text-3xl font-black ${balance >= 0 ? 'text-green-600' : 'text-red-600'}">â‚º${Math.floor(balance).toLocaleString()}</p>
                    </div>
                    
                    <div class="space-y-3 pt-2">
                        <div class="flex justify-between items-center text-xs font-bold text-gray-600 border-b border-gray-100 pb-2">
                            <span>Hesap BaÅŸlangÄ±cÄ±</span>
                            <span class="text-gray-800">${startCalc.toLocaleDateString('tr-TR')} ${isSalaryBased ? '<span class="text-[9px] bg-yellow-100 text-yellow-700 px-1 rounded ml-1">MaaÅŸ GÃ¼nÃ¼</span>' : '<span class="text-[9px] bg-gray-100 text-gray-500 px-1 rounded ml-1">KayÄ±t Tarihi</span>'}</span>
                        </div>
                        <div class="flex justify-between items-center text-xs font-bold text-gray-600 border-b border-gray-100 pb-2">
                            <span>GeÃ§en GÃ¼n</span>
                            <span class="text-gray-800">${daysPassed} GÃ¼n</span>
                        </div>
                        <div class="flex justify-between items-center text-xs font-bold text-green-600 border-b border-gray-100 pb-2">
                            <span>Biriken Limit (${daysPassed} x â‚º${Math.floor(dailyLimit)})</span>
                            <span>+ â‚º${Math.floor(accumulatedLimit).toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-center text-xs font-bold text-red-500 border-b border-gray-100 pb-2">
                            <span>Toplam Harcanan</span>
                            <span>- â‚º${Math.floor(totalSpent).toLocaleString()}</span>
                        </div>
                    </div>

                    <div class="p-3 bg-gray-50 rounded-xl text-[10px] text-gray-500 leading-relaxed">
                        <p><strong>GerÃ§ek Bakiye MantÄ±ÄŸÄ±:</strong><br>
                        Sistem, belirlediÄŸiniz gÃ¼nlÃ¼k limiti her yeni gÃ¼nde kumbaranÄ±za ekler. HarcamalarÄ±nÄ±z bu kumbaradan dÃ¼ÅŸÃ¼lÃ¼r. Kalan tutar, ay sonuna kadar "fazladan" harcayabileceÄŸiniz veya biriktirebileceÄŸiniz net tutardÄ±r.</p>
                        ${isSalaryBased ? '<p class="mt-2 text-blue-500">Not: GeÃ§miÅŸe dÃ¶nÃ¼k harcama girdiÄŸiniz iÃ§in hesaplama son maaÅŸ gÃ¼nÃ¼nÃ¼zden baÅŸlatÄ±lmÄ±ÅŸtÄ±r.</p>' : ''}
                    </div>
                </div>
            `;
            
            document.getElementById('balanceModalContent').innerHTML = html;
            const modal = document.getElementById('balanceModal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('open'), 10);
            document.getElementById('overlay').classList.add('active');
        }

        function closeBalanceModal() {
            const modal = document.getElementById('balanceModal');
            modal.classList.remove('open');
            setTimeout(() => modal.classList.add('hidden'), 300);
            document.getElementById('overlay').classList.remove('active'); 
        }

        // --- SÄ°HÄ°RBAZ MANTIÄžI ---
        function startWizard(isEditMode) {
            hideAll(); document.getElementById('wizardScreen').classList.remove('hidden');
            if(!isEditMode) { state = JSON.parse(JSON.stringify(defaultState)); state.registrationDate = new Date().toISOString(); }
            state.step = 1; renderWizard();
        }
        function wizardNext() { if (state.step === 8) { if(document.getElementById('wizRegEmail')) registerFromWizard(); else { saveState(); showDashboard(); } return; } state.step++; renderWizard(); }
        function wizardBack() { if (state.step > 1) { state.step--; renderWizard(); } else { if(currentUser) showDashboard(); else showLoginScreen(); } }
        
        function getStandardLoans() {
             return state.loans.filter(l => !l.excludeFromDebt && !l.excludeFromBudget).reduce((s, l) => s + (l.monthly || 0), 0);
        }

        function renderWizard() {
            const content = document.getElementById('wizardContent');
            document.getElementById('stepCount').innerText = `${state.step}/8`;
            document.getElementById('wizardProgress').innerHTML = Array(8).fill(0).map((_,i) => `<div class="h-1.5 flex-1 rounded-full ${i+1<=state.step?'bg-blue-600':'bg-gray-200'} transition-all"></div>`).join('');
            
            if(state.step === 8) {
                if(!currentUser) {
                    content.innerHTML = `<div class="text-center mb-6"><h3 class="text-2xl font-black">PlanÄ±n HazÄ±r!</h3></div><div class="space-y-4"><input type="text" id="wizRegName" class="w-full p-4 bg-gray-50 rounded-2xl border" placeholder="KullanÄ±cÄ± AdÄ±"><input type="email" id="wizRegEmail" class="w-full p-4 bg-gray-50 rounded-2xl border" placeholder="E-posta"><input type="password" id="wizRegPass" class="w-full p-4 bg-gray-50 rounded-2xl border" placeholder="Åžifre"></div>`;
                    document.getElementById('wizNextBtn').innerText = "KaydÄ± Tamamla";
                } else {
                    content.innerHTML = `<div class="text-center py-10"><h3 class="text-2xl font-black text-gray-800">TamamlandÄ±</h3></div>`; document.getElementById('wizNextBtn').innerText = "PlanÄ± GÃ¼ncelle";
                }
            } else if(state.step === 7) {
                const totalInc = state.incomes.reduce((s, i) => s + (i.val||0), 0);
                const normalBills = state.bills.reduce((s, b) => s + (b.val||0), 0);
                const loansTreatedAsBills = state.loans.filter(l => l.excludeFromDebt && !l.excludeFromBudget).reduce((s, l) => s + (l.monthly || 0), 0);
                const totalFix = normalBills + loansTreatedAsBills;
                const standardLoans = getStandardLoans();
                
                const grossNet = totalInc - totalFix; 
                const realNet = grossNet - standardLoans;
                const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();

                state.remainingAfterFixed = grossNet; 
                // HEDEF BÄ°RÄ°KÄ°M DÃœZELTMESÄ°:
                // Normalde DailyLimit = realNet / GÃ¼n. Ama kullanÄ±cÄ± slider ile oynayÄ±nca;
                // Spending = Daily * Days. 
                // Savings = realNet - Spending.
                if(!state.manualDailyLimit) state.manualDailyLimit = Math.max(0, realNet / daysInMonth);
                
                content.innerHTML = `
                    <h3 class="text-2xl font-black mb-2">BÃ¼tÃ§e PlanÄ±</h3>
                    <div class="text-center mb-6">
                        <p class="text-gray-400 text-xs uppercase tracking-widest">DaÄŸÄ±tÄ±labilir Gelir</p>
                        <div class="flex items-center justify-center gap-2">
                             <p class="text-3xl font-black text-blue-600">â‚º${Math.floor(grossNet).toLocaleString()}</p>
                             <button onclick="openCalcModal()" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-lg font-bold hover:bg-blue-200 transition-colors">Detay</button>
                        </div>
                        
                        ${standardLoans > 0 ? `<div class="mt-4 p-3 bg-red-50 border border-red-100 rounded-xl text-left shadow-sm">
                            <div class="flex items-center gap-2 mb-1"><i class="fas fa-info-circle text-red-400"></i><span class="text-[10px] font-bold text-red-400 uppercase">Bilgilendirme</span></div>
                            <p class="text-xs text-gray-600 font-medium leading-relaxed">Kredi Ã¶demeleriniz borÃ§tan dÃ¼ÅŸÃ¼leceÄŸinden bu hesabÄ±n iÃ§indedir. Kredileriniz Ã¶dendikten sonra kalan net tutarÄ±nÄ±z: <span class="text-red-600 font-black text-sm">â‚º${Math.floor(realNet).toLocaleString()}</span></p>
                        </div>` : ''}
                    </div>
                    <div class="space-y-6">
                        <div class="p-4 bg-white border border-gray-200 rounded-[2rem] shadow-sm text-center">
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 block">GÃ¼nlÃ¼k Harcama Hedefi</label>
                            <input type="number" id="idealDailyLimitInput" oninput="updateFromDailyLimitInput(this.value)" class="w-32 text-center text-3xl font-black text-blue-600 border-b-2 outline-none pb-2" placeholder="0">
                            <span class="text-[9px] text-gray-300 font-bold block mt-1">(Bu ay ${daysInMonth} gÃ¼n Ã¼zerinden hesaplanÄ±yor)</span>
                        </div>
                        <div class="space-y-2"><div class="flex justify-between text-xs font-bold text-gray-500"><span>Birikim %</span><span>Harcama %</span></div><input type="range" id="allocationSlider" min="0" max="100" oninput="handleSliderChange(this.value)" class="w-full h-3 bg-gray-200 rounded-lg cursor-pointer"></div>
                        <div class="flex justify-between gap-4">
                            <div class="flex-1 text-center p-3 bg-green-50 rounded-2xl"><p class="text-[9px] font-bold text-green-400 block mb-1">AYLIK BÄ°RÄ°KÄ°M</p><div class="relative"><span class="absolute left-2 top-1.5 text-green-700 font-bold">â‚º</span><input type="number" id="manualSavingsInput" oninput="updateFromSavingsInput(this.value)" class="w-full bg-transparent text-center font-black text-lg text-green-700 outline-none pl-4" placeholder="0"></div></div>
                            <div class="flex-1 text-center p-3 bg-blue-50 rounded-2xl"><p class="text-[9px] font-bold text-blue-400 block mb-1">AYLIK HARCAMA</p><div class="relative"><span class="absolute left-2 top-1.5 text-blue-700 font-bold">â‚º</span><input type="number" id="allocSpendingInput" oninput="updateFromSpendingInput(this.value)" class="w-full bg-transparent text-center font-black text-lg text-blue-700 outline-none pl-4" placeholder="0"></div></div>
                        </div>
                    </div>`;
                setTimeout(() => applyAllocationFromLimit(state.manualDailyLimit), 50); document.getElementById('wizNextBtn').innerText = "Devam Et";
            } else {
                const titles = ["", "Gelirler", "Sabit Giderler", "Banka Kredileri", "Kredi KartlarÄ±", "DiÄŸer BorÃ§lar", "VarlÄ±klar"];
                const colors = ["", "green", "red", "red", "purple", "red", "green"]; const keys = ["", "incomes", "bills", "loans", "debts", "otherDebts", "assets"]; const key = keys[state.step];
                content.innerHTML = `<h3 class="text-2xl font-black mb-6 text-${colors[state.step]}-600">${titles[state.step]}</h3><div id="wiz_${key}_list" class="custom-scrollbar overflow-y-auto max-h-[300px] mb-4"></div>`;
                
                if (state.step === 3) {
                    content.innerHTML += `<button id="btnShowwiz_loanForm" onclick="toggleInlineAdd('wiz_loan')" class="w-full py-3 border-2 border-dashed border-red-200 rounded-2xl text-red-500 font-bold">+ Yeni Kredi Ekle</button><div id="inlineAddwiz_loanContainer" class="hidden p-4 border border-red-100 bg-red-50 rounded-xl space-y-3"><input type="hidden" id="wiz_loanType" value="Kredi"><div id="wiz_loanFields" class="space-y-2"></div><div class="flex gap-2"><button onclick="cancelInlineAdd('wiz_loan')" class="flex-1 py-2 bg-white text-gray-600 rounded-lg text-xs font-bold border">Ä°ptal</button><button onclick="saveInlineAdd('wiz_loan')" class="flex-1 py-2 bg-red-500 text-white rounded-lg text-xs font-black">Ekle</button></div></div>`;
                } else if (state.step === 4) {
                    content.innerHTML += `<button id="btnShowwiz_cardForm" onclick="toggleInlineAdd('wiz_card')" class="w-full py-3 border-2 border-dashed border-purple-200 rounded-2xl text-purple-500 font-bold">+ Yeni Kart Ekle</button><div id="inlineAddwiz_cardContainer" class="hidden p-4 border border-purple-100 bg-purple-50 rounded-xl space-y-3"><input type="hidden" id="wiz_cardType" value="Kredi KartÄ±"><div id="wiz_cardFields" class="space-y-2"></div><div class="flex gap-2"><button onclick="cancelInlineAdd('wiz_card')" class="flex-1 py-2 bg-white text-gray-600 rounded-lg text-xs font-bold border">Ä°ptal</button><button onclick="saveInlineAdd('wiz_card')" class="flex-1 py-2 bg-purple-500 text-white rounded-lg text-xs font-black">Ekle</button></div></div>`;
                } else if (state.step === 5) {
                    content.innerHTML += `<button id="btnShowwiz_debtForm" onclick="toggleInlineAdd('wiz_debt')" class="w-full py-3 border-2 border-dashed border-red-200 rounded-2xl text-red-500 font-bold">+ Yeni BorÃ§ Ekle</button><div id="inlineAddwiz_debtContainer" class="hidden p-4 border border-red-100 bg-red-50 rounded-xl space-y-3"><select id="wiz_debtType" onchange="handleInlineTypeChange('wiz_debt')" class="w-full p-2.5 bg-white rounded-lg text-xs font-bold border border-gray-200 outline-none"><option value="DiÄŸer">DiÄŸer (Standart TL)</option><option value="AltÄ±n">AltÄ±n</option><option value="DÃ¶viz">DÃ¶viz</option><option value="GÃ¼mÃ¼ÅŸ">GÃ¼mÃ¼ÅŸ</option></select><div id="wiz_debtFields" class="space-y-2"></div><div class="flex gap-2"><button onclick="cancelInlineAdd('wiz_debt')" class="flex-1 py-2 bg-white text-gray-600 rounded-lg text-xs font-bold border">Ä°ptal</button><button onclick="saveInlineAdd('wiz_debt')" class="flex-1 py-2 bg-red-500 text-white rounded-lg text-xs font-black">Ekle</button></div></div>`;
                } else if (state.step === 6) {
                    content.innerHTML += `<button id="btnShowwiz_assetForm" onclick="toggleInlineAdd('wiz_asset')" class="w-full py-3 border-2 border-dashed border-green-200 rounded-2xl text-green-500 font-bold">+ Yeni VarlÄ±k Ekle</button><div id="inlineAddwiz_assetContainer" class="hidden p-4 border border-green-100 bg-green-50 rounded-xl space-y-3"><select id="wiz_assetType" onchange="handleInlineTypeChange('wiz_asset')" class="w-full p-2.5 bg-white rounded-lg text-xs font-bold border border-gray-200 outline-none"><option value="DiÄŸer">DiÄŸer (Standart TL)</option><option value="AltÄ±n">AltÄ±n</option><option value="DÃ¶viz">DÃ¶viz</option><option value="GÃ¼mÃ¼ÅŸ">GÃ¼mÃ¼ÅŸ</option></select><div id="wiz_assetFields" class="space-y-2"></div><div class="flex gap-2"><button onclick="cancelInlineAdd('wiz_asset')" class="flex-1 py-2 bg-white text-gray-600 rounded-lg text-xs font-bold border">Ä°ptal</button><button onclick="saveInlineAdd('wiz_asset')" class="flex-1 py-2 bg-green-500 text-white rounded-lg text-xs font-black">Ekle</button></div></div>`;
                } else {
                     content.innerHTML += `<button onclick="addSimpleWizItem('${key}', 'wiz_${key}_list')" class="w-full py-3 border-2 border-dashed border-${colors[state.step]}-200 rounded-2xl text-${colors[state.step]}-500 font-bold mt-4">+ Kalem Ekle</button>`;
                }
                if (state.step === 1) content.innerHTML += `<div class="pt-4 mt-6 border-t"><p class="text-[10px] font-bold text-gray-400 uppercase mb-2">MaaÅŸ GÃ¼nÃ¼</p><input type="number" id="wiz_salary_day_val" oninput="state.salaryDay=this.value" value="${state.salaryDay || 15}" class="w-20 p-3 bg-gray-50 rounded-xl font-black text-center text-xl" placeholder="15"></div>`;
            }
            renderWizardLists();
        }

        function addSimpleWizItem(key, id) { state[key].unshift({name:'',val:0}); renderWizardLists(); setTimeout(() => { const c = document.getElementById(id); if(c && c.firstElementChild) { c.firstElementChild.scrollIntoView({ behavior: 'smooth' }); const i = c.firstElementChild.querySelector('input'); if(i) i.focus(); } }, 100); }

        function renderWizardLists() {
             const listEl = (data, id, type) => { const el = document.getElementById(id); if(!el) return; el.innerHTML = data.map((item, idx) => `<div class="flex gap-2 mb-2 items-center"><input type="text" value="${item.name||''}" onchange="state.${type}[${idx}].name=this.value" class="flex-1 p-3 bg-white border border-gray-100 rounded-xl text-sm outline-none" placeholder="Ä°sim"> <input type="number" value="${item.val||''}" onchange="state.${type}[${idx}].val=parseFloat(this.value)||0" class="w-24 p-3 bg-gray-50 border rounded-xl text-right text-sm" placeholder="0"><button onclick="removeItem('${type}', ${idx})" class="text-gray-300 hover:text-red-500 px-2"><i class="fas fa-trash"></i></button></div>`).join(''); };
             if(state.step===1) listEl(state.incomes, 'wiz_incomes_list', 'incomes');
             if(state.step===2) listEl(state.bills, 'wiz_bills_list', 'bills');
             
             if(state.step===3) { 
                 const el = document.getElementById('wiz_loans_list'); 
                 if(el) el.innerHTML = state.loans.map((l, i) => `<div class="p-4 bg-white border rounded-2xl mb-3 space-y-3 relative"><button onclick="removeItem('loans', ${i})" class="absolute top-2 right-2 text-gray-300 hover:text-red-500"><i class="fas fa-times"></i></button><input type="text" value="${l.name}" onchange="state.loans[${i}].name=this.value" class="w-full border-b pb-1 font-black text-sm outline-none" placeholder="Kredi AdÄ±"><div class="grid grid-cols-3 gap-2"><input type="number" value="${l.monthly||''}" oninput="updateLoanData(${i}, 'monthly', this.value)" class="p-2 bg-gray-50 rounded-lg text-xs" placeholder="AylÄ±k"><input type="number" value="${l.totalMonths||''}" oninput="updateLoanData(${i}, 'totalMonths', this.value)" class="p-2 bg-gray-50 rounded-lg text-xs" placeholder="Vade"><input type="number" id="wiz_loan_t_${i}" value="${l.totalDebt||''}" oninput="updateLoanData(${i}, 'totalDebt', this.value)" class="p-2 bg-gray-50 rounded-lg text-xs" placeholder="Toplam"></div><div class="mb-1"><label class="text-[9px] font-bold text-gray-400">SÄ±radaki Taksit Tarihi</label><input type="date" value="${l.startDate || ''}" onchange="state.loans[${i}].startDate=this.value" class="w-full p-2 bg-gray-50 rounded-lg text-xs"></div><div class="flex flex-col gap-1 pt-1 border-t border-gray-50 mt-2"><div class="flex items-center gap-2"><input type="checkbox" id="wiz_ex_${i}" ${l.excludeFromBudget ? 'checked' : ''} onchange="state.loans[${i}].excludeFromBudget=this.checked" class="w-3.5 h-3.5 rounded text-blue-600 focus:ring-blue-500"><label for="wiz_ex_${i}" class="text-[10px] font-bold text-gray-500 uppercase tracking-tighter">AylÄ±k gidere dahil etme</label></div><div class="flex items-center gap-2"><input type="checkbox" id="wiz_ex_debt_${i}" ${l.excludeFromDebt ? 'checked' : ''} onchange="state.loans[${i}].excludeFromDebt=this.checked" class="w-3.5 h-3.5 rounded text-blue-600 focus:ring-blue-500"><label for="wiz_ex_debt_${i}" class="text-[10px] font-bold text-gray-500 uppercase tracking-tighter">Genel borca dahil etme</label></div></div></div>`).join(''); 
             }
             
             if(state.step===4) { 
                 const el = document.getElementById('wiz_debts_list'); 
                 if(el) el.innerHTML = state.debts.map((d, i) => `
                    <div class="p-4 bg-white border rounded-2xl mb-3 space-y-3 text-left relative">
                        <button onclick="removeItem('debts', ${i})" class="absolute top-2 right-2 text-gray-300 hover:text-red-500"><i class="fas fa-times"></i></button>
                        <div class="flex justify-between items-center pr-6">
                            <input type="text" value="${d.name}" onchange="state.debts[${i}].name=this.value" class="font-black text-sm outline-none flex-1" placeholder="Kart AdÄ±">
                        </div>
                        <input type="number" value="${d.val||''}" onchange="state.debts[${i}].val=parseFloat(this.value)||0; state.debts[${i}].calcMode=false;" class="w-full p-2 bg-gray-50 rounded-xl text-right text-sm" placeholder="Toplam BorÃ§ TutarÄ±">
                    </div>`).join(''); 
             }
             
             if(state.step===5) listEl(state.otherDebts, 'wiz_otherDebts_list', 'otherDebts');
             if(state.step===6) listEl(state.assets, 'wiz_assets_list', 'assets');
        }
        
        function updateFromDailyLimitInput(v) { 
            state.manualDailyLimit = parseFloat(v)||0; 
            applyAllocationFromLimit(state.manualDailyLimit); 
        }
        function handleSliderChange(v) { 
            const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
            const loans = getStandardLoans();
            // Spending = RealNet - (% of RealNet)
            // state.remainingAfterFixed is GrossNet
            // netAvailable for allocation is GrossNet - Loans
            const netAvailable = state.remainingAfterFixed - loans;
            
            const spend = netAvailable - ((netAvailable * v) / 100); 
            document.getElementById('idealDailyLimitInput').value = Math.floor(spend / daysInMonth); 
            updateFromDailyLimitInput(spend / daysInMonth); 
        }
        function applyAllocationFromLimit(daily) { 
            const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
            const loans = getStandardLoans();
            const spend = daily * daysInMonth; 
            // Save = GrossNet - Loans - Spend
            const save = Math.max(0, state.remainingAfterFixed - loans - spend); 
            
            document.getElementById('manualSavingsInput').value = Math.floor(save); 
            document.getElementById('allocSpendingInput').value = Math.floor(spend); 
            
            const netAvailable = state.remainingAfterFixed - loans;
            if(netAvailable > 0) document.getElementById('allocationSlider').value = (save / netAvailable) * 100; 
            
            state.calculatedMonthlyPool = spend; 
            state.calculatedMonthlySavings = save; 
        }
        function updateFromSavingsInput(v) { 
            const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
            const loans = getStandardLoans();
            const save = parseFloat(v) || 0; 
            // Spend = GrossNet - Loans - Save
            const spend = Math.max(0, state.remainingAfterFixed - loans - save); 
            
            document.getElementById('idealDailyLimitInput').value = Math.floor(spend / daysInMonth); 
            document.getElementById('allocSpendingInput').value = Math.floor(spend); 
            
            const netAvailable = state.remainingAfterFixed - loans;
            if(netAvailable > 0) document.getElementById('allocationSlider').value = (save / netAvailable) * 100; 
            
            state.calculatedMonthlyPool = spend; 
            state.calculatedMonthlySavings = save; 
            state.manualDailyLimit = spend / daysInMonth; 
        }
        function updateFromSpendingInput(v) { 
            const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
            const loans = getStandardLoans();
            const spend = parseFloat(v) || 0; 
            // Save = GrossNet - Loans - Spend
            const save = Math.max(0, state.remainingAfterFixed - loans - spend); 
            
            document.getElementById('idealDailyLimitInput').value = Math.floor(spend / daysInMonth); 
            document.getElementById('manualSavingsInput').value = Math.floor(save); 
            
            const netAvailable = state.remainingAfterFixed - loans;
            if(netAvailable > 0) document.getElementById('allocationSlider').value = (save / netAvailable) * 100; 
            
            state.calculatedMonthlyPool = spend; 
            state.calculatedMonthlySavings = save; 
            state.manualDailyLimit = spend / daysInMonth; 
        }
        
        function removeItem(key, i) { state[key].splice(i, 1); renderWizardLists(); }
        function updateLoanData(i, f, v) { state.loans[i][f] = parseFloat(v)||0; const l = state.loans[i]; if(f==='monthly' && l.totalMonths>0) l.totalDebt = l.monthly*l.totalMonths; else if(f==='totalMonths' && l.monthly>0) l.totalDebt = l.monthly*l.totalMonths; else if(f==='totalDebt' && l.totalMonths>0) l.monthly = l.totalDebt/l.totalMonths; document.getElementById(`wiz_loan_t_${i}`).value = Math.ceil(l.totalDebt); }
        
        function openCalcModal() { 
            // DÃœZELTME 3: DETAYLI HESAPLAMA GÃ–RÃœNÃœMÃœ
            const totalInc = state.incomes.reduce((s, i) => s + (i.val||0), 0); 
            const normalBills = state.bills.reduce((s, b) => s + (b.val||0), 0);
            
            // DÃœZELTME 1: BÃ¼tÃ§eye dahil olup Genel Borca dahil olmayanlar "Gizli Gider"
            const loansTreatedAsBills = state.loans.filter(l => l.excludeFromDebt && !l.excludeFromBudget).reduce((s, l) => s + (l.monthly || 0), 0);
            
            const totalFix = normalBills + loansTreatedAsBills;
            
            // DÃœZELTME 1 DevamÄ±: Sadece "Normal" krediler
            const standardLoans = state.loans.filter(l => !l.excludeFromDebt && !l.excludeFromBudget).reduce((s, l) => s + (l.monthly || 0), 0);
            
            const grossNet = totalInc - totalFix;
            const netIncome = grossNet - standardLoans;
            
            const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
            const daily = state.manualDailyLimit || 0;
            const monthlySpend = daily * daysInMonth;
            const savings = grossNet - (monthlySpend + standardLoans);

            // DetaylÄ± liste oluÅŸturma
            let incomeList = state.incomes.map(i => `<div class="flex justify-between text-xs text-green-600 pl-2"><span>${i.name}</span><span>+â‚º${(i.val||0).toLocaleString()}</span></div>`).join('');
            let billList = state.bills.filter(b => b.val > 0).map(b => `<div class="flex justify-between text-xs text-red-500 pl-2"><span>${b.name}</span><span>-â‚º${b.val.toLocaleString()}</span></div>`).join('');
            
            // Gizli Krediler Listesi
            let hiddenLoanList = state.loans.filter(l => l.excludeFromDebt && !l.excludeFromBudget).map(l => `<div class="flex justify-between text-xs text-red-500 pl-2"><span>${l.name} (Gizli Taksit)</span><span>-â‚º${(l.monthly||0).toLocaleString()}</span></div>`).join('');
            
            // Normal Krediler Listesi
            let standardLoanList = state.loans.filter(l => !l.excludeFromDebt && !l.excludeFromBudget).map(l => `<div class="flex justify-between text-xs text-red-500 pl-2"><span>${l.name} (Taksit)</span><span>-â‚º${(l.monthly||0).toLocaleString()}</span></div>`).join('');

            document.getElementById('calcModalContent').innerHTML = `
                <div class="space-y-4">
                    <div class="bg-green-50 p-4 rounded-2xl border border-green-100">
                        <div class="flex justify-between font-black text-green-800 mb-2"><span>Toplam Gelir</span><span>+ â‚º${totalInc.toLocaleString()}</span></div>
                        <div class="space-y-1 border-t border-green-200 pt-2">${incomeList || '<span class="text-xs italic opacity-50">Gelir kalemi yok</span>'}</div>
                    </div>

                    <div class="bg-red-50 p-4 rounded-2xl border border-red-100">
                        <div class="flex justify-between font-black text-red-800 mb-2"><span>Sabit Giderler (Fatura & Gizli Kredi)</span><span>- â‚º${totalFix.toLocaleString()}</span></div>
                        <div class="space-y-1 border-t border-red-200 pt-2">
                            ${billList}
                            ${hiddenLoanList}
                            ${(!billList && !hiddenLoanList) ? '<span class="text-xs italic opacity-50">Gider kalemi yok</span>' : ''}
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2 py-2">
                        <div class="h-px bg-gray-200 flex-1"></div>
                        <span class="text-xs font-bold text-gray-400 uppercase">Ara Toplam</span>
                        <div class="h-px bg-gray-200 flex-1"></div>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-2xl border border-gray-200 space-y-2">
                        <div class="flex justify-between text-sm font-bold text-gray-600"><span>DaÄŸÄ±tÄ±labilir Gelir:</span><span>â‚º${Math.floor(grossNet).toLocaleString()}</span></div>
                        
                        ${standardLoans > 0 ? `
                        <div class="border-t border-gray-200 pt-2">
                            <div class="flex justify-between font-black text-red-800 mb-1 text-xs"><span>Normal Kredi Taksitleri</span><span>- â‚º${standardLoans.toLocaleString()}</span></div>
                            ${standardLoanList}
                        </div>
                        <div class="flex justify-between text-sm font-bold text-gray-600 border-t border-gray-200 pt-2"><span>Kalan Net Gelir:</span><span>â‚º${Math.floor(netIncome).toLocaleString()}</span></div>
                        ` : ''}
                        
                        <div class="flex justify-between text-sm font-bold text-green-600 border-t border-gray-200 pt-2"><span>Hedeflenen Birikim:</span><span>- â‚º${Math.floor(savings).toLocaleString()}</span></div>
                        <div class="border-t border-gray-200 pt-2 flex justify-between text-base font-black text-blue-600"><span>Harcanabilir BÃ¼tÃ§e:</span><span>â‚º${Math.floor(monthlySpend).toLocaleString()}</span></div>
                    </div>

                    <div class="text-center pt-2">
                        <p class="text-[10px] text-gray-400 uppercase tracking-widest mb-1">GÃ¼nlÃ¼k Limit HesabÄ±</p>
                        <p class="text-xs font-bold text-gray-500">â‚º${Math.floor(monthlySpend).toLocaleString()} / ${daysInMonth} GÃ¼n</p>
                        <p class="text-2xl font-black text-blue-600 mt-1">â‚º${Math.floor(daily).toLocaleString()}</p>
                    </div>
                </div>`; 
            
            const modal = document.getElementById('calcModal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('open'), 10);
            document.getElementById('overlay').classList.add('active'); 
        }
        function closeCalcModal() { 
            const modal = document.getElementById('calcModal');
            modal.classList.remove('open');
            setTimeout(() => modal.classList.add('hidden'), 300);
            document.getElementById('overlay').classList.remove('active'); 
        }
        function closeAllPopups() { 
            document.getElementById('overlay').classList.remove('active'); 
            document.querySelectorAll('.fixed.z-50').forEach(el => { if(el.id !== 'saveIndicator') el.classList.add('hidden'); }); 
            document.querySelectorAll('.side-panel').forEach(el => { el.classList.remove('open'); setTimeout(() => el.classList.add('hidden'), 300); });
        }
    </script>
</body>
</html>
