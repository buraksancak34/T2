<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Birikim KoÃ§um | Gelir-Gider Takip</title>
    
    <!-- PWA ve Mobil Uygulama AyarlarÄ± -->
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2563eb">
    <meta name="application-name" content="Birikim KoÃ§um">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- FIREBASE SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc; 
            color: #1e293b;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
            overflow-x: hidden;
        }
        
        input, textarea { user-select: text; -webkit-user-select: text; }

        .glass-card { background: rgba(255, 255, 255, 0.95); border: 1px solid rgba(255,255,255,0.6); box-shadow: 0 10px 30px -10px rgba(0,0,0,0.1); backdrop-filter: blur(10px); }
        .hidden { display: none !important; }
        input[type="range"] { accent-color: #2563eb; }
        .overlay { background: rgba(0,0,0,0.6); opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .overlay.active { opacity: 1; pointer-events: auto; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .health-detail { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .health-detail.open { max-height: 1000px; transition: max-height 0.5s ease-in; }
        
        .fade-text { animation: textFade 0.5s ease-in-out; }
        @keyframes textFade { 0% { opacity: 0; } 100% { opacity: 1; } }

        @keyframes pulse-red { 0%, 100% { color: #ef4444; text-shadow: 0 0 5px rgba(239, 68, 68, 0.2); } 50% { color: #fca5a5; text-shadow: 0 0 15px rgba(239, 68, 68, 0.6); } }
        @keyframes pulse-green { 0%, 100% { color: #16a34a; text-shadow: 0 0 5px rgba(22, 163, 74, 0.2); } 50% { color: #86efac; text-shadow: 0 0 15px rgba(22, 163, 74, 0.6); } }
        .animate-pulse-red { animation: pulse-red 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .animate-pulse-green { animation: pulse-green 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }

        .side-panel {
            position: fixed; top: 0; right: 0; height: 100%; width: 100%; max-width: 28rem; 
            background: white; z-index: 60; box-shadow: -10px 0 30px rgba(0,0,0,0.1);
            transform: translateX(100%); transition: transform 0.3s ease-in-out;
            display: flex; flex-direction: column;
        }
        .side-panel.open { transform: translateX(0); }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col items-center justify-center bg-slate-50">

    <div id="overlay" class="overlay fixed inset-0 z-40" onclick="closeAllPopups()"></div>
    
    <div id="saveIndicator" class="fixed bottom-4 right-4 bg-white px-4 py-2 rounded-full shadow-lg border border-gray-100 flex items-center gap-2 text-xs font-bold text-gray-500 opacity-0 transition-opacity duration-500 pointer-events-none z-50">
        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div> Kaydedildi
    </div>

    <!-- 1. GÄ°RÄ°Åž EKRANI -->
    <!-- DÃœZELTME: overflow-hidden kaldÄ±rÄ±ldÄ± -->
    <div id="loginScreen" class="max-w-md w-full glass-card p-10 rounded-[2.5rem] shadow-2xl space-y-6 my-auto relative animate-fade-in">
        <div class="text-center">
            <!-- LOGO ALANI -->
            <div class="mx-auto mb-6 w-full max-w-[200px] h-auto hover:scale-105 transition-transform duration-300">
                <img src="logo.png" alt="Birikim KoÃ§um Logo" class="w-full h-full object-contain drop-shadow-xl" 
                     onerror="this.src='https://cdn-icons-png.flaticon.com/512/2382/2382461.png'; this.parentElement.classList.add('opacity-80');">
            </div>
            
            <h1 class="text-3xl font-black text-gray-900 tracking-tight mb-1" id="loginTitle">Birikim KoÃ§um</h1>
            <p class="text-blue-500 text-xs font-bold uppercase tracking-widest" id="loginSubtitle">Gelir - Gider Takip AsistanÄ±</p>
        </div>
        
        <div class="space-y-3 mt-8" id="authFormContainer">
            <div id="registerFields" class="hidden space-y-3">
                <input type="text" id="regUsernameInput" class="w-full p-4 bg-white border border-gray-200 rounded-2xl focus:ring-4 focus:ring-blue-100 outline-none font-bold text-gray-700 transition-all text-sm" placeholder="KullanÄ±cÄ± AdÄ± Belirle (Zorunlu)">
                <input type="text" id="regInviteCode" class="w-full p-4 bg-white border border-gray-200 rounded-2xl focus:ring-4 focus:ring-blue-100 outline-none font-bold text-gray-700 transition-all text-sm" placeholder="Davet Kodu (Varsa)">
                <input type="number" id="regDailyLimit" class="w-full p-4 bg-blue-50 border border-blue-200 rounded-2xl focus:ring-4 focus:ring-blue-100 outline-none font-black text-blue-700 transition-all text-sm hidden placeholder-blue-400" placeholder="GÃ¼nlÃ¼k Harcama Hedefiniz (TL)">
            </div>
            
            <input type="text" id="emailInput" class="w-full p-4 bg-white border border-gray-200 rounded-2xl focus:ring-4 focus:ring-blue-100 outline-none font-bold text-gray-700 transition-all text-sm" placeholder="E-posta veya KullanÄ±cÄ± AdÄ±">
            <input type="password" id="passwordInput" class="w-full p-4 bg-white border border-gray-200 rounded-2xl focus:ring-4 focus:ring-blue-100 outline-none font-bold text-gray-700 transition-all text-sm" placeholder="Åžifre">
            
            <button id="loginBtn" onclick="firebaseLogin()" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl shadow-xl shadow-blue-200 active:scale-95 transition-all hover:bg-blue-700 flex justify-center items-center gap-2">
                <span>GiriÅŸ Yap</span>
            </button>
            
            <button id="registerBtn" onclick="firebaseRegister()" class="w-full bg-indigo-600 text-white font-black py-4 rounded-2xl shadow-xl hidden active:scale-95 transition-all hover:bg-indigo-700 flex justify-center items-center gap-2">
                <span>Ãœye Ol ve KatÄ±l</span>
            </button>
            
            <p id="forgotPassText" class="text-center text-[11px] font-bold text-blue-400 cursor-pointer hover:text-blue-600 pt-2" onclick="forgotPassword()">Åžifremi Unuttum?</p>

            <p id="backToLoginText" class="text-center text-xs font-bold text-gray-400 cursor-pointer hover:text-blue-500 hidden pt-2" onclick="showLoginMode()">
                <i class="fas fa-arrow-left mr-1"></i> GiriÅŸ ekranÄ±na dÃ¶n
            </p>
        </div>
        
        <div class="relative py-4">
            <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-200"></div></div>
            <div class="relative flex justify-center"><span class="bg-white px-4 text-xs font-bold text-gray-400 uppercase">veya</span></div>
        </div>

        <div class="space-y-3" id="actionButtons">
            <button onclick="startWizard(false)" class="w-full bg-green-500 text-white font-black py-4 rounded-2xl shadow-lg shadow-green-100 active:scale-95 transition-all hover:bg-green-600 flex items-center justify-center gap-2">
                <i class="fas fa-magic"></i> <span>Plana BaÅŸla</span>
            </button>
            
            <button onclick="showQuickRegisterMode()" class="w-full bg-slate-800 text-white font-bold py-3 px-4 rounded-2xl active:scale-95 transition-all hover:bg-slate-900 shadow-md flex items-center justify-center gap-3 text-xs leading-tight">
                <i class="fas fa-bolt text-yellow-400 text-lg"></i> <span class="text-left">Veri girmek istemiyorum,<br>sadece gÃ¼nlÃ¼k harcama hesaplayacaÄŸÄ±m</span>
            </button>

            <p class="text-[10px] text-center text-gray-400 px-4 mt-2">BÃ¼tÃ§eni oluÅŸturmaya baÅŸla, en son adÄ±mda kaydedip Ã¼ye ol.</p>
            <button onclick="showRegisterMode()" class="w-full bg-white border-2 border-gray-100 text-gray-600 font-bold py-3 rounded-2xl active:scale-95 transition-all hover:border-indigo-200 hover:text-indigo-600 mt-2">
                Bir Plana Dahil Ol
            </button>
        </div>

        <!-- GÄ°RÄ°Åž EKRANI BÄ°ZE ULAÅžIN (DÃœZELTME: z-index eklendi) -->
        <div class="mt-8 text-center pt-4 border-t border-gray-100 relative z-20">
            <button onclick="openContactModal()" class="text-[10px] font-bold text-gray-400 hover:text-blue-500 transition-colors py-2 px-4 cursor-pointer">
                <i class="fas fa-envelope mr-1"></i> Bize UlaÅŸÄ±n
            </button>
        </div>
    </div>

    <!-- 2. SÄ°HÄ°RBAZ (WIZARD) -->
    <div id="wizardScreen" class="max-w-xl w-full glass-card p-8 rounded-[2.5rem] shadow-2xl hidden space-y-6 my-auto relative animate-fade-in">
        <div class="flex justify-between items-center mb-4">
            <div id="wizardProgress" class="flex gap-1 flex-1 mr-4"></div>
            <span class="text-xs font-bold text-gray-300" id="stepCount">1/8</span>
        </div>
        <div id="wizardContent" class="min-h-[420px] flex flex-col relative"></div>
        <div class="flex gap-3 mt-4" id="wizardNavBtns">
             <button onclick="wizardBack()" class="flex-1 bg-gray-100 text-gray-600 font-bold py-4 rounded-2xl hover:bg-gray-200 transition-all">Geri</button>
             <button onclick="wizardNext()" id="wizNextBtn" class="flex-[2] bg-blue-600 text-white font-black py-4 rounded-2xl shadow-xl active:scale-95 transition-all hover:bg-blue-700">Devam Et</button>
        </div>
    </div>

    <!-- 3. DASHBOARD -->
    <div id="dashboardScreen" class="max-w-4xl w-full hidden space-y-8 pb-32 animate-fade-in">
        
        <!-- Esprili Mesaj AlanÄ± -->
        <div id="motivationArea" class="hidden w-full p-4 rounded-3xl bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 text-white shadow-lg animate-fade-in">
            <div class="flex items-start gap-3">
                <div class="text-2xl mt-1">ðŸ¤–</div>
                <div>
                    <p class="text-[10px] font-bold uppercase tracking-widest opacity-80 mb-1">Durum Raporu</p>
                    <p class="font-black text-sm md:text-base leading-tight" id="motivationText">...</p>
                </div>
            </div>
        </div>

        <!-- Davet Bildirim AfiÅŸi -->
        <div id="inviteBanner" class="hidden bg-indigo-600 text-white p-4 rounded-3xl shadow-lg flex flex-col sm:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center"><i class="fas fa-envelope-open-text"></i></div>
                <div>
                    <p class="text-[10px] text-indigo-200 font-bold uppercase tracking-widest">Yeni Plan Daveti</p>
                    <p class="font-black text-sm" id="inviteBannerText">Sizi planÄ±na davet ediyor.</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="rejectInvite()" class="px-5 py-2 bg-white/10 hover:bg-white/20 rounded-xl text-xs font-bold transition-colors">Reddet</button>
                <button onclick="acceptInvite()" class="px-5 py-2 bg-white text-indigo-600 hover:bg-indigo-50 rounded-xl text-xs font-black transition-colors shadow-sm">Kabul Et</button>
            </div>
        </div>

        <!-- ADMIN MOD UYARISI -->
        <div id="adminModeBanner" class="hidden bg-red-600 text-white p-3 rounded-xl shadow-lg mb-4 flex justify-between items-center animate-fade-in">
             <div class="flex items-center gap-2">
                 <i class="fas fa-user-secret text-xl"></i>
                 <div>
                     <p class="text-[10px] font-bold uppercase opacity-80">Admin Modu</p>
                     <p class="text-xs font-bold">Åžu an incelenen kullanÄ±cÄ±: <span id="adminInspectName" class="font-black underline">...</span></p>
                 </div>
             </div>
             <button onclick="exitAdminInspect()" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded-lg text-xs font-bold transition-colors">Ã‡Ä±kÄ±ÅŸ</button>
        </div>

        <div class="flex justify-between items-center">
            <div>
                <h2 class="text-2xl font-black text-gray-800 tracking-tight" id="dashWelcome">Panelim</h2>
                <div class="flex items-center gap-2">
                    <span id="roleBadge" class="text-[9px] font-black bg-blue-100 text-blue-600 px-2 py-0.5 rounded uppercase tracking-wide">YÃ¶netici</span>
                </div>
            </div>
            <div class="flex gap-2">
                <!-- ADMIN BUTONU -->
                <button onclick="openAdminPanel()" id="btnAdmin" class="hidden text-[10px] font-black bg-red-500 text-white border border-red-600 px-4 py-2 rounded-full uppercase tracking-widest shadow-sm hover:bg-red-600"><i class="fas fa-shield-alt"></i> Admin</button>
                
                <button onclick="showAnalysisScreen()" id="btnAnalysis" class="text-[10px] font-black bg-white text-indigo-500 border border-indigo-200 px-4 py-2 rounded-full uppercase tracking-widest shadow-sm hover:bg-indigo-50"><i class="fas fa-chart-pie"></i></button>
                <button onclick="showSettingsModal()" class="text-[10px] font-black bg-white text-gray-500 border border-gray-200 px-4 py-2 rounded-full uppercase tracking-widest shadow-sm hover:bg-gray-50"><i class="fas fa-cog"></i></button>
                <button onclick="handleLogout()" class="text-[10px] font-black bg-white text-red-500 border border-red-50 px-4 py-2 rounded-full uppercase tracking-widest shadow-sm hover:bg-red-50">Ã‡Ä±kÄ±ÅŸ</button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-2 glass-card p-8 rounded-[3rem] bg-gradient-to-br from-slate-800 to-slate-900 text-white shadow-2xl relative overflow-hidden group">
                <div class="absolute top-0 right-0 w-64 h-64 bg-blue-500 rounded-full mix-blend-overlay filter blur-3xl opacity-20 -mr-16 -mt-16"></div>
                <div class="relative z-10">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest opacity-80">BugÃ¼nÃ¼n Limiti</p>
                                <!-- DÃœZELTME: onclick eklendi, z-index artÄ±rÄ±ldÄ± -->
                                <button onclick="openCalcModal()" class="text-blue-300 hover:text-white text-[9px] font-bold underline decoration-dashed underline-offset-2 transition-colors cursor-pointer relative z-50">NasÄ±l HesaplandÄ±?</button>
                            </div>
                            <h2 id="displayDailyLimit" class="text-6xl font-black tracking-tighter leading-none">â‚º0</h2>
                        </div>
                        <div class="text-right">
                            <p onclick="openBalanceModal()" class="text-blue-400 text-[10px] font-bold uppercase tracking-widest mb-1 underline decoration-dashed underline-offset-4 cursor-pointer hover:text-blue-200 transition-colors" title="Detay iÃ§in tÄ±kla">GerÃ§ek Bakiye</p>
                            <h4 id="displayCumulativeLimit" onclick="openBalanceModal()" class="text-4xl font-black text-white tracking-tight cursor-pointer">â‚º0</h4>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 mt-8 pt-6 border-t border-white/10">
                        <div class="bg-white/10 px-4 py-2 rounded-xl backdrop-blur-md border border-white/5">
                            <span class="text-[9px] text-slate-300 font-bold uppercase block">MaaÅŸa Kalan</span>
                            <span id="displayRemainingDays" class="text-lg font-black text-white">-- GÃ¼n</span>
                        </div>
                         <div class="bg-white/10 px-4 py-2 rounded-xl backdrop-blur-md border border-white/5">
                            <span class="text-[9px] text-slate-300 font-bold uppercase block">Hedef Birikim</span>
                            <span id="sumSavings" class="text-lg font-black text-green-400">â‚º0</span>
                        </div>
                        <!-- DÃœZELTME: z-index artÄ±rÄ±ldÄ±, onclick garantilendi -->
                        <button onclick="startWizard(true)" id="btnEditPlan" class="bg-white/10 px-4 py-2 rounded-xl backdrop-blur-md border border-white/5 hover:bg-white/20 transition-all flex flex-col items-center justify-center min-w-[80px] relative z-50 cursor-pointer">
                            <i class="fas fa-pen text-sm mb-1 text-slate-300"></i>
                            <span class="text-[9px] text-slate-300 font-bold uppercase block">DÃ¼zenle</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Aile YÃ¶netimi Paneli -->
            <div id="familyPanel" class="glass-card p-6 rounded-[3rem] flex flex-col bg-white border border-blue-50">
                <div class="flex justify-between items-center mb-4 border-b pb-4">
                    <h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Aile Sistemi</h4>
                    <button onclick="createInviteCode()" class="text-[9px] font-bold text-blue-500 bg-blue-50 px-2 py-1 rounded-md hover:bg-blue-100 transition-colors">Kod: <span id="displayInviteCode">-----</span></button>
                </div>
                <div class="flex flex-col gap-2 mb-2">
                    <input type="text" id="famInput" class="w-full p-2 bg-gray-50 rounded-lg font-bold text-xs outline-none border border-gray-100" placeholder="KullanÄ±cÄ± AdÄ±/E-posta">
                    <div class="flex gap-2">
                        <select id="famRole" class="flex-1 p-2 bg-white border border-gray-100 rounded-lg text-xs font-bold text-gray-600 outline-none">
                            <option value="full">Tam Yetki</option>
                            <option value="limited">SÄ±nÄ±rlÄ±</option>
                        </select>
                        <button onclick="addFamilyMember()" class="bg-orange-500 text-white font-black px-4 rounded-lg hover:bg-orange-600 transition-all text-xs">Ekle</button>
                    </div>
                </div>
                <div id="familyList" class="space-y-2 flex-1 overflow-y-auto max-h-[120px] custom-scrollbar pr-1 mt-2"></div>
            </div>
        </div>

        <div class="glass-card p-8 rounded-[2.5rem] bg-white border border-gray-100 shadow-lg">
            <div class="flex items-center justify-between mb-6">
                <h3 class="font-black text-xl text-gray-800">Harcama Ekle</h3>
                <span id="todayTotal" class="text-[10px] font-bold bg-blue-100 text-blue-700 px-3 py-1 rounded-lg uppercase tracking-wide">BugÃ¼n: â‚º0</span>
            </div>
            
            <div class="flex flex-col gap-3">
                <div class="flex gap-2 items-center">
                    <div class="w-1/3 relative">
                        <select id="expCat" class="w-full p-4 bg-gray-50 rounded-l-2xl font-bold text-xs text-gray-700 outline-none focus:ring-4 focus:ring-blue-100 transition-all border-r border-gray-200 appearance-none">
                             <!-- Categories will be injected here -->
                        </select>
                        <button onclick="openCategoryModal()" class="absolute right-0 top-0 h-full px-2 text-gray-400 hover:text-blue-500 rounded-r-2xl bg-white border-l border-gray-100" title="Kategorileri DÃ¼zenle">
                            <i class="fas fa-pencil-alt text-xs"></i>
                        </button>
                    </div>
                    <input type="text" id="expDesc" value="" placeholder="AÃ§Ä±klama (Opsiyonel)" onkeyup="if(event.key === 'Enter') addExpense()" class="flex-1 p-4 bg-gray-50 rounded-2xl font-bold text-gray-600 outline-none focus:ring-2 focus:ring-blue-500 transition-all text-sm">
                </div>
                
                <div class="flex gap-2 items-center">
                     <input type="number" id="expAmt" placeholder="Tutar (â‚º)" onkeyup="if(event.key === 'Enter') addExpense()" class="flex-1 p-4 bg-gray-50 rounded-2xl font-black text-lg outline-none focus:ring-4 focus:ring-blue-100 transition-all">
                     <input type="hidden" id="editExpIndex" value="-1">
                     <button id="addExpBtn" onclick="addExpense()" class="bg-blue-600 text-white w-16 rounded-2xl hover:bg-blue-700 active:scale-90 transition-all shadow-lg shadow-blue-200 flex items-center justify-center shrink-0 p-4"><i class="fas fa-plus text-xl"></i></button>
                </div>
                
                <!-- HÄ±zlÄ± Tarih SeÃ§ici -->
                <div class="flex items-center gap-2 bg-gray-50 p-2 rounded-xl border border-gray-100 w-full md:w-auto self-start mt-1">
                    <button onclick="changeExpenseDate(1)" class="w-8 h-8 flex items-center justify-center bg-white rounded-lg text-gray-500 hover:text-blue-600 shadow-sm transition-colors border border-gray-200"><i class="fas fa-chevron-left"></i></button>
                    <div class="relative flex-1 text-center min-w-[160px]">
                        <span id="expenseDateLabel" class="text-xs font-bold text-gray-600 cursor-pointer hover:text-blue-500 select-none" onclick="document.getElementById('expDateInputHidden').showPicker()">BugÃ¼n</span>
                        <input type="date" id="expDateInputHidden" class="absolute inset-0 opacity-0 cursor-pointer" onchange="setSpecificDate(this.value)">
                    </div>
                    <button onclick="changeExpenseDate(-1)" class="w-8 h-8 flex items-center justify-center bg-white rounded-lg text-gray-500 hover:text-blue-600 shadow-sm transition-colors border border-gray-200"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        </div>

        <div class="glass-card p-8 rounded-[3rem] shadow-xl bg-white border border-gray-100">
            <h3 class="font-black text-xl text-gray-800 uppercase tracking-widest text-[11px] mb-4">Harcama GeÃ§miÅŸi</h3>
            <div id="historyList" class="pb-4"></div>
        </div>

        <div id="financialHealthSection" class="glass-card p-10 rounded-[3rem] space-y-8 bg-white border border-blue-50 shadow-xl">
            <div class="flex flex-col items-center border-b pb-8">
                <h3 class="font-black text-3xl text-gray-800 mb-2">Finansal SaÄŸlÄ±k</h3>
                <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mb-4">Net VarlÄ±k (VarlÄ±k - BorÃ§)</p>
                <div id="netStatusBadge" class="text-4xl font-black text-gray-800 px-8 py-4 bg-gray-50 rounded-[2rem] transition-colors">
                    <span id="netStatusVal">â‚º0</span>
                </div>
                
                <div class="flex items-center justify-center mt-6">
                    <div class="text-center"><span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">AylÄ±k Sabit Gider</span><br><span id="sumGiderTotalHealth" class="text-xl font-black text-red-600">â‚º0</span></div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- BORÃ‡LAR -->
                <div class="space-y-4">
                    <div class="flex items-center gap-2 mb-2 pb-2 border-b border-red-100">
                        <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                        <span class="text-xs font-black text-red-600 uppercase tracking-widest">BorÃ§lar & Krediler</span>
                    </div>
                    <div id="detailedDebtsList" class="space-y-3 min-h-[50px]"></div>
                    
                    <div class="mt-4">
                        <button id="btnShowdashDebtForm" onclick="toggleInlineAdd('dashDebt')" class="w-full py-2 text-[10px] font-bold text-gray-400 hover:text-gray-600 border border-dashed border-gray-300 rounded-lg transition-colors">+ Yeni BorÃ§ Ekle</button>
                        <div id="inlineAdddashDebtContainer" class="hidden mt-2 p-4 border border-red-100 bg-red-50/50 rounded-xl space-y-3 shadow-inner">
                            <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">BorÃ§ TÃ¼rÃ¼</label>
                            <select id="dashDebtType" onchange="handleInlineTypeChange('dashDebt')" class="w-full p-2.5 bg-white rounded-lg text-xs font-bold border border-gray-200 outline-none focus:ring-2 focus:ring-blue-100">
                                <option value="Kredi">Kredi</option>
                                <option value="Kredi KartÄ±">Kredi KartÄ±</option>
                                <option value="AltÄ±n">AltÄ±n</option>
                                <option value="DÃ¶viz">DÃ¶viz</option>
                                <option value="GÃ¼mÃ¼ÅŸ">GÃ¼mÃ¼ÅŸ</option>
                                <option value="DiÄŸer">DiÄŸer</option>
                            </select>
                            <div id="dashDebtFields" class="space-y-2"></div>
                            <div class="flex gap-2 pt-2">
                                <button onclick="cancelInlineAdd('dashDebt')" class="flex-1 bg-white border border-gray-200 text-gray-600 rounded-lg py-2 text-xs font-bold hover:bg-gray-50">Ä°ptal</button>
                                <button onclick="saveInlineAdd('dashDebt')" class="flex-1 bg-red-500 text-white rounded-lg py-2 text-xs font-black hover:bg-red-600">Kaydet</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VARLIKLAR -->
                <div class="space-y-4">
                    <div class="flex items-center gap-2 mb-2 pb-2 border-b border-green-100">
                        <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                        <span class="text-xs font-black text-green-600 uppercase tracking-widest">VarlÄ±klar & Birikim</span>
                    </div>
                    <div id="detailedAssetsList" class="space-y-3 min-h-[50px]"></div>

                    <div class="mt-4">
                        <button id="btnShowdashAssetForm" onclick="toggleInlineAdd('dashAsset')" class="w-full py-2 text-[10px] font-bold text-gray-400 hover:text-gray-600 border border-dashed border-gray-300 rounded-lg transition-colors">+ Yeni VarlÄ±k Ekle</button>
                        <div id="inlineAdddashAssetContainer" class="hidden mt-2 p-4 border border-green-100 bg-green-50/50 rounded-xl space-y-3 shadow-inner">
                            <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">VarlÄ±k TÃ¼rÃ¼</label>
                            <select id="dashAssetType" onchange="handleInlineTypeChange('dashAsset')" class="w-full p-2.5 bg-white rounded-lg text-xs font-bold border border-gray-200 outline-none focus:ring-2 focus:ring-blue-100">
                                <option value="DiÄŸer">DiÄŸer (Standart TL)</option>
                                <option value="AltÄ±n">AltÄ±n</option>
                                <option value="DÃ¶viz">DÃ¶viz</option>
                                <option value="GÃ¼mÃ¼ÅŸ">GÃ¼mÃ¼ÅŸ</option>
                            </select>
                            <div id="dashAssetFields" class="space-y-2"></div>
                            <div class="flex gap-2 pt-2">
                                <button onclick="cancelInlineAdd('dashAsset')" class="flex-1 bg-white border border-gray-200 text-gray-600 rounded-lg py-2 text-xs font-bold hover:bg-gray-50">Ä°ptal</button>
                                <button onclick="saveInlineAdd('dashAsset')" class="flex-1 bg-green-500 text-white rounded-lg py-2 text-xs font-black hover:bg-green-600">Kaydet</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- SABÄ°T GÄ°DERLER AKORDÄ°YONU -->
            <div id="fixedExpensesSection" class="w-full pt-4"></div>
            
            <!-- DASHBOARD BÄ°ZE ULAÅžIN -->
            <div class="text-center mt-6 pt-6 border-t border-gray-100">
                <button onclick="openContactModal()" class="text-xs font-bold text-gray-400 hover:text-blue-500 transition-colors">
                    <i class="fas fa-comment-alt mr-1"></i> GÃ¶rÃ¼ÅŸ ve Ã–neri Bildir
                </button>
            </div>
        </div>
    </div>

    <!-- 4. ANALÄ°Z EKRANI -->
    <div id="analysisScreen" class="max-w-4xl w-full hidden space-y-8 pb-32 animate-fade-in my-auto">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-2xl font-black text-gray-800 tracking-tight">Finansal Analiz</h2>
                <div class="flex items-center gap-3 mt-2">
                     <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Analiz DÃ¶nemi:</p>
                     <input type="month" id="analysisDateFilter" class="bg-gray-100 text-gray-700 text-xs font-bold p-1 rounded-lg border-none outline-none" onchange="renderCharts()">
                </div>
                <p id="analysisPeriodLabel" class="text-[10px] text-blue-500 font-bold mt-1"></p>
            </div>
            <button onclick="showDashboard()" class="text-[10px] font-black bg-gray-100 text-gray-600 border border-gray-200 px-4 py-2 rounded-full uppercase tracking-widest shadow-sm hover:bg-gray-200">Geri DÃ¶n</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="glass-card p-6 rounded-[2.5rem] bg-white border border-gray-100 shadow-lg"><h3 class="font-black text-lg text-gray-800 mb-4 text-center">VarlÄ±k vs BorÃ§</h3><div class="h-64"><canvas id="assetsChart"></canvas></div></div>
            <div class="glass-card p-6 rounded-[2.5rem] bg-white border border-gray-100 shadow-lg"><h3 class="font-black text-lg text-gray-800 mb-4 text-center">Harcama DaÄŸÄ±lÄ±mÄ±</h3><div class="h-64"><canvas id="expensesChart"></canvas></div></div>
        </div>
        
        <!-- YENÄ° TREND GRAFÄ°ÄžÄ° -->
        <div class="glass-card p-6 rounded-[2.5rem] bg-white border border-gray-100 shadow-lg mt-6">
             <div class="flex justify-between items-center mb-4">
                 <h3 class="font-black text-lg text-gray-800 text-center flex-1">VarlÄ±k & BorÃ§ DeÄŸiÅŸimi (AylÄ±k Trend)</h3>
                 <div class="flex gap-2">
                     <button onclick="switchChartMode('TL')" id="btnChartTL" class="text-[10px] font-bold px-2 py-1 rounded bg-blue-100 text-blue-600">TL BazlÄ±</button>
                     <button onclick="switchChartMode('USD')" id="btnChartUSD" class="text-[10px] font-bold px-2 py-1 rounded bg-gray-100 text-gray-500 hover:bg-green-100 hover:text-green-600">USD BazlÄ±</button>
                 </div>
             </div>
             <div class="h-64"><canvas id="historyTrendChart"></canvas></div>
        </div>

        <div class="glass-card p-8 rounded-[2.5rem] bg-white border border-gray-100 shadow-lg">
            <h3 class="font-black text-xl text-gray-800 mb-4 border-b pb-2">GeÃ§miÅŸ KayÄ±t Ekle</h3>
            <div class="grid grid-cols-1 sm:grid-cols-5 gap-4 items-end">
                <div><label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">DÃ¶nem</label><input type="month" id="histDate" class="w-full p-3 bg-gray-50 rounded-xl font-bold text-sm outline-none"></div>
                <div><label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">VarlÄ±k (TL)</label><input type="number" id="histAssets" placeholder="0" class="w-full p-3 bg-gray-50 rounded-xl font-bold text-sm outline-none text-green-600"></div>
                <div><label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">BorÃ§ (TL)</label><input type="number" id="histDebts" placeholder="0" class="w-full p-3 bg-gray-50 rounded-xl font-bold text-sm outline-none text-red-600"></div>
                <!-- YENÄ° DOLAR KURU GÄ°RÄ°ÅžÄ° -->
                <div><label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Dolar Kuru</label><input type="number" step="0.01" id="histUSDRate" placeholder="Ã–rn: 30.50" class="w-full p-3 bg-blue-50 rounded-xl font-bold text-sm outline-none text-blue-600"></div>
                
                <button onclick="addHistoryRecord()" class="bg-indigo-600 text-white font-black py-3 rounded-xl shadow-lg hover:bg-indigo-700 active:scale-95 transition-all">Kaydet</button>
            </div>
            <!-- GEÃ‡MÄ°Åž KAYITLAR TABLOSU -->
            <div class="mt-6">
                <h4 class="text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">Eklenen KayÄ±tlar</h4>
                <div class="overflow-x-auto">
                    <table class="w-full text-xs text-left">
                        <thead class="text-gray-400 border-b">
                            <tr>
                                <th class="pb-2">DÃ¶nem</th>
                                <th class="pb-2 text-right">VarlÄ±k</th>
                                <th class="pb-2 text-right">BorÃ§</th>
                                <th class="pb-2 text-right">Kur</th>
                                <th class="pb-2 text-center">Ä°ÅŸlem</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody" class="font-bold text-gray-700"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- AYARLAR MODALI -->
    <div id="settingsModal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-sm glass-card p-8 rounded-[2rem] z-50 shadow-2xl hidden border-2 border-gray-100 animate-fade-in">
        <div class="flex justify-between items-center mb-6">
            <h4 class="font-black text-xl text-gray-800 tracking-tight">Ayarlar</h4>
            <button onclick="closeSettingsModal()" class="text-gray-300 hover:text-red-500"><i class="fas fa-times"></i></button>
        </div>

        <div class="space-y-6">
            <div class="p-4 bg-gray-50 rounded-xl border border-gray-100 text-center">
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Mevcut Plan StatÃ¼sÃ¼</p>
                <p class="font-black text-blue-600 text-sm" id="settingsCurrentPlanLabel">Kendi PlanÄ±nÄ±z (YÃ¶netici)</p>
                <button id="btnLeavePlan" onclick="leaveCurrentPlan()" class="hidden mt-3 text-[10px] font-bold text-red-500 bg-red-50 px-3 py-1.5 rounded-lg w-full hover:bg-red-100 transition-colors">Ortak Plandan AyrÄ±l</button>
            </div>

            <div class="space-y-2">
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Davet Kodu Ä°le BaÅŸka Plana KatÄ±l</p>
                <input type="text" id="settingsInviteCode" class="w-full p-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-100 outline-none font-bold text-gray-700 transition-all text-sm" placeholder="Davet Kodunu Girin">
                <button onclick="joinPlanByCode()" class="w-full bg-blue-600 text-white font-black py-3 rounded-xl shadow-lg hover:bg-blue-700 active:scale-95 transition-all text-sm">KatÄ±l</button>
            </div>
        </div>
    </div>

    <!-- ADMIN PANELI (YAN PANEL) -->
    <!-- DÃœZELTME: hidden class'Ä± eklendi -->
    <div id="adminModal" class="side-panel hidden">
        <div class="p-6 h-full flex flex-col bg-slate-900 text-white">
            <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-700">
                <h4 class="font-black text-xl tracking-tight text-white"><i class="fas fa-shield-alt mr-2"></i> Admin Paneli</h4>
                <div>
                     <button onclick="loadAdminUsers()" class="text-slate-400 hover:text-white mr-3"><i class="fas fa-sync-alt"></i></button>
                     <button onclick="closeAdminPanel()" class="text-slate-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
                </div>
            </div>
            
            <!-- ADMIN TABS -->
            <div class="flex gap-2 mb-4 bg-slate-800 p-1 rounded-xl">
                <button onclick="switchAdminTab('users')" id="tabAdminUsers" class="flex-1 py-2 text-xs font-bold rounded-lg bg-blue-600 text-white shadow-sm transition-all">KullanÄ±cÄ±lar</button>
                <button onclick="switchAdminTab('messages')" id="tabAdminMessages" class="flex-1 py-2 text-xs font-bold rounded-lg text-slate-400 hover:text-white transition-all">Mesajlar</button>
            </div>

            <!-- TAB: KULLANICILAR -->
            <div id="adminTabUsers" class="flex-1 flex flex-col min-h-0 overflow-hidden">
                <div class="grid grid-cols-2 gap-4 mb-6 flex-shrink-0">
                    <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                        <p class="text-[9px] font-bold uppercase text-slate-400">KullanÄ±cÄ±lar</p>
                        <p class="text-2xl font-black text-white" id="adminTotalUsers">-</p>
                    </div>
                     <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                        <p class="text-[9px] font-bold uppercase text-slate-400">YÃ¶netilen Para</p>
                        <p class="text-xl font-black text-green-400" id="adminTotalMoney">-</p>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto custom-scrollbar pb-10">
                    <table class="w-full text-xs text-left">
                         <thead class="text-slate-500 font-bold uppercase border-b border-slate-700 sticky top-0 bg-slate-900">
                             <tr><th class="pb-3 pl-1">KullanÄ±cÄ±</th><th class="pb-3 text-right">Ä°ÅŸlem</th></tr>
                         </thead>
                         <tbody id="adminUserList" class="font-bold text-slate-300"></tbody>
                     </table>
                </div>
            </div>

            <!-- TAB: MESAJLAR -->
            <div id="adminTabMessages" class="hidden flex-1 flex flex-col min-h-0 overflow-hidden">
                 <div class="flex-1 overflow-y-auto custom-scrollbar pb-10 space-y-3" id="adminMessageList">
                     <!-- Mesajlar Buraya Gelecek -->
                 </div>
            </div>
        </div>
    </div>

    <!-- DÃœZENLEME MODALI (YAN PANEL) -->
    <!-- DÃœZELTME: hidden class'Ä± eklendi -->
    <div id="editItemModal" class="side-panel hidden">
        <div class="p-6 h-full flex flex-col">
            <div class="flex justify-between items-center mb-6 pb-4 border-b">
                <h4 class="font-black text-xl text-gray-800 tracking-tight">DÃ¼zenle</h4>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto custom-scrollbar pb-10">
                <div class="space-y-4">
                    <input type="text" id="editItemName" class="w-full p-4 bg-gray-50 rounded-xl font-bold text-sm border border-gray-100" placeholder="Ä°sim">
                    <input type="number" id="editItemVal" class="w-full p-4 bg-gray-50 rounded-xl font-bold text-sm border border-gray-100" placeholder="Toplam Tutar">
                    
                    <div class="p-4 bg-blue-50 rounded-xl border border-blue-100 flex items-center gap-3">
                         <input type="checkbox" id="editExcludeNetWorth" class="w-5 h-5 rounded text-blue-600 focus:ring-blue-500">
                         <label for="editExcludeNetWorth" class="text-xs font-bold text-gray-600">Net VarlÄ±k HesabÄ±na Katma</label>
                    </div>
                    
                    <input type="hidden" id="editItemType"><input type="hidden" id="editItemIndex">
                    <div class="flex gap-2 pt-4">
                        <button onclick="closeEditModal()" class="flex-1 py-3 bg-gray-100 text-gray-600 font-bold rounded-xl border border-gray-200">Ä°ptal</button>
                        <button onclick="saveEditedItem()" class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg shadow-blue-200">Kaydet</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- HESAPLAMA DETAY YAN PANELÄ° -->
    <!-- DÃœZELTME: hidden class'Ä± eklendi -->
    <div id="calcModal" class="side-panel hidden">
        <div class="p-6 h-full flex flex-col">
            <div class="flex justify-between items-center mb-6 pb-4 border-b">
                <h4 class="font-black text-xl text-gray-800 tracking-tight">NasÄ±l HesaplandÄ±?</h4>
                <button onclick="closeCalcModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="calcModalContent" class="space-y-4 text-sm flex-1 overflow-y-auto custom-scrollbar pb-10"></div>
        </div>
    </div>

    <!-- GERÃ‡EK BAKÄ°YE DETAY YAN PANELÄ° -->
    <!-- DÃœZELTME: hidden class'Ä± eklendi -->
    <div id="balanceModal" class="side-panel hidden">
        <div class="p-6 h-full flex flex-col">
            <div class="flex justify-between items-center mb-6 pb-4 border-b">
                <h4 class="font-black text-xl text-gray-800 tracking-tight">GerÃ§ek Bakiye</h4>
                <button onclick="closeBalanceModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="balanceModalContent" class="space-y-4 text-sm flex-1 overflow-y-auto custom-scrollbar pb-10"></div>
        </div>
    </div>

    <!-- KREDÄ° Ã–DEME PLANI YAN PANELÄ° -->
    <!-- DÃœZELTME: hidden class'Ä± eklendi -->
    <div id="loanPlanModal" class="side-panel hidden">
        <div class="p-6 h-full flex flex-col">
            <div class="flex justify-between items-center mb-6 pb-4 border-b">
                <div>
                    <span class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Kredi DetayÄ±</span>
                    <h4 class="font-black text-xl text-gray-800 tracking-tight leading-none" id="loanPlanTitle">Ã–deme PlanÄ±</h4>
                </div>
                <button onclick="closeLoanPlanModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto custom-scrollbar pb-10">
                 <table class="w-full text-xs text-left">
                     <thead class="text-gray-400 font-bold uppercase border-b sticky top-0 bg-white"><tr><th class="pb-3 pl-2">Tak.</th><th class="pb-3">Tarih</th><th class="pb-3 text-right">Tutar</th><th class="pb-3 text-center">Durum</th></tr></thead>
                     <tbody id="loanPlanBody" class="font-bold text-gray-600"></tbody>
                 </table>
            </div>
        </div>
    </div>

    <!-- KATEGORÄ° DÃœZENLEME PANELÄ° -->
    <!-- DÃœZELTME: hidden class'Ä± eklendi -->
    <div id="categoryModal" class="side-panel hidden">
        <div class="p-6 h-full flex flex-col">
             <div class="flex justify-between items-center mb-6 pb-4 border-b">
                <h4 class="font-black text-xl text-gray-800 tracking-tight">Kategoriler</h4>
                <button onclick="closeCategoryModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="flex gap-2 mb-4">
                <input type="text" id="newCatName" placeholder="Yeni Kategori Ekle" class="flex-1 p-3 bg-gray-50 border rounded-xl text-sm font-bold outline-none" onkeyup="if(event.key==='Enter') addNewCategory()">
                <button onclick="addNewCategory()" class="bg-blue-600 text-white w-12 rounded-xl flex items-center justify-center hover:bg-blue-700 shadow-lg"><i class="fas fa-plus"></i></button>
            </div>
            
            <div id="categoryList" class="flex-1 overflow-y-auto custom-scrollbar space-y-2 pb-10"></div>
        </div>
    </div>

    <!-- Ä°LETÄ°ÅžÄ°M MODALI (MESAJ GÃ–NDERME) -->
    <!-- DÃœZELTME: hidden class'Ä± eklendi -->
    <div id="contactModal" class="side-panel hidden">
        <div class="p-6 h-full flex flex-col">
            <div class="flex justify-between items-center mb-6 pb-4 border-b">
                <h4 class="font-black text-xl text-gray-800 tracking-tight">Bize UlaÅŸÄ±n</h4>
                <button onclick="closeContactModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="flex-1 flex flex-col gap-4">
                <p class="text-sm text-gray-500">GÃ¶rÃ¼ÅŸ, Ã¶neri veya ÅŸikayetlerinizi bizimle paylaÅŸÄ±n. Size en kÄ±sa sÃ¼rede dÃ¶nÃ¼ÅŸ yapacaÄŸÄ±z.</p>
                <textarea id="contactMsg" rows="6" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-2xl text-sm font-bold text-gray-700 outline-none focus:ring-4 focus:ring-blue-100 transition-all resize-none" placeholder="MesajÄ±nÄ±z..."></textarea>
                <button onclick="sendContactMessage()" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl shadow-xl active:scale-95 transition-all hover:bg-blue-700">GÃ–NDER</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAyUQaeoVWnT4AuzSwD2M17-z1g2optqdA",
            authDomain: "hesapguvende-b07ca.firebaseapp.com",
            projectId: "hesapguvende-b07ca",
            storageBucket: "hesapguvende-b07ca.firebasestorage.app",
            messagingSenderId: "710002620092",
            appId: "1:710002620092:web:94f3ebb8dd2461af29c2b9",
            measurementId: "G-VE0EVVBM0V"
        };
        
        // ... (DeÄŸiÅŸmeyen JS kÄ±sÄ±mlarÄ±) ... 
        const financialTips = [ /* ... */ ];
        const messages_highSpend = [ /* ... */ ];
        const messages_lowSavings = [ /* ... */ ];
        const messages_streak = [ /* ... */ ];
        // ...
        let db, auth, currentUser = null;
        let currentPlanId = null; 
        let currentUserRole = 'owner';
        let isFirebaseReady = false;
        let isRegistering = false; 
        let assetsChartInstance = null;
        let expensesChartInstance = null;
        let historyChartInstance = null; 
        let adviceInterval = null;
        window.userInvites = [];
        window.currentHistoryDateIndex = 0;
        let currentExpenseDateOffset = 0;
        let editingCategoryIndex = -1; 
        let originalAdminUid = null;
        let currentChartMode = 'TL'; // Grafik Modu (TL veya USD)

        const defaultState = {
            step: 1, salaryDay: 15,
            registrationDate: new Date().toISOString(),
            incomes: [{ name: 'MaaÅŸ', val: null }], 
            bills: [
                { name: 'Kira', val: null }, { name: 'Aidat', val: null }, { name: 'Elektrik', val: null },
                { name: 'Su', val: null }, { name: 'DoÄŸalgaz', val: null }, { name: 'Ä°nternet', val: null },
                { name: 'Telefon', val: null }, { name: 'Bireysel Emeklilik (AylÄ±k)', val: null }
            ], 
            loans: [], debts: [], 
            otherDebts: [{ name: 'KMH / Avans Hesap (- Bakiye)', val: null }], 
            assets: [
                { name: 'Bankadaki Para', val: null }, { name: 'Cepteki Para', val: null }, { name: 'Bireysel Emeklilik (Toplam)', val: null }
            ],
            categories: ["Market / Manav", "Kasap", "AkaryakÄ±t", "Eczane / SaÄŸlÄ±k", "EÄŸlence", "EÄŸitim Ã–demeleri", "Vergi / HarÃ§ / Sigorta", "DiÄŸer"],
            manualDailyLimit: null, expenses: [], monthlyHistory: [], familyMembers: [], inviteCode: null
        };
        let state = JSON.parse(JSON.stringify(defaultState));

        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            isFirebaseReady = true;
            
            auth.onAuthStateChanged(async user => {
                if (user) {
                    currentUser = user;
                    const name = user.displayName || user.email.split('@')[0];
                    document.getElementById('dashWelcome').innerText = `HoÅŸgeldin, ${name}`;
                    
                    if (user.email.toLowerCase() === 'buraksancak@msn.com') {
                        document.getElementById('btnAdmin').classList.remove('hidden');
                    } else {
                        document.getElementById('btnAdmin').classList.add('hidden');
                    }

                    try {
                        const userDoc = await db.collection("users").doc(user.uid).get();
                        if(userDoc.exists && userDoc.data().pendingInvites) {
                            window.userInvites = userDoc.data().pendingInvites;
                        }
                    } catch(e) {}
                    
                    if (!originalAdminUid) await initUserPlan(); 
                    startAdviceRotator();
                } else {
                    currentUser = null;
                    clearInterval(adviceInterval);
                    showLoginScreen();
                }
            });
        } catch(e) { console.error("Firebase Init Error:", e); }

        function hideAll() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('wizardScreen').classList.add('hidden');
            document.getElementById('dashboardScreen').classList.add('hidden');
            document.getElementById('analysisScreen').classList.add('hidden');
        }

        // --- Ä°LETÄ°ÅžÄ°M / MESAJLAÅžMA ---
        function openContactModal() {
            document.getElementById('contactMsg').value = '';
            const modal = document.getElementById('contactModal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('open'), 10);
            document.getElementById('overlay').classList.add('active');
        }

        function closeContactModal() {
            const modal = document.getElementById('contactModal');
            modal.classList.remove('open');
            setTimeout(() => modal.classList.add('hidden'), 300);
            document.getElementById('overlay').classList.remove('active'); 
        }

        async function sendContactMessage() {
            const msg = document.getElementById('contactMsg').value.trim();
            if (!msg) return alert("LÃ¼tfen bir mesaj yazÄ±n.");
            
            const btn = document.querySelector('#contactModal button');
            const origText = btn.innerText;
            btn.innerText = "GÃ¶nderiliyor...";
            btn.disabled = true;

            try {
                let sender = "Misafir";
                let email = "-";
                let uid = "-";

                if (currentUser) {
                    sender = currentUser.displayName || "KullanÄ±cÄ±";
                    email = currentUser.email;
                    uid = currentUser.uid;
                }

                await db.collection('messages').add({
                    content: msg,
                    senderName: sender,
                    senderEmail: email,
                    senderUid: uid,
                    date: new Date().toISOString(),
                    isRead: false
                });

                alert("MesajÄ±nÄ±z iletildi! TeÅŸekkÃ¼rler.");
                closeContactModal();
            } catch (e) {
                alert("Hata: " + e.message);
            } finally {
                btn.innerText = origText;
                btn.disabled = false;
            }
        }

        // --- ADMIN FONKSÄ°YONLARI ---
        async function openAdminPanel() {
            document.getElementById('adminModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('adminModal').classList.add('open'), 10);
            document.getElementById('overlay').classList.add('active');
            // Default load users tab
            switchAdminTab('users');
        }

        function closeAdminPanel() {
            const modal = document.getElementById('adminModal');
            modal.classList.remove('open');
            setTimeout(() => modal.classList.add('hidden'), 300);
            if(!originalAdminUid) document.getElementById('overlay').classList.remove('active'); 
        }
        
        function switchAdminTab(tabName) {
            const btnUsers = document.getElementById('tabAdminUsers');
            const btnMsgs = document.getElementById('tabAdminMessages');
            const divUsers = document.getElementById('adminTabUsers');
            const divMsgs = document.getElementById('adminTabMessages');

            if (tabName === 'users') {
                btnUsers.className = "flex-1 py-2 text-xs font-bold rounded-lg bg-blue-600 text-white shadow-sm transition-all";
                btnMsgs.className = "flex-1 py-2 text-xs font-bold rounded-lg text-slate-400 hover:text-white transition-all";
                divUsers.classList.remove('hidden');
                divMsgs.classList.add('hidden');
                loadAdminUsers();
            } else {
                btnMsgs.className = "flex-1 py-2 text-xs font-bold rounded-lg bg-blue-600 text-white shadow-sm transition-all";
                btnUsers.className = "flex-1 py-2 text-xs font-bold rounded-lg text-slate-400 hover:text-white transition-all";
                divMsgs.classList.remove('hidden');
                divUsers.classList.add('hidden');
                loadAdminMessages();
            }
        }

        async function loadAdminUsers() {
            const list = document.getElementById('adminUserList');
            list.innerHTML = '<tr><td colspan="2" class="p-4 text-center"><div class="loader"></div></td></tr>';
            try {
                const snap = await db.collection('users').get();
                let totalUsers = 0;
                let totalMoney = 0;
                let html = '';

                snap.forEach(doc => {
                    const d = doc.data();
                    const assets = (d.assets || []).reduce((s,a)=>s+(a.val||0),0);
                    totalMoney += assets;
                    totalUsers++;

                    const name = d.username || d.email;
                    const regDate = d.registrationDate ? new Date(d.registrationDate).toLocaleDateString('tr-TR') : '-';

                    html += `
                    <tr class="border-b border-slate-800 hover:bg-slate-800/50">
                        <td class="py-3 pl-1">
                            <p class="font-bold text-white">${name}</p>
                            <p class="text-[9px] text-slate-500">${d.email}</p>
                            <p class="text-[9px] text-slate-600">KayÄ±t: ${regDate}</p>
                        </td>
                        <td class="py-3 text-right">
                            <button onclick="inspectUser('${doc.id}', '${name}')" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-500 text-xs font-bold shadow-lg shadow-blue-500/20 mr-2"><i class="fas fa-eye"></i></button>
                            <button onclick="deleteUserDoc('${doc.id}', '${name}')" class="bg-red-600 text-white p-2 rounded-lg hover:bg-red-500 text-xs font-bold shadow-lg shadow-red-500/20"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                });

                document.getElementById('adminTotalUsers').innerText = totalUsers;
                document.getElementById('adminTotalMoney').innerText = `â‚º${Math.floor(totalMoney).toLocaleString()}`;
                list.innerHTML = html;

            } catch(e) {
                list.innerHTML = `<tr><td colspan="2" class="text-red-500 p-4">Hata: ${e.message}</td></tr>`;
            }
        }

        async function deleteUserDoc(uid, name) {
            if(confirm(name + " adlÄ± kullanÄ±cÄ±nÄ±n tÃ¼m verileri silinecek. Bu iÅŸlem geri alÄ±namaz. Emin misiniz?")) {
                try {
                    await db.collection('users').doc(uid).delete();
                    alert("KullanÄ±cÄ± verisi silindi.");
                    loadAdminUsers(); // Refresh list
                } catch(e) {
                    alert("Hata: " + e.message);
                }
            }
        }
        
        async function loadAdminMessages() {
            const list = document.getElementById('adminMessageList');
            list.innerHTML = '<div class="text-center p-4"><div class="loader"></div></div>';
            
            try {
                const snap = await db.collection('messages').orderBy('date', 'desc').get();
                if (snap.empty) {
                    list.innerHTML = '<div class="text-center text-slate-500 text-xs p-4">HiÃ§ mesaj yok.</div>';
                    return;
                }
                
                let html = '';
                snap.forEach(doc => {
                    const m = doc.data();
                    const date = new Date(m.date).toLocaleString('tr-TR');
                    
                    html += `
                    <div class="bg-slate-800 p-3 rounded-xl border border-slate-700">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <p class="text-xs font-bold text-white">${m.senderName}</p>
                                <p class="text-[9px] text-slate-400">${m.senderEmail}</p>
                            </div>
                            <span class="text-[9px] text-slate-500">${date}</span>
                        </div>
                        <p class="text-xs text-slate-300 bg-slate-900/50 p-2 rounded-lg leading-relaxed">${m.content}</p>
                    </div>`;
                });
                
                list.innerHTML = html;
            } catch(e) {
                 list.innerHTML = `<div class="text-red-400 text-xs p-4">Hata: ${e.message}</div>`;
            }
        }

        async function inspectUser(targetUid, targetName) {
            // Adminin kendi ID'sini sakla (geri dÃ¶nmek iÃ§in)
            if (!originalAdminUid) originalAdminUid = currentUser.uid;
            
            // Hedef kullanÄ±cÄ± verisini Ã§ek
            try {
                const doc = await db.collection("users").doc(targetUid).get();
                if (doc.exists) {
                    state = doc.data();
                    currentPlanId = targetUid; // Hedefin plan ID'si
                    currentUserRole = 'owner'; // Tam yetkiyle gÃ¶r
                    
                    // Admin panelini kapat
                    closeAdminPanel();
                    
                    // Dashboard'Ä± gÃ¼ncelle
                    updateDashboardUI();
                    
                    // UyarÄ± bandÄ±nÄ± gÃ¶ster
                    document.getElementById('adminModeBanner').classList.remove('hidden');
                    document.getElementById('adminInspectName').innerText = targetName;
                    
                    // Overlay'i kapat (Panel kapandÄ± Ã§Ã¼nkÃ¼)
                    document.getElementById('overlay').classList.remove('active');
                }
            } catch(e) { alert("Hata: " + e.message); }
        }

        async function exitAdminInspect() {
            // Admin verisine geri dÃ¶n
            if (originalAdminUid) {
                const doc = await db.collection("users").doc(originalAdminUid).get();
                state = doc.data();
                currentPlanId = originalAdminUid;
                originalAdminUid = null;
                
                document.getElementById('adminModeBanner').classList.add('hidden');
                updateDashboardUI();
            }
        }

        function showLoginScreen() { hideAll(); document.getElementById('loginScreen').classList.remove('hidden'); }
        function showDashboard() { hideAll(); document.getElementById('dashboardScreen').classList.remove('hidden'); updateDashboardUI(); }
        function showAnalysisScreen() { 
            hideAll(); 
            document.getElementById('analysisScreen').classList.remove('hidden'); 
            
            // Set default date for analysis filter to current month
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            document.getElementById('analysisDateFilter').value = `${yyyy}-${mm}`;
            
            renderCharts(); 
            renderHistoryTableUI(); // Tabloyu ilk aÃ§Ä±lÄ±ÅŸta yÃ¼kle
        }

        function startAdviceRotator() {
            // Rotator yerine Gamification sistemi Ã§alÄ±ÅŸacak
        }

        function getRandomMessage(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

        function checkGamificationStatus() {
            const todayStr = new Date().toLocaleDateString('tr-TR');
            const dailyLimit = state.manualDailyLimit || 0;
            const spentToday = state.expenses.filter(e => e.date === todayStr).reduce((s,e)=>s+e.amount,0);
            
            if (spentToday > dailyLimit && dailyLimit > 0) {
                return getRandomMessage(messages_highSpend);
            }

            let streak = 0;
            const now = new Date();
            for (let i = 1; i < 30; i++) {
                const d = new Date(); d.setDate(now.getDate() - i);
                const dStr = d.toLocaleDateString('tr-TR');
                const spentThatDay = state.expenses.filter(e => e.date === dStr).reduce((s,e)=>s+e.amount,0);
                if (spentThatDay <= dailyLimit) streak++;
                else break; 
            }
            if (streak >= 3) return getRandomMessage(messages_streak);

            const nowTime = new Date();
            let startCalc = new Date(state.registrationDate);
            if(isNaN(startCalc.getTime())) startCalc = new Date();
            
            if (state.expenses.length > 0) {
                let minExpDate = new Date();
                state.expenses.forEach(e => {
                    let dParts = e.date.split('.');
                    if(dParts.length === 3) {
                        let d = new Date(dParts[2], dParts[1]-1, dParts[0]);
                        if (d < minExpDate) minExpDate = d;
                    }
                });
                
                if (minExpDate.getTime() < startCalc.getTime() - (1000 * 60 * 60 * 24)) {
                    const salaryDay = state.salaryDay || 15;
                    let lastSalaryDate = new Date(nowTime.getFullYear(), nowTime.getMonth(), salaryDay);
                    if (nowTime.getDate() < salaryDay) {
                        lastSalaryDate.setMonth(lastSalaryDate.getMonth() - 1);
                    }
                    startCalc = lastSalaryDate;
                }
            }

            const daysPassed = Math.max(1, Math.ceil(Math.abs(nowTime - startCalc) / (1000 * 60 * 60 * 24)));
            const totalSpent = state.expenses.reduce((s,e)=>s+e.amount,0);
            const cumulative = (dailyLimit * daysPassed) - totalSpent;
            
            if (cumulative < -(dailyLimit * 2)) {
                return getRandomMessage(messages_lowSavings);
            }

            return "Finansal yolculuÄŸunda baÅŸarÄ±lar dilerim! ðŸš€";
        }

        async function initUserPlan() {
            if (!currentUser) return;
            try {
                currentPlanId = currentUser.uid;
                currentUserRole = 'owner';
                
                const userDoc = await db.collection("users").doc(currentUser.uid).get();
                if(!userDoc.exists) {
                    await saveToCloud();
                } else {
                    const userData = userDoc.data();
                    if (userData.connectedPlanId) {
                        currentPlanId = userData.connectedPlanId;
                        if(currentPlanId !== currentUser.uid) {
                            const planDoc = await db.collection("users").doc(currentPlanId).get();
                            if(planDoc.exists) {
                                const planData = planDoc.data();
                                const member = planData.familyMembers ? planData.familyMembers.find(m => m.uid === currentUser.uid) : null;
                                currentUserRole = member ? member.role : 'limited';
                            } else {
                                currentPlanId = currentUser.uid;
                                currentUserRole = 'owner';
                                await db.collection("users").doc(currentUser.uid).update({ connectedPlanId: null });
                            }
                        }
                    }
                }
                loadFromCloud();
            } catch (e) { console.error("Plan Error:", e); }
        }

        function showLoginMode() {
            document.getElementById('loginTitle').innerText = "GiriÅŸ Yap";
            document.getElementById('loginSubtitle').innerText = "HesabÄ±na EriÅŸ";
            document.getElementById('loginBtn').classList.remove('hidden');
            document.getElementById('registerBtn').classList.add('hidden');
            document.getElementById('registerFields').classList.add('hidden');
            document.getElementById('regDailyLimit').classList.add('hidden');
            document.getElementById('emailInput').placeholder = "E-posta veya KullanÄ±cÄ± AdÄ±";
            document.getElementById('actionButtons').classList.remove('hidden');
            document.getElementById('backToLoginText').classList.add('hidden');
            document.getElementById('forgotPassText').classList.remove('hidden');
        }

        function showRegisterMode() {
            document.getElementById('loginTitle').innerText = "Ailene KatÄ±l";
            document.getElementById('loginSubtitle').innerText = "Davet Kodu Ä°le BaÄŸlan";
            document.getElementById('loginBtn').classList.add('hidden');
            document.getElementById('registerBtn').classList.remove('hidden');
            document.getElementById('registerFields').classList.remove('hidden');
            document.getElementById('regInviteCode').classList.remove('hidden');
            document.getElementById('regDailyLimit').classList.add('hidden');
            document.getElementById('emailInput').placeholder = "E-posta Adresi";
            document.getElementById('actionButtons').classList.add('hidden');
            document.getElementById('backToLoginText').classList.remove('hidden');
            document.getElementById('forgotPassText').classList.add('hidden');
        }

        function showQuickRegisterMode() {
            document.getElementById('loginTitle').innerText = "HÄ±zlÄ± BaÅŸlangÄ±Ã§";
            document.getElementById('loginSubtitle').innerText = "Sadece GÃ¼nlÃ¼k Harcama Takibi";
            document.getElementById('loginBtn').classList.add('hidden');
            document.getElementById('registerBtn').classList.remove('hidden');
            document.getElementById('registerFields').classList.remove('hidden');
            document.getElementById('regInviteCode').classList.add('hidden');
            document.getElementById('regDailyLimit').classList.remove('hidden');
            document.getElementById('emailInput').placeholder = "E-posta Adresi";
            document.getElementById('actionButtons').classList.add('hidden');
            document.getElementById('backToLoginText').classList.remove('hidden');
            document.getElementById('forgotPassText').classList.add('hidden');
        }

        async function firebaseLogin() {
            if(!isFirebaseReady) return;
            const emailInp = document.getElementById('emailInput').value.trim();
            const pass = document.getElementById('passwordInput').value;
            if(!emailInp || !pass) return alert("AlanlarÄ± doldurun.");
            const btn = document.getElementById('loginBtn');
            const orig = btn.innerHTML; btn.innerHTML = '<div class="loader"></div>';
            
            try {
                let email = emailInp;
                if (!email.includes('@')) {
                    const s = await db.collection('users').where('username', '==', email.toLowerCase()).limit(1).get();
                    if (s.empty) {
                        alert("KullanÄ±cÄ± adÄ± bulunamadÄ±. LÃ¼tfen e-posta adresinizi deneyin veya kontrol edin.");
                        btn.innerHTML = orig;
                        return;
                    }
                    email = s.docs[0].data().email;
                }
                await auth.signInWithEmailAndPassword(email, pass);
            } catch (e) { alert("Hata: " + e.message); btn.innerHTML = orig; }
        }

        async function firebaseRegister() {
            if(!isFirebaseReady) return;
            const user = document.getElementById('regUsernameInput').value.trim().toLowerCase();
            const email = document.getElementById('emailInput').value.trim();
            const pass = document.getElementById('passwordInput').value;
            const invite = document.getElementById('regInviteCode').value.trim().toUpperCase();
            
            const isQuickMode = !document.getElementById('regDailyLimit').classList.contains('hidden');
            const dailyLimitVal = parseFloat(document.getElementById('regDailyLimit').value);

            if(!email.includes('@') || !user || !pass) return alert("AlanlarÄ± doÄŸru doldurun.");
            if(isQuickMode && (!dailyLimitVal || dailyLimitVal <= 0)) return alert("LÃ¼tfen gÃ¼nlÃ¼k harcama hedefinizi girin.");
            
            const btn = document.getElementById('registerBtn');
            btn.innerHTML = '<div class="loader"></div> LÃ¼tfen Bekleyin...';
            isRegistering = true;
            
            try {
                const cred = await auth.createUserWithEmailAndPassword(email, pass);
                await cred.user.updateProfile({ displayName: user });

                const initState = JSON.parse(JSON.stringify(state)); 
                initState.email = email; initState.username = user;
                if(initState.registrationDate instanceof Date) initState.registrationDate = initState.registrationDate.toISOString();

                if (isQuickMode) {
                    initState.manualDailyLimit = dailyLimitVal;
                    initState.calculatedMonthlyPool = dailyLimitVal * 30;
                    initState.remainingAfterFixed = dailyLimitVal * 30;
                    initState.incomes = [{ name: 'Sanal BÃ¼tÃ§e (HÄ±zlÄ± BaÅŸlangÄ±Ã§)', val: dailyLimitVal * 30 }];
                } else if (invite) {
                    const snap = await db.collection('users').where('inviteCode', '==', invite).get();
                    if (!snap.empty) {
                        const owner = snap.docs[0];
                        initState.connectedPlanId = owner.id;
                        let members = owner.data().familyMembers || [];
                        members.push({ uid: cred.user.uid, name: user, role: 'full' });
                        await db.collection('users').doc(owner.id).update({ familyMembers: members });
                        alert("Davet kodunuz doÄŸrulandÄ±, plana eklendiniz.");
                    } else alert("GeÃ§ersiz davet kodu, kendi yeni planÄ±nÄ±z oluÅŸturuldu.");
                }

                await db.collection("users").doc(cred.user.uid).set(initState);
                isRegistering = false; 

                currentUser = cred.user;
                const userDoc = await db.collection("users").doc(cred.user.uid).get();
                if(userDoc.exists && userDoc.data().pendingInvites) window.userInvites = userDoc.data().pendingInvites;
                await initUserPlan();

            } catch (e) { isRegistering = false; alert("Hata: " + e.message); btn.innerHTML = "Ãœye Ol ve KatÄ±l"; }
        }

        function registerFromWizard() {
            const u = document.getElementById('wizRegName').value.trim();
            const e = document.getElementById('wizRegEmail').value.trim();
            const p = document.getElementById('wizRegPass').value;
            if(!u || !e || !p) return alert("TÃ¼m alanlarÄ± doldurun.");
            document.getElementById('regUsernameInput').value = u;
            document.getElementById('emailInput').value = e;
            document.getElementById('passwordInput').value = p;
            document.getElementById('regInviteCode').value = ""; 
            firebaseRegister();
        }

        function forgotPassword() {
            const email = document.getElementById('emailInput').value.trim();
            if (!email || !email.includes('@')) return alert("LÃ¼tfen geÃ§erli bir e-posta giriniz.");
            auth.sendPasswordResetEmail(email).then(() => alert("BaÄŸlantÄ± gÃ¶nderildi.")).catch(e => alert(e.message));
        }

        function handleLogout() {
            if(auth.currentUser) auth.signOut().then(() => window.location.reload());
            else window.location.reload();
        }

        // --- AYARLAR MODALI ---
        function showSettingsModal() {
            if(currentUserRole === 'owner') {
                document.getElementById('settingsCurrentPlanLabel').innerText = "Kendi PlanÄ±nÄ±z (YÃ¶netici)";
                document.getElementById('btnLeavePlan').classList.add('hidden');
            } else {
                document.getElementById('settingsCurrentPlanLabel').innerText = "Ortak Plan (Davetli Ãœye)";
                document.getElementById('btnLeavePlan').classList.remove('hidden');
            }
            document.getElementById('settingsInviteCode').value = '';
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('overlay').classList.add('active');
        }
        function closeSettingsModal() { document.getElementById('settingsModal').classList.add('hidden'); document.getElementById('overlay').classList.remove('active'); }
        
        async function joinPlanByCode() {
            const code = document.getElementById('settingsInviteCode').value.trim().toUpperCase();
            if(!code) return;
            const snap = await db.collection('users').where('inviteCode', '==', code).get();
            if(snap.empty) return alert("GeÃ§ersiz davet kodu!");
            const ownerDoc = snap.docs[0];
            if(ownerDoc.id === currentUser.uid) return alert("Kendi planÄ±nÄ±za katÄ±lamazsÄ±nÄ±z.");
            
            let members = ownerDoc.data().familyMembers || [];
            members = members.filter(m => m.uid !== currentUser.uid);
            members.push({ uid: currentUser.uid, name: currentUser.displayName || currentUser.email.split('@')[0], role: 'full' });
            await db.collection('users').doc(ownerDoc.id).update({ familyMembers: members });
            await db.collection('users').doc(currentUser.uid).update({ connectedPlanId: ownerDoc.id });
            
            alert("Plana baÅŸarÄ±yla katÄ±ldÄ±nÄ±z!"); window.location.reload();
        }
        async function leaveCurrentPlan() {
            if(!confirm("Mevcut plandan ayrÄ±lmak istediÄŸinize emin misiniz?")) return;
            const ownerDoc = await db.collection('users').doc(currentPlanId).get();
            if(ownerDoc.exists) {
                let members = ownerDoc.data().familyMembers || [];
                members = members.filter(m => m.uid !== currentUser.uid);
                await db.collection('users').doc(currentPlanId).update({ familyMembers: members });
            }
            await db.collection('users').doc(currentUser.uid).update({ connectedPlanId: null });
            alert("Plandan ayrÄ±ldÄ±nÄ±z."); window.location.reload();
        }

        // --- AÄ°LE YÃ–NETÄ°MÄ° & DAVET SÄ°STEMÄ° ---
        function createInviteCode() {
            if(currentUserRole !== 'owner' && currentUserRole !== 'full') return alert("Yetkiniz yok.");
            const code = Math.random().toString(36).substring(2, 7).toUpperCase();
            state.inviteCode = code; saveToCloud();
            document.getElementById('displayInviteCode').innerText = code;
        }

        async function addFamilyMember() {
            if(currentUserRole !== 'owner' && currentUserRole !== 'full') return alert("Yetkiniz yok.");
            const input = document.getElementById('famInput').value.trim().toLowerCase();
            const role = document.getElementById('famRole').value;
            if(!input) return;

            let snap = await db.collection('users').where('username', '==', input).limit(1).get();
            if(snap.empty) snap = await db.collection('users').where('email', '==', input).limit(1).get();
            if(snap.empty) return alert("KullanÄ±cÄ± sistemde bulunamadÄ±. LÃ¼tfen kayÄ±tlÄ± olduÄŸuna emin olun.");
            
            const target = snap.docs[0];
            if(target.id === currentUser.uid) return alert("Kendinizi ekleyemezsiniz.");

            // Davet GÃ¶nder
            await db.collection('users').doc(target.id).update({
                pendingInvites: firebase.firestore.FieldValue.arrayUnion({
                    planId: currentUser.uid,
                    planName: currentUser.displayName || currentUser.email.split('@')[0],
                    role: role
                })
            });
            
            document.getElementById('famInput').value = ''; 
            alert(`KullanÄ±cÄ±ya davet gÃ¶nderildi! Sisteme giriÅŸ yaptÄ±klarÄ±nda karÅŸÄ±larÄ±na Ã§Ä±kacaktÄ±r.`);
        }

        async function acceptInvite() {
            if(!window.userInvites || window.userInvites.length === 0) return;
            const invite = window.userInvites[0];
            
            const ownerDoc = await db.collection('users').doc(invite.planId).get();
            if(ownerDoc.exists) {
                let members = ownerDoc.data().familyMembers || [];
                members = members.filter(m => m.uid !== currentUser.uid);
                members.push({ uid: currentUser.uid, name: currentUser.displayName || currentUser.email.split('@')[0], role: invite.role });
                await db.collection('users').doc(invite.planId).update({ familyMembers: members });
            }
            
            await db.collection('users').doc(currentUser.uid).update({
                connectedPlanId: invite.planId,
                pendingInvites: firebase.firestore.FieldValue.arrayRemove(invite)
            });
            window.location.reload();
        }

        async function rejectInvite() {
            if(!window.userInvites || window.userInvites.length === 0) return;
            const invite = window.userInvites[0];
            await db.collection('users').doc(currentUser.uid).update({
                pendingInvites: firebase.firestore.FieldValue.arrayRemove(invite)
            });
            window.userInvites.shift();
            updateDashboardUI();
        }

        function renderFamilyList() {
            const list = document.getElementById('familyList');
            if(!state.familyMembers || state.familyMembers.length === 0) {
                list.innerHTML = '<p class="text-gray-400 text-[10px] text-center py-2">HenÃ¼z Ã¼ye yok.</p>'; return;
            }
            
            const canEdit = currentUserRole === 'owner';
            list.innerHTML = state.familyMembers.map((m, i) => `
                <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg text-xs">
                    <p class="font-bold text-gray-800">${m.name}</p>
                    <div class="flex items-center gap-2">
                        ${canEdit ? `
                        <select onchange="changeFamilyRole(${i}, this.value)" class="text-[10px] text-blue-600 font-bold bg-transparent outline-none cursor-pointer">
                            <option value="full" ${m.role==='full'?'selected':''}>Tam Yetki</option>
                            <option value="limited" ${m.role==='limited'?'selected':''}>SÄ±nÄ±rlÄ±</option>
                        </select>
                        <button onclick="removeFamilyMember(${i})" class="text-red-400 hover:text-red-600 ml-1"><i class="fas fa-trash"></i></button>
                        ` : `
                        <span class="text-[10px] text-blue-500 font-bold">${m.role === 'full' ? 'Tam' : 'SÄ±nÄ±rlÄ±'}</span>
                        `}
                    </div>
                </div>`).join('');
        }
        
        function changeFamilyRole(idx, newRole) { state.familyMembers[idx].role = newRole; saveToCloud(); }

        async function removeFamilyMember(idx) {
             const m = state.familyMembers[idx];
             if(confirm(`${m.name} plandan Ã§Ä±karÄ±lacak?`)) {
                 await db.collection('users').doc(m.uid).update({ connectedPlanId: null });
                 state.familyMembers.splice(idx, 1);
                 saveToCloud(); renderFamilyList();
             }
        }

        // --- BULUT Ä°ÅžLEMLERÄ° ---
        function loadFromCloud() {
            if(!currentUser || !currentPlanId) return;
            db.collection("users").doc(currentPlanId).get().then((doc) => {
                if (doc.exists) {
                    state = doc.data();
                    if(!state.incomes) state.incomes = [];
                    if(!state.bills) state.bills = [];
                    if(!state.loans) state.loans = [];
                    if(!state.debts) state.debts = [];
                    if(!state.otherDebts) state.otherDebts = [];
                    if(!state.assets) state.assets = [];
                    if(!state.expenses) state.expenses = [];
                    if(!state.monthlyHistory) state.monthlyHistory = [];
                    if(!state.familyMembers) state.familyMembers = [];
                    
                    // Kategori verisi yoksa default ile baÅŸlat
                    if(!state.categories || state.categories.length === 0) {
                        state.categories = ["Market / Manav", "Kasap", "AkaryakÄ±t", "Eczane / SaÄŸlÄ±k", "EÄŸlence", "EÄŸitim Ã–demeleri", "Vergi / HarÃ§ / Sigorta", "DiÄŸer"];
                    }
                    
                    showDashboard();
                }
            });
        }

        function saveToCloud() {
            if(!currentUser || !currentPlanId) return Promise.resolve();
            return db.collection("users").doc(currentPlanId).set(JSON.parse(JSON.stringify(state)), { merge: true }).then(() => {
                const ind = document.getElementById('saveIndicator');
                ind.style.opacity = '1'; setTimeout(() => ind.style.opacity = '0', 2000);
            });
        }
        function saveState() { if(currentUser && !isRegistering) saveToCloud(); }

        // --- DASHBOARD GÃœNCELLEME ---
        function applyPermissions() {
            const lbl = currentUserRole === 'owner' ? 'Plan Sahibi' : currentUserRole === 'full' ? 'Tam Yetki' : 'SÄ±nÄ±rlÄ± Yetki';
            document.getElementById('roleBadge').innerText = lbl;
            
            const dis = (currentUserRole === 'limited');
            document.getElementById('financialHealthSection').classList.toggle('hidden', dis);
            document.getElementById('btnAnalysis').classList.toggle('hidden', dis);
            document.getElementById('familyPanel').classList.toggle('hidden', dis);
            document.getElementById('btnEditPlan').classList.toggle('hidden', dis);
        }

        function updateDashboardUI() {
            applyPermissions();
            
            const inviteBanner = document.getElementById('inviteBanner');
            if (window.userInvites && window.userInvites.length > 0) {
                inviteBanner.classList.remove('hidden');
                document.getElementById('inviteBannerText').innerText = `${window.userInvites[0].planName} sizi planÄ±na davet ediyor.`;
            } else {
                inviteBanner.classList.add('hidden');
            }

            const now = new Date(); const todayStr = now.toLocaleDateString('tr-TR');
            let startCalc = new Date(state.registrationDate);
            if(isNaN(startCalc.getTime())) startCalc = new Date();
            
            // --- HÄ°BRÄ°T HESAPLAMA MANTIÄžI ---
            if (state.expenses.length > 0) {
                let minExpDate = new Date(); // BugÃ¼nle baÅŸla
                
                state.expenses.forEach(e => {
                    let dParts = e.date.split('.');
                    if(dParts.length === 3) {
                        let d = new Date(dParts[2], dParts[1]-1, dParts[0]);
                        if (d < minExpDate) minExpDate = d;
                    }
                });
                
                if (minExpDate.getTime() < startCalc.getTime() - (1000 * 60 * 60 * 24)) {
                    const salaryDay = state.salaryDay || 15;
                    let lastSalaryDate = new Date(now.getFullYear(), now.getMonth(), salaryDay);
                    if (now.getDate() < salaryDay) {
                        lastSalaryDate.setMonth(lastSalaryDate.getMonth() - 1);
                    }
                    startCalc = lastSalaryDate;
                }
            }
            
            const daysPassed = Math.max(1, Math.ceil(Math.abs(now - startCalc) / (1000 * 60 * 60 * 24))); 
            
            const spentToday = state.expenses.filter(e => e.date === todayStr).reduce((s,e)=>s+e.amount,0);
            const totalSpent = state.expenses.reduce((s,e)=>s+e.amount,0);
            const cumulative = ((state.manualDailyLimit||0) * daysPassed) - totalSpent;
            
            document.getElementById('displayDailyLimit').innerText = `â‚º${Math.floor((state.manualDailyLimit||0) - spentToday).toLocaleString()}`;
            const cumEl = document.getElementById('displayCumulativeLimit');
            cumEl.innerText = `â‚º${Math.floor(cumulative).toLocaleString()}`;
            
            // Efekt KontrolÃ¼
            cumEl.classList.remove('animate-pulse-red', 'animate-pulse-green');
            if (cumulative < 0) cumEl.classList.add('animate-pulse-red');
            else if (cumulative > (state.manualDailyLimit||0)) cumEl.classList.add('animate-pulse-green');

            document.getElementById('todayTotal').innerText = `BugÃ¼n: â‚º${Math.floor(spentToday).toLocaleString()}`;
            
            let targetDate = new Date(now.getFullYear(), now.getMonth(), state.salaryDay||15);
            if (now.getDate() >= (state.salaryDay||15)) targetDate.setMonth(targetDate.getMonth()+1);
            document.getElementById('displayRemainingDays').innerText = `${Math.ceil((targetDate - now)/(1000*60*60*24))} GÃ¼n`;

            const assets = state.assets.filter(a => !a.excludeFromNetWorth).reduce((s,a)=>s+(a.val||0),0);
            const loans = state.loans.filter(l=>!l.excludeFromDebt).reduce((s,l)=>s+(l.totalDebt||0),0);
            const cards = state.debts.filter(d => !d.excludeFromNetWorth).reduce((s,d)=>s+(d.val||0),0);
            const others = state.otherDebts.filter(d => !d.excludeFromNetWorth).reduce((s,d)=>s+(d.val||0),0);
            const totalDebt = loans + cards + others;
            const net = assets - totalDebt;
            
            const daysInCurrentMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            const normalBills = state.bills.reduce((s, b) => s + (b.val||0), 0);
            const loansTreatedAsBills = state.loans.filter(l => l.excludeFromDebt && !l.excludeFromBudget).reduce((s, l) => s + (l.monthly || 0), 0);
            const standardLoans = state.loans.filter(l => !l.excludeFromDebt && !l.excludeFromBudget).reduce((s, l) => s + (l.monthly || 0), 0);
            const totalFix = normalBills + loansTreatedAsBills;
            const totalInc = state.incomes.reduce((s, i) => s + (i.val||0), 0);
            
            const grossNet = totalInc - totalFix; 
            const realNet = grossNet - standardLoans;
            let monthlySpend = (state.manualDailyLimit || 0) * daysInCurrentMonth;
            
            // HEDEF BÄ°RÄ°KÄ°M DÃœZELTMESÄ° (SON TALEP):
            const calcSavings = Math.max(0, grossNet - monthlySpend);
            
            const totalMonthlyOutflow = totalFix + standardLoans;

            document.getElementById('sumSavings').innerText = `â‚º${Math.floor(calcSavings).toLocaleString()}`;
            document.getElementById('sumGiderTotalHealth').innerText = `â‚º${Math.floor(totalMonthlyOutflow).toLocaleString()}`;
            document.getElementById('netStatusVal').innerText = `${net>=0?'+':'-'}â‚º${Math.abs(Math.floor(net)).toLocaleString()}`;
            document.getElementById('netStatusBadge').className = `text-4xl font-black px-8 py-4 rounded-[2rem] ${net>=0?'text-green-600 bg-green-50':'text-red-600 bg-red-50'}`;

            document.getElementById('displayInviteCode').innerText = state.inviteCode || '-----';
            
            const motivationalMsg = checkGamificationStatus();
            document.getElementById('motivationText').innerText = motivationalMsg;
            document.getElementById('motivationArea').classList.remove('hidden');

            renderFamilyList();
            renderDetailedHealthLists();
            
            window.currentHistoryDateIndex = 0; 
            renderHistoryList();
            updateExpenseDateLabel();
            renderCategoryOptions(); 
        }

        // --- TARÄ°H NAVÄ°GASYON MANTIÄžI ---
        function changeExpenseDate(delta) {
            if (delta === -1) {
                currentExpenseDateOffset += 1;
            } else {
                currentExpenseDateOffset -= 1;
            }
            if (currentExpenseDateOffset < 0) currentExpenseDateOffset = 0;
            updateExpenseDateLabel();
        }

        function updateExpenseDateLabel() {
            const lbl = document.getElementById('expenseDateLabel');
            const d = new Date();
            d.setDate(d.getDate() - currentExpenseDateOffset);
            const options = { day: 'numeric', month: 'long', weekday: 'long' };
            const formattedDate = d.toLocaleDateString('tr-TR', options);
            
            if (currentExpenseDateOffset === 0) {
                lbl.innerText = `BugÃ¼n (${formattedDate})`;
            } else if (currentExpenseDateOffset === 1) {
                lbl.innerText = `DÃ¼n (${formattedDate})`;
            } else {
                lbl.innerText = `${currentExpenseDateOffset} GÃ¼n Ã–nce (${formattedDate})`;
            }
            
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            document.getElementById('expDateInputHidden').value = `${yyyy}-${mm}-${dd}`;
        }
        
        function setSpecificDate(val) {
            if (!val) return;
            const selected = new Date(val);
            const today = new Date();
            selected.setHours(0,0,0,0);
            today.setHours(0,0,0,0);
            const diffTime = today - selected;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            
            if (diffDays >= 0) {
                currentExpenseDateOffset = diffDays;
                updateExpenseDateLabel();
            } else {
                alert("GeleceÄŸe harcama giremezsiniz!");
                currentExpenseDateOffset = 0;
                updateExpenseDateLabel();
            }
        }

        // --- KATEGORÄ° YÃ–NETÄ°MÄ° ---
        function renderCategoryOptions() {
            const sel = document.getElementById('expCat');
            if (!state.categories) {
                state.categories = ["Market / Manav", "Kasap", "AkaryakÄ±t", "Eczane / SaÄŸlÄ±k", "EÄŸlence", "EÄŸitim Ã–demeleri", "Vergi / HarÃ§ / Sigorta", "DiÄŸer"];
            }
            sel.innerHTML = state.categories.map(c => `<option value="${c}">${c}</option>`).join('');
            
            const list = document.getElementById('categoryList');
            list.innerHTML = state.categories.map((c, i) => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl">
                    <div class="flex-1">
                        ${editingCategoryIndex === i 
                            ? `<div class="flex gap-2">
                                 <input type="text" id="catEditInput_${i}" value="${c}" class="w-full p-2 border border-blue-200 rounded-lg text-sm" onkeyup="if(event.key==='Enter') saveCategoryEdit(${i})">
                                 <button onclick="saveCategoryEdit(${i})" class="text-green-600 hover:text-green-800"><i class="fas fa-check"></i></button>
                                 <button onclick="cancelCategoryEdit()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                               </div>`
                            : `<span class="text-sm font-bold text-gray-700">${c}</span>`
                        }
                    </div>
                    ${editingCategoryIndex !== i ? 
                    `<div class="flex gap-2">
                        <button onclick="startCategoryEdit(${i})" class="text-blue-400 hover:text-blue-600"><i class="fas fa-pen"></i></button>
                        <button onclick="deleteCategory(${i})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                    </div>` : ''}
                </div>
            `).join('');
        }

        function openCategoryModal() {
            renderCategoryOptions();
            const modal = document.getElementById('categoryModal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('open'), 10);
            document.getElementById('overlay').classList.add('active');
        }

        function closeCategoryModal() {
            editingCategoryIndex = -1; 
            const modal = document.getElementById('categoryModal');
            modal.classList.remove('open');
            setTimeout(() => modal.classList.add('hidden'), 300);
            document.getElementById('overlay').classList.remove('active');
            renderCategoryOptions(); 
        }

        function addNewCategory() {
            const inp = document.getElementById('newCatName');
            const val = inp.value.trim();
            if (val && !state.categories.includes(val)) {
                state.categories.push(val);
                inp.value = '';
                saveToCloud();
                renderCategoryOptions();
            }
        }
        
        function startCategoryEdit(idx) {
            editingCategoryIndex = idx;
            renderCategoryOptions();
            setTimeout(() => document.getElementById(`catEditInput_${idx}`).focus(), 50);
        }
        
        function cancelCategoryEdit() {
            editingCategoryIndex = -1;
            renderCategoryOptions();
        }
        
        function saveCategoryEdit(idx) {
            const input = document.getElementById(`catEditInput_${idx}`);
            const newVal = input.value.trim();
            if (newVal && newVal !== state.categories[idx]) {
                const oldVal = state.categories[idx];
                state.categories[idx] = newVal;
                state.expenses.forEach(exp => {
                    if (exp.category === oldVal) {
                        exp.category = newVal;
                    }
                });
                saveToCloud();
                editingCategoryIndex = -1;
                renderCategoryOptions();
                updateDashboardUI(); 
            } else {
                cancelCategoryEdit();
            }
        }

        function deleteCategory(idx) {
            if (confirm("Bu kategoriyi silmek istediÄŸinize emin misiniz?")) {
                state.categories.splice(idx, 1);
                saveToCloud();
                renderCategoryOptions();
            }
        }

        // --- SATIR Ä°Ã‡Ä° (INLINE) EKLEME SÄ°STEMÄ° ---
        const subTypes = {
            'AltÄ±n': ['Gr. (24 Ayar)', 'Gr & Ajda (22 Ayar)', 'Ã‡eyrek', 'YarÄ±m', 'Tam'],
            'DÃ¶viz': ['Dolar', 'Euro', 'GBP', 'Ä°sviÃ§re FrangÄ±'],
            'GÃ¼mÃ¼ÅŸ': ['GÃ¼mÃ¼ÅŸ']
        };

        function toggleInlineAdd(prefix) {
            const container = document.getElementById(`inlineAdd${prefix}Container`);
            const btn = document.getElementById(`btnShow${prefix}Form`);
            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                btn.classList.add('hidden');
                if (prefix === 'dashDebt' || prefix === 'wiz_debt') document.getElementById(`${prefix}Type`).value = 'Kredi';
                if (prefix === 'dashAsset' || prefix === 'wiz_asset') document.getElementById(`${prefix}Type`).value = 'DiÄŸer';
                if (prefix === 'wiz_loan') document.getElementById(`${prefix}Type`).value = 'Kredi';
                if (prefix === 'wiz_card') document.getElementById(`${prefix}Type`).value = 'Kredi KartÄ±';
                handleInlineTypeChange(prefix);
            }
        }

        function cancelInlineAdd(prefix) {
            document.getElementById(`inlineAdd${prefix}Container`).classList.add('hidden');
            document.getElementById(`btnShow${prefix}Form`).classList.remove('hidden');
        }

        function handleInlineTypeChange(prefix) {
            const typeEl = document.getElementById(`${prefix}Type`);
            const type = typeEl ? typeEl.value : 'DiÄŸer';
            const fieldsDiv = document.getElementById(`${prefix}Fields`);
            if(!fieldsDiv) return;
            const cmnCls = "w-full p-2.5 bg-white rounded-lg text-xs font-bold border border-gray-200 outline-none focus:ring-2 focus:ring-blue-100";
            let html = '';
            if (type === 'Kredi') {
                html = `<input type="text" id="${prefix}_name" placeholder="Kredi AdÄ±" class="${cmnCls} mb-2">
                        <div class="flex gap-2 mb-2">
                            <input type="number" id="${prefix}_monthly" placeholder="AylÄ±k Taksit" class="${cmnCls} w-1/2" oninput="calcInlineLoan('${prefix}')">
                            <input type="number" id="${prefix}_months" placeholder="Kalan Ay" class="${cmnCls} w-1/2" oninput="calcInlineLoan('${prefix}')">
                        </div>
                        <div class="mb-2">
                            <label class="text-[9px] font-bold text-gray-400 uppercase">SÄ±radaki Taksit Tarihi</label>
                            <input type="date" id="${prefix}_date" class="${cmnCls}">
                        </div>
                        <input type="number" id="${prefix}_total" placeholder="Toplam BorÃ§" class="${cmnCls}">`;
            } else if (type === 'Kredi KartÄ±') {
                html = `<input type="text" id="${prefix}_name" placeholder="Kart AdÄ± (Ã–rn: Bonus)" class="${cmnCls} mb-2">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Hesaplama Modu</span>
                            <select id="${prefix}_cc_mode" onchange="toggleInlineCCMode('${prefix}')" class="p-1 bg-blue-50 text-blue-600 rounded text-xs font-bold outline-none border border-blue-100">
                                <option value="manual">Direkt BorÃ§ Gir</option>
                                <option value="limit">Limit - KullanÄ±labilir</option>
                            </select>
                        </div>
                        <div id="${prefix}_cc_manual_div">
                            <input type="number" id="${prefix}_total" placeholder="GÃ¼ncel BorÃ§ (TL)" class="${cmnCls}">
                        </div>
                        <div id="${prefix}_cc_limit_div" class="hidden space-y-2">
                            <div class="flex gap-2">
                                <input type="number" id="${prefix}_cc_limit" placeholder="Kart Limiti" class="${cmnCls} w-1/2" oninput="calcInlineCC('${prefix}')">
                                <input type="number" id="${prefix}_cc_avail" placeholder="KullanÄ±labilir" class="${cmnCls} w-1/2" oninput="calcInlineCC('${prefix}')">
                            </div>
                            <div class="text-right text-xs font-bold text-gray-500">Hesaplanan: <span id="${prefix}_cc_debt_display" class="text-purple-600">0</span> TL</div>
                            <input type="hidden" id="${prefix}_cc_calc_total" value="0">
                        </div>`;
            } else if (type === 'DiÄŸer') {
                html = `<input type="text" id="${prefix}_name" placeholder="Kalem AdÄ±" class="${cmnCls} mb-2">
                        <input type="number" id="${prefix}_total" placeholder="Tutar (TL)" class="${cmnCls}">`;
            } else {
                const options = subTypes[type].map(s => `<option value="${s}">${s}</option>`).join('');
                html = `<select id="${prefix}_sub" class="${cmnCls} mb-2" onchange="fetchInlineRate('${prefix}', '${type}')">${options}</select>
                        <input type="text" id="${prefix}_name" placeholder="Ã–zel Ä°sim (Opsiyonel)" class="${cmnCls} mb-2">
                        <div class="flex gap-2 mb-2">
                            <input type="number" id="${prefix}_amount" placeholder="Miktar (Adet/Gr)" class="${cmnCls} w-1/2" oninput="calcInlineMarket('${prefix}')">
                            <input type="number" step="any" id="${prefix}_rate" placeholder="Birim Kur" class="${cmnCls} w-1/2 border-blue-200" title="Kur" oninput="calcInlineMarket('${prefix}')">
                        </div>
                        <div class="mb-2">
                            <label class="text-[9px] font-bold text-gray-400 uppercase block mb-1">Veya Direkt Toplam Tutar Girin (TL)</label>
                            <input type="number" id="${prefix}_total" placeholder="Toplam Tutar (TL)" class="${cmnCls} border-green-200">
                        </div>`;
                setTimeout(() => fetchInlineRate(prefix, type), 50);
            }
            fieldsDiv.innerHTML = html;
        }

        function toggleInlineCCMode(prefix) {
            const mode = document.getElementById(`${prefix}_cc_mode`).value;
            const manDiv = document.getElementById(`${prefix}_cc_manual_div`);
            const limDiv = document.getElementById(`${prefix}_cc_limit_div`);
            if (mode === 'limit') { manDiv.classList.add('hidden'); limDiv.classList.remove('hidden'); } 
            else { limDiv.classList.add('hidden'); manDiv.classList.remove('hidden'); }
        }

        function calcInlineCC(prefix) {
            const limit = parseFloat(document.getElementById(`${prefix}_cc_limit`).value) || 0;
            const avail = parseFloat(document.getElementById(`${prefix}_cc_avail`).value) || 0;
            const debt = Math.max(0, limit - avail);
            document.getElementById(`${prefix}_cc_calc_total`).value = debt;
            document.getElementById(`${prefix}_cc_debt_display`).innerText = debt.toLocaleString(undefined, {maximumFractionDigits:2});
        }

        function calcInlineLoan(prefix) {
            const monthly = parseFloat(document.getElementById(`${prefix}_monthly`).value) || 0;
            const months = parseFloat(document.getElementById(`${prefix}_months`).value) || 0;
            document.getElementById(`${prefix}_total`).value = monthly * months;
        }

        function calcInlineMarket(prefix) {
            const amount = parseFloat(document.getElementById(`${prefix}_amount`).value) || 0;
            const rate = parseFloat(document.getElementById(`${prefix}_rate`).value) || 0;
            const totalInput = document.getElementById(`${prefix}_total`);
            if(totalInput && amount > 0 && rate > 0) {
                totalInput.value = (amount * rate).toFixed(2);
            }
        }

        const apiMapping = {
            'Gr. (24 Ayar)': 'Gram AltÄ±n', 'Gr & Ajda (22 Ayar)': '22 Ayar Bilezik', 'Ã‡eyrek': 'Ã‡eyrek AltÄ±n', 'YarÄ±m': 'YarÄ±m AltÄ±n', 'Tam': 'Tam AltÄ±n',
            'Dolar': 'USD', 'Euro': 'EUR', 'GBP': 'GBP', 'Ä°sviÃ§re FrangÄ±': 'CHF', 'GÃ¼mÃ¼ÅŸ': 'GÃ¼mÃ¼ÅŸ'
        };

        async function fetchInlineRate(prefix, mainType) {
            const subInput = document.getElementById(`${prefix}_sub`);
            const sub = subInput ? subInput.value : mainType;
            const rateInput = document.getElementById(`${prefix}_rate`);
            if(!rateInput) return;

            rateInput.placeholder = "Kur Ã§ekiliyor...";
            try {
                const res = await fetch('https://finans.truncgil.com/today.json');
                const data = await res.json();
                let rateData = data[apiMapping[sub]]; 
                if(rateData) {
                    let rateStr = rateData.AlÄ±ÅŸ || rateData.SatÄ±ÅŸ; 
                    let rate = parseFloat(rateStr.toString().replace(/\./g, '').replace(',', '.'));
                    rateInput.value = rate;
                    calcInlineMarket(prefix);
                } else {
                    rateInput.placeholder = "Kur bilgisi bulunamadÄ±";
                }
            } catch(e) { rateInput.placeholder = "Kur alÄ±namadÄ±, elle girin"; }
        }

        function saveInlineAdd(prefix) {
            const typeEl = document.getElementById(`${prefix}Type`);
            const type = typeEl ? typeEl.value : 'DiÄŸer';
            
            let finalVal = 0;
            let finalName = document.getElementById(`${prefix}_name`) ? document.getElementById(`${prefix}_name`).value.trim() : '';

            let targetArray = 'otherDebts';
            if (prefix.includes('Asset') || prefix.includes('asset')) targetArray = 'assets';
            if (type === 'Kredi') targetArray = 'loans';
            if (type === 'Kredi KartÄ±') targetArray = 'debts';

            let itemObj = {};

            if (type === 'Kredi') {
                finalName = finalName || 'Kredi';
                const monthly = parseFloat(document.getElementById(`${prefix}_monthly`).value) || 0;
                const months = parseFloat(document.getElementById(`${prefix}_months`).value) || 0;
                finalVal = parseFloat(document.getElementById(`${prefix}_total`).value) || (monthly * months);
                const lDate = document.getElementById(`${prefix}_date`).value || new Date().toISOString().slice(0,10);
                itemObj = { name: finalName, totalDebt: finalVal, monthly: monthly, totalMonths: months, startDate: lDate, excludeFromBudget: false, excludeFromDebt: false };
            } else if (type === 'Kredi KartÄ±') {
                const mode = document.getElementById(`${prefix}_cc_mode`).value;
                if (mode === 'limit') {
                    let limit = parseFloat(document.getElementById(`${prefix}_cc_limit`).value) || 0;
                    let avail = parseFloat(document.getElementById(`${prefix}_cc_avail`).value) || 0;
                    finalVal = Math.max(0, limit - avail);
                    itemObj = { name: finalName || 'Kredi KartÄ±', val: finalVal, calcMode: true, limit: limit, avail: avail };
                } else {
                    finalVal = parseFloat(document.getElementById(`${prefix}_total`).value) || 0;
                    itemObj = { name: finalName || 'Kredi KartÄ±', val: finalVal, calcMode: false };
                }
            } else if (type === 'DiÄŸer') {
                finalVal = parseFloat(document.getElementById(`${prefix}_total`).value) || 0;
                itemObj = { name: finalName || 'DiÄŸer Kalem', val: finalVal };
            } else {
                const sub = document.getElementById(`${prefix}_sub`).value;
                const amount = parseFloat(document.getElementById(`${prefix}_amount`).value) || 0;
                finalVal = parseFloat(document.getElementById(`${prefix}_total`).value) || 0;
                
                if (!finalName) {
                    finalName = amount > 0 ? `${amount} ${sub}` : `${sub}`;
                }
                itemObj = { name: finalName, val: finalVal };
            }

            state[targetArray].unshift(itemObj); // Listenin baÅŸÄ±na ekle
            saveToCloud();
            
            cancelInlineAdd(prefix);
            if (prefix.startsWith('dash')) updateDashboardUI();
            else renderWizardLists();
        }

        // --- HARCAMA Ä°ÅžLEMLERÄ° ---
        function addExpense() {
            const amtInp = document.getElementById('expAmt');
            const descInp = document.getElementById('expDesc');
            const catInp = document.getElementById('expCat'); 
            const editIndex = parseInt(document.getElementById('editExpIndex').value);
            const amt = parseFloat(amtInp.value);
            
            if(!amt) return amtInp.focus();

            const myStr = currentUser?.displayName || currentUser?.email?.split('@')[0] || 'Ben';
            
            // HÄ±zlÄ± Tarih SeÃ§ici DeÄŸerini Kullan
            const d = new Date();
            d.setDate(d.getDate() - currentExpenseDateOffset);
            let finalDate = d.toLocaleDateString('tr-TR');
            
            const selectedCat = catInp.value;
            let finalDesc = descInp.value.trim();
            if (!finalDesc && selectedCat !== 'DiÄŸer') {
                finalDesc = selectedCat;
            } else if (!finalDesc) {
                finalDesc = 'DiÄŸer';
            }

            if(editIndex > -1 && currentUserRole === 'limited') {
                if(state.expenses[editIndex].addedBy !== myStr && state.expenses[editIndex].addedBy !== 'Ben') {
                    return alert("Sadece kendi harcamalarÄ±nÄ±zÄ± dÃ¼zenleyebilirsiniz.");
                }
            }

            if(editIndex > -1) {
                state.expenses[editIndex].amount = amt;
                state.expenses[editIndex].desc = finalDesc;
                state.expenses[editIndex].category = selectedCat; 
                
                document.getElementById('editExpIndex').value = "-1";
                document.getElementById('addExpBtn').innerHTML = '<i class="fas fa-plus text-xl"></i>';
                document.getElementById('addExpBtn').classList.replace('bg-green-600', 'bg-blue-600');
            } else {
                state.expenses.unshift({ 
                    amount: amt, 
                    desc: finalDesc,
                    category: selectedCat, 
                    date: finalDate, 
                    addedBy: myStr, ts: Date.now()
                });
            }
            
            amtInp.value = ''; descInp.value = ''; 
            currentExpenseDateOffset = 0; 
            updateExpenseDateLabel();
            
            saveToCloud(); updateDashboardUI();
        }
        
        function editExpense(idx) {
            const exp = state.expenses[idx];
            document.getElementById('expAmt').value = exp.amount;
            document.getElementById('expDesc').value = exp.desc;
            const catInp = document.getElementById('expCat');
            if (exp.category) {
                catInp.value = exp.category;
            } else {
                catInp.value = 'DiÄŸer';
            }
            
            document.getElementById('editExpIndex').value = idx;
            document.getElementById('addExpBtn').innerHTML = '<i class="fas fa-check text-xl"></i>';
            document.getElementById('addExpBtn').classList.replace('bg-blue-600', 'bg-green-600');
            document.querySelector('.glass-card').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteExpense(idx) {
            if(confirm("Bu harcamayÄ± silmek istediÄŸinize emin misiniz?")) { 
                state.expenses.splice(idx, 1); saveToCloud(); updateDashboardUI(); 
            }
        }

        function changeHistoryDate(step) {
            window.currentHistoryDateIndex += step;
            renderHistoryList();
        }

        function renderHistoryList() {
            const list = document.getElementById('historyList');
            if(!list) return;
            if(state.expenses.length === 0) { list.innerHTML = '<div class="text-center text-gray-400 text-xs py-4">Harcama yok.</div>'; return; }
            
            const myName = currentUser?.displayName || currentUser?.email?.split('@')[0] || 'Ben';
            
            const sortedExpenses = [...state.expenses].sort((a, b) => b.ts - a.ts);
            const grouped = {};
            sortedExpenses.forEach((e) => {
                const origIdx = state.expenses.indexOf(e);
                if(!grouped[e.date]) grouped[e.date] = [];
                grouped[e.date].push({ ...e, originalIndex: origIdx });
            });

            const sortedDates = [...new Set(sortedExpenses.map(e => e.date))];

            if (window.currentHistoryDateIndex >= sortedDates.length) window.currentHistoryDateIndex = sortedDates.length - 1;
            if (window.currentHistoryDateIndex < 0) window.currentHistoryDateIndex = 0;

            const currentDate = sortedDates[window.currentHistoryDateIndex];
            const expensesForDate = grouped[currentDate];

            const hasPrev = window.currentHistoryDateIndex > 0; // Index 0 is newest, so > 0 means there are newer dates
            const hasNext = window.currentHistoryDateIndex < sortedDates.length - 1; // Means there are older dates

            let html = `
            <div class="mb-5">
                <div class="flex items-center justify-between gap-4 mb-4 bg-blue-50 p-2 rounded-xl border border-blue-100">
                    <button onclick="changeHistoryDate(1)" class="w-8 h-8 flex items-center justify-center rounded-lg bg-white text-blue-600 shadow-sm hover:bg-blue-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" ${!hasNext ? 'disabled' : ''}><i class="fas fa-chevron-left"></i></button>
                    <div class="text-blue-800 px-3 py-1 rounded-lg text-sm font-black tracking-widest text-center flex-1">${currentDate}</div>
                    <button onclick="changeHistoryDate(-1)" class="w-8 h-8 flex items-center justify-center rounded-lg bg-white text-blue-600 shadow-sm hover:bg-blue-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" ${!hasPrev ? 'disabled' : ''}><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="space-y-2">`;
            
            expensesForDate.forEach(e => {
                const canEdit = currentUserRole === 'owner' || currentUserRole === 'full' || e.addedBy === myName || e.addedBy === 'Ben';
                const initials = e.addedBy.substring(0, 2).toUpperCase();
                html += `
                    <div class="flex justify-between items-center p-3 bg-white border border-gray-100 rounded-xl hover:shadow-md transition-all group">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 font-black text-xs uppercase border border-gray-200">
                                ${initials}
                            </div>
                            <div>
                                <p class="font-black text-gray-800 text-sm">${e.desc}</p>
                                <p class="text-[9px] text-gray-400 font-bold uppercase tracking-wide">
                                    ${e.category && e.category !== 'DiÄŸer' ? `<span class="bg-blue-50 text-blue-600 px-1 rounded mr-1">${e.category}</span>` : ''} 
                                    ${e.addedBy}
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-black text-red-500 text-base">-â‚º${Math.floor(e.amount).toLocaleString()}</span>
                            ${canEdit ? `<div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="editExpense(${e.originalIndex})" class="text-blue-300 hover:text-blue-500"><i class="fas fa-pen"></i></button><button onclick="deleteExpense(${e.originalIndex})" class="text-gray-200 hover:text-red-500"><i class="fas fa-trash-alt"></i></button></div>` : ''}
                        </div>
                    </div>`;
            });
            html += `</div></div>`;
            list.innerHTML = html;
        }

        function renderDetailedHealthLists() { 
            const createRow = (name, amount, type, idx, extraClass='', clickAction='', isExcluded=false) => `
                <div class="flex justify-between items-center p-3 rounded-xl text-xs font-bold text-gray-600 bg-gray-50 border border-gray-100 shadow-sm group ${extraClass} ${isExcluded ? 'opacity-50 grayscale' : ''}" ${clickAction ? `onclick="${clickAction}" style="cursor:pointer"` : ''}>
                    <span>${name}</span>
                    <div class="flex items-center gap-3">
                        <span class="font-black text-gray-800">â‚º${Math.floor(amount).toLocaleString()}</span>
                        <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="event.stopPropagation(); openEditModal('${type}', ${idx})" class="text-blue-400 hover:text-blue-600"><i class="fas fa-pen"></i></button>
                            ${idx !== 'total' ? `<button onclick="event.stopPropagation(); deleteHealthItem('${type}', ${idx})" class="text-red-300 hover:text-red-500"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                    </div>
                </div>`; 
            
            const activeBills = state.bills.filter(b => b.val > 0);
            const totalBills = activeBills.reduce((s, b) => s + b.val, 0);
            const billsHTML = activeBills.map((b) => createRow(b.name, b.val, 'bills', state.bills.indexOf(b), 'bg-white')).join('');
            const billsAccordion = `
            <div class="border border-blue-100 rounded-2xl overflow-hidden bg-blue-50/50 shadow-sm mb-6">
                <div onclick="document.getElementById('billsDetails').classList.toggle('open');" class="flex justify-between items-center p-4 cursor-pointer hover:bg-blue-100/50 transition-colors">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center"><i class="fas fa-file-invoice-dollar"></i></div>
                        <span class="text-sm font-black text-blue-900 uppercase tracking-wide">AylÄ±k Sabit Giderler</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-black text-blue-900 text-lg">â‚º${totalBills.toLocaleString()}</span>
                        <i class="fas fa-chevron-down text-blue-400"></i>
                    </div>
                </div>
                <div id="billsDetails" class="health-detail space-y-2 px-4 pb-4">
                    ${billsHTML || '<div class="text-xs text-gray-400 text-center py-2">KayÄ±tlÄ± sabit gider yok.</div>'}
                    <button onclick="addNewHealthItem('bills')" class="w-full py-3 text-xs font-bold text-blue-500 hover:text-blue-700 bg-white border border-dashed border-blue-200 rounded-xl transition-colors">+ Yeni Sabit Gider Ekle</button>
                </div>
            </div>`;
            document.getElementById('fixedExpensesSection').innerHTML = billsAccordion;

            let debtHTML = ''; 
            const activeLoans = state.loans.filter(l => l.totalDebt > 0);
            const totalLoanDebt = activeLoans.reduce((s,l) => s + (l.excludeFromDebt ? 0 : l.totalDebt), 0);
            
            if (activeLoans.length > 0) {
                 const loansHTML = activeLoans.map(l => {
                    const isExcluded = l.excludeFromDebt;
                    return createRow(l.name + (isExcluded ? ' <span class="text-[8px] text-red-400 font-bold ml-1 bg-red-50 px-1 rounded">(Dahil DeÄŸil)</span>' : ''), l.totalDebt, 'loans', state.loans.indexOf(l), 'bg-white', `openLoanPlanModal(${state.loans.indexOf(l)})`, isExcluded);
                 }).join('');

                 debtHTML += `
                 <div class="border border-red-100 rounded-2xl overflow-hidden bg-red-50/50 shadow-sm mb-2">
                    <div onclick="document.getElementById('loanDetails').classList.toggle('open');" class="flex justify-between items-center p-3 cursor-pointer hover:bg-red-100/50 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-red-100 text-red-600 rounded-full flex items-center justify-center"><i class="fas fa-hand-holding-usd"></i></div>
                            <span class="text-xs font-black text-red-900 uppercase tracking-wide">Toplam Kredi Borcu</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-black text-red-900 text-sm">â‚º${totalLoanDebt.toLocaleString()}</span>
                            <i class="fas fa-chevron-down text-red-400"></i>
                        </div>
                    </div>
                    <div id="loanDetails" class="health-detail space-y-2 px-3 pb-3">
                        ${loansHTML}
                    </div>
                </div>`;
            }

            const activeCards = state.debts.filter(d => d.val > 0);
            const totalCardDebt = activeCards.reduce((s,d) => s + (d.excludeFromNetWorth ? 0 : d.val), 0);
            
            if (activeCards.length > 0) {
                 const cardsHTML = activeCards.map(d => createRow(d.name + (d.excludeFromNetWorth ? ' <span class="text-[8px] text-red-400 font-bold ml-1 bg-red-50 px-1 rounded">(Dahil DeÄŸil)</span>' : ''), d.val, 'debts', state.debts.indexOf(d), 'bg-white', '', d.excludeFromNetWorth)).join('');
                 
                 debtHTML += `
                 <div class="border border-purple-100 rounded-2xl overflow-hidden bg-purple-50/50 shadow-sm mb-2">
                    <div onclick="document.getElementById('cardDetails').classList.toggle('open');" class="flex justify-between items-center p-3 cursor-pointer hover:bg-purple-100/50 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center"><i class="fas fa-credit-card"></i></div>
                            <span class="text-xs font-black text-purple-900 uppercase tracking-wide">Kredi KartlarÄ± ToplamÄ±</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-black text-purple-900 text-sm">â‚º${totalCardDebt.toLocaleString()}</span>
                            <i class="fas fa-chevron-down text-purple-400"></i>
                        </div>
                    </div>
                    <div id="cardDetails" class="health-detail space-y-2 px-3 pb-3">
                        ${cardsHTML}
                    </div>
                </div>`;
            }

            const sortedOtherDebts = [...state.otherDebts].filter(d => d.val > 0).sort((a,b) => b.val - a.val);
            sortedOtherDebts.forEach((d) => {
                 const originalIndex = state.otherDebts.indexOf(d);
                 debtHTML += createRow(d.name + (d.excludeFromNetWorth ? ' <span class="text-[8px] text-red-400 font-bold ml-1 bg-red-50 px-1 rounded">(Dahil DeÄŸil)</span>' : ''), d.val, 'otherDebts', originalIndex, '', '', d.excludeFromNetWorth);
            }); 
            
            document.getElementById('detailedDebtsList').innerHTML = debtHTML || '<span class="text-gray-300 text-xs">KayÄ±tlÄ± borÃ§ yok</span>'; 
            
            const sortedAssets = [...state.assets].filter(a => a.val > 0).sort((a,b) => b.val - a.val);
            let assetHTML = sortedAssets.map((a) => {
                const originalIndex = state.assets.indexOf(a);
                return createRow(a.name + (a.excludeFromNetWorth ? ' <span class="text-[8px] text-red-400 font-bold ml-1 bg-red-50 px-1 rounded">(Dahil DeÄŸil)</span>' : ''), a.val, 'assets', originalIndex, '', '', a.excludeFromNetWorth);
            }).join(''); 
            document.getElementById('detailedAssetsList').innerHTML = assetHTML || '<span class="text-gray-300 text-xs">KayÄ±tlÄ± varlÄ±k yok</span>'; 
        }

        function addNewHealthItem(type) { 
            const name = prompt("Yeni Kalem AdÄ±:"); 
            if(name) { 
                const val = parseFloat(prompt("Tutar:")) || 0; 
                let newItem = {name, val:val};
                if(type === 'loans') newItem = {name, totalDebt:val, monthly:0, totalMonths:1, startDate: new Date().toISOString().slice(0,10)};
                else if(type === 'debts') newItem = {name, val:val, calcMode: false};
                
                state[type].unshift(newItem); 
                saveToCloud(); updateDashboardUI(); 
            } 
        }
        
        function openEditModal(type, index) { 
            const item = state[type][index]; 
            document.getElementById('editItemName').value = item.name; 
            document.getElementById('editItemVal').value = item.val || item.totalDebt || 0; 
            document.getElementById('editItemType').value = type; 
            document.getElementById('editItemIndex').value = index; 
            
            const chk = document.getElementById('editExcludeNetWorth');
            if (type === 'loans') chk.checked = item.excludeFromDebt || false;
            else chk.checked = item.excludeFromNetWorth || false;
            
            const modal = document.getElementById('editItemModal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('open'), 10);
            document.getElementById('overlay').classList.add('active'); 
        }
        
        function saveEditedItem() { 
            const type = document.getElementById('editItemType').value; 
            const idx = parseInt(document.getElementById('editItemIndex').value); 
            const name = document.getElementById('editItemName').value; 
            const val = parseFloat(document.getElementById('editItemVal').value); 
            const excluded = document.getElementById('editExcludeNetWorth').checked;

            if(state[type][idx]) { 
                state[type][idx].name = name; 
                if(type === 'loans') {
                    state[type][idx].totalDebt = val; 
                    state[type][idx].excludeFromDebt = excluded;
                } else { 
                    state[type][idx].val = val; 
                    state[type][idx].excludeFromNetWorth = excluded;
                    if (type === 'debts' && state[type][idx].calcMode) state[type][idx].calcMode = false; 
                }
                saveToCloud(); updateDashboardUI(); closeEditModal(); 
            } 
        }
        function closeEditModal() { 
            const modal = document.getElementById('editItemModal');
            modal.classList.remove('open');
            setTimeout(() => modal.classList.add('hidden'), 300);
            document.getElementById('overlay').classList.remove('active'); 
        }
        function deleteHealthItem(type, idx) { if(confirm('Bu kalemi tamamen silmek istediÄŸinize emin misiniz?')) { state[type].splice(idx, 1); saveToCloud(); updateDashboardUI(); } }

        function renderCharts() {
            const ctx1 = document.getElementById('assetsChart').getContext('2d');
            const ctx2 = document.getElementById('expensesChart').getContext('2d');
            const ctx3 = document.getElementById('historyTrendChart').getContext('2d');

            if(assetsChartInstance) assetsChartInstance.destroy();
            if(expensesChartInstance) expensesChartInstance.destroy();
            if(historyChartInstance) historyChartInstance.destroy();
            
            const filterVal = document.getElementById('analysisDateFilter').value; 
            let filteredExpenses = state.expenses;
            
            if (filterVal) {
                const [year, month] = filterVal.split('-').map(Number);
                const salaryDay = state.salaryDay || 15;
                const startDate = new Date(year, month - 1, salaryDay);
                const endDate = new Date(year, month, salaryDay);
                
                const startStr = startDate.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
                const endStr = new Date(endDate - 1).toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
                document.getElementById('analysisPeriodLabel').innerText = `DÃ¶nem: ${startStr} - ${endStr}`;
                
                filteredExpenses = state.expenses.filter(e => {
                    const parts = e.date.split('.'); 
                    const d = new Date(parts[2], parts[1] - 1, parts[0]);
                    return d >= startDate && d < endDate;
                });
            }

            const assets = state.assets.reduce((s,a)=>s+(a.val||0),0);
            const debts = state.loans.filter(l=>!l.excludeFromDebt).reduce((s,l)=>s+(l.totalDebt||0),0) + state.debts.reduce((s,d)=>s+(d.val||0),0) + state.otherDebts.reduce((s,d)=>s+(d.val||0),0);
            
            const expenseMap = {};
            filteredExpenses.forEach(e => {
                let key = e.category; 
                if (!key || key === 'DiÄŸer') key = 'DiÄŸer / Ã–zel';
                expenseMap[key] = (expenseMap[key] || 0) + e.amount; 
            });

            const sortedKeys = Object.keys(expenseMap).sort((a,b) => expenseMap[b] - expenseMap[a]);
            const sortedData = sortedKeys.map(k => expenseMap[k]);

            assetsChartInstance = new Chart(ctx1, { type: 'doughnut', data: { labels: ['VarlÄ±klar', 'BorÃ§lar'], datasets: [{ data: [assets, debts], backgroundColor: ['#22c55e', '#ef4444'], borderWidth: 0 }] }, options: { cutout: '70%', plugins: { legend: { position: 'bottom' } } } });
            expensesChartInstance = new Chart(ctx2, { type: 'bar', data: { labels: sortedKeys.slice(0, 8), datasets: [{ label: 'Harcama', data: sortedData.slice(0, 8), backgroundColor: '#3b82f6', borderRadius: 5 }] }, options: { scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } } });
            
            // --- GÃœNCELLENMÄ°Åž TREND GRAFÄ°ÄžÄ° (TL / USD SEÃ‡ENEKLÄ°) ---
            const sortedHistory = [...state.monthlyHistory].sort((a, b) => a.date.localeCompare(b.date));
            const labels = sortedHistory.map(h => h.date);
            
            let dNet = [];
            let chartColor = '#3b82f6'; // Mavi (VarsayÄ±lan)
            let pointPosColor = '#22c55e'; // YeÅŸil
            let pointNegColor = '#ef4444'; // KÄ±rmÄ±zÄ±
            let labelPrefix = 'â‚º';

            if (currentChartMode === 'USD') {
                dNet = sortedHistory.map(h => {
                    const netTL = (h.assets || 0) - (h.debts || 0);
                    const rate = h.usdRate || 0; // EÄŸer kur girilmediyse 0
                    return rate > 0 ? (netTL / rate) : 0; // Kur yoksa 0 gÃ¶ster
                });
                chartColor = '#10b981'; // YeÅŸil (Dolar iÃ§in)
                labelPrefix = '$';
            } else {
                dNet = sortedHistory.map(h => (h.assets || 0) - (h.debts || 0));
            }

            historyChartInstance = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { 
                            label: currentChartMode === 'USD' ? 'Net Durum (USD)' : 'Net Durum (TL)', 
                            data: dNet, 
                            borderColor: chartColor, 
                            backgroundColor: (context) => {
                                const ctx = context.chart.ctx;
                                const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                                gradient.addColorStop(0, currentChartMode === 'USD' ? 'rgba(16, 185, 129, 0.4)' : 'rgba(59, 130, 246, 0.4)');
                                gradient.addColorStop(1, currentChartMode === 'USD' ? 'rgba(16, 185, 129, 0.0)' : 'rgba(59, 130, 246, 0.0)');
                                return gradient;
                            },
                            fill: true, 
                            tension: 0.4,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            pointBackgroundColor: dNet.map(val => val >= 0 ? pointPosColor : pointNegColor),
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2
                        }
                    ]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { display: false }, 
                        tooltip: { 
                            callbacks: {
                                label: function(context) {
                                    return `Net: ${labelPrefix}${context.raw.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
                                }
                            }
                        } 
                    }, 
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            grid: { color: (ctx) => ctx.tick.value === 0 ? '#6b7280' : '#f3f4f6', lineWidth: (ctx) => ctx.tick.value === 0 ? 2 : 1 }
                        } 
                    } 
                }
            });
        }

        function switchChartMode(mode) {
            currentChartMode = mode;
            // Buton stillerini gÃ¼ncelle
            const btnTL = document.getElementById('btnChartTL');
            const btnUSD = document.getElementById('btnChartUSD');
            
            if (mode === 'TL') {
                btnTL.className = "text-[10px] font-bold px-2 py-1 rounded bg-blue-100 text-blue-600 shadow-sm";
                btnUSD.className = "text-[10px] font-bold px-2 py-1 rounded bg-gray-100 text-gray-500 hover:bg-green-100 hover:text-green-600 transition-colors";
            } else {
                btnUSD.className = "text-[10px] font-bold px-2 py-1 rounded bg-green-100 text-green-600 shadow-sm";
                btnTL.className = "text-[10px] font-bold px-2 py-1 rounded bg-gray-100 text-gray-500 hover:bg-blue-100 hover:text-blue-600 transition-colors";
            }
            
            renderCharts(); // GrafiÄŸi yeniden Ã§iz
        }

        function addHistoryRecord() {
            const date = document.getElementById('histDate').value; 
            const assets = parseFloat(document.getElementById('histAssets').value); 
            const debts = parseFloat(document.getElementById('histDebts').value);
            const rate = parseFloat(document.getElementById('histUSDRate').value); // YENÄ° KUR
            
            if(!date) return alert("Tarih seÃ§in");
            
            const existingIndex = state.monthlyHistory.findIndex(h => h.date === date);
            if(existingIndex > -1) {
                 if(confirm("Bu aya ait kayÄ±t zaten var. GÃ¼ncellensin mi?")) {
                     state.monthlyHistory[existingIndex] = {date, assets: assets||0, debts: debts||0, usdRate: rate||0};
                 } else return;
            } else {
                 state.monthlyHistory.push({date, assets: assets||0, debts: debts||0, usdRate: rate||0});
            }
            
            saveToCloud(); 
            renderCharts(); 
            renderHistoryTableUI();
            alert("KayÄ±t Eklendi/GÃ¼ncellendi");
        }

        function renderHistoryTableUI() {
            const tbody = document.getElementById('historyTableBody');
            if(!tbody) return;
            
            const sorted = [...state.monthlyHistory].sort((a,b) => b.date.localeCompare(a.date)); 
            
            if(sorted.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-400 font-normal">HenÃ¼z geÃ§miÅŸ kayÄ±t yok.</td></tr>';
                return;
            }

            tbody.innerHTML = sorted.map(h => `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 text-gray-600">${h.date}</td>
                    <td class="py-3 text-right text-green-600">â‚º${(h.assets||0).toLocaleString()}</td>
                    <td class="py-3 text-right text-red-500">â‚º${(h.debts||0).toLocaleString()}</td>
                    <td class="py-3 text-right text-blue-500 font-normal">${h.usdRate ? '$' + h.usdRate : '-'}</td>
                    <td class="py-3 text-center">
                        <button onclick="deleteHistoryItem('${h.date}')" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function deleteHistoryItem(date) {
            if(confirm(`${date} tarihli kayÄ±t silinsin mi?`)) {
                state.monthlyHistory = state.monthlyHistory.filter(h => h.date !== date);
                saveToCloud();
                renderCharts();
                renderHistoryTableUI();
            }
        }
        
        function openLoanPlanModal(loanIndex) {
            const loan = state.loans[loanIndex];
            if (!loan) return;
            document.getElementById('loanPlanTitle').innerText = loan.name;
            const tbody = document.getElementById('loanPlanBody');
            tbody.innerHTML = '';
            
            let currentDate = new Date(loan.startDate || new Date());
            const monthly = loan.monthly || 0;
            const totalMonths = loan.totalMonths || 0;
            const now = new Date();

            for(let i=1; i<=totalMonths; i++) {
                const dateStr = currentDate.toLocaleDateString('tr-TR', { month: 'long', year: 'numeric', day: 'numeric' });
                const isPaid = currentDate < now && (currentDate.getMonth() !== now.getMonth() || currentDate.getFullYear() !== now.getFullYear());
                
                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-100 last:border-0 hover:bg-red-50 transition-colors";
                tr.innerHTML = `
                    <td class="py-3 pl-2">${i}/${totalMonths}</td>
                    <td class="py-3">${dateStr}</td>
                    <td class="py-3 text-right">â‚º${Math.floor(monthly).toLocaleString()}</td>
                    <td class="py-3 text-center"><span class="${isPaid ? 'text-green-500 bg-green-50' : 'text-gray-400 bg-gray-100'} px-2 py-1 rounded text-[10px] uppercase font-black tracking-wider">${isPaid ? 'Ã–dendi' : 'Bekliyor'}</span></td>
                `;
                tbody.appendChild(tr);
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
            
            const modal = document.getElementById('loanPlanModal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('open'), 10);
            document.getElementById('overlay').classList.add('active');
        }

        function closeLoanPlanModal() {
            const modal = document.getElementById('loanPlanModal');
            modal.classList.remove('open');
            setTimeout(() => modal.classList.add('hidden'), 300);
            document.getElementById('overlay').classList.remove('active'); 
        }

        function openBalanceModal() {
            const now = new Date(); const todayStr = now.toLocaleDateString('tr-TR');
            let startCalc = new Date(state.registrationDate);
            if(isNaN(startCalc.getTime())) startCalc = new Date();
            
            let isSalaryBased = false;
            if (state.expenses.length > 0) {
                let minExpDate = new Date();
                state.expenses.forEach(e => {
                    let dParts = e.date.split('.');
                    if(dParts.length === 3) {
                        let d = new Date(dParts[2], dParts[1]-1, dParts[0]);
                        if (d < minExpDate) minExpDate = d;
                    }
                });
                if (minExpDate.getTime() < startCalc.getTime() - (1000 * 60 * 60 * 24)) {
                    const salaryDay = state.salaryDay || 15;
                    let lastSalaryDate = new Date(now.getFullYear(), now.getMonth(), salaryDay);
                    if (now.getDate() < salaryDay) {
                        lastSalaryDate.setMonth(lastSalaryDate.getMonth() - 1);
                    }
                    startCalc = lastSalaryDate;
                    isSalaryBased = true;
                }
            }
            
            const daysPassed = Math.max(1, Math.ceil(Math.abs(now - startCalc) / (1000 * 60 * 60 * 24))); 
            const dailyLimit = state.manualDailyLimit || 0;
            const accumulatedLimit = dailyLimit * daysPassed;
            const totalSpent = state.expenses.reduce((s,e)=>s+e.amount,0);
            const balance = accumulatedLimit - totalSpent;

            const html = `
                <div class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100 text-center">
                        <p class="text-[10px] font-bold text-blue-400 uppercase tracking-widest mb-1">Åžu Anki Durum</p>
                        <p class="text-3xl font-black ${balance >= 0 ? 'text-green-600' : 'text-red-600'}">â‚º${Math.floor(balance).toLocaleString()}</p>
                    </div>
                    
                    <div class="space-y-3 pt-2">
                        <div class="flex justify-between items-center text-xs font-bold text-gray-600 border-b border-gray-100 pb-2">
                            <span>Hesap BaÅŸlangÄ±cÄ±</span>
                            <span class="text-gray-800">${startCalc.toLocaleDateString('tr-TR')} ${isSalaryBased ? '<span class="text-[9px] bg-yellow-100 text-yellow-700 px-1 rounded ml-1">MaaÅŸ GÃ¼nÃ¼</span>' : '<span class="text-[9px] bg-gray-100 text-gray-500 px-1 rounded ml-1">KayÄ±t Tarihi</span>'}</span>
                        </div>
                        <div class="flex justify-between items-center text-xs font-bold text-gray-600 border-b border-gray-100 pb-2">
                            <span>GeÃ§en GÃ¼n</span>
                            <span class="text-gray-800">${daysPassed} GÃ¼n</span>
                        </div>
                        <div class="flex justify-between items-center text-xs font-bold text-green-600 border-b border-gray-100 pb-2">
                            <span>Biriken Limit (${daysPassed} x â‚º${Math.floor(dailyLimit)})</span>
                            <span>+ â‚º${Math.floor(accumulatedLimit).toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-center text-xs font-bold text-red-500 border-b border-gray-100 pb-2">
                            <span>Toplam Harcanan</span>
                            <span>- â‚º${Math.floor(totalSpent).toLocaleString()}</span>
                        </div>
                    </div>

                    <div class="p-3 bg-gray-50 rounded-xl text-[10px] text-gray-500 leading-relaxed">
                        <p><strong>GerÃ§ek Bakiye MantÄ±ÄŸÄ±:</strong><br>
                        Sistem, belirlediÄŸiniz gÃ¼nlÃ¼k limiti her yeni gÃ¼nde kumbaranÄ±za ekler. HarcamalarÄ±nÄ±z bu kumbaradan dÃ¼ÅŸÃ¼lÃ¼r. Kalan tutar, ay sonuna kadar "fazladan" harcayabileceÄŸiniz veya biriktirebileceÄŸiniz net tutardÄ±r.</p>
                        ${isSalaryBased ? '<p class="mt-2 text-blue-500">Not: GeÃ§miÅŸe dÃ¶nÃ¼k harcama girdiÄŸiniz iÃ§in hesaplama son maaÅŸ gÃ¼nÃ¼nÃ¼zden baÅŸlatÄ±lmÄ±ÅŸtÄ±r.</p>' : ''}
                    </div>
                </div>
            `;
            
            document.getElementById('balanceModalContent').innerHTML = html;
            const modal = document.getElementById('balanceModal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('open'), 10);
            document.getElementById('overlay').classList.add('active');
        }

        function closeBalanceModal() {
            const modal = document.getElementById('balanceModal');
            modal.classList.remove('open');
            setTimeout(() => modal.classList.add('hidden'), 300);
            document.getElementById('overlay').classList.remove('active'); 
        }

        function openCalcModal() { 
            // Veri korumasÄ± eklendi (|| [])
            const totalInc = (state.incomes || []).reduce((s, i) => s + (i.val||0), 0); 
            const normalBills = (state.bills || []).reduce((s, b) => s + (b.val||0), 0);
            
            const loansTreatedAsBills = (state.loans || []).filter(l => l.excludeFromDebt && !l.excludeFromBudget).reduce((s, l) => s + (l.monthly || 0), 0);
            
            const totalFix = normalBills + loansTreatedAsBills;
            
            const standardLoans = (state.loans || []).filter(l => !l.excludeFromDebt && !l.excludeFromBudget).reduce((s, l) => s + (l.monthly || 0), 0);
            
            const grossNet = totalInc - totalFix;
            
            const netIncome = grossNet - standardLoans;
            
            const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
            const daily = state.manualDailyLimit || 0;
            const monthlySpend = daily * daysInMonth;
            
            // Hedeflenen Birikim (Kredi Dahil) = grossNet - monthlySpend
            const savings = grossNet - monthlySpend;

            // DetaylÄ± liste oluÅŸturma
            let incomeList = (state.incomes || []).map(i => `<div class="flex justify-between text-xs text-green-600 pl-2"><span>${i.name}</span><span>+â‚º${(i.val||0).toLocaleString()}</span></div>`).join('');
            let billList = (state.bills || []).filter(b => b.val > 0).map(b => `<div class="flex justify-between text-xs text-red-500 pl-2"><span>${b.name}</span><span>-â‚º${b.val.toLocaleString()}</span></div>`).join('');
            
            let hiddenLoanList = (state.loans || []).filter(l => l.excludeFromDebt && !l.excludeFromBudget).map(l => `<div class="flex justify-between text-xs text-red-500 pl-2"><span>${l.name} (Gizli Taksit)</span><span>-â‚º${(l.monthly||0).toLocaleString()}</span></div>`).join('');
            
            let standardLoanList = (state.loans || []).filter(l => !l.excludeFromDebt && !l.excludeFromBudget).map(l => `<div class="flex justify-between text-xs text-red-500 pl-2"><span>${l.name} (Taksit)</span><span>-â‚º${(l.monthly||0).toLocaleString()}</span></div>`).join('');

            document.getElementById('calcModalContent').innerHTML = `
                <div class="space-y-4">
                    <div class="bg-green-50 p-4 rounded-2xl border border-green-100">
                        <div class="flex justify-between font-black text-green-800 mb-2"><span>Toplam Gelir</span><span>+ â‚º${totalInc.toLocaleString()}</span></div>
                        <div class="space-y-1 border-t border-green-200 pt-2">${incomeList || '<span class="text-xs italic opacity-50">Gelir kalemi yok</span>'}</div>
                    </div>

                    <div class="bg-red-50 p-4 rounded-2xl border border-red-100">
                        <div class="flex justify-between font-black text-red-800 mb-2"><span>Sabit Giderler (Fatura & Gizli Kredi)</span><span>- â‚º${totalFix.toLocaleString()}</span></div>
                        <div class="space-y-1 border-t border-red-200 pt-2">
                            ${billList}
                            ${hiddenLoanList}
                            ${(!billList && !hiddenLoanList) ? '<span class="text-xs italic opacity-50">Gider kalemi yok</span>' : ''}
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2 py-2">
                        <div class="h-px bg-gray-200 flex-1"></div>
                        <span class="text-xs font-bold text-gray-400 uppercase">Ara Toplam</span>
                        <div class="h-px bg-gray-200 flex-1"></div>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-2xl border border-gray-200 space-y-2">
                        <div class="flex justify-between text-sm font-bold text-gray-600"><span>DaÄŸÄ±tÄ±labilir Gelir:</span><span>â‚º${Math.floor(grossNet).toLocaleString()}</span></div>
                        
                        <div class="border-t border-gray-200 pt-2 flex justify-between text-base font-black text-blue-600"><span>Harcanabilir BÃ¼tÃ§e (Harcama):</span><span>- â‚º${Math.floor(monthlySpend).toLocaleString()}</span></div>
                        <div class="flex justify-between text-sm font-bold text-green-600 border-t border-gray-200 pt-2"><span>Hedeflenen Birikim (Kredi Dahil):</span><span>= â‚º${Math.floor(savings).toLocaleString()}</span></div>
                        
                        ${standardLoans > 0 ? `
                        <div class="mt-2 text-[10px] text-gray-400 italic">
                             * Bu birikimin â‚º${standardLoans.toLocaleString()} kadarÄ± kredi Ã¶demesidir.
                        </div>
                        ` : ''}
                    </div>

                    <div class="text-center pt-2">
                        <p class="text-[10px] text-gray-400 uppercase tracking-widest mb-1">GÃ¼nlÃ¼k Limit HesabÄ±</p>
                        <p class="text-xs font-bold text-gray-500">â‚º${Math.floor(monthlySpend).toLocaleString()} / ${daysInMonth} GÃ¼n</p>
                        <p class="text-2xl font-black text-blue-600 mt-1">â‚º${Math.floor(daily).toLocaleString()}</p>
                    </div>
                </div>`; 
            
            const modal = document.getElementById('calcModal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('open'), 10);
            document.getElementById('overlay').classList.add('active'); 
        }
        function closeCalcModal() { 
            const modal = document.getElementById('calcModal');
            modal.classList.remove('open');
            setTimeout(() => modal.classList.add('hidden'), 300);
            document.getElementById('overlay').classList.remove('active'); 
        }
        function closeAllPopups() { 
            document.getElementById('overlay').classList.remove('active'); 
            document.querySelectorAll('.fixed.z-50').forEach(el => { if(el.id !== 'saveIndicator') el.classList.add('hidden'); }); 
            document.querySelectorAll('.side-panel').forEach(el => { el.classList.remove('open'); setTimeout(() => el.classList.add('hidden'), 300); });
        }
    </script>
</body>
</html>
