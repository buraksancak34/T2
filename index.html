<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bizim Bütçe | Profesyonel Finans Yönetimi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; color: #1e293b; overflow-x: hidden; }
        .glass-card { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3); }
        .hidden { display: none; }
        .wizard-step { display: none; }
        .wizard-step.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        input[type="range"] { accent-color: #2563eb; }
        
        .overlay { background: rgba(0,0,0,0.5); opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .overlay.active { opacity: 1; pointer-events: auto; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .expandable-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-in-out; }
        .expanded .expandable-content { max-height: 1000px; }
        .expanded .rotate-icon { transform: rotate(180deg); }
        .rotate-icon { transition: transform 0.3s; }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col items-center">

    <div id="overlay" class="overlay fixed inset-0 z-40" onclick="closeAllPopups()"></div>
    
    <!-- KREDİ DETAY MODALI -->
    <div id="loanDetailModal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[95%] max-w-md glass-card p-8 rounded-[2rem] z-50 shadow-2xl hidden flex flex-col max-h-[80vh]">
        <div class="flex justify-between items-center mb-6 shrink-0">
            <h4 class="font-black text-xl text-gray-800 tracking-tight" id="loanDetailTitle">Kredi Detayı</h4>
            <button onclick="closeLoanDetailModal()" class="text-gray-300 hover:text-red-500"><i class="fas fa-times"></i></button>
        </div>
        <div id="loanDetailContent" class="overflow-y-auto custom-scrollbar space-y-4 pr-2"></div>
    </div>

    <!-- HESAPLAMA DETAYI MODAL -->
    <div id="calcModal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[95%] max-w-sm glass-card p-8 rounded-[2rem] z-50 shadow-2xl hidden text-center border-2 border-blue-50">
        <div class="flex justify-between items-center mb-6">
            <h4 class="font-black text-xl text-gray-800 tracking-tight">Bütçe Özeti</h4>
            <button onclick="closeCalcModal()" class="text-gray-300 hover:text-red-500"><i class="fas fa-times"></i></button>
        </div>
        <div id="calcModalContent" class="space-y-4"></div>
    </div>

    <!-- AYARLAR / DÜZENLEME MODAL -->
    <div id="editSettingsModal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[95%] max-w-lg glass-card p-8 rounded-[2.5rem] z-50 shadow-2xl hidden flex flex-col max-h-[90vh]">
        <div class="flex justify-between items-center mb-6 shrink-0">
            <h4 class="font-black text-xl text-gray-800 tracking-tight">Verileri Güncelle</h4>
            <button onclick="closeEditSettingsModal()" class="text-gray-300 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
        </div>
        <div class="overflow-y-auto pr-2 custom-scrollbar space-y-6 pb-4">
            
            <section class="bg-blue-50/50 p-5 rounded-[2rem] border border-blue-100">
                <div class="flex justify-between items-center mb-4">
                    <h5 class="text-[11px] font-black text-green-600 uppercase tracking-widest">Gelirlerim (Yeşil)</h5>
                    <button onclick="addNewItem('incomes'); renderEditSettingsLists();" class="text-[10px] font-bold text-green-500">+ YENİ</button>
                </div>
                <div id="editIncomesList" class="space-y-2"></div>
            </section>

            <section class="bg-red-50/50 p-5 rounded-[2rem] border border-red-100">
                <div class="flex justify-between items-center mb-4">
                    <h5 class="text-[11px] font-black text-red-600 uppercase tracking-widest">Giderlerim</h5>
                    <button onclick="addNewItem('bills'); renderEditSettingsLists();" class="text-[10px] font-bold text-red-500">+ YENİ</button>
                </div>
                <div id="editBillsList" class="space-y-2"></div>
            </section>

            <section class="bg-indigo-50/50 p-5 rounded-[2rem] border border-indigo-100">
                <div class="flex justify-between items-center mb-4">
                    <h5 class="text-[11px] font-black text-red-600 uppercase tracking-widest">Banka Kredileri</h5>
                    <button onclick="addNewItem('loans'); renderEditSettingsLists();" class="text-[10px] font-bold text-red-500">+ YENİ</button>
                </div>
                <div id="editLoansList" class="space-y-4"></div>
            </section>

            <section class="bg-purple-50/50 p-5 rounded-[2rem] border border-purple-100">
                <div class="flex justify-between items-center mb-4">
                    <h5 class="text-[11px] font-black text-red-600 uppercase tracking-widest">Borçlar & Kartlar</h5>
                    <button onclick="addNewItem('debts'); renderEditSettingsLists();" class="text-[10px] font-black text-red-500">+ YENİ</button>
                </div>
                <div id="editDebtsList" class="space-y-4"></div>
            </section>

            <section class="bg-green-50/50 p-5 rounded-[2rem] border border-green-100">
                <div class="flex justify-between items-center mb-4">
                    <h5 class="text-[11px] font-black text-green-600 uppercase tracking-widest">Varlıklarım</h5>
                    <button onclick="addNewItem('assets'); renderEditSettingsLists();" class="text-[10px] font-bold text-green-500">+ YENİ</button>
                </div>
                <div id="editAssetsList" class="space-y-2"></div>
            </section>

        </div>
        <div class="pt-4 border-t shrink-0">
            <button onclick="saveSettingsChanges()" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl shadow-xl hover:bg-blue-700 transition-all active:scale-95">Değişiklikleri Kaydet</button>
        </div>
    </div>

    <!-- 1. KARŞILAMA EKRANI -->
    <div id="welcomeScreen" class="max-w-md w-full glass-card p-10 rounded-[2.5rem] shadow-2xl text-center space-y-8 my-auto">
        <div class="w-24 h-24 bg-gradient-to-br from-blue-600 to-blue-800 rounded-3xl flex items-center justify-center mx-auto shadow-xl">
            <i class="fas fa-wallet text-white text-4xl"></i>
        </div>
        <h1 class="text-4xl font-black text-gray-900 tracking-tight leading-none">Bizim Bütçe</h1>
        <p class="text-gray-500 text-sm">Finansal takip ve disiplinli bütçe yönetimi.</p>
        <div class="space-y-3 pt-4">
            <button onclick="showLogin()" class="w-full bg-blue-600 text-white font-bold py-5 rounded-2xl shadow-lg active:scale-95 transition-all">Giriş Yap</button>
            <div class="space-y-2 border-t pt-4">
                <button onclick="startWizard()" class="w-full bg-white border-2 border-gray-100 text-gray-700 font-bold py-5 rounded-2xl active:scale-95 transition-all">Hemen Planla</button>
                <button onclick="showLogin()" class="w-full text-blue-600 text-xs font-bold uppercase tracking-widest hover:underline p-2">Bir Plana Dahil Ol</button>
            </div>
        </div>
    </div>

    <!-- 2. GİRİŞ EKRANI -->
    <div id="loginScreen" class="max-w-md w-full glass-card p-10 rounded-[2.5rem] shadow-2xl hidden space-y-6 my-auto">
        <button onclick="showWelcome()" class="text-gray-400 font-bold flex items-center gap-2 hover:text-blue-600 transition-all"><i class="fas fa-arrow-left"></i> Geri</button>
        <h2 class="text-3xl font-black text-gray-800">Hoş Geldiniz</h2>
        <div class="space-y-4">
            <input type="text" id="usernameInput" class="w-full p-4 bg-gray-50 border-0 rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none font-bold" placeholder="ilkersancak">
            <input type="password" id="passwordInput" class="w-full p-4 bg-gray-50 border-0 rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none font-bold" placeholder="1881">
            <button onclick="handleLogin()" class="w-full bg-blue-600 text-white font-bold py-5 rounded-2xl shadow-xl">Devam Et</button>
        </div>
    </div>

    <!-- 3. SİHİRBAZ (WIZARD) -->
    <div id="wizardScreen" class="max-w-xl w-full glass-card p-8 rounded-[2.5rem] shadow-2xl hidden space-y-8 my-auto relative">
        <div id="wizardProgress" class="flex gap-1"></div>
        <div id="wizardContent" class="min-h-[350px]">
            <!-- Dinamik Wizard İçeriği -->
        </div>
        <div class="flex gap-3">
            <button onclick="wizardBack()" class="flex-1 py-4 bg-gray-100 text-gray-500 font-bold rounded-2xl">Geri</button>
            <button onclick="wizardNext()" id="wizNextBtn" class="flex-[2] py-4 bg-blue-600 text-white font-bold rounded-2xl shadow-xl transition-all">Devam Et</button>
        </div>
    </div>

    <!-- 4. ANA DASHBOARD -->
    <div id="dashboardScreen" class="max-w-4xl w-full hidden space-y-8 pb-20">
        <!-- Dashboard Header -->
        <div class="flex justify-between items-center mb-2">
            <div class="flex items-center gap-3">
                <button onclick="openEditSettingsModal()" class="p-3 bg-white shadow-sm rounded-xl text-blue-600 hover:bg-blue-50 border border-blue-50 transition-colors"><i class="fas fa-cog"></i></button>
                <h2 class="text-2xl font-black text-gray-800 tracking-tight">Cebimdeki Para</h2>
            </div>
            <button onclick="logout()" class="text-[10px] font-black bg-white text-red-500 border border-red-50 px-4 py-2 rounded-full uppercase tracking-widest shadow-sm">Çıkış</button>
        </div>

        <!-- Limit Kartı -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-2 glass-card p-10 rounded-[3rem] bg-gradient-to-br from-slate-800 to-slate-900 text-white shadow-2xl relative overflow-hidden">
                <div class="relative z-10 text-center">
                    <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest mb-1 opacity-80 underline underline-offset-8 decoration-blue-500">Bugünkü Harcanabilir Limit</p>
                    <h2 id="displayDailyLimit" class="text-7xl font-black my-2 tracking-tighter text-white leading-none">₺0,00</h2>
                    <div class="mt-8 pt-6 border-t border-white/5 space-y-2">
                        <p class="text-blue-400 text-[10px] font-bold uppercase tracking-widest">Gününüzün Gerçek Bakiyesi</p>
                        <h4 id="displayCumulativeLimit" class="text-4xl font-black text-white tracking-tight italic opacity-90">₺0,00</h4>
                    </div>
                    <div class="flex items-center justify-between mt-10">
                        <span id="displayRemainingDays" class="bg-white/10 px-5 py-2 rounded-full text-[10px] font-bold uppercase tracking-widest text-white/80">Maaşa -- gün</span>
                        <div class="flex gap-4">
                            <span class="text-[10px] text-slate-500 font-bold uppercase italic tracking-widest underline decoration-blue-400">USD Kur: ₺34,50</span>
                        </div>
                    </div>
                </div>
                <div class="absolute -right-20 -top-20 w-64 h-64 bg-white/5 rounded-full blur-3xl"></div>
            </div>

            <!-- Analiz Özet Panel -->
            <div class="glass-card p-8 rounded-[3rem] shadow-xl space-y-6 bg-white border-blue-50 border-2 flex flex-col justify-center text-center">
                <h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest text-center">Aylık Karne</h4>
                <div class="space-y-5">
                    <div class="border-b pb-4">
                        <p class="text-gray-400 uppercase text-[9px] font-bold mb-1">Borç Endeksi (Maaş)</p>
                        <span id="sumSalaryMult" class="font-black text-indigo-600 text-3xl tracking-tighter">0.0</span>
                    </div>
                    <div class="flex justify-between items-end">
                        <span class="text-gray-400 uppercase text-[9px] font-bold">Birikim Hedefi</span>
                        <span id="sumSavings" class="font-black text-green-600 text-sm">₺0</span>
                    </div>
                    <div class="flex justify-between items-end">
                        <span class="text-gray-400 uppercase text-[9px] font-bold">Aylık Gider</span>
                        <span id="sumGiderTotal" class="font-black text-red-600 text-sm">₺0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Harcama Girişi -->
        <div class="glass-card p-10 rounded-[3rem] shadow-xl bg-white border border-gray-100">
            <div class="flex items-center justify-between mb-8">
                <h3 class="font-black text-2xl text-gray-800 tracking-tight text-center md:text-left">Harcama Ekle</h3>
                <span id="todayTotal" class="text-[10px] font-bold bg-blue-50 text-blue-600 px-4 py-2 rounded-full uppercase tracking-widest">Bugün Toplam: ₺0</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <input type="number" id="expAmt" placeholder="₺ 0" onkeyup="if(event.key === 'Enter') addExpense()" class="p-6 bg-gray-50 rounded-2xl outline-none focus:ring-4 focus:ring-blue-100 text-3xl font-black transition-all">
                <input type="text" id="expDesc" value="Diğer" onkeyup="if(event.key === 'Enter') addExpense()" onfocus="if(this.value==='Diğer') this.value=''" onblur="if(this.value==='') this.value='Diğer'" class="p-6 bg-gray-50 rounded-2xl outline-none italic text-gray-500 text-lg">
                <button onclick="addExpense()" class="bg-blue-600 text-white p-6 rounded-2xl font-black text-xl shadow-xl shadow-blue-100 active:scale-95 transition-all hover:bg-blue-700">Kaydet</button>
            </div>
        </div>

        <!-- Harcama Geçmişi -->
        <div class="glass-card p-10 rounded-[3rem] shadow-xl bg-white border border-gray-100">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <h3 class="font-black text-xl text-gray-800 uppercase tracking-widest text-[11px]">Harcama Kayıtları</h3>
                <input type="month" id="historyMonthFilter" onchange="updateDashboardUI()" class="p-3 bg-gray-50 border-0 rounded-xl text-xs font-black outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div id="historyList" class="space-y-4 max-h-[500px] overflow-y-auto pr-3 custom-scrollbar"></div>
        </div>

        <!-- FİNANSAL SAĞLIK RAPORU (DETAYLI - EN ALTTA) -->
        <div id="financialHealthSection" class="glass-card p-10 rounded-[3rem] shadow-xl bg-white border border-gray-100 space-y-10">
            <div class="flex justify-between items-center border-b pb-8">
                <div class="flex-1"></div>
                <div class="flex flex-col items-center flex-1">
                    <h3 class="font-black text-3xl text-gray-800 tracking-tight mb-2 text-center">Sağlık Raporu</h3>
                    <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mb-4">Net Durum (Varlık - Borç)</p>
                    <div id="netStatusBadge" class="px-10 py-4 rounded-[2rem] font-black text-3xl shadow-xl transition-all">
                        <span id="netStatusVal">₺0</span>
                    </div>
                </div>
                <div class="flex-1 flex justify-end">
                    <button onclick="openEditSettingsModal()" class="w-12 h-12 rounded-full bg-gray-50 text-gray-400 hover:text-blue-600 hover:bg-blue-100 transition-all flex items-center justify-center">
                        <i class="fas fa-edit text-xl"></i>
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                <div class="space-y-6">
                    <div class="flex items-center gap-3 mb-2"><div class="w-2 h-6 bg-red-500 rounded-full"></div><h4 class="text-[13px] font-black text-gray-800 uppercase tracking-widest">Borçlar & Krediler</h4></div>
                    <div id="detailedDebtsList" class="space-y-4"></div>
                </div>
                <div class="space-y-6">
                    <div class="flex items-center gap-3 mb-2"><div class="w-2 h-6 bg-green-500 rounded-full"></div><h4 class="text-[13px] font-black text-gray-800 uppercase tracking-widest">Varlıklar & Birikim</h4></div>
                    <div id="detailedAssetsList" class="space-y-4"></div>
                </div>
            </div>
        </div>

    </div>

    <script>
        let state = {
            step: 1, salaryDay: 15,
            registrationDate: new Date(),
            incomes: [{ name: 'Maaş (İlker)', val: 45000 }],
            bills: [{ name: 'Kira', val: 16000 }, { name: 'İnternet', val: 700 }],
            // YENİ KREDİ YAPISI: excludeFromDebt = Genel Borca Dahil Etme
            loans: [{ name: 'Akbank Kredi', totalDebt: 221000, totalMonths: 13, monthly: 17000, payDay: 15, excludeFromBudget: false, excludeFromDebt: false }],
            debts: [{ name: 'Word Kart', val: 140696, calcMode: false, limit: 951000, avail: 810304 }],
            assets: [{ name: 'Altın', val: 55400, included: true }, { name: 'Banka Hesabı', val: 15000, included: true }],
            allocationPercent: 30, remainingAfterFixed: 0, calculatedMonthlyPool: 0, calculatedMonthlySavings: 0,
            manualLimit: null, expenses: [], usdRate: 34.50
        };

        window.onload = () => {
            const now = new Date();
            const filter = document.getElementById('historyMonthFilter');
            if(filter) filter.value = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;
            if(state.user) showDashboard(); 
        };

        // --- AUTH & NAV ---
        function showWelcome() { hideAll(); document.getElementById('welcomeScreen').classList.remove('hidden'); }
        function showLogin() { hideAll(); document.getElementById('loginScreen').classList.remove('hidden'); }
        function startWizard() { 
            hideAll(); document.getElementById('wizardScreen').classList.remove('hidden'); 
            state.step = 1; state.registrationDate = new Date(); renderProgress(); renderLists(); updateWizardUI(); 
        }
        function hideAll() { ['welcomeScreen', 'loginScreen', 'wizardScreen', 'dashboardScreen'].forEach(id => document.getElementById(id).classList.add('hidden')); }
        function handleLogin() { if(document.getElementById('usernameInput')?.value === "ilkersancak") { state.registrationDate = new Date(); state.user = "ilkersancak"; showDashboard(); } else alert("ilkersancak / 1881."); }
        function logout() { location.reload(); }

        // --- KREDİ DOM UPDATE (KLAVYE SORUNU ÇÖZÜMÜ) ---
        function updateLoanData(idx, field, value) {
            state.loans[idx][field] = parseFloat(value) || 0;
            const l = state.loans[idx];
            
            // Eğer Taksit değiştiyse -> Toplamı güncelle (Vade varsa)
            // Eğer Toplam değiştiyse -> Taksiti güncelle (Vade varsa)
            // Eğer Vade değiştiyse -> Taksiti güncelle (Toplam varsa)
            
            if (field === 'monthly' && l.totalMonths > 0) {
               // Taksit girildi, vade var -> Toplam değişmez, kullanıcı toplamı elle girer. 
               // Burada otomatik hesaplamayı sadece VADE veya TOPLAM girilince taksit hesaplasın diye kısıtlayalım.
            } 
            else if ((field === 'totalDebt' || field === 'totalMonths') && l.totalDebt > 0 && l.totalMonths > 0) {
               l.monthly = Math.ceil(l.totalDebt / l.totalMonths);
               const monthlyInput = document.getElementById(`loan_monthly_${idx}`);
               if(monthlyInput) monthlyInput.value = l.monthly;
            }
        }

        // --- LOAN DETAIL MODAL (YENİ) ---
        function openLoanDetail(idx) {
            const loan = state.loans[idx];
            document.getElementById('loanDetailTitle').innerText = loan.name;
            
            let html = `
                <div class="bg-indigo-50 p-4 rounded-2xl mb-4">
                    <div class="flex justify-between text-xs font-bold text-indigo-400 uppercase tracking-widest mb-1">Kalan Borç</div>
                    <div class="text-3xl font-black text-indigo-700">₺${loan.totalDebt.toLocaleString()}</div>
                    <div class="text-[10px] font-bold text-indigo-400 mt-2">Aylık Taksit: ₺${(loan.monthly||0).toLocaleString()}</div>
                </div>
                <div class="space-y-1">
                    <div class="flex justify-between text-[9px] font-bold text-gray-400 uppercase px-2"><span>Taksit</span><span>Kalan</span></div>
            `;
            
            let currentDebt = loan.totalDebt;
            let monthCount = loan.totalMonths || (loan.monthly > 0 ? Math.ceil(loan.totalDebt/loan.monthly) : 0);
            
            for(let i=1; i<=monthCount; i++) {
                currentDebt -= loan.monthly;
                if(currentDebt < 0) currentDebt = 0;
                html += `
                    <div class="flex justify-between items-center p-3 bg-white border border-gray-100 rounded-xl">
                        <span class="font-bold text-xs text-gray-600">${i}. Taksit</span>
                        <span class="font-black text-xs text-gray-800">₺${currentDebt.toLocaleString()}</span>
                    </div>
                `;
                if(currentDebt <= 0) break;
            }
            html += `</div>`;
            
            document.getElementById('loanDetailContent').innerHTML = html;
            document.getElementById('loanDetailModal').classList.remove('hidden');
            document.getElementById('overlay').classList.add('active');
        }
        function closeLoanDetailModal() { document.getElementById('loanDetailModal').classList.add('hidden'); document.getElementById('overlay').classList.remove('active'); }

        // --- EDIT MODAL ---
        function openEditSettingsModal() { renderEditSettingsLists(); document.getElementById('editSettingsModal').classList.remove('hidden'); document.getElementById('overlay').classList.add('active'); }
        function closeEditSettingsModal() { document.getElementById('editSettingsModal').classList.add('hidden'); document.getElementById('overlay').classList.remove('active'); }
        function closeAllPopups() { closeEditSettingsModal(); closeCalcModal(); closeLoanDetailModal(); }

        function renderEditSettingsLists() {
            // Helper for simple lists
            const listEl = (item, type, idx) => `
                <div class="flex items-center gap-2 p-2 bg-white border border-gray-100 rounded-xl mb-2">
                    <input type="text" value="${item.name}" onchange="state.${type}[${idx}].name=this.value" class="flex-1 bg-transparent text-xs font-bold outline-none">
                    <input type="number" value="${item.val}" onchange="state.${type}[${idx}].val=parseFloat(this.value)||0" class="w-20 bg-gray-50 p-1.5 rounded-lg text-right text-xs font-black">
                    <button onclick="state.${type}.splice(${idx},1); renderEditSettingsLists();" class="text-red-300 px-1"><i class="fas fa-times text-[10px]"></i></button>
                </div>
            `;
            document.getElementById('editIncomesList').innerHTML = state.incomes.map((a, i) => listEl(a, 'incomes', i)).join('');
            document.getElementById('editBillsList').innerHTML = state.bills.map((a, i) => listEl(a, 'bills', i)).join('');
            document.getElementById('editAssetsList').innerHTML = state.assets.map((a, i) => listEl(a, 'assets', i)).join('');
            
            // Cards
            document.getElementById('editDebtsList').innerHTML = state.debts.map((d, i) => `
                <div class="p-3 bg-white border border-gray-100 rounded-2xl mb-2 space-y-2">
                    <div class="flex justify-between items-center"><input type="text" value="${d.name}" onchange="state.debts[${i}].name=this.value" class="text-[11px] font-black outline-none flex-1"><button onclick="state.debts[${i}].calcMode=!state.debts[${i}].calcMode; renderEditSettingsLists();" class="text-[8px] text-blue-500 uppercase font-bold mr-2">Sen Hesapla</button><button onclick="state.debts.splice(${i},1); renderEditSettingsLists();" class="text-red-300"><i class="fas fa-trash text-[9px]"></i></button></div>
                    ${d.calcMode ? `<div class="grid grid-cols-2 gap-2"><div><label class="text-[8px] font-bold text-gray-400">KART LİMİTİ</label><input type="number" value="${d.limit}" oninput="state.debts[${i}].limit=parseFloat(this.value)||0; state.debts[${i}].val=Math.max(0, state.debts[${i}].limit - state.debts[${i}].avail); renderEditSettingsLists();" placeholder="Limit" class="w-full bg-gray-50 p-1.5 rounded-lg text-[10px] font-black outline-none"></div><div><label class="text-[8px] font-bold text-gray-400">KULLANILABİLİR</label><input type="number" value="${d.avail}" oninput="state.debts[${i}].avail=parseFloat(this.value)||0; state.debts[${i}].val=Math.max(0, state.debts[${i}].limit - state.debts[${i}].avail); renderEditSettingsLists();" placeholder="Kalan" class="w-full bg-gray-50 p-1.5 rounded-lg text-[10px] font-black border border-blue-50"></div></div>` : `<div class="text-right text-[11px] font-black text-purple-600">Borç: ₺${(d.val||0).toLocaleString()}</div>`}
                </div>
            `).join('');
            
            // Loans (Improved layout: Monthly | Months | Total) + DOUBLE CHECKBOX
            document.getElementById('editLoansList').innerHTML = state.loans.map((l, i) => `
                <div class="p-3 bg-white border border-gray-100 rounded-2xl mb-2 space-y-2">
                    <div class="flex justify-between items-center"><input type="text" value="${l.name}" onchange="state.loans[${i}].name=this.value" class="text-[11px] font-black outline-none flex-1"><button onclick="state.loans.splice(${i},1); renderEditSettingsLists();" class="text-red-300"><i class="fas fa-trash text-[9px]"></i></button></div>
                    <div class="grid grid-cols-3 gap-2">
                        <div class="col-span-1"><label class="text-[8px] text-gray-400 font-bold block">AYLIK</label><input type="number" id="loan_monthly_${i}" value="${l.monthly}" oninput="updateLoanData(${i}, 'monthly', this.value)" class="w-full bg-gray-50 p-1.5 rounded-lg text-[10px] font-black outline-none border-2 border-indigo-50"></div>
                        <div class="col-span-1"><label class="text-[8px] text-gray-400 font-bold block">KALAN AY</label><input type="number" value="${l.totalMonths}" oninput="updateLoanData(${i}, 'totalMonths', this.value)" class="w-full bg-gray-50 p-1.5 rounded-lg text-[10px] font-black outline-none"></div>
                        <div class="col-span-1"><label class="text-[8px] text-gray-400 font-bold block">TOPLAM</label><input type="number" value="${l.totalDebt}" oninput="updateLoanData(${i}, 'totalDebt', this.value)" class="w-full bg-gray-50 p-1.5 rounded-lg text-[10px] font-black outline-none"></div>
                    </div>
                    <div class="flex flex-col gap-1 pt-1 border-t border-gray-50">
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="ex_chk_edit_${i}" ${l.excludeFromBudget ? 'checked' : ''} onchange="state.loans[${i}].excludeFromBudget=this.checked;" class="w-3.5 h-3.5 rounded">
                            <label for="ex_chk_edit_${i}" class="text-[9px] font-bold text-gray-500 uppercase tracking-tighter">Aylık gidere dahil etme</label>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="ex_debt_edit_${i}" ${l.excludeFromDebt ? 'checked' : ''} onchange="state.loans[${i}].excludeFromDebt=this.checked;" class="w-3.5 h-3.5 rounded">
                            <label for="ex_debt_edit_${i}" class="text-[9px] font-bold text-gray-500 uppercase tracking-tighter">Genel borca dahil etme</label>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        function saveSettingsChanges() { updateDashboardUI(); closeEditSettingsModal(); }

        // --- MATH ---
        function updateAllocationUI() {
            const totalInc = state.incomes.reduce((s, i) => s + (i.val || 0), 0);
            const totalFix = state.bills.reduce((s, b) => s + (b.val || 0), 0);
            // SADECE GİDERE DAHİL OLAN KREDİLERİ DÜŞ
            const incLoanPayments = state.loans.filter(l => !l.excludeFromBudget).reduce((s, l) => s + (l.monthly || 0), 0);
            
            state.remainingAfterFixed = totalInc - totalFix - incLoanPayments;
            if(isNaN(state.remainingAfterFixed)) state.remainingAfterFixed = 0;
            
            applyAllocation(state.allocationPercent);
        }
        function handleSliderChange(v) { state.allocationPercent = parseFloat(v); applyAllocation(v); }
        function handleManualSavingsChange(v) {
            const s = parseFloat(v) || 0;
            let p = state.remainingAfterFixed > 0 ? (s / state.remainingAfterFixed * 100) : 0;
            state.allocationPercent = Math.min(100, Math.max(0, p));
            if(document.getElementById('allocationSlider')) document.getElementById('allocationSlider').value = state.allocationPercent;
            applyAllocation(state.allocationPercent);
        }
        function applyAllocation(p) {
            const savings = (state.remainingAfterFixed * p / 100);
            const spending = state.remainingAfterFixed - savings;
            if(document.getElementById('remainingCalcText')) document.getElementById('remainingCalcText').innerText = Math.max(0, state.remainingAfterFixed).toLocaleString();
            if(document.getElementById('manualSavingsInput')) document.getElementById('manualSavingsInput').value = Math.max(0, savings).toFixed(0);
            if(document.getElementById('allocSpendingVal')) document.getElementById('allocSpendingVal').innerText = `₺${Math.max(0, spending).toLocaleString(undefined, {maximumFractionDigits:0})}`;
            if(document.getElementById('idealDailyLimit')) document.getElementById('idealDailyLimit').innerText = `₺${Math.max(0, spending/31).toLocaleString('tr-TR', {minimumFractionDigits:2})}`;
            state.calculatedMonthlyPool = spending; state.calculatedMonthlySavings = savings;
        }

        // --- WIZARD RENDERERS ---
        function wizardNext() {
            if (state.step < 6) { state.step++; updateWizardUI(); } else { showDashboard(); }
        }
        function wizardBack() { if (state.step > 1) { state.step--; updateWizardUI(); } else { showWelcome(); } }

        function updateWizardUI() {
            document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
            document.querySelector(`[data-step="${state.step}"]`)?.classList.add('active');
            renderProgress();
            
            const wizContent = document.getElementById('wizardContent');
            if(state.step === 1) wizContent.innerHTML = `<h3 class="text-2xl font-black mb-6 text-green-600">Gelirlerim</h3><div id="wiz_inc_list"></div><button onclick="addNewItem('incomes'); renderWizardLists();" class="w-full py-3 border-2 border-dashed border-green-200 rounded-2xl text-green-500 font-bold mt-4">+ Gelir Ekle</button><div class="pt-4 mt-6 border-t"><p class="text-[10px] font-bold text-gray-400 uppercase mb-2">Maaş Günü</p><input type="number" id="wiz_salary_day_val" oninput="state.salaryDay=this.value" value="${state.salaryDay}" class="w-20 p-3 bg-gray-50 rounded-xl font-black text-center text-xl"></div>`;
            if(state.step === 2) wizContent.innerHTML = `<h3 class="text-2xl font-black mb-6 text-red-600">Sabit Giderler</h3><div id="wiz_bill_list"></div><button onclick="addNewItem('bills'); renderWizardLists();" class="w-full py-3 border-2 border-dashed border-red-200 rounded-2xl text-red-500 font-bold mt-4">+ Gider Ekle</button>`;
            
            // KREDİ WIZARD (Left: Monthly, Center: Months, Right: Total) + DOUBLE CHECKBOX
            if(state.step === 3) wizContent.innerHTML = `<h3 class="text-2xl font-black mb-6 text-red-600">Banka Kredileri</h3><div id="wiz_loan_list"></div><button onclick="addNewItem('loans'); renderWizardLists();" class="w-full py-3 border-2 border-dashed border-red-200 rounded-2xl text-red-500 font-bold mt-4">+ Kredi Ekle</button>`;
            
            if(state.step === 4) wizContent.innerHTML = `<h3 class="text-2xl font-black mb-6 text-purple-600">Borçlar & Kartlar</h3><div id="wiz_debt_list"></div><button onclick="addNewItem('debts'); renderWizardLists();" class="w-full py-3 border-2 border-dashed border-purple-200 rounded-2xl text-purple-500 font-bold mt-4">+ Borç/Kart Ekle</button>`;
            if(state.step === 5) wizContent.innerHTML = `<h3 class="text-2xl font-black mb-6 text-green-600">Varlıklarım</h3><div id="wiz_asset_list"></div><button onclick="addNewItem('assets'); renderWizardLists();" class="w-full py-3 border-2 border-dashed border-green-200 rounded-2xl text-green-500 font-bold mt-4">+ Varlık Ekle</button>`;
            if(state.step === 6) { wizContent.innerHTML = `<h3 class="text-2xl font-black mb-4">Maaş Planı</h3><p class="text-sm text-gray-500 mb-6 text-center">Net Kalan: <button onclick="openCalcModal()" class="text-blue-600 font-black underline underline-offset-4">₺<span id="remainingCalcText">0</span></button></p><div class="space-y-8"><div class="flex justify-between font-bold text-[9px] uppercase tracking-widest"><span class="text-green-600 text-left">Birikim Hedefi<br>(Borçtan Düşer)</span><span class="text-blue-600 text-right">Harcama<br>Bütçesi</span></div><input type="range" id="allocationSlider" min="0" max="100" value="30" oninput="handleSliderChange(this.value)" class="w-full h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer"><div class="flex justify-between gap-4"><div class="flex-1"><label class="text-[9px] font-bold text-gray-400 block mb-1">BİRİKİM</label><input type="number" id="manualSavingsInput" oninput="handleManualSavingsChange(this.value)" class="w-full p-4 bg-green-50 rounded-2xl text-center font-black text-xl text-green-700 outline-none"></div><div class="flex-1"><label class="text-[9px] font-bold text-gray-400 block mb-1">HARCAMA</label><div id="allocSpendingVal" class="w-full p-4 bg-blue-50 rounded-2xl text-center font-black text-xl text-blue-700">₺0</div></div></div><div class="p-5 bg-slate-900 rounded-[2.5rem] border border-white/10 shadow-xl"><p class="text-[10px] font-bold text-slate-400 mb-1 uppercase text-center">İdeal Günlük Limit</p><h4 id="idealDailyLimit" class="text-4xl font-black text-white text-center leading-none">₺0</h4></div></div>`; updateAllocationUI(); }

            renderWizardLists();
            document.getElementById('wizNextBtn').innerText = state.step === 6 ? "Plana Başla" : "Devam Et";
        }

        function renderWizardLists() {
            const listEl = (data, id, type) => {
                const el = document.getElementById(id); if(!el) return;
                el.innerHTML = data.map((item, idx) => `<div class="flex gap-2 mb-2"><input type="text" value="${item.name}" onchange="state.${type}[${idx}].name=this.value" class="flex-1 p-3 bg-white border border-gray-100 rounded-xl font-bold text-sm outline-none"> <input type="number" value="${item.val}" onchange="state.${type}[${idx}].val=parseFloat(this.value)||0" class="w-24 p-3 bg-gray-50 border border-transparent rounded-xl text-right font-black text-sm"></div>`).join('');
            };
            if(state.step === 1) listEl(state.incomes, 'wiz_inc_list', 'incomes');
            if(state.step === 2) listEl(state.bills, 'wiz_bill_list', 'bills');
            if(state.step === 3) {
                // KREDİ WIZARD: Left(Monthly) - Center(Months) - Right(Total) + Input Focus Fix
                const lEl = document.getElementById('wiz_loan_list'); if(lEl) lEl.innerHTML = state.loans.map((l, i) => `
                    <div class="p-4 bg-white border border-gray-100 rounded-2xl mb-3 space-y-3">
                        <input type="text" value="${l.name}" onchange="state.loans[${i}].name=this.value" class="w-full border-b pb-1 font-black text-sm outline-none" placeholder="Kredi Adı">
                        <div class="grid grid-cols-3 gap-2">
                            <div class="col-span-1"><label class="text-[8px] font-bold text-gray-400">AYLIK</label><input type="number" id="wiz_loan_m_${i}" value="${l.monthly}" oninput="updateLoanData(${i}, 'monthly', this.value)" class="w-full p-2 bg-gray-50 rounded-lg text-xs font-black border-2 border-indigo-50"></div>
                            <div class="col-span-1"><label class="text-[8px] font-bold text-gray-400">KALAN AY</label><input type="number" value="${l.totalMonths}" oninput="updateLoanData(${i}, 'totalMonths', this.value)" class="w-full p-2 bg-gray-50 rounded-lg text-xs font-black"></div>
                            <div class="col-span-1"><label class="text-[8px] font-bold text-gray-400">TOPLAM</label><input type="number" value="${l.totalDebt}" oninput="updateLoanData(${i}, 'totalDebt', this.value)" class="w-full p-2 bg-gray-50 rounded-lg text-xs font-black"></div>
                        </div>
                        <div class="flex flex-col gap-1 pt-1 border-t border-gray-50">
                            <div class="flex items-center gap-2"><input type="checkbox" id="wiz_ex_${i}" ${l.excludeFromBudget ? 'checked' : ''} onchange="state.loans[${i}].excludeFromBudget=this.checked" class="w-3.5 h-3.5"><label for="wiz_ex_${i}" class="text-[10px] font-bold text-gray-500 uppercase tracking-tighter">Aylık gidere dahil etme</label></div>
                            <div class="flex items-center gap-2"><input type="checkbox" id="wiz_ex_debt_${i}" ${l.excludeFromDebt ? 'checked' : ''} onchange="state.loans[${i}].excludeFromDebt=this.checked" class="w-3.5 h-3.5"><label for="wiz_ex_debt_${i}" class="text-[10px] font-bold text-gray-500 uppercase tracking-tighter">Genel borca dahil etme</label></div>
                        </div>
                    </div>`).join('');
            }
            if(state.step === 4) {
                const dEl = document.getElementById('wiz_debt_list'); if(dEl) dEl.innerHTML = state.debts.map((d, i) => `<div class="p-4 bg-white border border-gray-100 rounded-2xl mb-3 space-y-3 text-left"><div class="flex justify-between items-center"><input type="text" value="${d.name}" onchange="state.debts[${i}].name=this.value" class="font-black text-sm outline-none flex-1"><button onclick="state.debts[${i}].calcMode=!state.debts[${i}].calcMode; renderWizardLists();" class="text-[9px] font-black text-blue-500 uppercase px-2 py-1 bg-blue-50 rounded-lg transition-all">Sen Hesapla</button></div>${d.calcMode ? `<div class="grid grid-cols-2 gap-3"><div><label class="text-[8px] font-bold text-gray-400">KART LİMİTİ</label><input type="number" value="${d.limit}" oninput="state.debts[${i}].limit=parseFloat(this.value)||0; state.debts[${i}].val=Math.max(0, state.debts[${i}].limit - state.debts[${i}].avail); renderWizardLists();" placeholder="Limit" class="w-full p-2.5 bg-gray-50 rounded-xl font-black text-xs outline-none"></div><div><label class="text-[8px] font-bold text-gray-400">KULLANILABİLİR</label><input type="number" value="${d.avail}" oninput="state.debts[${i}].avail=parseFloat(this.value)||0; state.debts[${i}].val=Math.max(0, state.debts[${i}].limit - state.debts[${i}].avail); renderWizardLists();" placeholder="Kalan" class="w-full p-2.5 bg-gray-50 rounded-xl font-black text-xs border border-blue-50"></div></div>` : `<div class="flex items-center gap-2 justify-end"><span class="text-gray-400 font-bold">₺</span><input type="number" value="${d.val}" onchange="state.debts[${i}].val=parseFloat(this.value)||0" class="w-32 bg-gray-50 p-2.5 rounded-xl text-right font-black outline-none"></div>`}</div>`).join('');
            }
            if(state.step === 5) listEl(state.assets, 'wiz_asset_list', 'assets');
        }
        function renderProgress() { const bar = document.getElementById('wizardProgress'); if(bar) bar.innerHTML = Array.from({length:6}, (_, i) => `<div class="h-1.5 flex-1 rounded-full ${i+1 <= state.step ? 'bg-blue-600' : 'bg-gray-100'}"></div>`).join(''); }

        // --- DASHBOARD CORE ---
        function showDashboard() { hideAll(); document.getElementById('dashboardScreen').classList.remove('hidden'); updateDashboardUI(); }

        function updateDashboardUI() {
            const now = new Date();
            const todayStr = now.toLocaleDateString('tr-TR');
            const idealRate = state.manualLimit || (state.calculatedMonthlyPool / 31);
            const startCalc = state.registrationDate;
            const daysPassed = Math.ceil((now - startCalc) / (1000 * 60 * 60 * 24)) || 1;
            const spentToday = state.expenses.filter(e => e.date === todayStr).reduce((s, e) => s + e.amount, 0);
            
            // CUMULATIVE BALANCE LOGIC: (DailyRate * Days) - TotalSpent
            const totalSpentSinceReg = state.expenses.filter(e => {
                const p = e.date.split('.');
                return new Date(p[2], p[1]-1, p[0]) >= startCalc;
            }).reduce((s, e) => s + e.amount, 0);

            const cumulativeLimitToday = (idealRate * daysPassed) - totalSpentSinceReg;

            document.getElementById('displayDailyLimit').innerText = `₺${(idealRate - spentToday).toLocaleString('tr-TR', {minimumFractionDigits:2})}`;
            document.getElementById('displayCumulativeLimit').innerText = `₺${cumulativeLimitToday.toLocaleString('tr-TR', {minimumFractionDigits:2})}`;
            
            const target = new Date(now.getFullYear(), (now.getDate() >= state.salaryDay ? now.getMonth() + 1 : now.getMonth()), state.salaryDay);
            document.getElementById('displayRemainingDays').innerText = `Maaşa ${Math.ceil((target - now)/(1000*60*60*24))} gün`;
            
            updateDetailedHealthUI();
            renderFilteredHistory();
        }

        function updateDetailedHealthUI() {
            // SADECE 'excludeFromDebt' OLMAYANLARI TOPLA
            const totalLoan = state.loans.filter(l => !l.excludeFromDebt).reduce((s, l) => s + (l.val ?? l.totalDebt), 0);
            const totalCard = state.debts.filter(d => d.limit > 0).reduce((s, d) => s + (d.val || 0), 0);
            const totalOther = state.debts.filter(d => d.limit === undefined || d.limit === 0).reduce((s, d) => s + (d.val || 0), 0);
            const totalDebt = totalLoan + totalCard + totalOther;
            const totalAssets = state.assets.reduce((s, a) => s + (a.val || 0), 0);
            const totalInc = state.incomes.reduce((s, i) => s + (i.val || 0), 0);

            const netVal = totalAssets - totalDebt;
            document.getElementById('netStatusVal').innerText = `${netVal >= 0 ? '+' : ''}₺${netVal.toLocaleString()}`;
            document.getElementById('netStatusBadge').className = `px-10 py-4 rounded-[2rem] font-black text-3xl shadow-xl transition-all ${netVal >= 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;

            // Debt Index: Total Debt / 1 Month Income
            document.getElementById('sumSalaryMult').innerText = (totalInc > 0 ? totalDebt / totalInc : 0).toFixed(1);
            document.getElementById('sumSavings').innerText = `₺${state.calculatedMonthlySavings.toLocaleString()}`;
            document.getElementById('sumGiderTotal').innerText = `₺${(state.bills.reduce((s,b)=>s+b.val,0) + state.loans.filter(l=>!l.excludeFromBudget).reduce((s,l)=>s+(l.monthly||0),0)).toLocaleString()}`;

            renderHealthGroups('detailedDebtsList', [
                { title: 'Kredi Kartı Borçları', val: totalCard, icon: 'fa-credit-card', items: state.debts.filter(d => d.limit > 0), color: 'text-red-500' },
                { title: 'Banka Kredileri (Tıkla Gör)', val: totalLoan, icon: 'fa-university', items: state.loans.filter(l => !l.excludeFromDebt), color: 'text-red-600', isLoan: true },
                { title: 'Diğer Borçlar', val: totalOther, icon: 'fa-hand-holding-usd', items: state.debts.filter(d => d.limit === undefined || d.limit === 0), color: 'text-orange-600' }
            ]);
            renderHealthGroups('detailedAssetsList', [{ title: 'Varlıklar & Birikim', val: totalAssets, icon: 'fa-coins', items: state.assets, color: 'text-green-600' }]);
        }

        function renderHealthGroups(id, groups) {
            const container = document.getElementById(id);
            container.innerHTML = groups.map(group => `
                <div class="bg-gray-50 rounded-[2rem] p-5 shadow-sm border border-white">
                    <div class="flex justify-between items-center cursor-pointer" onclick="this.parentElement.classList.toggle('expanded')">
                        <div class="flex items-center gap-3"><i class="fas ${group.icon} ${group.color} opacity-40 text-lg"></i><span class="font-black text-gray-700 text-[11px] uppercase tracking-wider">${group.title}</span></div>
                        <div class="flex items-center gap-3"><span class="font-black ${group.color} text-sm">₺${(group.val || 0).toLocaleString()}</span><i class="fas fa-chevron-down text-[10px] text-gray-300 rotate-icon"></i></div>
                    </div>
                    <div class="expandable-content mt-4 space-y-3 border-t pt-4">
                        ${group.items.map((item, idx) => `
                            <div class="flex justify-between text-xs font-bold text-gray-500 ${group.isLoan ? 'cursor-pointer hover:text-indigo-500' : ''}" ${group.isLoan ? `onclick="openLoanDetail(${findLoanIndex(item.name)})"` : ''}>
                                <span>${item.name}</span>
                                <span class="text-gray-800 tracking-tighter">₺${(item.val ?? item.totalDebt ?? 0).toLocaleString()}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }
        
        function findLoanIndex(name) { return state.loans.findIndex(l => l.name === name); }

        function openLoanDetail(idx) {
            const loan = state.loans[idx];
            document.getElementById('loanDetailTitle').innerText = loan.name;
            let html = `
                <div class="bg-indigo-50 p-4 rounded-2xl mb-4">
                    <div class="flex justify-between text-xs font-bold text-indigo-400 uppercase tracking-widest mb-1">Kalan Borç</div>
                    <div class="text-3xl font-black text-indigo-700">₺${loan.totalDebt.toLocaleString()}</div>
                    <div class="text-[10px] font-bold text-indigo-400 mt-2">Aylık Taksit: ₺${(loan.monthly||0).toLocaleString()}</div>
                </div>
                <div class="space-y-1"><div class="flex justify-between text-[9px] font-bold text-gray-400 uppercase px-2"><span>Taksit</span><span>Kalan</span></div>`;
            
            let currentDebt = loan.totalDebt;
            let monthCount = loan.totalMonths || (loan.monthly > 0 ? Math.ceil(loan.totalDebt/loan.monthly) : 0);
            
            for(let i=1; i<=monthCount; i++) {
                currentDebt -= loan.monthly;
                if(currentDebt < 0) currentDebt = 0;
                html += `<div class="flex justify-between items-center p-3 bg-white border border-gray-100 rounded-xl"><span class="font-bold text-xs text-gray-600">${i}. Taksit</span><span class="font-black text-xs text-gray-800">₺${currentDebt.toLocaleString()}</span></div>`;
                if(currentDebt <= 0) break;
            }
            html += `</div>`;
            document.getElementById('loanDetailContent').innerHTML = html;
            document.getElementById('loanDetailModal').classList.remove('hidden');
            document.getElementById('overlay').classList.add('active');
        }
        function closeLoanDetailModal() { document.getElementById('loanDetailModal').classList.add('hidden'); document.getElementById('overlay').classList.remove('active'); }

        function renderFilteredHistory() {
            const filterVal = document.getElementById('historyMonthFilter').value;
            const [fYear, fMonth] = filterVal.split('-').map(Number);
            const history = document.getElementById('historyList');
            const ex = state.expenses.filter(e => { const p = e.date.split('.'); return parseInt(p[2]) === fYear && parseInt(p[1]) === fMonth; });
            if(ex.length === 0) { history.innerHTML = `<p class="text-center text-gray-300 py-10 italic text-sm">Harcama kaydı yok.</p>`; return; }
            history.innerHTML = ex.map((e, idx) => `<div class="flex justify-between items-center p-5 bg-gray-50 rounded-[2rem] border border-white mb-3 shadow-sm"><div class="flex items-center gap-4"><div class="w-12 h-12 bg-white rounded-2xl flex items-center justify-center text-blue-600 shadow-sm"><i class="fas fa-shopping-basket"></i></div><div><h5 class="font-black text-gray-800 text-sm leading-tight">${e.desc}</h5><p class="text-[9px] text-gray-400 font-bold mt-1">${e.date}</p></div></div><div class="flex flex-col items-end"><span class="font-black text-gray-900 text-lg">₺${e.amount.toLocaleString()}</span><button onclick="deleteExpense(${idx})" class="text-[8px] font-bold text-red-300 uppercase">Sil</button></div></div>`).reverse().join('');
            document.getElementById('todayTotal').innerText = `Bugün: ₺${state.expenses.filter(e => e.date === new Date().toLocaleDateString('tr-TR')).reduce((sum, e) => sum + e.amount, 0).toLocaleString()}`;
        }

        // --- UTILS ---
        function addNewItem(key) { 
            if(key === 'loans') state.loans.push({ name: 'Yeni Kredi', totalDebt: 0, totalMonths: 12, monthly: 0, excludeFromBudget: false });
            else if(key === 'incomes') state.incomes.push({ name: 'Yeni Gelir', val: 0 });
            else if(key === 'bills') state.bills.push({ name: 'Yeni Gider', val: 0 });
            else state[key].push({ name: 'Yeni Kalem', val: 0 }); 
        }
        function addExpense() {
            const amtEl = document.getElementById('expAmt');
            const a = parseFloat(amtEl?.value);
            if (!a || a <= 0) return;
            state.expenses.push({ amount: a, desc: document.getElementById('expDesc')?.value || "Diğer", date: new Date().toLocaleDateString('tr-TR'), time: new Date().toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'}) });
            amtEl.value = ""; document.getElementById('expDesc').value = "Diğer";
            updateDashboardUI();
        }
        function deleteExpense(idx) { state.expenses.splice(idx, 1); updateDashboardUI(); }
        function openCalcModal() {
            const totalInc = state.incomes.reduce((s, i) => s + (i.val||0), 0);
            const totalFix = state.bills.reduce((s, b) => s + (b.val||0), 0);
            const loanPayments = state.loans.filter(l => !l.excludeFromBudget).reduce((s, l) => s + (l.monthly || 0), 0);
            document.getElementById('calcModalContent').innerHTML = `<div class="flex justify-between font-bold text-green-600"><span>Gelirler:</span><span>+ ₺${totalInc.toLocaleString()}</span></div><div class="flex justify-between text-red-500 text-xs"><span>Sabit Giderler:</span><span>- ₺${totalFix.toLocaleString()}</span></div><div class="flex justify-between text-red-500 text-xs"><span>Dahil Edilen Krediler:</span><span>- ₺${loanPayments.toLocaleString()}</span></div><div class="border-t pt-4 font-black text-blue-600 text-2xl">KALAN NET: ₺${state.remainingAfterFixed.toLocaleString()}</div>`;
            document.getElementById('calcModal').classList.remove('hidden'); document.getElementById('overlay').classList.add('active');
        }
        function closeCalcModal() { document.getElementById('calcModal').classList.add('hidden'); document.getElementById('overlay').classList.remove('active'); }
        function renderLists() {} 
    </script>
</body>
</html>
