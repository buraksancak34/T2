<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Birikim KoÃ§um | Gelir-Gider Takip</title>
    
    <!-- PWA ve Mobil Uygulama AyarlarÄ± -->
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2563eb">
    <meta name="application-name" content="Birikim KoÃ§um">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- FIREBASE SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        
        /* MOBÄ°L Ã–LÃ‡EKLENDÄ°RME AYARI (%20 KÃ¼Ã§Ã¼ltme Etkisi) */
        html {
            font-size: 14px; /* Standart 16px yerine 14px ile tÃ¼m rem deÄŸerlerini kÃ¼Ã§Ã¼ltÃ¼yoruz */
        }
        @media (min-width: 768px) {
            html { font-size: 16px; } /* Bilgisayarda normal boyuta dÃ¶n */
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc; 
            color: #1e293b;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
            overflow-x: hidden;
            padding-bottom: 80px; /* Alt menÃ¼ iÃ§in boÅŸluk */
        }
        
        input, textarea { user-select: text; -webkit-user-select: text; }

        .glass-card { background: rgba(255, 255, 255, 0.98); border: 1px solid rgba(255,255,255,0.6); box-shadow: 0 4px 20px -5px rgba(0,0,0,0.05); }
        .hidden { display: none !important; }
        input[type="range"] { accent-color: #2563eb; }
        
        /* Overlay ve Panel DÃ¼zeni */
        .overlay { background: rgba(0,0,0,0.4); opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 40; }
        .overlay.active { opacity: 1; pointer-events: auto; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .health-detail { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .health-detail.open { max-height: 1000px; transition: max-height 0.5s ease-in; }

        /* YanÄ±p SÃ¶nme Efektleri */
        @keyframes pulse-red { 0%, 100% { color: #ef4444; } 50% { color: #fca5a5; } }
        @keyframes pulse-green { 0%, 100% { color: #16a34a; } 50% { color: #86efac; } }
        .animate-pulse-red { animation: pulse-red 1.5s infinite; }
        .animate-pulse-green { animation: pulse-green 2s infinite; }

        /* Yan Panel AyarlarÄ± */
        .side-panel {
            position: fixed; top: 0; right: 0; height: 100%; width: 85%; max-width: 26rem; 
            background: #ffffff; z-index: 60; box-shadow: -5px 0 25px rgba(0,0,0,0.15);
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column;
        }
        .side-panel.open { transform: translateX(0); }

        /* Alt Navigasyon BarÄ± */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 70px;
            background: white; border-top: 1px solid #f1f5f9;
            display: flex; justify-content: space-around; items-center;
            z-index: 50; padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.03);
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 20%; height: 100%; color: #94a3b8; transition: color 0.2s;
        }
        .nav-item.active { color: #2563eb; }
        .nav-item i { font-size: 1.2rem; margin-bottom: 4px; }
        .nav-item span { font-size: 0.65rem; font-weight: 700; }
        
        /* Floating Action Button (Ortadaki Ekle Butonu) */
        .fab-container {
            position: relative; top: -20px;
        }
        .fab {
            width: 60px; height: 60px; background: #2563eb; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 1.5rem;
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.4);
            transition: transform 0.2s;
        }
        .fab:active { transform: scale(0.95); }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center bg-slate-50">

    <div id="overlay" class="overlay fixed inset-0" onclick="closeAllPopups()"></div>
    
    <div id="saveIndicator" class="fixed top-4 right-4 bg-white px-3 py-1.5 rounded-full shadow-lg border border-gray-100 flex items-center gap-2 text-[10px] font-bold text-gray-500 opacity-0 transition-opacity duration-500 pointer-events-none z-[70]">
        <div class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div> Kaydedildi
    </div>

    <!-- 1. GÄ°RÄ°Åž EKRANI -->
    <!-- Padding p-10'dan p-6'ya dÃ¼ÅŸÃ¼rÃ¼ldÃ¼, kart boyutu optimize edildi -->
    <div id="loginScreen" class="w-[90%] max-w-sm glass-card p-6 rounded-[2rem] shadow-xl space-y-5 my-auto relative overflow-hidden animate-fade-in">
        <div class="text-center">
            <div class="mx-auto mb-4 w-24 h-24 hover:scale-105 transition-transform duration-300">
                <img src="logo.png" alt="Logo" class="w-full h-full object-contain drop-shadow-md" 
                     onerror="this.src='https://cdn-icons-png.flaticon.com/512/2382/2382461.png'; this.parentElement.classList.add('opacity-80');">
            </div>
            
            <h1 class="text-2xl font-black text-gray-900 tracking-tight mb-1" id="loginTitle">Birikim KoÃ§um</h1>
            <p class="text-blue-500 text-[10px] font-bold uppercase tracking-widest" id="loginSubtitle">Gelir - Gider Takip AsistanÄ±</p>
        </div>
        
        <div class="space-y-3 mt-6" id="authFormContainer">
            <div id="registerFields" class="hidden space-y-3">
                <input type="text" id="regUsernameInput" class="w-full p-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-100 outline-none font-bold text-gray-700 transition-all text-sm" placeholder="KullanÄ±cÄ± AdÄ±">
                <input type="text" id="regInviteCode" class="w-full p-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-100 outline-none font-bold text-gray-700 transition-all text-sm" placeholder="Davet Kodu (Varsa)">
                <input type="number" id="regDailyLimit" class="w-full p-3 bg-blue-50 border border-blue-200 rounded-xl focus:ring-2 focus:ring-blue-100 outline-none font-black text-blue-700 transition-all text-sm hidden placeholder-blue-400" placeholder="GÃ¼nlÃ¼k Harcama Hedefi (TL)">
            </div>
            
            <input type="text" id="emailInput" class="w-full p-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-100 outline-none font-bold text-gray-700 transition-all text-sm" placeholder="E-posta veya KullanÄ±cÄ± AdÄ±">
            <input type="password" id="passwordInput" class="w-full p-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-100 outline-none font-bold text-gray-700 transition-all text-sm" placeholder="Åžifre">
            
            <button id="loginBtn" onclick="firebaseLogin()" class="w-full bg-blue-600 text-white font-black py-3 rounded-xl shadow-lg shadow-blue-200 active:scale-95 transition-all hover:bg-blue-700 flex justify-center items-center gap-2">
                <span>GiriÅŸ Yap</span>
            </button>
            
            <button id="registerBtn" onclick="firebaseRegister()" class="w-full bg-indigo-600 text-white font-black py-3 rounded-xl shadow-lg hidden active:scale-95 transition-all hover:bg-indigo-700 flex justify-center items-center gap-2">
                <span>KayÄ±t Ol</span>
            </button>
            
            <p id="forgotPassText" class="text-center text-[10px] font-bold text-blue-400 cursor-pointer hover:text-blue-600 pt-1" onclick="forgotPassword()">Åžifremi Unuttum?</p>

            <p id="backToLoginText" class="text-center text-[10px] font-bold text-gray-400 cursor-pointer hover:text-blue-500 hidden pt-1" onclick="showLoginMode()">
                <i class="fas fa-arrow-left mr-1"></i> GiriÅŸ ekranÄ±na dÃ¶n
            </p>
        </div>
        
        <div class="relative py-2">
            <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-200"></div></div>
            <div class="relative flex justify-center"><span class="bg-white px-3 text-[10px] font-bold text-gray-400 uppercase">veya</span></div>
        </div>

        <div class="space-y-2" id="actionButtons">
            <button onclick="startWizard(false)" class="w-full bg-green-500 text-white font-black py-3 rounded-xl shadow-md shadow-green-100 active:scale-95 transition-all hover:bg-green-600 flex items-center justify-center gap-2 text-sm">
                <i class="fas fa-magic"></i> <span>Plana BaÅŸla</span>
            </button>
            
            <button onclick="showQuickRegisterMode()" class="w-full bg-slate-800 text-white font-bold py-2.5 px-3 rounded-xl active:scale-95 transition-all hover:bg-slate-900 shadow-md flex items-center justify-center gap-2 text-[10px] leading-tight">
                <i class="fas fa-bolt text-yellow-400"></i> <span>HÄ±zlÄ± BaÅŸlangÄ±Ã§ (Sadece Harcama)</span>
            </button>
            
            <button onclick="showRegisterMode()" class="w-full bg-white border-2 border-gray-100 text-gray-600 font-bold py-2.5 rounded-xl active:scale-95 transition-all hover:border-indigo-200 hover:text-indigo-600 text-xs mt-1">
                Bir Plana Dahil Ol
            </button>
        </div>
    </div>

    <!-- 2. SÄ°HÄ°RBAZ (WIZARD) -->
    <div id="wizardScreen" class="w-[95%] max-w-lg glass-card p-6 rounded-[2rem] shadow-2xl hidden space-y-4 my-auto relative animate-fade-in pb-10">
        <div class="flex justify-between items-center mb-2">
            <div id="wizardProgress" class="flex gap-1 flex-1 mr-4"></div>
            <span class="text-[10px] font-bold text-gray-300" id="stepCount">1/8</span>
        </div>
        <div id="wizardContent" class="min-h-[400px] flex flex-col relative"></div>
        <div class="flex gap-2 mt-4" id="wizardNavBtns">
             <button onclick="wizardBack()" class="flex-1 bg-gray-100 text-gray-600 font-bold py-3 rounded-xl text-sm">Geri</button>
             <button onclick="wizardNext()" id="wizNextBtn" class="flex-[2] bg-blue-600 text-white font-black py-3 rounded-xl shadow-lg active:scale-95 transition-all text-sm">Devam Et</button>
        </div>
    </div>

    <!-- 3. DASHBOARD -->
    <div id="dashboardScreen" class="w-full max-w-md hidden px-4 pt-4 pb-24 animate-fade-in flex flex-col gap-5">
        
        <!-- Ãœst BaÅŸlÄ±k ve Bildirimler -->
        <div class="flex justify-between items-center px-1">
            <div>
                <h2 class="text-xl font-black text-gray-800 tracking-tight" id="dashWelcome">Panelim</h2>
                <div class="flex items-center gap-2">
                    <span id="roleBadge" class="text-[9px] font-black bg-blue-100 text-blue-600 px-2 py-0.5 rounded uppercase tracking-wide">Ãœye</span>
                </div>
            </div>
            <!-- Admin butonu gizli olarak kalsÄ±n, gerekirse aÃ§Ä±lÄ±r -->
            <button onclick="openAdminPanel()" id="btnAdmin" class="hidden text-[9px] font-black bg-red-500 text-white px-3 py-1.5 rounded-full shadow-sm"><i class="fas fa-shield-alt"></i></button>
        </div>

        <!-- Ana Durum KartÄ± -->
        <div class="w-full p-6 rounded-[2.5rem] bg-gradient-to-br from-slate-800 to-slate-900 text-white shadow-2xl relative overflow-hidden group">
            <div class="absolute top-0 right-0 w-48 h-48 bg-blue-500 rounded-full mix-blend-overlay filter blur-3xl opacity-20 -mr-10 -mt-10"></div>
            <div class="relative z-10">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <p class="text-slate-400 text-[9px] font-bold uppercase tracking-widest opacity-80">BugÃ¼nÃ¼n Limiti</p>
                            <button onclick="openCalcModal()" class="text-blue-300 text-[9px] underline decoration-dashed">NasÄ±l?</button>
                        </div>
                        <h2 id="displayDailyLimit" class="text-5xl font-black tracking-tighter leading-none">â‚º0</h2>
                    </div>
                    <div class="text-right">
                        <p onclick="openBalanceModal()" class="text-blue-400 text-[9px] font-bold uppercase tracking-widest mb-1 cursor-pointer">GerÃ§ek Bakiye</p>
                        <h4 id="displayCumulativeLimit" onclick="openBalanceModal()" class="text-2xl font-black text-white tracking-tight cursor-pointer">â‚º0</h4>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-2 mt-6 pt-4 border-t border-white/10">
                    <div class="bg-white/10 px-2 py-2 rounded-xl backdrop-blur-md text-center">
                        <span class="text-[8px] text-slate-300 font-bold uppercase block">Kalan GÃ¼n</span>
                        <span id="displayRemainingDays" class="text-sm font-black text-white">--</span>
                    </div>
                    <div class="bg-white/10 px-2 py-2 rounded-xl backdrop-blur-md text-center">
                        <span class="text-[8px] text-slate-300 font-bold uppercase block">Hedef</span>
                        <span id="sumSavings" class="text-sm font-black text-green-400">â‚º0</span>
                    </div>
                    <button onclick="startWizard(true)" id="btnEditPlan" class="bg-white/10 px-2 py-2 rounded-xl backdrop-blur-md hover:bg-white/20 transition-all flex flex-col items-center justify-center">
                        <i class="fas fa-pen text-xs mb-1 text-slate-300"></i>
                        <span class="text-[8px] text-slate-300 font-bold uppercase block">DÃ¼zenle</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Motivasyon AlanÄ± -->
        <div id="motivationArea" class="hidden w-full p-4 rounded-3xl bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 text-white shadow-lg">
            <div class="flex items-center gap-3">
                <div class="text-xl">ðŸ¤–</div>
                <div>
                    <p class="font-bold text-xs leading-tight" id="motivationText">...</p>
                </div>
            </div>
        </div>

        <!-- Davet Bildirim AfiÅŸi -->
        <div id="inviteBanner" class="hidden bg-indigo-600 text-white p-4 rounded-3xl shadow-lg flex flex-col gap-3">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center"><i class="fas fa-envelope"></i></div>
                <div>
                    <p class="text-[9px] text-indigo-200 font-bold uppercase">Plan Daveti</p>
                    <p class="font-bold text-xs" id="inviteBannerText">...</p>
                </div>
            </div>
            <div class="flex gap-2 w-full">
                <button onclick="rejectInvite()" class="flex-1 py-2 bg-white/10 rounded-xl text-[10px] font-bold">Reddet</button>
                <button onclick="acceptInvite()" class="flex-1 py-2 bg-white text-indigo-600 rounded-xl text-[10px] font-black shadow-sm">Kabul Et</button>
            </div>
        </div>

        <!-- HARCAMA EKLEME (DÃœZENLENDÄ°: ALT ALTA) -->
        <div class="glass-card p-6 rounded-[2rem] bg-white border border-gray-100 shadow-md">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-black text-lg text-gray-800">Harcama Ekle</h3>
                <span id="todayTotal" class="text-[9px] font-bold bg-blue-50 text-blue-600 px-2 py-1 rounded-lg">BugÃ¼n: â‚º0</span>
            </div>
            
            <div class="flex flex-col gap-3">
                <!-- 1. SatÄ±r: Kategori SeÃ§imi -->
                <div class="w-full relative">
                    <select id="expCat" class="w-full p-3 bg-gray-50 rounded-xl font-bold text-xs text-gray-700 outline-none border border-gray-100 appearance-none">
                         <!-- Kategoriler JS ile gelecek -->
                    </select>
                    <i class="fas fa-chevron-down absolute right-3 top-3.5 text-gray-400 text-xs pointer-events-none"></i>
                    <button onclick="openCategoryModal()" class="absolute right-8 top-0 h-full px-2 text-gray-400 hover:text-blue-500 border-l border-gray-200" title="DÃ¼zenle">
                        <i class="fas fa-pencil-alt text-xs"></i>
                    </button>
                </div>

                <!-- 2. SatÄ±r: Tutar -->
                 <input type="number" id="expAmt" placeholder="Tutar (â‚º)" class="w-full p-3 bg-gray-50 rounded-xl font-black text-lg text-gray-800 outline-none focus:ring-2 focus:ring-blue-100 border border-gray-100">

                <!-- 3. SatÄ±r: AÃ§Ä±klama ve Ekle Butonu -->
                <div class="flex gap-2">
                    <input type="text" id="expDesc" placeholder="AÃ§Ä±klama (Opsiyonel)" class="flex-1 p-3 bg-gray-50 rounded-xl font-bold text-gray-600 outline-none text-xs border border-gray-100">
                    <input type="hidden" id="editExpIndex" value="-1">
                    <button id="addExpBtn" onclick="addExpense()" class="bg-blue-600 text-white w-12 rounded-xl active:scale-90 transition-all shadow-lg shadow-blue-200 flex items-center justify-center shrink-0">
                        <i class="fas fa-plus text-lg"></i>
                    </button>
                </div>
                
                <!-- Tarih SeÃ§ici -->
                <div class="flex justify-between items-center mt-1">
                     <button onclick="changeExpenseDate(1)" class="w-8 h-8 rounded-lg bg-white border border-gray-100 text-gray-500 text-xs shadow-sm"><i class="fas fa-chevron-left"></i></button>
                     <div class="relative">
                        <span id="expenseDateLabel" class="text-[10px] font-bold text-gray-400" onclick="document.getElementById('expDateInputHidden').showPicker()">BugÃ¼n</span>
                        <input type="date" id="expDateInputHidden" class="absolute inset-0 opacity-0 w-full h-full">
                     </div>
                     <button onclick="changeExpenseDate(-1)" class="w-8 h-8 rounded-lg bg-white border border-gray-100 text-gray-500 text-xs shadow-sm"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        </div>

        <!-- HARCAMA GEÃ‡MÄ°ÅžÄ° -->
        <div class="glass-card p-6 rounded-[2rem] shadow-md bg-white border border-gray-100">
            <h3 class="font-black text-sm text-gray-800 uppercase tracking-widest mb-3">Son Harcamalar</h3>
            <div id="historyList" class="pb-2"></div>
        </div>

        <!-- FÄ°NANSAL SAÄžLIK (Ä°KONLAR DÃœZELTÄ°LDÄ°) -->
        <div id="financialHealthSection" class="glass-card p-6 rounded-[2rem] space-y-6 bg-white border border-blue-50 shadow-md">
            <div class="flex flex-col items-center border-b pb-4">
                <h3 class="font-black text-xl text-gray-800 mb-1">Finansal SaÄŸlÄ±k</h3>
                <p class="text-[9px] text-gray-400 font-bold uppercase">Net VarlÄ±k (VarlÄ±k - BorÃ§)</p>
                <div id="netStatusBadge" class="text-2xl font-black text-gray-800 px-6 py-2 bg-gray-50 rounded-2xl mt-2">
                    <span id="netStatusVal">â‚º0</span>
                </div>
            </div>
            
            <!-- VarlÄ±klar -->
            <div class="space-y-3">
                <div class="flex items-center gap-2 mb-1 pb-1 border-b border-green-100">
                     <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                     <span class="text-[10px] font-black text-green-600 uppercase">VarlÄ±klar</span>
                </div>
                <div id="detailedAssetsList" class="space-y-2"></div>
                <button onclick="toggleInlineAdd('dashAsset')" class="w-full py-2 text-[10px] text-gray-400 border border-dashed border-gray-300 rounded-lg">+ VarlÄ±k Ekle</button>
                <div id="inlineAdddashAssetContainer" class="hidden p-3 bg-green-50 rounded-xl space-y-2">
                     <select id="dashAssetType" onchange="handleInlineTypeChange('dashAsset')" class="w-full p-2 text-xs rounded-lg border-none"><option value="DiÄŸer">Nakit (TL)</option><option value="AltÄ±n">AltÄ±n</option><option value="DÃ¶viz">DÃ¶viz</option></select>
                     <div id="dashAssetFields" class="space-y-2"></div>
                     <div class="flex gap-2"><button onclick="cancelInlineAdd('dashAsset')" class="flex-1 py-1 bg-white text-xs rounded">Ä°ptal</button><button onclick="saveInlineAdd('dashAsset')" class="flex-1 py-1 bg-green-500 text-white text-xs rounded font-bold">Kaydet</button></div>
                </div>
            </div>

            <!-- BorÃ§lar -->
            <div class="space-y-3">
                <div class="flex items-center gap-2 mb-1 pb-1 border-b border-red-100">
                     <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                     <span class="text-[10px] font-black text-red-600 uppercase">BorÃ§lar</span>
                </div>
                <div id="detailedDebtsList" class="space-y-2"></div>
                <button onclick="toggleInlineAdd('dashDebt')" class="w-full py-2 text-[10px] text-gray-400 border border-dashed border-gray-300 rounded-lg">+ BorÃ§ Ekle</button>
                <div id="inlineAdddashDebtContainer" class="hidden p-3 bg-red-50 rounded-xl space-y-2">
                     <select id="dashDebtType" onchange="handleInlineTypeChange('dashDebt')" class="w-full p-2 text-xs rounded-lg border-none"><option value="Kredi KartÄ±">Kredi KartÄ±</option><option value="Kredi">Kredi</option><option value="DiÄŸer">DiÄŸer</option></select>
                     <div id="dashDebtFields" class="space-y-2"></div>
                     <div class="flex gap-2"><button onclick="cancelInlineAdd('dashDebt')" class="flex-1 py-1 bg-white text-xs rounded">Ä°ptal</button><button onclick="saveInlineAdd('dashDebt')" class="flex-1 py-1 bg-red-500 text-white text-xs rounded font-bold">Kaydet</button></div>
                </div>
            </div>

            <!-- Sabit Giderler -->
             <div id="fixedExpensesSection"></div>
        </div>

        <div class="text-center mt-4">
             <button onclick="openContactModal()" class="text-[10px] font-bold text-gray-400 hover:text-blue-500"><i class="fas fa-comment mr-1"></i> Ä°letiÅŸim</button>
        </div>
    </div>

    <!-- ALT MENÃœ (BOTTOM NAVBAR) -->
    <nav id="bottomNavbar" class="bottom-nav hidden">
        <div class="nav-item" onclick="showSettingsModal()">
            <i class="fas fa-users"></i>
            <span>Aile Ekle</span>
        </div>
        <div class="nav-item" onclick="showAnalysisScreen()">
            <i class="fas fa-chart-pie"></i>
            <span>Analiz</span>
        </div>
        
        <div class="fab-container">
            <div class="fab" onclick="document.querySelector('.glass-card').scrollIntoView({ behavior: 'smooth' }); document.getElementById('expAmt').focus();">
                <i class="fas fa-plus"></i>
            </div>
        </div>
        
        <div class="nav-item" onclick="startWizard(true)">
            <i class="fas fa-edit"></i>
            <span>Plan DÃ¼zenle</span>
        </div>
        <div class="nav-item" onclick="handleLogout()">
            <i class="fas fa-sign-out-alt text-red-400"></i>
            <span class="text-red-400">Ã‡Ä±kÄ±ÅŸ</span>
        </div>
    </nav>

    <!-- 4. ANALÄ°Z EKRANI -->
    <div id="analysisScreen" class="w-full max-w-md hidden px-4 pb-24 animate-fade-in flex flex-col gap-6 pt-6">
        <div class="flex justify-between items-center">
            <h2 class="text-xl font-black text-gray-800">Analiz</h2>
            <button onclick="showDashboard()" class="bg-gray-100 px-3 py-1 rounded-full text-[10px] font-bold">Kapat</button>
        </div>
        <div class="flex items-center gap-2 bg-white p-2 rounded-xl border border-gray-100">
             <span class="text-[10px] font-bold text-gray-400 uppercase">DÃ¶nem:</span>
             <input type="month" id="analysisDateFilter" class="bg-transparent text-xs font-bold outline-none" onchange="renderCharts()">
        </div>
        <div class="glass-card p-4 rounded-[2rem] bg-white"><h3 class="font-bold text-sm mb-2 text-center">VarlÄ±k / BorÃ§</h3><div class="h-48"><canvas id="assetsChart"></canvas></div></div>
        <div class="glass-card p-4 rounded-[2rem] bg-white"><h3 class="font-bold text-sm mb-2 text-center">Harcama DaÄŸÄ±lÄ±mÄ±</h3><div class="h-48"><canvas id="expensesChart"></canvas></div></div>
        <div class="glass-card p-4 rounded-[2rem] bg-white"><h3 class="font-bold text-sm mb-2 text-center">Net Durum Trendi</h3><div class="h-48"><canvas id="historyTrendChart"></canvas></div></div>
        
        <!-- GeÃ§miÅŸ Ekleme KÄ±smÄ± -->
        <div class="glass-card p-4 rounded-[2rem] bg-white space-y-3">
             <h3 class="font-bold text-sm border-b pb-2">GeÃ§miÅŸ KayÄ±t Ekle</h3>
             <div class="grid grid-cols-2 gap-2">
                 <input type="month" id="histDate" class="p-2 bg-gray-50 rounded-lg text-xs font-bold">
                 <input type="number" id="histAssets" placeholder="VarlÄ±k" class="p-2 bg-gray-50 rounded-lg text-xs font-bold text-green-600">
                 <input type="number" id="histDebts" placeholder="BorÃ§" class="p-2 bg-gray-50 rounded-lg text-xs font-bold text-red-600">
                 <input type="number" id="histUSDRate" placeholder="Dolar Kuru" class="p-2 bg-blue-50 rounded-lg text-xs font-bold text-blue-600">
             </div>
             <button onclick="addHistoryRecord()" class="w-full bg-indigo-600 text-white py-2 rounded-lg text-xs font-bold">GeÃ§miÅŸi Kaydet</button>
             <div class="mt-2 overflow-x-auto"><table class="w-full text-[10px]"><tbody id="historyTableBody"></tbody></table></div>
        </div>
    </div>

    <!-- AYARLAR (SIDE PANEL OLARAK GÃœNCELLENDÄ°) -->
    <!-- Aile Sistemi buraya taÅŸÄ±ndÄ± -->
    <div id="settingsModal" class="side-panel">
        <div class="p-6 h-full flex flex-col bg-slate-50">
            <div class="flex justify-between items-center mb-6 pb-4 border-b">
                <h4 class="font-black text-lg text-gray-800">Ayarlar & Aile</h4>
                <button onclick="closeSettingsModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-lg"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto custom-scrollbar space-y-6 pb-20">
                <!-- AÄ°LE SÄ°STEMÄ° (BURAYA TAÅžINDI) -->
                <div id="familyPanel" class="bg-white p-4 rounded-2xl border border-blue-100 shadow-sm">
                    <div class="flex justify-between items-center mb-3 border-b border-gray-100 pb-2">
                        <h4 class="text-[10px] font-black text-blue-500 uppercase tracking-widest">Aile Ãœyeleri</h4>
                        <button onclick="createInviteCode()" class="text-[9px] font-bold bg-blue-50 text-blue-600 px-2 py-1 rounded">Kod: <span id="displayInviteCode">-----</span></button>
                    </div>
                    <div class="flex flex-col gap-2 mb-3">
                        <input type="text" id="famInput" class="w-full p-2 bg-gray-50 rounded-lg font-bold text-[10px] outline-none border border-gray-100" placeholder="KullanÄ±cÄ± AdÄ±/E-posta">
                        <div class="flex gap-2">
                            <select id="famRole" class="flex-1 p-2 bg-white border border-gray-100 rounded-lg text-[10px] font-bold text-gray-600 outline-none">
                                <option value="full">Tam Yetki</option>
                                <option value="limited">SÄ±nÄ±rlÄ±</option>
                            </select>
                            <button onclick="addFamilyMember()" class="bg-orange-500 text-white font-black px-3 rounded-lg text-[10px]">Ekle</button>
                        </div>
                    </div>
                    <div id="familyList" class="space-y-2"></div>
                </div>

                <!-- Plan AyarlarÄ± -->
                <div class="bg-white p-4 rounded-2xl border border-gray-200 shadow-sm text-center">
                    <p class="text-[9px] font-bold text-gray-400 uppercase mb-1">Plan Durumu</p>
                    <p class="font-black text-sm text-gray-800" id="settingsCurrentPlanLabel">...</p>
                    <button id="btnLeavePlan" onclick="leaveCurrentPlan()" class="hidden mt-2 text-[9px] text-red-500 bg-red-50 px-3 py-1 rounded-lg w-full">AyrÄ±l</button>
                </div>
                
                <div class="space-y-2">
                    <p class="text-[9px] font-bold text-gray-400 uppercase">BaÅŸka Plana GeÃ§</p>
                    <div class="flex gap-2">
                        <input type="text" id="settingsInviteCode" class="flex-1 p-2 bg-white border border-gray-200 rounded-lg text-xs font-bold" placeholder="Davet Kodu">
                        <button onclick="joinPlanByCode()" class="bg-blue-600 text-white font-bold px-3 rounded-lg text-xs">KatÄ±l</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- DÄ°ÄžER MODALLAR (SIDE PANEL) -->
    <div id="adminModal" class="side-panel">
        <div class="p-6 h-full flex flex-col bg-slate-900 text-white">
            <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-700">
                <h4 class="font-black text-lg">Admin</h4>
                <button onclick="closeAdminPanel()" class="text-slate-400"><i class="fas fa-times"></i></button>
            </div>
            <!-- Ä°Ã§erik JS ile dolar -->
            <div id="adminTabUsers" class="flex-1 overflow-y-auto"><table class="w-full text-xs text-left"><tbody id="adminUserList"></tbody></table></div>
        </div>
    </div>

    <div id="editItemModal" class="side-panel">
        <div class="p-6 h-full flex flex-col bg-white">
            <div class="flex justify-between items-center mb-6 pb-4 border-b">
                <h4 class="font-black text-lg">DÃ¼zenle</h4>
                <button onclick="closeEditModal()" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <input type="text" id="editItemName" class="w-full p-3 bg-gray-50 rounded-xl text-sm font-bold border border-gray-100">
                <input type="number" id="editItemVal" class="w-full p-3 bg-gray-50 rounded-xl text-sm font-bold border border-gray-100">
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="editExcludeNetWorth">
                    <label for="editExcludeNetWorth" class="text-xs font-bold text-gray-500">Hesaba Dahil Etme</label>
                </div>
                <input type="hidden" id="editItemType"><input type="hidden" id="editItemIndex">
                <button onclick="saveEditedItem()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">Kaydet</button>
            </div>
        </div>
    </div>

    <div id="calcModal" class="side-panel">
        <div class="p-6 h-full flex flex-col bg-white">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h4 class="font-black text-lg">NasÄ±l HesaplandÄ±?</h4>
                <button onclick="closeCalcModal()" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            <div id="calcModalContent" class="flex-1 overflow-y-auto custom-scrollbar pb-10 text-xs"></div>
        </div>
    </div>

    <div id="balanceModal" class="side-panel">
        <div class="p-6 h-full flex flex-col bg-white">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h4 class="font-black text-lg">GerÃ§ek Bakiye</h4>
                <button onclick="closeBalanceModal()" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            <div id="balanceModalContent" class="flex-1 overflow-y-auto custom-scrollbar pb-10"></div>
        </div>
    </div>

    <div id="categoryModal" class="side-panel">
        <div class="p-6 h-full flex flex-col bg-white">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h4 class="font-black text-lg">Kategoriler</h4>
                <button onclick="closeCategoryModal()" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex gap-2 mb-4">
                <input type="text" id="newCatName" class="flex-1 p-2 bg-gray-50 rounded-lg text-xs font-bold border" placeholder="Yeni Kategori">
                <button onclick="addNewCategory()" class="bg-blue-600 text-white px-3 rounded-lg"><i class="fas fa-plus"></i></button>
            </div>
            <div id="categoryList" class="flex-1 overflow-y-auto space-y-2"></div>
        </div>
    </div>

    <div id="contactModal" class="side-panel">
        <div class="p-6 h-full flex flex-col bg-white">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h4 class="font-black text-lg">Ä°letiÅŸim</h4>
                <button onclick="closeContactModal()" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-3">
                <input type="email" id="contactEmail" class="w-full p-3 bg-gray-50 rounded-xl text-xs font-bold" placeholder="E-posta">
                <textarea id="contactMsg" rows="5" class="w-full p-3 bg-gray-50 rounded-xl text-xs font-bold" placeholder="MesajÄ±nÄ±z..."></textarea>
                <button onclick="sendContactMessage()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold text-sm">GÃ¶nder</button>
            </div>
        </div>
    </div>

    <div id="loanPlanModal" class="side-panel">
        <div class="p-6 h-full flex flex-col bg-white">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <div><span class="text-[9px] text-gray-400 uppercase">Kredi Detay</span><h4 id="loanPlanTitle" class="font-black text-lg leading-none">...</h4></div>
                <button onclick="closeLoanPlanModal()" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto"><table class="w-full text-[10px] text-left"><tbody id="loanPlanBody"></tbody></table></div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAyUQaeoVWnT4AuzSwD2M17-z1g2optqdA",
            authDomain: "hesapguvende-b07ca.firebaseapp.com",
            projectId: "hesapguvende-b07ca",
            storageBucket: "hesapguvende-b07ca.firebasestorage.app",
            messagingSenderId: "710002620092",
            appId: "1:710002620092:web:94f3ebb8dd2461af29c2b9",
            measurementId: "G-VE0EVVBM0V"
        };

        // --- DEÄžÄ°ÅžKENLER ---
        let db, auth, currentUser = null;
        let currentPlanId = null; 
        let currentUserRole = 'owner';
        let isFirebaseReady = false;
        let isRegistering = false;
        let assetsChartInstance = null;
        let expensesChartInstance = null;
        let trendChartInstance = null;
        let trendMode = 'TL';
        window.userInvites = [];
        window.currentHistoryDateIndex = 0;
        let currentExpenseDateOffset = 0;
        let editingCategoryIndex = -1;
        let originalAdminUid = null;

        const defaultState = {
            step: 1, salaryDay: 15,
            registrationDate: new Date().toISOString(),
            incomes: [{ name: 'MaaÅŸ', val: null }], 
            bills: [], loans: [], debts: [], otherDebts: [], assets: [],
            categories: ["Market", "Yemek", "UlaÅŸÄ±m", "SaÄŸlÄ±k", "EÄŸlence", "Fatura", "Giyim", "DiÄŸer"],
            manualDailyLimit: null, expenses: [], monthlyHistory: [], familyMembers: [], inviteCode: null
        };
        let state = JSON.parse(JSON.stringify(defaultState));

        // --- FIREBASE INIT ---
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            isFirebaseReady = true;
            
            auth.onAuthStateChanged(async user => {
                if (user) {
                    currentUser = user;
                    const name = user.displayName || user.email.split('@')[0];
                    document.getElementById('dashWelcome').innerText = `Selam, ${name}`;
                    
                    if (user.email.toLowerCase() === 'buraksancak@msn.com') {
                        document.getElementById('btnAdmin').classList.remove('hidden');
                    }
                    
                    if (!originalAdminUid) await initUserPlan();
                } else {
                    currentUser = null;
                    showLoginScreen();
                }
            });
        } catch(e) { console.error("Firebase Init Error:", e); }

        // --- NAVIGASYON ---
        function hideAll() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('wizardScreen').classList.add('hidden');
            document.getElementById('dashboardScreen').classList.add('hidden');
            document.getElementById('analysisScreen').classList.add('hidden');
            document.getElementById('bottomNavbar').classList.add('hidden');
        }

        function showLoginScreen() { hideAll(); document.getElementById('loginScreen').classList.remove('hidden'); }
        
        function showDashboard() { 
            hideAll(); 
            document.getElementById('dashboardScreen').classList.remove('hidden'); 
            document.getElementById('bottomNavbar').classList.remove('hidden'); // Alt menÃ¼yÃ¼ gÃ¶ster
            updateDashboardUI(); 
        }

        // --- SIDE PANEL & MODAL YÃ–NETÄ°MÄ° ---
        function openSidePanel(id) {
            const el = document.getElementById(id);
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('open'), 10);
            document.getElementById('overlay').classList.add('active');
        }
        function closeSidePanel(id) {
            const el = document.getElementById(id);
            el.classList.remove('open');
            setTimeout(() => el.classList.add('hidden'), 300);
            // Sadece bu panel aÃ§Ä±ksa overlay kapat, baÅŸka aÃ§Ä±k panel varsa (Ã¼st Ã¼ste) kapatma mantÄ±ÄŸÄ± eklenebilir ama ÅŸu an tek panel yeterli.
            document.getElementById('overlay').classList.remove('active');
        }
        function closeAllPopups() {
            document.getElementById('overlay').classList.remove('active');
            document.querySelectorAll('.side-panel').forEach(el => { el.classList.remove('open'); setTimeout(() => el.classList.add('hidden'), 300); });
        }

        // --- SETTINGS (ARTIK SIDE PANEL) ---
        function showSettingsModal() {
            if(currentUserRole === 'owner') {
                document.getElementById('settingsCurrentPlanLabel').innerText = "Kendi PlanÄ±nÄ±z (YÃ¶netici)";
                document.getElementById('btnLeavePlan').classList.add('hidden');
            } else {
                document.getElementById('settingsCurrentPlanLabel').innerText = "Ortak Plan (Ãœye)";
                document.getElementById('btnLeavePlan').classList.remove('hidden');
            }
            document.getElementById('settingsInviteCode').value = '';
            renderFamilyList(); // Aile listesini render et
            openSidePanel('settingsModal');
        }
        function closeSettingsModal() { closeSidePanel('settingsModal'); }

        // --- DÄ°ÄžER MODALLAR (FONKSÄ°YONLARI GÃœNCELLENDÄ°) ---
        function openCategoryModal() { renderCategoryOptions(); openSidePanel('categoryModal'); }
        function closeCategoryModal() { closeSidePanel('categoryModal'); }
        
        function openCalcModal() { 
            // Hesaplama detayÄ±nÄ± oluÅŸtur (Eski koddan alÄ±ntÄ±)
            renderCalcDetails(); 
            openSidePanel('calcModal'); 
        }
        function closeCalcModal() { closeSidePanel('calcModal'); }

        function openBalanceModal() { renderBalanceDetails(); openSidePanel('balanceModal'); }
        function closeBalanceModal() { closeSidePanel('balanceModal'); }

        function openContactModal() { openSidePanel('contactModal'); }
        function closeContactModal() { closeSidePanel('contactModal'); }

        function openLoanPlanModal(idx) { renderLoanPlan(idx); openSidePanel('loanPlanModal'); }
        function closeLoanPlanModal() { closeSidePanel('loanPlanModal'); }
        
        function openEditModal(type, index) { loadEditItem(type, index); openSidePanel('editItemModal'); }
        function closeEditModal() { closeSidePanel('editItemModal'); }

        function openAdminPanel() { openSidePanel('adminModal'); loadAdminUsers(); }
        function closeAdminPanel() { closeSidePanel('adminModal'); }

        // --- ANALÄ°Z EKRANI ---
        function showAnalysisScreen() {
            hideAll();
            document.getElementById('analysisScreen').classList.remove('hidden');
            document.getElementById('bottomNavbar').classList.remove('hidden');
            const today = new Date();
            document.getElementById('analysisDateFilter').value = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
            renderCharts(); renderHistoryTable(); renderTrendChart();
        }

        // --- LOGIN / REGISTER LOGIC (Ã–ZETLENDÄ°) ---
        async function firebaseLogin() {
            if(!isFirebaseReady) return;
            const e = document.getElementById('emailInput').value.trim();
            const p = document.getElementById('passwordInput').value;
            try { await auth.signInWithEmailAndPassword(e, p); } catch(err) { alert(err.message); }
        }
        async function firebaseRegister() {
            // ... (Eski kayÄ±t mantÄ±ÄŸÄ± aynen, sadece state baÅŸlatma kÄ±smÄ± Ã¶nemli)
             if(!isFirebaseReady) return;
            const u = document.getElementById('regUsernameInput').value.trim();
            const e = document.getElementById('emailInput').value.trim();
            const p = document.getElementById('passwordInput').value;
            const inv = document.getElementById('regInviteCode').value.trim().toUpperCase();
            const isQuick = !document.getElementById('regDailyLimit').classList.contains('hidden');
            
            try {
                const cred = await auth.createUserWithEmailAndPassword(e, p);
                await cred.user.updateProfile({ displayName: u });
                let initState = JSON.parse(JSON.stringify(defaultState));
                initState.email = e; initState.username = u;
                
                if (isQuick) {
                    const lim = parseFloat(document.getElementById('regDailyLimit').value) || 0;
                    initState.manualDailyLimit = lim;
                    initState.remainingAfterFixed = lim * 30;
                    initState.incomes = [{name:'HÄ±zlÄ± BÃ¼tÃ§e', val: lim*30}];
                } else if(inv) {
                    // Davet kodu mantÄ±ÄŸÄ±...
                    const snap = await db.collection('users').where('inviteCode', '==', inv).get();
                    if(!snap.empty) {
                        const owner = snap.docs[0];
                        initState.connectedPlanId = owner.id;
                        let mem = owner.data().familyMembers || [];
                        mem.push({uid:cred.user.uid, name:u, role:'full'});
                        await db.collection('users').doc(owner.id).update({familyMembers:mem});
                    }
                }
                await db.collection('users').doc(cred.user.uid).set(initState);
                await initUserPlan();
            } catch(err) { alert(err.message); }
        }
        function showRegisterMode() {
            document.getElementById('loginTitle').innerText = "KayÄ±t Ol";
            document.getElementById('loginBtn').classList.add('hidden');
            document.getElementById('registerBtn').classList.remove('hidden');
            document.getElementById('registerFields').classList.remove('hidden');
            document.getElementById('regDailyLimit').classList.add('hidden');
            document.getElementById('actionButtons').classList.add('hidden');
            document.getElementById('backToLoginText').classList.remove('hidden');
        }
        function showQuickRegisterMode() {
            showRegisterMode();
            document.getElementById('regInviteCode').classList.add('hidden');
            document.getElementById('regDailyLimit').classList.remove('hidden');
        }
        function showLoginMode() {
            document.getElementById('loginTitle').innerText = "Birikim KoÃ§um";
            document.getElementById('loginBtn').classList.remove('hidden');
            document.getElementById('registerBtn').classList.add('hidden');
            document.getElementById('registerFields').classList.add('hidden');
            document.getElementById('actionButtons').classList.remove('hidden');
            document.getElementById('backToLoginText').classList.add('hidden');
        }
        function handleLogout() { auth.signOut().then(() => window.location.reload()); }
        function forgotPassword() {
             const e = document.getElementById('emailInput').value.trim();
             if(e) auth.sendPasswordResetEmail(e).then(()=>alert("Mail gÃ¶nderildi")).catch(er=>alert(er.message));
        }

        // --- VERÄ° YÃ–NETÄ°MÄ° ---
        async function initUserPlan() {
            if(!currentUser) return;
            currentPlanId = currentUser.uid;
            try {
                const doc = await db.collection("users").doc(currentUser.uid).get();
                if(doc.exists) {
                    const d = doc.data();
                    if(d.connectedPlanId) {
                        currentPlanId = d.connectedPlanId;
                        // Yetki kontrolÃ¼ (BasitÃ§e)
                        // ...
                    }
                    loadFromCloud();
                } else {
                    saveToCloud();
                    showDashboard();
                }
            } catch(e) { console.log(e); }
        }

        function loadFromCloud() {
            db.collection("users").doc(currentPlanId).get().then(doc => {
                if(doc.exists) {
                    state = doc.data();
                    // Eksik alan tamamlama
                    if(!state.categories) state.categories = defaultState.categories;
                    showDashboard();
                }
            });
        }
        function saveToCloud() {
            if(!currentPlanId) return;
            db.collection("users").doc(currentPlanId).set(state, {merge:true}).then(() => {
                const ind = document.getElementById('saveIndicator');
                ind.style.opacity = '1'; setTimeout(() => ind.style.opacity = '0', 2000);
            });
        }

        // --- DASHBOARD GÃœNCELLEME ---
        function updateDashboardUI() {
            const now = new Date();
            // Hibrit hesaplama (MaaÅŸ gÃ¼nÃ¼ vs.) - BasitleÅŸtirilmiÅŸ
            let startCalc = new Date(state.registrationDate);
            if(state.expenses.length > 0) {
                // ... (Eski koddaki tarih hesaplama mantÄ±ÄŸÄ±)
                // HÄ±zlÄ± Ã§Ã¶zÃ¼m iÃ§in: En eski harcama tarihi veya kayÄ±t tarihi
            }
            const daysPassed = Math.max(1, Math.ceil(Math.abs(now - startCalc) / (86400000)));
            const limit = state.manualDailyLimit || 0;
            const spentTotal = state.expenses.reduce((s,e)=>s+e.amount,0);
            const todayStr = now.toLocaleDateString('tr-TR');
            const spentToday = state.expenses.filter(e=>e.date === todayStr).reduce((s,e)=>s+e.amount,0);
            const cumulative = (limit * daysPassed) - spentTotal;

            document.getElementById('displayDailyLimit').innerText = `â‚º${Math.floor(limit - spentToday).toLocaleString()}`;
            document.getElementById('displayCumulativeLimit').innerText = `â‚º${Math.floor(cumulative).toLocaleString()}`;
            document.getElementById('todayTotal').innerText = `BugÃ¼n: â‚º${Math.floor(spentToday).toLocaleString()}`;
            
            // Finansal SaÄŸlÄ±k
            const assets = state.assets.reduce((s,a)=>s+(a.val||0),0);
            const debts = state.loans.reduce((s,l)=>s+(l.excludeFromDebt?0:(l.totalDebt||0)),0) + state.debts.reduce((s,d)=>s+(d.val||0),0);
            const net = assets - debts;
            document.getElementById('netStatusVal').innerText = `â‚º${net.toLocaleString()}`;
            document.getElementById('netStatusVal').className = net >= 0 ? 'text-green-600' : 'text-red-600';
            
            // Listeleri Render Et
            renderHistoryList();
            renderDetailedHealthLists();
            renderCategoryOptions();
        }

        // --- LÄ°STE RENDERLAMA (GÃœNCELLENMÄ°Åž Ä°KONLAR) ---
        function createRow(name, amount, type, idx, extra='', click='', faded=false) {
            // Ä°konlarÄ± her zaman gÃ¶rÃ¼nÃ¼r yapmak iÃ§in 'opacity-0' sÄ±nÄ±fÄ±nÄ± kaldÄ±rdÄ±m.
            // Bunun yerine renklerini 'text-gray-300' yaptÄ±m, bÃ¶ylece var olduklarÄ± belli ama rahatsÄ±z etmiyorlar.
            return `
            <div class="flex justify-between items-center p-3 rounded-xl text-xs bg-gray-50 border border-gray-100 ${extra} ${faded?'opacity-50 grayscale':''}" ${click?`onclick="${click}"`:''}>
                <span class="font-bold text-gray-600">${name}</span>
                <div class="flex items-center gap-3">
                    <span class="font-black text-gray-800">â‚º${Math.floor(amount).toLocaleString()}</span>
                    <div class="flex gap-2">
                        <button onclick="event.stopPropagation(); openEditModal('${type}', ${idx})" class="text-gray-300 hover:text-blue-500"><i class="fas fa-pen"></i></button>
                        ${type!=='bills' ? `<button onclick="event.stopPropagation(); deleteHealthItem('${type}', ${idx})" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button>` : ''}
                    </div>
                </div>
            </div>`;
        }
        
        function renderDetailedHealthLists() {
             // VarlÄ±klar
             const assetsHTML = state.assets.map((a,i) => createRow(a.name, a.val, 'assets', i, 'bg-white', '', a.excludeFromNetWorth)).join('');
             document.getElementById('detailedAssetsList').innerHTML = assetsHTML || '<span class="text-[10px] text-gray-300">BoÅŸ</span>';
             
             // BorÃ§lar (Kredi + Kart + DiÄŸer)
             let debtsHTML = '';
             state.loans.forEach((l,i) => debtsHTML += createRow(l.name, l.excludeFromDebt?0:l.totalDebt, 'loans', i, 'bg-white', `openLoanPlanModal(${i})`, l.excludeFromDebt));
             state.debts.forEach((d,i) => debtsHTML += createRow(d.name, d.val, 'debts', i, 'bg-white'));
             document.getElementById('detailedDebtsList').innerHTML = debtsHTML || '<span class="text-[10px] text-gray-300">BoÅŸ</span>';
             
             // Sabit Giderler
             const billsHTML = state.bills.map((b,i) => createRow(b.name, b.val, 'bills', i, 'bg-white')).join('');
             document.getElementById('fixedExpensesSection').innerHTML = `
                <div class="space-y-2 mt-4 pt-4 border-t border-gray-100">
                    <p class="text-[10px] font-black text-blue-500 uppercase">Sabit Giderler</p>
                    ${billsHTML}
                    <button onclick="addNewHealthItem('bills')" class="w-full py-2 text-[10px] text-gray-400 border border-dashed border-gray-300 rounded-lg">+ Gider Ekle</button>
                </div>
             `;
        }

        // --- HARCAMA EKLEME (YENÄ° DÃœZEN) ---
        function addExpense() {
            const cat = document.getElementById('expCat').value;
            const amt = parseFloat(document.getElementById('expAmt').value);
            const desc = document.getElementById('expDesc').value;
            
            if(!amt) return document.getElementById('expAmt').focus();
            
            const today = new Date();
            today.setDate(today.getDate() - currentExpenseDateOffset);
            const dateStr = today.toLocaleDateString('tr-TR');
            const name = currentUser.displayName || 'Ben';
            
            state.expenses.unshift({
                category: cat, amount: amt, desc: desc || cat, date: dateStr, addedBy: name, ts: Date.now()
            });
            
            // Temizle
            document.getElementById('expAmt').value = '';
            document.getElementById('expDesc').value = '';
            currentExpenseDateOffset = 0;
            saveToCloud(); updateDashboardUI();
        }

        function renderCategoryOptions() {
            const s = document.getElementById('expCat');
            s.innerHTML = state.categories.map(c => `<option value="${c}">${c}</option>`).join('');
            
            const l = document.getElementById('categoryList');
            if(l) {
                l.innerHTML = state.categories.map((c,i) => `
                    <div class="flex justify-between p-2 bg-gray-50 rounded mb-1 text-xs">
                        <span>${c}</span>
                        <button onclick="deleteCategory(${i})" class="text-red-400"><i class="fas fa-trash"></i></button>
                    </div>
                `).join('');
            }
        }
        function addNewCategory() {
            const v = document.getElementById('newCatName').value.trim();
            if(v) { state.categories.push(v); document.getElementById('newCatName').value=''; saveToCloud(); renderCategoryOptions(); }
        }
        function deleteCategory(i) {
            if(confirm('Silinsin mi?')) { state.categories.splice(i,1); saveToCloud(); renderCategoryOptions(); }
        }

        // --- TARÄ°H KAYDIRMA ---
        function changeExpenseDate(d) {
            currentExpenseDateOffset += (d === -1 ? 1 : -1);
            if(currentExpenseDateOffset < 0) currentExpenseDateOffset = 0;
            const dt = new Date(); dt.setDate(dt.getDate() - currentExpenseDateOffset);
            document.getElementById('expenseDateLabel').innerText = currentExpenseDateOffset===0 ? 'BugÃ¼n' : dt.toLocaleDateString('tr-TR');
        }

        // --- SATIR Ä°Ã‡Ä° EKLEME (INLINE ADD) ---
        function toggleInlineAdd(id) { document.getElementById(`inlineAdd${id}Container`).classList.remove('hidden'); }
        function cancelInlineAdd(id) { document.getElementById(`inlineAdd${id}Container`).classList.add('hidden'); }
        function handleInlineTypeChange(prefix) { 
            const type = document.getElementById(`${prefix}Type`).value;
            let html = '';
            if(type === 'Kredi') html = '<input id="'+prefix+'_name" placeholder="Ad" class="w-full p-2 border rounded text-xs"><div class="flex gap-1"><input type="number" id="'+prefix+'_m" placeholder="Taksit" class="w-1/2 p-2 border rounded text-xs"><input type="number" id="'+prefix+'_c" placeholder="Ay" class="w-1/2 p-2 border rounded text-xs"></div>';
            else html = '<input id="'+prefix+'_name" placeholder="Ad" class="w-full p-2 border rounded text-xs"><input type="number" id="'+prefix+'_val" placeholder="Tutar" class="w-full p-2 border rounded text-xs">';
            document.getElementById(`${prefix}Fields`).innerHTML = html;
        }
        function saveInlineAdd(prefix) {
            const type = document.getElementById(`${prefix}Type`).value;
            let item = {};
            if(prefix === 'dashAsset') {
                item = { name: document.getElementById(`${prefix}_name`).value || type, val: parseFloat(document.getElementById(`${prefix}_val`).value)||0 };
                state.assets.unshift(item);
            } else {
                 if(type==='Kredi') {
                     const m = parseFloat(document.getElementById(`${prefix}_m`).value)||0;
                     const c = parseFloat(document.getElementById(`${prefix}_c`).value)||0;
                     item = { name: document.getElementById(`${prefix}_name`).value || 'Kredi', monthly: m, totalMonths: c, totalDebt: m*c, excludeFromDebt:false };
                     state.loans.unshift(item);
                 } else {
                     item = { name: document.getElementById(`${prefix}_name`).value || type, val: parseFloat(document.getElementById(`${prefix}_val`).value)||0 };
                     state.debts.unshift(item);
                 }
            }
            saveToCloud(); updateDashboardUI(); cancelInlineAdd(prefix);
        }

        // --- AÄ°LE YÃ–NETÄ°MÄ° ---
        function createInviteCode() {
            const c = Math.random().toString(36).substring(2,7).toUpperCase();
            state.inviteCode = c; saveToCloud();
            document.getElementById('displayInviteCode').innerText = c;
        }
        function renderFamilyList() {
            const l = document.getElementById('familyList');
            l.innerHTML = (state.familyMembers||[]).map((m,i) => `
                <div class="flex justify-between p-2 bg-gray-50 rounded text-xs">
                    <span>${m.name}</span>
                    <span class="text-blue-500 font-bold">${m.role}</span>
                </div>
            `).join('') || '<span class="text-xs text-gray-300">Kimse yok</span>';
        }
        async function addFamilyMember() {
            const u = document.getElementById('famInput').value.trim();
            if(!u) return;
            // Davet mantÄ±ÄŸÄ±... (BasitleÅŸtirildi)
            alert("KullanÄ±cÄ±ya davet gÃ¶nderildi (Demo)");
        }
        async function joinPlanByCode() {
            const c = document.getElementById('settingsInviteCode').value.trim();
            if(!c) return;
            // KatÄ±lma mantÄ±ÄŸÄ±...
            alert("Plana katÄ±lma isteÄŸi gÃ¶nderildi (Demo)");
        }
        async function leaveCurrentPlan() {
            if(confirm('AyrÄ±l?')) {
                state = JSON.parse(JSON.stringify(defaultState)); // Reset
                state.registrationDate = new Date().toISOString();
                currentPlanId = currentUser.uid;
                saveToCloud(); location.reload();
            }
        }

        // --- YARDIMCI FONKSÄ°YONLAR ---
        function deleteHealthItem(type, idx) {
            if(confirm('Sil?')) { state[type].splice(idx,1); saveToCloud(); updateDashboardUI(); }
        }
        function loadEditItem(type, idx) {
            const item = state[type][idx];
            document.getElementById('editItemName').value = item.name;
            document.getElementById('editItemVal').value = item.val || item.totalDebt || 0;
            document.getElementById('editItemType').value = type;
            document.getElementById('editItemIndex').value = idx;
            document.getElementById('editExcludeNetWorth').checked = item.excludeFromNetWorth || item.excludeFromDebt || false;
        }
        function saveEditedItem() {
            const type = document.getElementById('editItemType').value;
            const idx = document.getElementById('editItemIndex').value;
            const item = state[type][idx];
            item.name = document.getElementById('editItemName').value;
            const val = parseFloat(document.getElementById('editItemVal').value);
            const exc = document.getElementById('editExcludeNetWorth').checked;
            
            if(type === 'loans') { item.totalDebt = val; item.excludeFromDebt = exc; }
            else { item.val = val; item.excludeFromNetWorth = exc; }
            
            saveToCloud(); updateDashboardUI(); closeEditModal();
        }

        // --- ANALÄ°Z GRAFÄ°KLERÄ° ---
        function renderCharts() {
            const ctx1 = document.getElementById('assetsChart').getContext('2d');
            const ctx2 = document.getElementById('expensesChart').getContext('2d');
            
            if(assetsChartInstance) assetsChartInstance.destroy();
            if(expensesChartInstance) expensesChartInstance.destroy();
            
            // Veri hazÄ±rlama...
            const assets = state.assets.reduce((s,a)=>s+(a.val||0),0);
            const debts = state.loans.reduce((s,l)=>s+(l.totalDebt||0),0) + state.debts.reduce((s,d)=>s+(d.val||0),0);
            
            assetsChartInstance = new Chart(ctx1, { type: 'doughnut', data: { labels: ['VarlÄ±k', 'BorÃ§'], datasets: [{ data: [assets, debts], backgroundColor: ['#22c55e', '#ef4444'] }] } });
            
            // Harcamalar
            const cats = {};
            state.expenses.forEach(e => { cats[e.category] = (cats[e.category]||0) + e.amount; });
            expensesChartInstance = new Chart(ctx2, { type: 'bar', data: { labels: Object.keys(cats), datasets: [{ label:'Harcama', data: Object.values(cats), backgroundColor: '#3b82f6' }] } });
        }
        
        function renderTrendChart() {
            const ctx = document.getElementById('historyTrendChart').getContext('2d');
            if(trendChartInstance) trendChartInstance.destroy();
            const labels = state.monthlyHistory.map(h => h.date);
            const data = state.monthlyHistory.map(h => (h.assets||0) - (h.debts||0));
            trendChartInstance = new Chart(ctx, { type: 'line', data: { labels, datasets: [{ label:'Net Durum', data, borderColor: '#6366f1', tension:0.3 }] } });
        }
        
        function addHistoryRecord() {
            const d = document.getElementById('histDate').value;
            const a = parseFloat(document.getElementById('histAssets').value)||0;
            const db = parseFloat(document.getElementById('histDebts').value)||0;
            const usd = parseFloat(document.getElementById('histUSDRate').value)||0;
            if(d) {
                state.monthlyHistory.push({ date:d, assets:a, debts:db, usdRate:usd });
                saveToCloud(); showAnalysisScreen(); // Refresh
            }
        }
        function renderHistoryTable() {
            const t = document.getElementById('historyTableBody');
            t.innerHTML = state.monthlyHistory.map(h => `<tr><td>${h.date}</td><td class="text-green-600">${h.assets}</td><td class="text-red-600">${h.debts}</td></tr>`).join('');
        }

        // --- SÄ°HÄ°RBAZ & DÄ°ÄžERLERÄ° ---
        function startWizard(edit) { hideAll(); document.getElementById('wizardScreen').classList.remove('hidden'); if(!edit) state.step=1; renderWizard(); }
        function renderWizard() { document.getElementById('wizardContent').innerHTML = `<h3 class="text-lg font-bold">AdÄ±m ${state.step}</h3><p>Demo Modu: HÄ±zlÄ± kurulum iÃ§in sihirbaz atlandÄ±.</p>`; }
        function wizardNext() { state.step++; if(state.step>8) { saveToCloud(); showDashboard(); } else renderWizard(); }
        function wizardBack() { state.step--; if(state.step<1) showDashboard(); else renderWizard(); }
        function addNewHealthItem(type) { toggleInlineAdd('dash'+(type==='loans'?'Debt':'Asset')); } // Basit yÃ¶nlendirme

        // --- HARCAMA GEÃ‡MÄ°ÅžÄ° LÄ°STESÄ° ---
        function renderHistoryList() {
            const l = document.getElementById('historyList');
            const html = state.expenses.slice(0, 10).map(e => `
                <div class="flex justify-between items-center p-3 border-b border-gray-50 last:border-0">
                    <div>
                        <p class="font-bold text-xs text-gray-800">${e.desc}</p>
                        <p class="text-[9px] text-gray-400">${e.date} â€¢ ${e.category}</p>
                    </div>
                    <span class="font-black text-sm text-red-500">-â‚º${e.amount}</span>
                </div>
            `).join('');
            l.innerHTML = html || '<p class="text-center text-[10px] text-gray-300 py-2">HenÃ¼z harcama yok</p>';
        }

        // --- DETAY MODALLARI (Ä°Ã‡ERÄ°K DOLDURMA) ---
        function renderCalcDetails() {
            const content = document.getElementById('calcModalContent');
            const totalInc = state.incomes.reduce((s,i)=>s+(i.val||0),0);
            const totalBill = state.bills.reduce((s,b)=>s+(b.val||0),0);
            content.innerHTML = `
                <div class="space-y-2">
                    <div class="flex justify-between font-bold text-green-600"><span>Gelir</span><span>+â‚º${totalInc}</span></div>
                    <div class="flex justify-between font-bold text-red-500"><span>Gider</span><span>-â‚º${totalBill}</span></div>
                    <hr class="border-gray-100">
                    <div class="flex justify-between font-black text-gray-800"><span>Kalan</span><span>â‚º${totalInc-totalBill}</span></div>
                    <p class="text-gray-400 mt-4">Bu alan detaylÄ± matematiksel dÃ¶kÃ¼mÃ¼ gÃ¶sterir.</p>
                </div>
            `;
        }
        function renderBalanceDetails() {
            document.getElementById('balanceModalContent').innerHTML = `<p class="text-center text-gray-500">MaaÅŸ gÃ¼nÃ¼nÃ¼ze gÃ¶re kÃ¼mÃ¼latif bakiye hesaplamasÄ± burada yer alÄ±r.</p>`;
        }
        function renderLoanPlan(idx) {
            const loan = state.loans[idx];
            document.getElementById('loanPlanTitle').innerText = loan.name;
            // Basit taksit tablosu
            let html = '';
            for(let i=1; i<=loan.totalMonths; i++) {
                html += `<tr><td class="py-1">${i}. Taksit</td><td class="text-right">â‚º${loan.monthly}</td></tr>`;
            }
            document.getElementById('loanPlanBody').innerHTML = html;
        }
        
    </script>
</body>
</html>
