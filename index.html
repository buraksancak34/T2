<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bizim Bütçe | Finansal Asistan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- FIREBASE SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .glass-card { background: rgba(255, 255, 255, 0.95); border: 1px solid rgba(255,255,255,0.6); box-shadow: 0 10px 30px -10px rgba(0,0,0,0.1); backdrop-filter: blur(10px); }
        .hidden { display: none !important; }
        input[type="range"] { accent-color: #2563eb; }
        .overlay { background: rgba(0,0,0,0.6); opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .overlay.active { opacity: 1; pointer-events: auto; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .health-detail { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .health-detail.open { max-height: 500px; transition: max-height 0.3s ease-in; }
        
        .fade-text { animation: textFade 0.5s ease-in-out; }
        @keyframes textFade { 0% { opacity: 0; } 100% { opacity: 1; } }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col items-center justify-center bg-slate-50">

    <div id="overlay" class="overlay fixed inset-0 z-40" onclick="closeAllPopups()"></div>
    
    <!-- Kayıt İndikatörü -->
    <div id="saveIndicator" class="fixed bottom-4 right-4 bg-white px-4 py-2 rounded-full shadow-lg border border-gray-100 flex items-center gap-2 text-xs font-bold text-gray-500 opacity-0 transition-opacity duration-500 pointer-events-none z-50">
        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div> Kaydedildi
    </div>

    <!-- 1. GİRİŞ EKRANI -->
    <div id="loginScreen" class="max-w-md w-full glass-card p-10 rounded-[2.5rem] shadow-2xl space-y-6 my-auto relative overflow-hidden animate-fade-in">
        <div class="text-center">
            <div class="w-16 h-16 bg-blue-50 rounded-2xl flex items-center justify-center mx-auto mb-4 text-blue-600 shadow-sm transform hover:rotate-12 transition-transform duration-300">
                <i class="fas fa-cloud text-2xl"></i>
            </div>
            <h1 class="text-2xl font-black text-gray-900 tracking-tight" id="loginTitle">Giriş Yap</h1>
            <p class="text-gray-400 text-[10px] font-bold uppercase tracking-widest mt-1" id="loginSubtitle">Hesabına Eriş</p>
        </div>
        
        <!-- Auth Form -->
        <div class="space-y-3" id="authFormContainer">
            <!-- Kayıt Modunda Görünecek -->
            <div id="registerFields" class="hidden space-y-3">
                <input type="text" id="regUsernameInput" class="w-full p-4 bg-white border border-gray-200 rounded-2xl focus:ring-4 focus:ring-blue-100 outline-none font-bold text-gray-700 transition-all text-sm" placeholder="Kullanıcı Adı Belirle (Zorunlu)">
                <input type="text" id="regInviteCode" class="w-full p-4 bg-white border border-gray-200 rounded-2xl focus:ring-4 focus:ring-blue-100 outline-none font-bold text-gray-700 transition-all text-sm" placeholder="Davet Kodu (Varsa)">
            </div>
            
            <input type="text" id="emailInput" class="w-full p-4 bg-white border border-gray-200 rounded-2xl focus:ring-4 focus:ring-blue-100 outline-none font-bold text-gray-700 transition-all text-sm" placeholder="E-posta veya Kullanıcı Adı">
            <input type="password" id="passwordInput" class="w-full p-4 bg-white border border-gray-200 rounded-2xl focus:ring-4 focus:ring-blue-100 outline-none font-bold text-gray-700 transition-all text-sm" placeholder="Şifre">
            
            <button id="loginBtn" onclick="firebaseLogin()" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl shadow-xl shadow-blue-200 active:scale-95 transition-all hover:bg-blue-700 flex justify-center items-center gap-2">
                <span>Giriş Yap</span>
            </button>
            
            <button id="registerBtn" onclick="firebaseRegister()" class="w-full bg-indigo-600 text-white font-black py-4 rounded-2xl shadow-xl hidden active:scale-95 transition-all hover:bg-indigo-700 flex justify-center items-center gap-2">
                <span>Üye Ol ve Katıl</span>
            </button>
            
            <!-- Şifremi Unuttum Linki -->
            <p id="forgotPassText" class="text-center text-[11px] font-bold text-blue-400 cursor-pointer hover:text-blue-600 pt-2" onclick="forgotPassword()">
                Şifremi Unuttum?
            </p>

            <p id="backToLoginText" class="text-center text-xs font-bold text-gray-400 cursor-pointer hover:text-blue-500 hidden pt-2" onclick="showLoginMode()">
                <i class="fas fa-arrow-left mr-1"></i> Giriş ekranına dön
            </p>
        </div>
        
        <div class="relative py-2">
            <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-200"></div></div>
            <div class="relative flex justify-center"><span class="bg-white px-4 text-xs font-bold text-gray-400 uppercase">veya</span></div>
        </div>

        <div class="space-y-3" id="actionButtons">
            <button onclick="startWizard(false)" class="w-full bg-green-500 text-white font-black py-4 rounded-2xl shadow-lg shadow-green-100 active:scale-95 transition-all hover:bg-green-600 flex items-center justify-center gap-2">
                <i class="fas fa-magic"></i> <span>Plana Başla</span>
            </button>
            <p class="text-[10px] text-center text-gray-400 px-4">Bütçeni oluşturmaya başla, en son adımda kaydedip üye ol.</p>

            <button onclick="showRegisterMode()" class="w-full bg-white border-2 border-gray-100 text-gray-600 font-bold py-3 rounded-2xl active:scale-95 transition-all hover:border-indigo-200 hover:text-indigo-600 mt-2">
                Bir Plana Dahil Ol
            </button>
        </div>
    </div>

    <!-- 2. SİHİRBAZ (WIZARD) -->
    <div id="wizardScreen" class="max-w-xl w-full glass-card p-8 rounded-[2.5rem] shadow-2xl hidden space-y-6 my-auto relative animate-fade-in">
        <div class="flex justify-between items-center mb-4">
            <div id="wizardProgress" class="flex gap-1 flex-1 mr-4"></div>
            <span class="text-xs font-bold text-gray-300" id="stepCount">1/8</span>
        </div>
        <div id="wizardContent" class="min-h-[420px] flex flex-col relative"></div>
        <div class="flex gap-3 mt-4" id="wizardNavBtns">
             <button onclick="wizardBack()" class="flex-1 bg-gray-100 text-gray-600 font-bold py-4 rounded-2xl hover:bg-gray-200 transition-all">Geri</button>
             <button onclick="wizardNext()" id="wizNextBtn" class="flex-[2] bg-blue-600 text-white font-black py-4 rounded-2xl shadow-xl active:scale-95 transition-all hover:bg-blue-700">Devam Et</button>
        </div>
    </div>

    <!-- 3. DASHBOARD -->
    <div id="dashboardScreen" class="max-w-4xl w-full hidden space-y-8 pb-32 animate-fade-in">
        <div class="flex justify-between items-center">
            <div>
                <h2 class="text-2xl font-black text-gray-800 tracking-tight" id="dashWelcome">Panelim</h2>
                <div class="flex items-center gap-2">
                    <span id="roleBadge" class="text-[9px] font-black bg-blue-100 text-blue-600 px-2 py-0.5 rounded uppercase tracking-wide">Yönetici</span>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="showFamilyModal()" id="btnFamily" class="text-[10px] font-black bg-white text-orange-500 border border-orange-200 px-4 py-2 rounded-full uppercase tracking-widest shadow-sm hover:bg-orange-50"><i class="fas fa-users mr-1"></i> Aile</button>
                <button onclick="showAnalysisScreen()" id="btnAnalysis" class="text-[10px] font-black bg-white text-indigo-500 border border-indigo-200 px-4 py-2 rounded-full uppercase tracking-widest shadow-sm hover:bg-indigo-50"><i class="fas fa-chart-pie mr-1"></i> Analiz</button>
                <button onclick="handleLogout()" class="text-[10px] font-black bg-white text-red-500 border border-red-50 px-4 py-2 rounded-full uppercase tracking-widest shadow-sm hover:bg-red-50">Çıkış</button>
            </div>
        </div>

        <!-- Limit Kartı -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-2 glass-card p-8 rounded-[3rem] bg-gradient-to-br from-slate-800 to-slate-900 text-white shadow-2xl relative overflow-hidden group">
                <div class="absolute top-0 right-0 w-64 h-64 bg-blue-500 rounded-full mix-blend-overlay filter blur-3xl opacity-20 -mr-16 -mt-16"></div>
                <div class="relative z-10">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest mb-1 opacity-80">Bugünün Limiti</p>
                            <h2 id="displayDailyLimit" class="text-6xl font-black tracking-tighter leading-none">₺0</h2>
                        </div>
                        <div class="text-right">
                            <p class="text-blue-400 text-[10px] font-bold uppercase tracking-widest mb-1 underline decoration-dashed underline-offset-4 cursor-help" title="Geçmiş günlerden artan/azalan + Bugünün Limiti">Gerçek Bakiye</p>
                            <h4 id="displayCumulativeLimit" class="text-4xl font-black text-white tracking-tight">₺0</h4>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 mt-8 pt-6 border-t border-white/10">
                        <div class="bg-white/10 px-4 py-2 rounded-xl backdrop-blur-md border border-white/5">
                            <span class="text-[9px] text-slate-300 font-bold uppercase block">Maaşa Kalan</span>
                            <span id="displayRemainingDays" class="text-lg font-black text-white">-- Gün</span>
                        </div>
                         <div class="bg-white/10 px-4 py-2 rounded-xl backdrop-blur-md border border-white/5">
                            <span class="text-[9px] text-slate-300 font-bold uppercase block">Hedef Birikim</span>
                            <span id="sumSavings" class="text-lg font-black text-green-400">₺0</span>
                        </div>
                        <!-- PLANI DÜZENLE BUTONU -->
                        <button onclick="startWizard(true)" id="btnEditPlan" class="bg-white/10 px-4 py-2 rounded-xl backdrop-blur-md border border-white/5 hover:bg-white/20 transition-all flex flex-col items-center justify-center min-w-[80px]">
                            <i class="fas fa-pen text-sm mb-1 text-slate-300"></i>
                            <span class="text-[9px] text-slate-300 font-bold uppercase block">Düzenle</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Özet Karne -->
            <div class="glass-card p-8 rounded-[3rem] flex flex-col justify-center space-y-6 bg-white border border-blue-50">
                <h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest text-center border-b pb-4">Aylık Durum</h4>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] font-bold text-gray-500 uppercase">Borç Endeksi</span>
                        <span id="sumSalaryMult" class="text-lg font-black text-indigo-600">0.0x</span>
                    </div>
                     <div class="flex justify-between items-center">
                        <span class="text-[10px] font-bold text-gray-500 uppercase">Toplam Gider</span>
                        <span id="sumGiderTotal" class="text-lg font-black text-red-600">₺0</span>
                    </div>
                </div>
                
                <!-- Finansal Tavsiyeler (30 Saniyede Bir Değişen) -->
                <div class="mt-4 pt-4 border-t border-gray-100 flex-1 flex items-center justify-center">
                    <p id="financialAdviceText" class="text-center text-xs font-semibold text-gray-500 italic leading-relaxed fade-text">
                        Yükleniyor...
                    </p>
                </div>
            </div>
        </div>

        <!-- Hızlı İşlem -->
        <div class="glass-card p-8 rounded-[2.5rem] bg-white border border-gray-100 shadow-lg">
            <div class="flex items-center justify-between mb-6">
                <h3 class="font-black text-xl text-gray-800">Harcama Ekle</h3>
                <span id="todayTotal" class="text-[10px] font-bold bg-blue-100 text-blue-700 px-3 py-1 rounded-lg uppercase tracking-wide">Bugün: ₺0</span>
            </div>
            <div class="flex gap-3">
                <input type="number" id="expAmt" placeholder="Tutar (₺)" onkeyup="if(event.key === 'Enter') addExpense()" class="w-1/3 p-4 bg-gray-50 rounded-2xl font-black text-lg outline-none focus:ring-4 focus:ring-blue-100 transition-all">
                <input type="text" id="expDesc" value="" placeholder="Açıklama (Opsiyonel)" onkeyup="if(event.key === 'Enter') addExpense()" class="flex-1 p-4 bg-gray-50 rounded-2xl font-bold text-gray-600 outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                <input type="hidden" id="editExpIndex" value="-1">
                <button id="addExpBtn" onclick="addExpense()" class="bg-blue-600 text-white w-20 rounded-2xl hover:bg-blue-700 active:scale-90 transition-all shadow-lg shadow-blue-200 flex items-center justify-center"><i class="fas fa-plus text-xl"></i></button>
            </div>
        </div>

        <!-- Harcama Geçmişi -->
        <div class="glass-card p-10 rounded-[3rem] shadow-xl bg-white border border-gray-100">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-black text-xl text-gray-800 uppercase tracking-widest text-[11px]">Son İşlemler</h3>
            </div>
            <div id="historyList" class="space-y-3 pb-4 max-h-60 overflow-y-auto custom-scrollbar pr-1"></div>
        </div>

        <!-- Finansal Sağlık (Sadece Tam Yetki) -->
        <div id="financialHealthSection" class="glass-card p-10 rounded-[3rem] space-y-8 bg-white border border-blue-50 shadow-xl">
            <div class="flex flex-col items-center border-b pb-8">
                <h3 class="font-black text-3xl text-gray-800 mb-2">Finansal Sağlık</h3>
                <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mb-4">Net Varlık (Varlık - Borç)</p>
                <div id="netStatusBadge" class="text-4xl font-black text-gray-800 px-8 py-4 bg-gray-50 rounded-[2rem] transition-colors">
                    <span id="netStatusVal">₺0</span>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-4">
                    <div class="flex items-center gap-2 mb-2 pb-2 border-b border-red-100"><div class="w-3 h-3 bg-red-500 rounded-full"></div><span class="text-xs font-black text-red-600 uppercase tracking-widest">Borçlar & Krediler</span></div>
                    <div id="detailedDebtsList" class="space-y-3 min-h-[50px]"></div>
                </div>
                <div class="space-y-4">
                    <div class="flex items-center gap-2 mb-2 pb-2 border-b border-green-100"><div class="w-3 h-3 bg-green-500 rounded-full"></div><span class="text-xs font-black text-green-600 uppercase tracking-widest">Varlıklar</span></div>
                    <div id="detailedAssetsList" class="space-y-3 min-h-[50px]"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. ANALİZ EKRANI -->
    <div id="analysisScreen" class="max-w-4xl w-full hidden space-y-8 pb-32 animate-fade-in my-auto">
        <div class="flex justify-between items-center mb-6">
            <div><h2 class="text-2xl font-black text-gray-800 tracking-tight">Finansal Analiz</h2><p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Geçmiş Veriler & Grafikler</p></div>
            <button onclick="showDashboard()" class="text-[10px] font-black bg-gray-100 text-gray-600 border border-gray-200 px-4 py-2 rounded-full uppercase tracking-widest shadow-sm hover:bg-gray-200">Geri Dön</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="glass-card p-6 rounded-[2.5rem] bg-white border border-gray-100 shadow-lg"><h3 class="font-black text-lg text-gray-800 mb-4 text-center">Varlık vs Borç</h3><div class="h-64"><canvas id="assetsChart"></canvas></div></div>
            <div class="glass-card p-6 rounded-[2.5rem] bg-white border border-gray-100 shadow-lg"><h3 class="font-black text-lg text-gray-800 mb-4 text-center">Harcamalar</h3><div class="h-64"><canvas id="expensesChart"></canvas></div></div>
        </div>
        <div class="glass-card p-8 rounded-[2.5rem] bg-white border border-gray-100 shadow-lg">
            <h3 class="font-black text-xl text-gray-800 mb-4 border-b pb-2">Geçmiş Kayıt Ekle</h3>
            <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 items-end">
                <div><label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Dönem</label><input type="month" id="histDate" class="w-full p-3 bg-gray-50 rounded-xl font-bold text-sm outline-none"></div>
                <div><label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Varlık</label><input type="number" id="histAssets" placeholder="0" class="w-full p-3 bg-gray-50 rounded-xl font-bold text-sm outline-none text-green-600"></div>
                <div><label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Borç</label><input type="number" id="histDebts" placeholder="0" class="w-full p-3 bg-gray-50 rounded-xl font-bold text-sm outline-none text-red-600"></div>
                <button onclick="addHistoryRecord()" class="bg-indigo-600 text-white font-black py-3 rounded-xl shadow-lg hover:bg-indigo-700 active:scale-95 transition-all">Kaydet</button>
            </div>
            <div id="historyTable" class="mt-6 space-y-2"></div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="calcModal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-sm glass-card p-8 rounded-[2rem] z-50 shadow-2xl hidden text-center border-2 border-blue-50 animate-fade-in">
        <div class="flex justify-between items-center mb-6"><h4 class="font-black text-xl text-gray-800 tracking-tight w-full">Hesaplama Özeti</h4><button onclick="closeCalcModal()" class="text-gray-300 hover:text-red-500 absolute right-6"><i class="fas fa-times"></i></button></div><div id="calcModalContent" class="space-y-4 text-sm"></div>
    </div>

    <div id="editItemModal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-sm glass-card p-8 rounded-[2rem] z-50 shadow-2xl hidden text-center border-2 border-gray-50 animate-fade-in">
        <h4 class="font-black text-xl text-gray-800 mb-4">Düzenle</h4><input type="text" id="editItemName" class="w-full p-3 mb-3 bg-gray-50 rounded-xl font-bold text-sm"><input type="number" id="editItemVal" class="w-full p-3 mb-6 bg-gray-50 rounded-xl font-bold text-sm"><input type="hidden" id="editItemType"><input type="hidden" id="editItemIndex"><div class="flex gap-2"><button onclick="closeEditModal()" class="flex-1 py-3 bg-gray-100 text-gray-600 font-bold rounded-xl">İptal</button><button onclick="saveEditedItem()" class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl">Kaydet</button></div>
    </div>

    <!-- AİLE YÖNETİM MODALI -->
    <div id="familyModal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[95%] max-w-md glass-card p-8 rounded-[2.5rem] z-50 shadow-2xl hidden border-2 border-orange-50 animate-fade-in">
        <div class="flex justify-between items-center mb-6">
            <h4 class="font-black text-xl text-gray-800 tracking-tight">Aile Üyeleri</h4>
            <button onclick="document.getElementById('familyModal').classList.add('hidden'); document.getElementById('overlay').classList.remove('active')" class="text-gray-300 hover:text-red-500"><i class="fas fa-times"></i></button>
        </div>
        
        <!-- DAVET KODU BÖLÜMÜ -->
        <div class="bg-blue-50 p-4 rounded-xl mb-4 border border-blue-100 text-center relative overflow-hidden">
             <p class="text-[9px] font-bold text-blue-400 uppercase tracking-widest mb-1">Plan Davet Kodu</p>
             <h3 id="displayInviteCode" class="text-3xl font-black text-blue-600 tracking-wider mb-2">-----</h3>
             <button onclick="createInviteCode()" class="text-xs font-bold text-blue-500 hover:text-blue-700 underline">Oluştur / Yenile</button>
        </div>

        <div class="space-y-4 mb-6">
            <h5 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Yeni Üye Ekle</h5>
            <div class="flex flex-col gap-2">
                <input type="text" id="famInput" class="w-full p-3 bg-gray-50 rounded-xl font-bold text-sm outline-none border border-gray-100" placeholder="Kullanıcı Adı veya E-posta">
                <div class="flex gap-2">
                    <select id="famRole" class="flex-1 p-3 bg-white border border-gray-100 rounded-xl text-sm font-bold text-gray-600 outline-none">
                        <option value="full">Tam Yetki</option>
                        <option value="limited">Sınırlı Yetki</option>
                    </select>
                    <button onclick="addFamilyMember()" class="bg-orange-500 text-white font-black px-6 rounded-xl hover:bg-orange-600 active:scale-95 transition-all">Ekle</button>
                </div>
                <p class="text-[9px] text-gray-400 px-1">* Sınırlı yetki: Sadece harcama ekler ve görür.</p>
            </div>
        </div>

        <div id="familyList" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar"></div>
    </div>

    <script>
        // --------------------------------------------------------
        // FIREBASE YAPILANDIRMASI
        // --------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyAyUQaeoVWnT4AuzSwD2M17-z1g2optqdA",
            authDomain: "hesapguvende-b07ca.firebaseapp.com",
            projectId: "hesapguvende-b07ca",
            storageBucket: "hesapguvende-b07ca.firebasestorage.app",
            messagingSenderId: "710002620092",
            appId: "1:710002620092:web:94f3ebb8dd2461af29c2b9",
            measurementId: "G-VE0EVVBM0V"
        };

        // --- FİNANSAL SÖZLER HAVUZU ---
        const financialTips = [
            "Finansal sağlık, gelir ve giderler arasında sürdürülebilir bir denge kurabilme becerisidir.",
            "Finansal sağlık, sadece para biriktirmek değil, parayı bilinçli yönetmektir.",
            "Finansal sağlık, harcamaların kontrol altında olması anlamına gelir.",
            "Finansal sağlık, geleceğe dair ekonomik güven hissi oluşturur.",
            "Finansal sağlık, borçların yönetilebilir seviyede olmasıdır.",
            "Finansal sağlık, ani harcamalara karşı hazırlıklı olmaktır.",
            "Finansal sağlık, tasarruf alışkanlığının sürekliliğidir.",
            "Finansal sağlık, gelir kaynaklarının farkında olmaktır.",
            "Finansal sağlık, harcama alışkanlıklarını analiz edebilmektir.",
            "Finansal sağlık, finansal stresin düşük olmasıdır.",
            "Finansal sağlık, uzun vadeli plan yapabilme yeteneğidir.",
            "Finansal sağlık, bütçe oluşturma disiplinidir.",
            "Finansal sağlık, finansal kararların bilinçli alınmasıdır.",
            "Finansal sağlık, gereksiz harcamaları ayırt edebilmektir.",
            "Finansal sağlık, finansal hedeflere sahip olmaktır.",
            "Finansal sağlık, gelir artışı kadar gider kontrolünü de önemsemektir.",
            "Finansal sağlık, finansal farkındalık düzeyidir.",
            "Finansal sağlık, ekonomik risklere karşı dayanıklılıktır.",
            "Finansal sağlık, bugün ile yarın arasında denge kurmaktır.",
            "Finansal sağlık, finansal özgürlüğe giden yolun temelidir.",
            "Gelir ve gider dengesini bilmek finansal kontrolün ilk adımıdır.",
            "Gelirinden fazla harcamak uzun vadede finansal kırılganlık yaratır.",
            "Düzenli gelir-gider takibi bilinçsiz harcamaları azaltır.",
            "Gelir-gider dengesi bütçe planlamasının temelidir.",
            "Harcamaları yazmak farkındalık oluşturur.",
            "Küçük ama sık harcamalar bütçeyi sessizce tüketir.",
            "Gelir-gider analizi tasarruf alanlarını ortaya çıkarır.",
            "Finansal disiplin günlük takip ile başlar.",
            "Gelir-gider kontrolü borçlanma ihtiyacını azaltır.",
            "Harcamaları görmek davranış değişikliğini kolaylaştırır.",
            "Gelir-gider dengesi finansal stresin azalmasına yardımcı olur.",
            "Aylık dengeyi bilmek yıllık plan yapmayı kolaylaştırır.",
            "Denge sağlanmadığında tasarruf imkânsızlaşır.",
            "Gelir-gider takibi finansal hedeflere ulaşmayı hızlandırır.",
            "Düzensiz harcama gelecekte belirsizlik yaratır.",
            "Gelir-gider farkı yatırım potansiyelini belirler.",
            "Finansal denge kriz dönemlerinde koruma sağlar.",
            "Günlük kontrol uzun vadeli istikrar oluşturur.",
            "Gelir-gider dengesi finansal özgüveni artırır.",
            "Kontrol edilen para, yönlendirilebilir paradır.",
            "Tasarruf geleceğe yapılmış bilinçli bir yatırımdır.",
            "Tasarruf beklenmeyen durumlara karşı güvenlik sağlar.",
            "Tasarruf finansal bağımsızlığın temelidir.",
            "Tasarruf küçük miktarlarla başlar.",
            "Düzenli tasarruf alışkanlık gerektirir.",
            "Tasarruf gelecekteki fırsatları mümkün kılar.",
            "Tasarruf borç ihtiyacını azaltır.",
            "Tasarruf finansal stresi düşürür.",
            "Tasarruf uzun vadeli hedefleri erişilebilir kılar.",
            "Tasarruf disiplinli harcama davranışı kazandırır.",
            "Tasarruf kriz anlarında dayanıklılık sağlar.",
            "Tasarruf yatırım yapabilmenin ön koşuludur.",
            "Tasarruf özgür seçim yapma gücü verir.",
            "Tasarruf bilinçli tüketimin göstergesidir.",
            "Tasarruf küçük fedakârlıkların büyük sonucudur.",
            "Tasarruf zamanla büyüyen bir finansal güvenliktir.",
            "Tasarruf finansal istikrar oluşturur.",
            "Tasarruf sabır gerektirir.",
            "Tasarruf finansal hedeflere ulaşma süresini kısaltır.",
            "Tasarruf gelecekteki belirsizlikleri azaltır.",
            "Finansal farkındalık harcamadan önce düşünmeyi sağlar.",
            "Bilinçli harcama uzun vadeli rahatlık getirir.",
            "Anlık tatmin uzun vadeli sorun yaratabilir.",
            "Planlı hareket eden kişi finansal kontrolü elinde tutar.",
            "Harcamaların amacı sorgulanmalıdır.",
            "Finansal kararlar duygusal değil bilinçli verilmelidir.",
            "Para yönetimi bir alışkanlık meselesidir.",
            "Günlük küçük kararlar finansal geleceği belirler.",
            "Finansal disiplin özgüven yaratır.",
            "Harcamaların yazılması davranışı değiştirir.",
            "Finansal hedefler motivasyonu artırır.",
            "Bilinçli tüketim sürdürülebilir yaşamı destekler.",
            "Finansal planlama belirsizliği azaltır.",
            "Harcama kontrolü özgürlük sağlar.",
            "Finansal düzen zihinsel düzeni destekler.",
            "Düzenli takip başarı olasılığını artırır.",
            "Finansal sağlığı güçlü olan birey risklere karşı dayanıklıdır.",
            "Bütçe yapmak kısıtlama değil yönlendirmedir.",
            "Finansal disiplin bir yaşam becerisidir.",
            "Finansal sağlığı korumak günlük küçük adımlarla mümkündür."
        ];

        let db, auth, currentUser = null;
        let currentPlanId = null; 
        let currentUserRole = 'owner';
        let isFirebaseReady = false;
        let isRegistering = false; 
        let assetsChartInstance = null;
        let expensesChartInstance = null;
        let adviceInterval = null;

        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            isFirebaseReady = true;
            
            auth.onAuthStateChanged(user => {
                if(isRegistering) return;
                if (user) {
                    currentUser = user;
                    const name = user.displayName || user.email.split('@')[0];
                    document.getElementById('dashWelcome').innerText = `Hoşgeldin, ${name}`;
                    initUserPlan(); 
                    startAdviceRotator();
                } else {
                    currentUser = null;
                    clearInterval(adviceInterval);
                }
            });
        } catch(e) { console.error(e); }

        function startAdviceRotator() {
            const el = document.getElementById('financialAdviceText');
            if(!el) return;
            const update = () => {
                el.classList.remove('fade-text');
                void el.offsetWidth; // Trigger reflow
                const randomTip = financialTips[Math.floor(Math.random() * financialTips.length)];
                el.innerText = randomTip;
                el.classList.add('fade-text');
            };
            update();
            adviceInterval = setInterval(update, 30000);
        }

        // --- AUTH & PLAN LOGIC ---
        async function initUserPlan() {
            if (!currentUser) return;
            try {
                // Önce ID'yi varsayılan olarak ayarla
                currentPlanId = currentUser.uid;
                currentUserRole = 'owner';

                const userDoc = await db.collection("users").doc(currentUser.uid).get();
                if(!userDoc.exists) {
                    // Kayıt yoksa oluştur (ID zaten set edildi)
                    saveToCloud();
                } else {
                    const userData = userDoc.data();
                    if (userData.connectedPlanId) {
                        currentPlanId = userData.connectedPlanId;
                        // Bağlı planı kontrol et
                        const planDoc = await db.collection("users").doc(currentPlanId).get();
                        if(planDoc.exists) {
                            const planData = planDoc.data();
                            const member = planData.familyMembers ? planData.familyMembers.find(m => m.uid === currentUser.uid) : null;
                            currentUserRole = member ? member.role : 'limited';
                        } else {
                            // Plan silinmişse fallback
                            currentPlanId = currentUser.uid;
                            currentUserRole = 'owner';
                        }
                    }
                }
                loadFromCloud();
            } catch (error) {
                console.error("Plan yükleme hatası:", error);
            }
        }

        // --- AUTH UI ---
        function showLoginMode() {
            document.getElementById('loginTitle').innerText = "Giriş Yap";
            document.getElementById('loginBtn').classList.remove('hidden');
            document.getElementById('registerBtn').classList.add('hidden');
            document.getElementById('registerFields').classList.add('hidden'); // Register fields gizle
            document.getElementById('emailInput').placeholder = "E-posta veya Kullanıcı Adı";
            document.getElementById('actionButtons').classList.remove('hidden');
            document.getElementById('backToLoginText').classList.add('hidden');
            document.getElementById('forgotPassText').classList.remove('hidden');
        }

        function showRegisterMode() {
            document.getElementById('loginTitle').innerText = "Ailene Katıl";
            document.getElementById('loginBtn').classList.add('hidden');
            document.getElementById('registerBtn').classList.remove('hidden');
            document.getElementById('registerFields').classList.remove('hidden'); // Kullanıcı adı görünür
            document.getElementById('emailInput').placeholder = "E-posta Adresi";
            document.getElementById('actionButtons').classList.add('hidden');
            document.getElementById('backToLoginText').classList.remove('hidden');
            document.getElementById('forgotPassText').classList.add('hidden');
        }

        async function firebaseLogin() {
            if(!isFirebaseReady) return;
            const emailInp = document.getElementById('emailInput').value.trim();
            const pass = document.getElementById('passwordInput').value;
            if(!emailInp || !pass) return alert("Alanları doldurun.");
            
            const btn = document.getElementById('loginBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loader"></div>';

            try {
                let email = emailInp;
                if (!email.includes('@')) {
                    // Kullanıcı adını küçük harfe çevirerek ara
                    const usernameQuery = email.toLowerCase();
                    const snapshot = await db.collection('users').where('username', '==', usernameQuery).limit(1).get();
                    if (snapshot.empty) throw new Error("Bu kullanıcı adı ile kayıt bulunamadı.");
                    email = snapshot.docs[0].data().email;
                }
                await auth.signInWithEmailAndPassword(email, pass);
            } catch (error) {
                alert("Giriş Hatası: " + error.message);
                btn.innerHTML = originalText;
            }
        }

        async function firebaseRegister() {
            if(!isFirebaseReady) return;
            const username = document.getElementById('regUsernameInput').value.trim().toLowerCase();
            const email = document.getElementById('emailInput').value.trim();
            const pass = document.getElementById('passwordInput').value;
            const inviteCode = document.getElementById('regInviteCode').value.trim().toUpperCase();
            
            if(!email.includes('@') || !username || !pass) return alert("Tüm alanları doğru doldurun.");
            
            const btn = document.getElementById('registerBtn');
            btn.innerHTML = '<div class="loader"></div>';
            isRegistering = true;
            
            try {
                const cred = await auth.createUserWithEmailAndPassword(email, pass);
                currentUser = cred.user;
                await cred.user.updateProfile({ displayName: username });

                const initState = JSON.parse(JSON.stringify(defaultState));
                initState.email = email;
                initState.username = username;

                if (inviteCode) {
                    const snapshot = await db.collection('users').where('inviteCode', '==', inviteCode).get();
                    if (!snapshot.empty) {
                        const ownerDoc = snapshot.docs[0];
                        const ownerData = ownerDoc.data();
                        initState.connectedPlanId = ownerDoc.id;
                        const newMember = { uid: cred.user.uid, name: username, role: 'full' };
                        let members = ownerData.familyMembers || [];
                        members.push(newMember);
                        await db.collection('users').doc(ownerDoc.id).update({ familyMembers: members });
                        alert("Davet kodu onaylandı! Plana tam yetkili olarak eklendiniz.");
                    } else {
                         alert("Geçersiz davet kodu, kendi planınız oluşturuldu.");
                    }
                }

                await db.collection("users").doc(cred.user.uid).set(initState);
                isRegistering = false;
                showDashboard();

            } catch (error) {
                isRegistering = false; 
                alert("Hata: " + error.message); 
                btn.innerHTML = "Üye Ol ve Katıl";
            }
        }

        function forgotPassword() {
            const email = document.getElementById('emailInput').value.trim();
            if (!email) {
                return alert("Lütfen şifre sıfırlama bağlantısı için e-posta adresinizi giriniz.");
            }
            if (!email.includes('@')) {
                return alert("Şifre sıfırlama sadece E-posta adresi ile yapılabilir. Lütfen geçerli bir e-posta giriniz.");
            }

            if(confirm(`${email} adresine şifre sıfırlama bağlantısı gönderilsin mi?`)) {
                auth.sendPasswordResetEmail(email)
                    .then(() => alert("Şifre sıfırlama bağlantısı gönderildi."))
                    .catch((error) => alert("Hata: " + error.message));
            }
        }

        function handleLogout() {
            if(auth.currentUser) {
                auth.signOut().then(() => window.location.reload()).catch(() => window.location.reload());
            } else {
                window.location.reload();
            }
        }

        function showFamilyModal() {
            if(currentUserRole !== 'owner' && currentUserRole !== 'full') return alert("Bu işlem için yetkiniz yok.");
            renderFamilyList();
            const code = state.inviteCode || '-----';
            document.getElementById('displayInviteCode').innerText = code;
            document.getElementById('familyModal').classList.remove('hidden');
            document.getElementById('overlay').classList.add('active');
        }

        function createInviteCode() {
            const code = Math.random().toString(36).substring(2, 7).toUpperCase();
            state.inviteCode = code;
            saveToCloud();
            document.getElementById('displayInviteCode').innerText = code;
        }

        async function addFamilyMember() {
            const input = document.getElementById('famInput').value.trim().toLowerCase();
            const role = document.getElementById('famRole').value;
            if(!input) return;

            let snapshot = await db.collection('users').where('username', '==', input).limit(1).get();
            if(snapshot.empty) {
                snapshot = await db.collection('users').where('email', '==', document.getElementById('famInput').value.trim()).limit(1).get();
            }
            
            if(snapshot.empty) return alert("Kullanıcı bulunamadı.");
            
            const targetDoc = snapshot.docs[0];
            const targetUid = targetDoc.id;

            if(targetUid === currentUser.uid) return alert("Kendinizi ekleyemezsiniz.");

            await db.collection('users').doc(targetUid).update({ connectedPlanId: currentUser.uid });
            
            if(!state.familyMembers) state.familyMembers = [];
            const existingIdx = state.familyMembers.findIndex(m => m.uid === targetUid);
            if(existingIdx > -1) {
                state.familyMembers[existingIdx].role = role;
            } else {
                state.familyMembers.push({ uid: targetUid, name: targetDoc.data().username || targetDoc.data().email, role: role });
            }
            
            saveToCloud();
            renderFamilyList();
            document.getElementById('famInput').value = '';
            alert(`Kullanıcı eklendi!`);
        }

        async function updateMemberRole(idx, newRole) {
            state.familyMembers[idx].role = newRole;
            saveToCloud();
        }

        async function removeFamilyMember(idx) {
            const member = state.familyMembers[idx];
            if(confirm(`${member.name} plandan çıkarılacak?`)) {
                await db.collection('users').doc(member.uid).update({ connectedPlanId: null });
                state.familyMembers.splice(idx, 1);
                saveToCloud();
                renderFamilyList();
            }
        }

        function renderFamilyList() {
            const list = document.getElementById('familyList');
            if(!state.familyMembers || state.familyMembers.length === 0) {
                list.innerHTML = '<p class="text-gray-400 text-xs text-center py-4">Henüz aile üyesi yok.</p>';
                return;
            }
            list.innerHTML = state.familyMembers.map((m, i) => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl text-sm">
                    <p class="font-bold text-gray-800">${m.name}</p>
                    <div class="flex items-center gap-2">
                        <select onchange="updateMemberRole(${i}, this.value)" class="text-[10px] font-bold uppercase bg-transparent outline-none cursor-pointer text-blue-500">
                            <option value="full" ${m.role === 'full' ? 'selected' : ''}>Tam Yetki</option>
                            <option value="limited" ${m.role === 'limited' ? 'selected' : ''}>Sınırlı</option>
                        </select>
                        <button onclick="removeFamilyMember(${i})" class="text-red-400 hover:text-red-600 ml-2"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`).join('');
        }

        function loadFromCloud() {
            if(!currentUser || !currentPlanId) return;
            db.collection("users").doc(currentPlanId).get().then((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    if(data.registrationDate) data.registrationDate = new Date(data.registrationDate.seconds ? data.registrationDate.seconds * 1000 : data.registrationDate);
                    state = data;
                    // Ensure arrays exist
                    if(!state.otherDebts) state.otherDebts = [];
                    if(!state.monthlyHistory) state.monthlyHistory = [];
                    if(!state.familyMembers) state.familyMembers = [];
                    
                    showDashboard();
                }
            });
        }

        function saveToCloud() {
            if(!currentUser || !currentPlanId) return Promise.resolve();
            const stateToSave = JSON.parse(JSON.stringify(state));
            stateToSave.registrationDate = state.registrationDate.toISOString();
            
            return db.collection("users").doc(currentPlanId).set(stateToSave, { merge: true })
                .then(() => {
                    const ind = document.getElementById('saveIndicator');
                    ind.style.opacity = '1';
                    setTimeout(() => ind.style.opacity = '0', 2000);
                });
        }

        // --- STATE & DEFAULTS ---
        const defaultState = {
            step: 1, salaryDay: 15,
            registrationDate: new Date(),
            incomes: [], 
            bills: [
                { name: 'Kira', val: null }, { name: 'Aidat', val: null }, { name: 'Elektrik', val: null },
                { name: 'Su', val: null }, { name: 'Doğalgaz', val: null }, { name: 'İnternet', val: null },
                { name: 'Telefon Faturaları', val: null }, { name: 'Dijital abonelikler', val: null }
            ], 
            loans: [], debts: [], otherDebts: [], 
            assets: [
                { name: 'Bankadaki Para', val: null }, { name: 'Cepteki Para', val: null }, { name: 'Birikim Hesabı', val: null }
            ],
            manualDailyLimit: null, expenses: [], monthlyHistory: [], familyMembers: [], inviteCode: null
        };
        let state = JSON.parse(JSON.stringify(defaultState));

        function saveState() {
            if(currentUser && !isRegistering) saveToCloud();
        }

        // --- UI UPDATES ---
        function applyPermissions() {
            const roleLabel = currentUserRole === 'owner' ? 'Plan Sahibi' : currentUserRole === 'full' ? 'Tam Yetki' : 'Sınırlı Yetki';
            document.getElementById('roleBadge').innerText = roleLabel;
            
            if(currentUserRole === 'limited') {
                document.getElementById('financialHealthSection').classList.add('hidden');
                document.getElementById('btnAnalysis').classList.add('hidden');
                document.getElementById('btnFamily').classList.add('hidden');
                document.getElementById('btnEditPlan').classList.add('hidden');
            } else {
                document.getElementById('financialHealthSection').classList.remove('hidden');
                document.getElementById('btnAnalysis').classList.remove('hidden');
                document.getElementById('btnFamily').classList.remove('hidden');
                document.getElementById('btnEditPlan').classList.remove('hidden');
            }
        }

        function updateDashboardUI() {
            applyPermissions();
            const now = new Date();
            const todayStr = now.toLocaleDateString('tr-TR');
            let startCalc = state.registrationDate ? new Date(state.registrationDate) : new Date();
            if(isNaN(startCalc.getTime())) startCalc = new Date();
            const daysPassed = Math.max(1, Math.ceil((now - startCalc) / (1000 * 60 * 60 * 24)));
            
            const spentToday = state.expenses.filter(e => e.date === todayStr).reduce((s,e)=>s+e.amount,0);
            const totalSpent = state.expenses.reduce((s,e)=>s+e.amount,0);
            const cumulative = ((state.manualDailyLimit||0) * daysPassed) - totalSpent;
            
            document.getElementById('displayDailyLimit').innerText = `₺${Math.floor((state.manualDailyLimit||0) - spentToday).toLocaleString()}`;
            document.getElementById('displayCumulativeLimit').innerText = `₺${Math.floor(cumulative).toLocaleString()}`;
            document.getElementById('todayTotal').innerText = `Bugün: ₺${Math.floor(spentToday).toLocaleString()}`;
            
            let targetDate = new Date(now.getFullYear(), now.getMonth(), state.salaryDay||15);
            if (now.getDate() >= (state.salaryDay||15)) targetDate.setMonth(targetDate.getMonth()+1);
            document.getElementById('displayRemainingDays').innerText = `${Math.ceil((targetDate - now)/(1000*60*60*24))} Gün`;

            // Health
            const assets = state.assets.reduce((s,a)=>s+(a.val||0),0);
            const loans = state.loans.filter(l=>!l.excludeFromDebt).reduce((s,l)=>s+(l.totalDebt||0),0);
            const cards = state.debts.reduce((s,d)=>s+(d.val||0),0);
            const others = state.otherDebts.reduce((s,d)=>s+(d.val||0),0);
            const totalDebt = loans + cards + others;
            const net = assets - totalDebt;
            const inc = state.incomes.reduce((s,i)=>s+(i.val||0),0);

            document.getElementById('sumSalaryMult').innerText = inc>0 ? (totalDebt/inc).toFixed(1)+' Maaş' : '0x';
            document.getElementById('sumSavings').innerText = `₺${Math.floor(state.calculatedMonthlySavings||0).toLocaleString()}`;
            document.getElementById('sumGiderTotal').innerText = `₺${Math.floor(state.calculatedMonthlyPool||0).toLocaleString()}`;
            document.getElementById('netStatusVal').innerText = `${net>=0?'+':'-'}₺${Math.abs(Math.floor(net)).toLocaleString()}`;
            document.getElementById('netStatusBadge').className = `text-4xl font-black px-8 py-4 rounded-[2rem] ${net>=0?'text-green-600 bg-green-50':'text-red-600 bg-red-50'}`;

            renderDetailedHealthLists();
            renderHistoryList();
        }

        // --- EXPENSES ---
        function addExpense() {
            const amtInp = document.getElementById('expAmt');
            const descInp = document.getElementById('expDesc');
            const editIndex = parseInt(document.getElementById('editExpIndex').value);
            const amt = parseFloat(amtInp.value);
            
            if(!amt) return amtInp.focus();

            if(editIndex > -1 && currentUserRole === 'limited') {
                const targetExp = state.expenses[editIndex];
                const myName = currentUser.email.split('@')[0];
                if(targetExp.addedBy !== myName && targetExp.addedBy !== 'Ben') {
                    return alert("Sadece kendi harcamalarınızı düzenleyebilirsiniz.");
                }
            }

            if(editIndex > -1) {
                state.expenses[editIndex].amount = amt;
                state.expenses[editIndex].desc = descInp.value || 'Diğer';
                document.getElementById('editExpIndex').value = "-1";
                document.getElementById('addExpBtn').innerHTML = '<i class="fas fa-plus text-xl"></i>';
                document.getElementById('addExpBtn').classList.replace('bg-green-600', 'bg-blue-600');
            } else {
                state.expenses.unshift({ 
                    amount: amt, 
                    desc: descInp.value || 'Diğer', 
                    date: new Date().toLocaleDateString('tr-TR'), 
                    addedBy: currentUser ? currentUser.email.split('@')[0] : 'Ben',
                    ts: Date.now()
                });
            }
            
            amtInp.value = ''; descInp.value = '';
            saveToCloud(); 
            updateDashboardUI();
        }

        function renderHistoryList() {
            const list = document.getElementById('historyList');
            if(!list) return;
            if(state.expenses.length === 0) return list.innerHTML = '<div class="text-center text-gray-400 text-xs">Harcama yok.</div>';
            
            const myName = currentUser ? currentUser.email.split('@')[0] : '';

            list.innerHTML = state.expenses.map((e, idx) => {
                const canEdit = currentUserRole === 'owner' || currentUserRole === 'full' || e.addedBy === myName || e.addedBy === 'Ben';
                return `
                <div class="flex justify-between items-center p-3 bg-white border border-gray-100 rounded-xl mb-2 hover:bg-gray-50 transition-colors group">
                    <div><p class="font-bold text-gray-800 text-xs">${e.desc}</p><p class="text-[10px] text-gray-400">${e.date} • ${e.addedBy}</p></div>
                    <div class="flex items-center gap-3"><span class="font-black text-red-500 text-sm">-₺${Math.floor(e.amount).toLocaleString()}</span>${canEdit ? `<div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="editExpense(${idx})" class="text-blue-300 hover:text-blue-500"><i class="fas fa-pen"></i></button><button onclick="deleteExpense(${idx})" class="text-gray-200 hover:text-red-500"><i class="fas fa-trash-alt"></i></button></div>` : ''}</div>
                </div>`;
            }).join('');
        }

        // --- WIZARD ---
        function startWizard(isEditMode) {
            hideAll(); document.getElementById('wizardScreen').classList.remove('hidden');
            if(!isEditMode) { 
                // Set default values only if creating new plan
                state = JSON.parse(JSON.stringify(defaultState)); 
                state.registrationDate = new Date(); 
                state.incomes = [{ name: 'Maaş', val: null }];
                // Ensure defaults are set for new wizard
                state.bills = [
                    { name: 'Kira', val: null }, { name: 'Aidat', val: null }, { name: 'Elektrik', val: null },
                    { name: 'Su', val: null }, { name: 'Doğalgaz', val: null }, { name: 'İnternet', val: null },
                    { name: 'Telefon Faturaları', val: null }, { name: 'Dijital abonelikler', val: null }
                ];
                state.assets = [
                    { name: 'Bankadaki Para', val: null }, { name: 'Cepteki Para', val: null }, { name: 'Birikim Hesabı', val: null }
                ];
            }
            state.step = 1; renderWizard();
        }
        function wizardNext() { if (state.step === 8) { if(document.getElementById('wizRegEmail')) registerFromWizard(); else { saveState(); showDashboard(); } return; } state.step++; renderWizard(); }
        function wizardBack() { 
            if (state.step > 1) { 
                state.step--; 
                renderWizard(); 
            } else { 
                if(currentUser) {
                    showDashboard();
                } else {
                    showLoginScreen(); 
                }
            } 
        }
        
        function renderWizard() {
            const content = document.getElementById('wizardContent');
            document.getElementById('stepCount').innerText = `${state.step}/8`;
            document.getElementById('wizardProgress').innerHTML = Array(8).fill(0).map((_,i) => `<div class="h-1.5 flex-1 rounded-full ${i+1<=state.step?'bg-blue-600':'bg-gray-200'} transition-all"></div>`).join('');
            
            if(state.step === 8) {
                if(!currentUser) {
                    content.innerHTML = `<div class="text-center mb-6"><h3 class="text-2xl font-black">Planın Hazır!</h3></div><div class="space-y-4"><input type="text" id="wizRegName" class="w-full p-4 bg-gray-50 rounded-2xl border" placeholder="Kullanıcı Adı"><input type="email" id="wizRegEmail" class="w-full p-4 bg-gray-50 rounded-2xl border" placeholder="E-posta"><input type="password" id="wizRegPass" class="w-full p-4 bg-gray-50 rounded-2xl border" placeholder="Şifre"></div>`;
                    document.getElementById('wizNextBtn').innerText = "Kaydı Tamamla";
                } else {
                    content.innerHTML = `<div class="text-center py-10"><h3 class="text-2xl font-black text-gray-800">Tamamlandı</h3></div>`;
                    document.getElementById('wizNextBtn').innerText = "Planı Güncelle";
                }
            } else if(state.step === 7) {
                // PLANLAMA EKRANI (DÜZELTİLDİ)
                const totalInc = state.incomes.reduce((s, i) => s + (i.val||0), 0);
                const totalFix = state.bills.reduce((s, b) => s + (b.val||0), 0);
                const loanPayments = state.loans.filter(l => !l.excludeFromBudget).reduce((s, l) => s + (l.monthly || 0), 0);
                const netIncome = totalInc - totalFix - loanPayments;
                
                state.remainingAfterFixed = netIncome;
                if(!state.manualDailyLimit) state.manualDailyLimit = Math.max(0, netIncome / 30);
                
                content.innerHTML = `
                    <h3 class="text-2xl font-black mb-2">Bütçe Planı</h3>
                    <div class="text-center mb-6"><p class="text-gray-400 text-xs uppercase tracking-widest">Kalan Net Gelir</p><p class="text-3xl font-black text-blue-600">₺${Math.floor(netIncome).toLocaleString()}</p></div>
                    <div class="space-y-6">
                        <div class="p-4 bg-white border border-gray-200 rounded-[2rem] shadow-sm text-center">
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 block">Günlük Harcama Hedefi</label>
                            <input type="number" id="idealDailyLimitInput" oninput="updateFromDailyLimitInput(this.value)" class="w-32 text-center text-3xl font-black text-blue-600 border-b-2 outline-none pb-2" placeholder="0">
                        </div>
                        <div class="space-y-2"><div class="flex justify-between text-xs font-bold text-gray-500"><span>Birikim %</span><span>Harcama %</span></div><input type="range" id="allocationSlider" min="0" max="100" oninput="handleSliderChange(this.value)" class="w-full h-3 bg-gray-200 rounded-lg cursor-pointer"></div>
                        <div class="flex justify-between gap-4">
                            <div class="flex-1 text-center p-3 bg-green-50 rounded-2xl"><p class="text-[9px] font-bold text-green-400 block mb-1">AYLIK BİRİKİM</p><div class="relative"><span class="absolute left-2 top-1.5 text-green-700 font-bold">₺</span><input type="number" id="manualSavingsInput" oninput="updateFromSavingsInput(this.value)" class="w-full bg-transparent text-center font-black text-lg text-green-700 outline-none pl-4" placeholder="0"></div></div>
                            <div class="flex-1 text-center p-3 bg-blue-50 rounded-2xl"><p class="text-[9px] font-bold text-blue-400 block mb-1">AYLIK HARCAMA</p><div class="relative"><span class="absolute left-2 top-1.5 text-blue-700 font-bold">₺</span><input type="number" id="allocSpendingInput" oninput="updateFromSpendingInput(this.value)" class="w-full bg-transparent text-center font-black text-lg text-blue-700 outline-none pl-4" placeholder="0"></div></div>
                        </div>
                    </div>`;
                setTimeout(() => applyAllocationFromLimit(state.manualDailyLimit), 50);
                document.getElementById('wizNextBtn').innerText = "Devam Et";
            }
            else {
                // Diğer Adımlar (Liste)
                const titles = ["", "Gelirler", "Sabit Giderler", "Banka Kredileri", "Kredi Kartları", "Diğer Borçlar", "Varlıklar"];
                const colors = ["", "green", "red", "red", "purple", "red", "green"];
                const keys = ["", "incomes", "bills", "loans", "debts", "otherDebts", "assets"];
                const key = keys[state.step];
                content.innerHTML = `<h3 class="text-2xl font-black mb-6 text-${colors[state.step]}-600">${titles[state.step]}</h3><div id="wiz_${key}_list" class="custom-scrollbar overflow-y-auto max-h-[300px]"></div><button onclick="addItem('${key}', 'wiz_${key}_list')" class="w-full py-3 border-2 border-dashed border-${colors[state.step]}-200 rounded-2xl text-${colors[state.step]}-500 font-bold mt-4">+ Ekle</button>`;
                
                // Add Maaş Günü input only on first step
                 if (state.step === 1) {
                     content.innerHTML += `<div class="pt-4 mt-6 border-t"><p class="text-[10px] font-bold text-gray-400 uppercase mb-2">Maaş Günü</p><input type="number" id="wiz_salary_day_val" oninput="state.salaryDay=this.value" value="${state.salaryDay || 15}" class="w-20 p-3 bg-gray-50 rounded-xl font-black text-center text-xl" placeholder="15"></div>`;
                 }
            }
            renderWizardLists();
        }
        
        function renderWizardLists() {
             const listEl = (data, id, type) => { const el = document.getElementById(id); if(!el) return; el.innerHTML = data.map((item, idx) => `<div class="flex gap-2 mb-2 items-center"><input type="text" value="${item.name||''}" onchange="state.${type}[${idx}].name=this.value" class="flex-1 p-3 bg-white border border-gray-100 rounded-xl text-sm outline-none" placeholder="İsim"> <input type="number" value="${item.val||''}" onchange="state.${type}[${idx}].val=parseFloat(this.value)||0" class="w-24 p-3 bg-gray-50 border rounded-xl text-right text-sm" placeholder="0"><button onclick="removeItem('${type}', ${idx})" class="text-gray-300 hover:text-red-500 px-2"><i class="fas fa-trash"></i></button></div>`).join(''); };
             // --- ID DÜZELTMELERİ BURADA YAPILDI ---
             if(state.step===1) listEl(state.incomes, 'wiz_inc_list', 'incomes');
             if(state.step===2) listEl(state.bills, 'wiz_bills_list', 'bills');
             if(state.step===3) { const el = document.getElementById('wiz_loans_list'); if(el) el.innerHTML = state.loans.map((l, i) => `<div class="p-4 bg-white border rounded-2xl mb-3 space-y-3 relative"><button onclick="removeItem('loans', ${i})" class="absolute top-2 right-2 text-gray-300 hover:text-red-500"><i class="fas fa-times"></i></button><input type="text" value="${l.name}" onchange="state.loans[${i}].name=this.value" class="w-full border-b pb-1 font-black text-sm outline-none" placeholder="Kredi Adı"><div class="grid grid-cols-3 gap-2"><input type="number" value="${l.monthly||''}" oninput="updateLoanData(${i}, 'monthly', this.value)" class="p-2 bg-gray-50 rounded-lg text-xs" placeholder="Aylık"><input type="number" value="${l.totalMonths||''}" oninput="updateLoanData(${i}, 'totalMonths', this.value)" class="p-2 bg-gray-50 rounded-lg text-xs" placeholder="Vade"><input type="number" id="wiz_loan_t_${i}" value="${l.totalDebt||''}" oninput="updateLoanData(${i}, 'totalDebt', this.value)" class="p-2 bg-gray-50 rounded-lg text-xs" placeholder="Toplam"></div><div class="flex flex-col gap-1 pt-1 border-t border-gray-50 mt-2"><div class="flex items-center gap-2"><input type="checkbox" id="wiz_ex_${i}" ${l.excludeFromBudget ? 'checked' : ''} onchange="state.loans[${i}].excludeFromBudget=this.checked" class="w-3.5 h-3.5 rounded text-blue-600 focus:ring-blue-500"><label for="wiz_ex_${i}" class="text-[10px] font-bold text-gray-500 uppercase tracking-tighter">Aylık gidere dahil etme</label></div><div class="flex items-center gap-2"><input type="checkbox" id="wiz_ex_debt_${i}" ${l.excludeFromDebt ? 'checked' : ''} onchange="state.loans[${i}].excludeFromDebt=this.checked" class="w-3.5 h-3.5 rounded text-blue-600 focus:ring-blue-500"><label for="wiz_ex_debt_${i}" class="text-[10px] font-bold text-gray-500 uppercase tracking-tighter">Genel borca dahil etme</label></div></div></div>`).join(''); }
             if(state.step===4) { const el = document.getElementById('wiz_debts_list'); if(el) el.innerHTML = state.debts.map((d, i) => `<div class="p-4 bg-white border rounded-2xl mb-3 space-y-3 text-left relative"><button onclick="removeItem('debts', ${i})" class="absolute top-2 right-2 text-gray-300 hover:text-red-500"><i class="fas fa-times"></i></button><div class="flex justify-between items-center pr-6"><input type="text" value="${d.name}" onchange="state.debts[${i}].name=this.value" class="font-black text-sm outline-none flex-1" placeholder="Kart Adı"><button onclick="toggleCardMode(${i})" class="text-[9px] font-black text-blue-500 bg-blue-50 px-2 py-1 rounded-lg">Mod: ${d.calcMode?'Limit':'Manuel'}</button></div>${d.calcMode ? `<div class="grid grid-cols-3 gap-2"><input type="number" value="${d.limit||''}" oninput="calcCard(${i}, 'limit', this.value)" class="p-2 bg-gray-50 rounded-xl text-xs" placeholder="Limit"><input type="number" value="${d.avail||''}" oninput="calcCard(${i}, 'avail', this.value)" class="p-2 bg-gray-50 rounded-xl text-xs" placeholder="Kullanılabilir"><div id="wiz_card_res_${i}" class="p-2 bg-purple-50 text-purple-700 font-black text-xs rounded-xl">${d.val||0}</div></div>` : `<input type="number" value="${d.val||''}" onchange="state.debts[${i}].val=parseFloat(this.value)||0" class="w-full p-2 bg-gray-50 rounded-xl text-right text-sm" placeholder="Borç">`}</div>`).join(''); }
             if(state.step===5) listEl(state.otherDebts, 'wiz_otherDebts_list', 'otherDebts');
             if(state.step===6) listEl(state.assets, 'wiz_assets_list', 'assets');
        }

        // --- MATH HELPERS ---
        function updateFromDailyLimitInput(v) { state.manualDailyLimit = parseFloat(v)||0; applyAllocationFromLimit(state.manualDailyLimit); }
        function handleSliderChange(v) { 
            const save = (state.remainingAfterFixed * v) / 100; 
            const spend = state.remainingAfterFixed - save; 
            const daily = spend / 30;
            document.getElementById('idealDailyLimitInput').value = Math.floor(daily); 
            updateFromDailyLimitInput(daily); 
        }
        function applyAllocationFromLimit(daily) { 
            const spend = daily * 30; 
            const save = state.remainingAfterFixed - spend; 
            document.getElementById('manualSavingsInput').value = Math.floor(save); 
            document.getElementById('allocSpendingInput').value = Math.floor(spend); 
            if(state.remainingAfterFixed > 0) document.getElementById('allocationSlider').value = (save / state.remainingAfterFixed) * 100;
            state.calculatedMonthlyPool = spend; 
            state.calculatedMonthlySavings = save; 
        }

        function updateFromSavingsInput(v) {
            const save = parseFloat(v) || 0;
            const spend = state.remainingAfterFixed - save;
            const daily = spend / 30;
            document.getElementById('idealDailyLimitInput').value = Math.floor(daily);
            document.getElementById('allocSpendingInput').value = Math.floor(spend);
            if(state.remainingAfterFixed > 0) document.getElementById('allocationSlider').value = (save / state.remainingAfterFixed) * 100;
            state.calculatedMonthlyPool = spend; state.calculatedMonthlySavings = save; state.manualDailyLimit = daily;
        }

        function updateFromSpendingInput(v) {
            const spend = parseFloat(v) || 0;
            const save = state.remainingAfterFixed - spend;
            const daily = spend / 30;
            document.getElementById('idealDailyLimitInput').value = Math.floor(daily);
            document.getElementById('manualSavingsInput').value = Math.floor(save);
            if(state.remainingAfterFixed > 0) document.getElementById('allocationSlider').value = (save / state.remainingAfterFixed) * 100;
            state.calculatedMonthlyPool = spend; state.calculatedMonthlySavings = save; state.manualDailyLimit = daily;
        }
        
        function addItem(key, id) { 
            const item = {name:'',val:0}; 
            if(key==='loans') Object.assign(item, {name:'Kredi',totalDebt:0,totalMonths:12,monthly:0}); 
            else if(key==='debts') Object.assign(item, {name:'Kart',val:0,calcMode:false}); // Manual mode default
            state[key].push(item); 
            renderWizardLists(); 
            
            // Auto Scroll
            setTimeout(() => {
                const container = document.getElementById(id);
                if(container && container.lastElementChild) {
                    container.lastElementChild.scrollIntoView({ behavior: 'smooth' });
                    const input = container.lastElementChild.querySelector('input');
                    if(input) input.focus();
                }
            }, 100);
        }
        // ... (Kalan helper fonksiyonlar, modal vb.) ...
        function removeItem(key, i) { state[key].splice(i, 1); renderWizardLists(); }
        function updateLoanData(i, f, v) { state.loans[i][f] = parseFloat(v)||0; const l = state.loans[i]; if(f==='monthly' && l.totalMonths>0) l.totalDebt = l.monthly*l.totalMonths; else if(f==='totalMonths' && l.monthly>0) l.totalDebt = l.monthly*l.totalMonths; else if(f==='totalDebt' && l.totalMonths>0) l.monthly = l.totalDebt/l.totalMonths; document.getElementById(`wiz_loan_t_${i}`).value = Math.ceil(l.totalDebt); }
        function calcCard(i, f, v) { state.debts[i][f] = parseFloat(v)||0; state.debts[i].val = Math.max(0, (state.debts[i].limit||0)-(state.debts[i].avail||0)); document.getElementById(`wiz_card_res_${i}`).innerText = state.debts[i].val; }
        function toggleCardMode(i) { state.debts[i].calcMode = !state.debts[i].calcMode; renderWizardLists(); }
        function openEditModal(type, index) { const item = state[type][index]; document.getElementById('editItemName').value = item.name; document.getElementById('editItemVal').value = item.val || item.totalDebt || 0; document.getElementById('editItemType').value = type; document.getElementById('editItemIndex').value = index; document.getElementById('editItemModal').classList.remove('hidden'); document.getElementById('overlay').classList.add('active'); }
        function saveEditedItem() { const type = document.getElementById('editItemType').value; const idx = parseInt(document.getElementById('editItemIndex').value); const name = document.getElementById('editItemName').value; const val = parseFloat(document.getElementById('editItemVal').value); if(state[type][idx]) { state[type][idx].name = name; if(type === 'loans') state[type][idx].totalDebt = val; else state[type][idx].val = val; saveToCloud(); updateDashboardUI(); closeEditModal(); } }
        function closeEditModal() { document.getElementById('editItemModal').classList.add('hidden'); document.getElementById('overlay').classList.remove('active'); }
        function deleteHealthItem(type, idx) { if(confirm('Sil?')) { state[type].splice(idx, 1); saveToCloud(); updateDashboardUI(); } }
        function renderDetailedHealthLists() { const createRow = (name, amount, type, idx, extraClass='') => `<div class="flex justify-between items-center p-3 rounded-xl text-xs font-bold text-gray-600 bg-gray-50 border border-gray-100 shadow-sm group ${extraClass}"><span>${name}</span><div class="flex items-center gap-3"><span class="font-black text-gray-800">₺${Math.floor(amount).toLocaleString()}</span><div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="openEditModal('${type}', ${idx})" class="text-blue-400 hover:text-blue-600"><i class="fas fa-pen"></i></button>${idx !== 'total' ? `<button onclick="deleteHealthItem('${type}', ${idx})" class="text-red-300 hover:text-red-500"><i class="fas fa-trash"></i></button>` : ''}</div></div></div>`; let debtHTML = ''; state.loans.forEach((l, i) => debtHTML += createRow(l.name, l.totalDebt, 'loans', i)); state.otherDebts.forEach((d, i) => debtHTML += createRow(d.name, d.val, 'otherDebts', i)); const totalCardDebt = state.debts.reduce((s,d)=>s+(d.val||0),0); if(totalCardDebt > 0 || state.debts.length > 0) { debtHTML += `<div class="border border-purple-100 rounded-xl overflow-hidden bg-purple-50/30"><div onclick="document.getElementById('cardDetails').classList.toggle('open');" class="flex justify-between items-center p-3 cursor-pointer"><div class="flex items-center gap-2"><i class="fas fa-chevron-down text-purple-400"></i> <span class="text-xs font-bold text-purple-800">Toplam Kredi Kartı</span></div><span class="font-black text-purple-900 text-sm">₺${totalCardDebt.toLocaleString()}</span></div><div id="cardDetails" class="health-detail space-y-1 px-2 pb-2">${state.debts.map((d, i) => createRow(d.name, d.val, 'debts', i, 'bg-white')).join('')}<button onclick="addNewHealthItem('debts')" class="w-full py-2 text-[10px] font-bold text-purple-400 hover:text-purple-600">+ Kart Ekle</button></div></div>`; } debtHTML += `<button onclick="addNewHealthItem('otherDebts')" class="w-full py-2 text-[10px] font-bold text-gray-400 hover:text-gray-600 border border-dashed rounded-lg">+ Borç/Kredi Ekle</button>`; document.getElementById('detailedDebtsList').innerHTML = debtHTML || '<span class="text-gray-300 text-xs">Borç yok</span>'; let assetHTML = state.assets.map((a, i) => createRow(a.name, a.val, 'assets', i)).join(''); assetHTML += `<button onclick="addNewHealthItem('assets')" class="w-full py-2 text-[10px] font-bold text-gray-400 hover:text-gray-600 border border-dashed rounded-lg">+ Varlık Ekle</button>`; document.getElementById('detailedAssetsList').innerHTML = assetHTML; }
        function addNewHealthItem(type) { const name = prompt("Yeni Kalem Adı:"); if(name) { const val = parseFloat(prompt("Tutar:")) || 0; const newItem = type==='loans' ? {name, totalDebt:val, monthly:0, totalMonths:1} : {name, val:val}; state[type].push(newItem); saveToCloud(); updateDashboardUI(); } }
        function openCalcModal() { const totalInc = state.incomes.reduce((s, i) => s + (i.val||0), 0); const totalFix = state.bills.reduce((s, b) => s + (b.val||0), 0); const loanPayments = state.loans.filter(l => !l.excludeFromBudget).reduce((s, l) => s + (l.monthly || 0), 0); document.getElementById('calcModalContent').innerHTML = `<div class="flex justify-between font-bold text-green-600 bg-green-50 p-2 rounded-lg"><span>Gelirler:</span><span>+ ₺${totalInc.toLocaleString(undefined, {maximumFractionDigits:0})}</span></div><div class="flex justify-between text-red-500 text-xs px-2"><span>Sabit Giderler:</span><span>- ₺${totalFix.toLocaleString(undefined, {maximumFractionDigits:0})}</span></div><div class="flex justify-between text-red-500 text-xs px-2"><span>Dahil Edilen Krediler:</span><span>- ₺${loanPayments.toLocaleString(undefined, {maximumFractionDigits:0})}</span></div><div class="border-t pt-4 font-black text-blue-600 text-2xl mt-2">KALAN NET: ₺${(state.remainingAfterFixed||0).toLocaleString(undefined, {maximumFractionDigits:0})}</div><p class="text-[10px] text-gray-400 mt-2">Bu tutar üzerinden birikim ve harcama limitiniz belirlenir.</p>`; document.getElementById('calcModal').classList.remove('hidden'); document.getElementById('overlay').classList.add('active'); }
        function closeCalcModal() { document.getElementById('calcModal').classList.add('hidden'); document.getElementById('overlay').classList.remove('active'); }
    </script>
</body>
</html>
