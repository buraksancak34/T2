<!DOCTYPE html>
<html lang="tr" class="overflow-x-hidden">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Birikim KoÃ§um | Gelir-Gider Takip</title>
    
    <!-- Temel Web App AyarlarÄ± -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2563eb">
    <meta name="application-name" content="Birikim KoÃ§um">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- FIREBASE SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        
        :root { font-size: 14px; }
        @media (max-width: 768px) { :root { font-size: 12px; } }

        html, body {
            overflow-x: hidden;
            width: 100%;
            position: relative;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc; 
            color: #1e293b;
            -webkit-tap-highlight-color: transparent;
            user-select: none; -webkit-user-select: none;
            padding-bottom: 80px; 
        }
        
        input, textarea { user-select: text; -webkit-user-select: text; }

        .glass-card { background: rgba(255, 255, 255, 0.95); border: 1px solid rgba(255,255,255,0.6); box-shadow: 0 10px 30px -10px rgba(0,0,0,0.1); backdrop-filter: blur(10px); }
        .hidden { display: none !important; }
        input[type="range"] { accent-color: #2563eb; }
        .overlay { background: rgba(0,0,0,0.6); opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .overlay.active { opacity: 1; pointer-events: auto; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .health-detail { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .health-detail.open { max-height: 1000px; transition: max-height 0.5s ease-in; }
        
        .fade-text { animation: textFade 0.5s ease-in-out; }
        @keyframes textFade { 0% { opacity: 0; } 100% { opacity: 1; } }

        @keyframes pulse-red { 0%, 100% { color: #ef4444; text-shadow: 0 0 5px rgba(239, 68, 68, 0.2); } 50% { color: #fca5a5; text-shadow: 0 0 15px rgba(239, 68, 68, 0.6); } }
        @keyframes pulse-green { 0%, 100% { color: #22c55e; text-shadow: 0 0 5px rgba(34, 197, 94, 0.2); } 50% { color: #86efac; text-shadow: 0 0 15px rgba(34, 197, 94, 0.6); } }
        .animate-pulse-red { animation: pulse-red 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .animate-pulse-green { animation: pulse-green 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }

        @keyframes softPulse { 0% { background-color: #f9fafb; border-color: #e5e7eb; } 50% { background-color: #eff6ff; border-color: #bfdbfe; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); } 100% { background-color: #f9fafb; border-color: #e5e7eb; } }
        .animate-soft-pulse { animation: softPulse 3s infinite ease-in-out; }

        .side-panel { position: fixed; top: 0; right: 0; height: 100%; width: 100%; max-width: 28rem; background: white; z-index: 60; box-shadow: -10px 0 30px rgba(0,0,0,0.1); transform: translateX(100%); visibility: hidden; transition: transform 0.3s ease-in-out, visibility 0s linear 0.3s; display: flex; flex-direction: column; }
        .side-panel.open { transform: translateX(0); visibility: visible; transition: transform 0.3s ease-in-out, visibility 0s linear 0s; }

        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-top: 1px solid #e2e8f0; display: flex; justify-content: space-around; align-items: center; z-index: 50; padding-bottom: env(safe-area-inset-bottom); box-shadow: 0 -5px 20px rgba(0,0,0,0.05); }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #64748b; font-size: 0.7rem; font-weight: 700; gap: 4px; padding: 5px; width: 20%; cursor: pointer;}
        .nav-item i { font-size: 1.3rem; margin-bottom: 2px; }
        .nav-center-btn { background: #2563eb; color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-top: -30px; border: 4px solid #f8fafc; box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3); }
        .nav-center-btn i { font-size: 1.5rem; margin: 0; }

        .gradient-text-family { background: linear-gradient(to right, #f97316, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .gradient-text-analysis { background: linear-gradient(to right, #3b82f6, #8b5cf6, #6366f1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .gradient-text-plan { background: linear-gradient(to right, #22c55e, #14b8a6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    </style>
</head>
<body class="min-h-screen p-2 flex flex-col items-center justify-center bg-slate-50">

    <div id="overlay" class="overlay fixed inset-0 z-40" onclick="closeAllPopups()"></div>
    
    <div id="saveIndicator" class="fixed bottom-20 right-4 bg-white px-4 py-2 rounded-full shadow-lg border border-gray-100 flex items-center gap-2 text-xs font-bold text-gray-500 opacity-0 transition-opacity duration-500 pointer-events-none z-50">
        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div> Kaydedildi
    </div>

    <!-- Ã–ZEL ONAY KUTUSU -->
    <div id="customConfirmModal" class="fixed inset-0 z-[70] hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeCustomConfirm()"></div>
        <div class="bg-white rounded-3xl p-6 w-[85%] max-w-sm relative z-10 shadow-2xl animate-fade-in text-center border-2 border-white">
            <div class="w-14 h-14 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-inner"><i class="fas fa-exclamation-triangle text-2xl"></i></div>
            <h3 class="text-xl font-black text-gray-800 mb-2 tracking-tight">Emin misiniz?</h3>
            <p id="customConfirmMsg" class="text-xs text-gray-500 font-bold mb-6 leading-relaxed">Bu iÅŸlem geri alÄ±namaz.</p>
            <div class="flex gap-3">
                <button onclick="closeCustomConfirm()" class="flex-1 py-3 bg-gray-100 text-gray-600 font-black rounded-xl text-xs hover:bg-gray-200 transition-colors">VazgeÃ§</button>
                <button id="customConfirmBtn" class="flex-1 py-3 bg-red-500 text-white font-black rounded-xl text-xs hover:bg-red-600 shadow-lg shadow-red-200 transition-colors">Evet</button>
            </div>
        </div>
    </div>

    <!-- APP UYARI MODALI -->
    <div id="appAlertModal" class="fixed inset-0 z-[80] hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeAppAlert()"></div>
        <div class="bg-white rounded-3xl p-6 w-[85%] max-w-sm relative z-10 shadow-2xl animate-fade-in text-center border-2 border-white">
            <div class="w-12 h-12 bg-blue-100 text-blue-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-inner"><i class="fas fa-info text-xl"></i></div>
            <h3 class="text-lg font-black text-gray-800 mb-2 tracking-tight">Bilgi</h3>
            <p id="appAlertMsg" class="text-xs text-gray-500 font-bold mb-6 leading-relaxed">...</p>
            <button onclick="closeAppAlert()" class="w-full py-3 bg-blue-600 text-white font-black rounded-xl text-xs hover:bg-blue-700 shadow-lg shadow-blue-200 transition-colors">Tamam</button>
        </div>
    </div>
    
    <!-- HESAP SÄ°LME PAROLA MODALI -->
    <div id="deleteAccountModal" class="fixed inset-0 z-[80] hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeDeleteAccountModal()"></div>
        <div class="bg-white rounded-3xl p-6 w-[85%] max-w-sm relative z-10 shadow-2xl animate-fade-in text-center border-2 border-red-100">
            <div class="w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-inner"><i class="fas fa-exclamation-triangle text-xl"></i></div>
            <h3 class="text-lg font-black text-gray-800 mb-2 tracking-tight">GÃ¼venlik OnayÄ±</h3>
            <p class="text-xs text-gray-500 font-bold mb-4 leading-relaxed">TÃ¼m verilerinizi silmek iÃ§in lÃ¼tfen parolanÄ±zÄ± girin.</p>
            <input type="password" id="deleteAccountPassword" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-4 focus:ring-red-100 outline-none font-bold text-gray-700 transition-all text-xs mb-4" placeholder="ParolanÄ±z">
            <div class="flex gap-2">
                <button onclick="closeDeleteAccountModal()" class="flex-1 py-3 bg-gray-100 text-gray-600 font-black rounded-xl text-xs hover:bg-gray-200 transition-colors">Ä°ptal</button>
                <button onclick="confirmDeleteAccount()" id="confirmDeleteBtn" class="flex-1 py-3 bg-red-600 text-white font-black rounded-xl text-xs hover:bg-red-700 shadow-lg shadow-red-200 transition-colors">KalÄ±cÄ± Olarak Sil</button>
            </div>
        </div>
    </div>

    <!-- Ã–ZEL GÃœN MODALI -->
    <div id="specialDayModal" class="fixed inset-0 z-[90] hidden flex items-center justify-center">
        <canvas id="confettiCanvas" class="absolute inset-0 pointer-events-none z-0"></canvas>
        <div class="absolute inset-0 bg-gradient-to-br from-red-600/90 to-red-900/95 backdrop-blur-md"></div>
        <div class="relative z-10 w-full max-w-md p-8 text-center text-white animate-fade-in">
             <div class="mb-6 animate-bounce"><i class="fas fa-star text-5xl text-yellow-300 drop-shadow-lg"></i></div>
             <h2 id="specialDayTitle" class="text-3xl font-black mb-4 drop-shadow-md tracking-tight leading-tight">...</h2>
             <p id="specialDayMsg" class="text-base font-bold text-red-50 mb-8 leading-relaxed opacity-90">...</p>
             <button onclick="closeSpecialDayModal()" class="bg-white text-red-600 font-black py-4 px-10 rounded-full shadow-2xl hover:bg-gray-100 transition-transform active:scale-95 text-sm uppercase tracking-widest">Harika!</button>
        </div>
    </div>

    <!-- 1. GÄ°RÄ°Åž EKRANI -->
    <div id="loginScreen" class="max-w-md w-full glass-card p-6 rounded-[2rem] shadow-2xl space-y-6 my-auto relative overflow-hidden animate-fade-in">
        <div class="text-center">
            <div class="mx-auto mb-6 w-full max-w-[150px] h-auto hover:scale-105 transition-transform duration-300">
                <img src="logo.png" alt="Birikim KoÃ§um Logo" class="w-full h-full object-contain drop-shadow-xl" onerror="this.src='https://cdn-icons-png.flaticon.com/512/2382/2382461.png'; this.parentElement.classList.add('opacity-80');">
            </div>
            <h1 class="text-2xl font-black text-gray-900 tracking-tight mb-1" id="loginTitle">Birikim KoÃ§um</h1>
            <p class="text-blue-500 text-[10px] font-bold uppercase tracking-widest" id="loginSubtitle">Gelir - Gider Takip AsistanÄ±</p>
        </div>
        
        <div class="space-y-3 mt-6" id="authFormContainer">
            <div id="registerFields" class="hidden space-y-3">
                <input type="text" id="regUsernameInput" class="w-full p-3 bg-white border border-gray-200 rounded-xl focus:ring-4 focus:ring-blue-100 outline-none font-bold text-gray-700 transition-all text-xs" placeholder="KullanÄ±cÄ± AdÄ± Belirle (Zorunlu)">
                <input type="text" id="regInviteCode" class="w-full p-3 bg-white border border-gray-200 rounded-xl focus:ring-4 focus:ring-blue-100 outline-none font-bold text-gray-700 transition-all text-xs" placeholder="Davet Kodu (Varsa)">
                <input type="number" id="regDailyLimit" class="w-full p-3 bg-blue-50 border border-blue-200 rounded-xl focus:ring-4 focus:ring-blue-100 outline-none font-black text-blue-700 transition-all text-xs hidden placeholder-blue-400" placeholder="GÃ¼nlÃ¼k Harcama Hedefiniz (TL)">
            </div>
            <input type="text" id="emailInput" class="w-full p-3 bg-white border border-gray-200 rounded-xl focus:ring-4 focus:ring-blue-100 outline-none font-bold text-gray-700 transition-all text-xs" placeholder="E-posta">
            <input type="password" id="passwordInput" class="w-full p-3 bg-white border border-gray-200 rounded-xl focus:ring-4 focus:ring-blue-100 outline-none font-bold text-gray-700 transition-all text-xs" placeholder="Åžifre">
            
            <button id="loginBtn" onclick="firebaseLogin()" class="w-full bg-blue-600 text-white font-black py-3 rounded-xl shadow-xl shadow-blue-200 active:scale-95 transition-all hover:bg-blue-700 flex justify-center items-center gap-2 text-sm"><span>GiriÅŸ Yap</span></button>
            <button id="registerBtn" onclick="firebaseRegister()" class="w-full bg-indigo-600 text-white font-black py-3 rounded-xl shadow-xl hidden active:scale-95 transition-all hover:bg-indigo-700 flex justify-center items-center gap-2 text-sm"><span>Ãœye Ol ve KatÄ±l</span></button>
            
            <p id="forgotPassText" class="text-center text-[10px] font-bold text-blue-400 cursor-pointer hover:text-blue-600 pt-2" onclick="forgotPassword()">Åžifremi Unuttum?</p>
            <p id="backToLoginText" class="text-center text-[10px] font-bold text-gray-400 cursor-pointer hover:text-blue-500 hidden pt-2" onclick="showLoginMode()"><i class="fas fa-arrow-left mr-1"></i> GiriÅŸ ekranÄ±na dÃ¶n</p>
        </div>
        
        <div class="relative py-3">
            <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-200"></div></div>
            <div class="relative flex justify-center"><span class="bg-white px-4 text-[10px] font-bold text-gray-400 uppercase">veya</span></div>
        </div>

        <div class="space-y-3" id="actionButtons">
            <button onclick="startWizard(false)" class="w-full bg-green-500 text-white font-black py-3 rounded-xl shadow-lg shadow-green-100 active:scale-95 transition-all hover:bg-green-600 flex items-center justify-center gap-2 text-sm"><i class="fas fa-magic"></i> <span>Plana BaÅŸla</span></button>
            <button onclick="showQuickRegisterMode()" class="w-full bg-slate-800 text-white font-bold py-3 px-4 rounded-xl active:scale-95 transition-all hover:bg-slate-900 shadow-md flex items-center justify-center gap-3 text-[10px] leading-tight"><i class="fas fa-bolt text-yellow-400 text-base"></i> <span class="text-left">Veri girmek istemiyorum,<br>sadece gÃ¼nlÃ¼k harcama hesaplayacaÄŸÄ±m</span></button>
            <p class="text-[9px] text-center text-gray-400 px-4 mt-2">BÃ¼tÃ§eni oluÅŸturmaya baÅŸla, en son adÄ±mda kaydedip Ã¼ye ol.</p>
            <button onclick="showRegisterMode()" class="w-full bg-white border-2 border-gray-100 text-gray-600 font-bold py-2 rounded-xl active:scale-95 transition-all hover:border-indigo-200 hover:text-indigo-600 mt-2 text-xs">Bir Plana Dahil Ol</button>
        </div>

        <div class="mt-6 text-center pt-3 border-t border-gray-100">
            <button onclick="openContactModal()" class="text-[10px] font-bold text-gray-400 hover:text-blue-500 transition-colors"><i class="fas fa-envelope mr-1"></i> Bize UlaÅŸÄ±n</button>
        </div>
    </div>

    <!-- 2. SÄ°HÄ°RBAZ (WIZARD) -->
    <div id="wizardScreen" class="max-w-xl w-full glass-card p-6 rounded-[2rem] shadow-2xl hidden space-y-4 my-auto relative animate-fade-in">
        <div class="flex justify-between items-center mb-2">
            <div id="wizardProgress" class="flex gap-1 flex-1 mr-4"></div>
            <span class="text-[10px] font-bold text-gray-300" id="stepCount">1/8</span>
        </div>
        <div id="wizardContent" class="min-h-[350px] flex flex-col relative"></div>
        <div class="flex gap-3 mt-4" id="wizardNavBtns">
             <button onclick="wizardBack()" class="flex-1 bg-gray-100 text-gray-600 font-bold py-3 rounded-xl hover:bg-gray-200 transition-all text-xs">Geri</button>
             <button onclick="wizardNext()" id="wizNextBtn" class="flex-[2] bg-blue-600 text-white font-black py-3 rounded-xl shadow-xl active:scale-95 transition-all hover:bg-blue-700 text-xs">Devam Et</button>
        </div>
    </div>

    <!-- 3. DASHBOARD -->
    <div id="dashboardScreen" class="max-w-4xl w-full hidden space-y-4 pb-20 animate-fade-in">
        
        <div id="motivationArea" class="hidden w-full p-3 rounded-2xl bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 text-white shadow-lg animate-fade-in">
            <div class="flex items-start gap-3">
                <div class="text-xl mt-1">ðŸ¤–</div>
                <div>
                    <p class="text-[9px] font-bold uppercase tracking-widest opacity-80 mb-1">Durum Raporu</p>
                    <p class="font-black text-xs md:text-sm leading-tight" id="motivationText">...</p>
                </div>
            </div>
        </div>

        <div id="inviteBanner" class="hidden bg-indigo-600 text-white p-3 rounded-2xl shadow-lg flex flex-col sm:flex-row justify-between items-center gap-3">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center"><i class="fas fa-envelope-open-text text-sm"></i></div>
                <div>
                    <p class="text-[9px] text-indigo-200 font-bold uppercase tracking-widest">Yeni Plan Daveti</p>
                    <p class="font-black text-xs" id="inviteBannerText">Sizi planÄ±na davet ediyor.</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="rejectInvite()" class="px-3 py-1 bg-white/10 hover:bg-white/20 rounded-lg text-[10px] font-bold transition-colors">Reddet</button>
                <button onclick="acceptInvite()" class="px-3 py-1 bg-white text-indigo-600 hover:bg-indigo-50 rounded-lg text-[10px] font-black transition-colors shadow-sm">Kabul Et</button>
            </div>
        </div>

        <div id="adminModeBanner" class="hidden bg-red-600 text-white p-3 rounded-xl shadow-lg mb-4 flex justify-between items-center animate-fade-in">
             <div class="flex items-center gap-2">
                 <i class="fas fa-user-secret text-lg"></i>
                 <div>
                     <p class="text-[9px] font-bold uppercase opacity-80">Admin Modu</p>
                     <p class="text-[10px] font-bold">Ä°ncelenen: <span id="adminInspectName" class="font-black underline">...</span></p>
                 </div>
             </div>
             <button onclick="exitAdminInspect()" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded-lg text-[10px] font-bold transition-colors">Ã‡Ä±kÄ±ÅŸ</button>
        </div>

        <div class="flex justify-between items-center">
            <div>
                <h2 class="text-xl font-black text-gray-800 tracking-tight" id="dashWelcome">Panelim</h2>
                <div class="flex items-center gap-2">
                    <span id="roleBadge" class="text-[9px] font-black bg-blue-100 text-blue-600 px-2 py-0.5 rounded uppercase tracking-wide">YÃ¶netici</span>
                </div>
            </div>
            <div class="flex gap-2 hidden md:flex"> 
                <button onclick="openAdminPanel()" id="btnAdmin" class="hidden text-[10px] font-black bg-red-500 text-white border border-red-600 px-4 py-2 rounded-full uppercase tracking-widest shadow-sm hover:bg-red-600"><i class="fas fa-shield-alt"></i> Admin</button>
                <button onclick="showAnalysisScreen()" id="btnAnalysis" class="text-[10px] font-black bg-white text-indigo-500 border border-indigo-200 px-4 py-2 rounded-full uppercase tracking-widest shadow-sm hover:bg-indigo-50"><i class="fas fa-chart-pie"></i></button>
                <button onclick="openSettingsPanel()" class="text-[10px] font-black bg-white text-gray-500 border border-gray-200 px-4 py-2 rounded-full uppercase tracking-widest shadow-sm hover:bg-gray-50"><i class="fas fa-cog"></i></button>
                <button onclick="handleLogout()" class="text-[10px] font-black bg-white text-red-500 border border-red-50 px-4 py-2 rounded-full uppercase tracking-widest shadow-sm hover:bg-red-50">Ã‡Ä±kÄ±ÅŸ</button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="md:col-span-3 glass-card p-5 rounded-[2.5rem] bg-gradient-to-br from-slate-800 to-slate-900 text-white shadow-2xl relative overflow-hidden group">
                <div class="absolute top-0 right-0 w-64 h-64 bg-blue-500 rounded-full mix-blend-overlay filter blur-3xl opacity-20 -mr-16 -mt-16"></div>
                <div class="relative z-10">
                    <!-- Top Row -->
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4 border-b border-white/10 pb-5">
                        <div class="cursor-pointer group" onclick="openBalanceModal()">
                            <div class="flex items-center gap-2 mb-1">
                                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest opacity-80 group-hover:text-white transition-colors">GerÃ§ek Bakiye</p>
                            </div>
                            <h2 id="displayCumulativeLimit" class="text-5xl md:text-6xl font-black tracking-tighter leading-none group-hover:scale-105 transform origin-left transition-transform duration-300">â‚º0</h2>
                        </div>
                        
                        <div class="flex flex-col gap-2 items-end">
                            <div class="flex gap-1 bg-white/5 p-1 rounded-lg border border-white/10">
                                <button onclick="setBalanceMethod('salary')" id="btnCalcSalary" class="text-[7px] font-medium px-2 py-1 rounded-md text-slate-300 transition-all hover:bg-white/10">Gelir GÃ¼nÃ¼</button>
                                <button onclick="setBalanceMethod('register')" id="btnCalcRegister" class="text-[7px] font-medium px-2 py-1 rounded-md text-slate-300 transition-all hover:bg-white/10">KayÄ±t GÃ¼nÃ¼</button>
                            </div>
                            <label class="relative overflow-hidden inline-flex cursor-pointer items-center" onclick="try{document.getElementById('customBalanceDate').showPicker()}catch(e){}">
                                <input type="date" id="customBalanceDate" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20" onchange="setCustomBalanceDate(this.value)">
                                <button id="btnCalcCustom" class="text-[7px] font-medium px-2 py-1 rounded-lg bg-white/5 hover:bg-white/10 text-slate-300 transition-all border border-white/10 pointer-events-none flex items-center gap-1 w-full justify-center">
                                    Åžu tarihten itibaren: <span id="customDateDisplay" class="font-bold text-white">SeÃ§</span>
                                </button>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Middle Row Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                        <div class="bg-slate-800/50 p-4 rounded-2xl border border-slate-700 cursor-pointer hover:bg-slate-800 transition-colors group" onclick="openCalcModal()">
                            <p class="text-blue-400 text-[9px] font-bold uppercase tracking-widest opacity-80 mb-2 group-hover:text-blue-300 transition-colors">BugÃ¼nÃ¼n Limiti</p>
                            <div class="flex justify-between items-end">
                                <h4 id="displayDailyLimit" class="text-3xl font-black text-white tracking-tight">â‚º0</h4>
                                <span class="text-slate-500 text-[10px] group-hover:text-blue-400 transition-colors"><i class="fas fa-info-circle"></i></span>
                            </div>
                        </div>
                        
                        <div class="bg-blue-600/10 p-4 rounded-2xl border border-blue-500/20 cursor-pointer hover:bg-blue-600/20 transition-colors group" onclick="openRecoveryPlanModal()">
                            <p class="text-blue-200 text-[9px] font-bold uppercase tracking-widest opacity-90 mb-2 group-hover:text-white transition-colors">Hedefi Tutturmak Ä°Ã§in Gereken GÃ¼nlÃ¼k Ortalama Harcama</p>
                            <div class="flex justify-between items-end">
                                <h4 id="displayRequiredDaily" class="text-3xl font-black text-blue-400 tracking-tight">â‚º0</h4>
                                <span class="text-blue-500/50 text-[10px] group-hover:text-blue-300 transition-colors"><i class="fas fa-calculator"></i></span>
                            </div>
                        </div>
                    </div>

                    <!-- Bottom Row -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-white/5 px-4 py-3 rounded-2xl border border-white/5 text-center">
                            <span class="text-[8px] text-slate-400 font-bold uppercase tracking-widest block mb-1">MaaÅŸa Kalan</span>
                            <span id="displayRemainingDays" class="text-lg font-black text-white">-- GÃ¼n</span>
                        </div>
                         <div class="bg-white/5 px-4 py-3 rounded-2xl border border-white/5 text-center">
                            <span class="text-[8px] text-slate-400 font-bold uppercase tracking-widest block mb-1">Hedef Birikim</span>
                            <span id="sumSavings" class="text-lg font-black text-green-400">â‚º0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="addExpenseSection" class="glass-card p-5 rounded-[2rem] bg-white border border-gray-100 shadow-lg">
            <div class="flex items-center justify-between mb-3">
                <h3 class="font-black text-lg text-gray-800">Harcama Ekle</h3>
                <span id="todayTotal" class="text-[9px] font-bold text-gray-400 bg-gray-50 px-2 py-1 rounded-md uppercase tracking-wide">BugÃ¼n: â‚º0</span>
            </div>

            <!-- TARÄ°H SEÃ‡Ä°CÄ° (ORTALANMIÅž VE DETAYLI) -->
            <div class="flex justify-center mb-2">
                <div class="flex items-center gap-3 bg-red-50 p-2 rounded-2xl border border-red-100 shadow-sm w-full max-w-[250px]">
                    <button onclick="changeExpenseDate(1)" class="w-8 h-8 shrink-0 flex items-center justify-center bg-white rounded-xl text-red-400 hover:text-red-600 shadow-sm transition-transform active:scale-95 border border-red-50"><i class="fas fa-chevron-left text-sm"></i></button>
                    <div class="relative text-center flex-1">
                        <div id="expenseDateLabel" class="cursor-pointer hover:text-red-800 select-none flex flex-col items-center justify-center" onclick="document.getElementById('expDateInputHidden').showPicker()">
                            <span class="text-[12px] font-black text-red-600 block leading-tight">BugÃ¼n</span>
                            <span class="text-[9px] font-bold text-red-400 block leading-tight mt-0.5">(...)</span>
                        </div>
                        <input type="date" id="expDateInputHidden" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full" onchange="setSpecificDate(this.value)">
                    </div>
                    <button onclick="changeExpenseDate(-1)" class="w-8 h-8 shrink-0 flex items-center justify-center bg-white rounded-xl text-red-400 hover:text-red-600 shadow-sm transition-transform active:scale-95 border border-red-50"><i class="fas fa-chevron-right text-sm"></i></button>
                </div>
            </div>
            
            <!-- BUGÃœNE DÃ–N BUTONU -->
            <div id="returnToTodayBtnContainer" class="flex justify-center mb-4 hidden animate-fade-in">
                <button onclick="returnToToday()" class="bg-green-500 text-white px-5 py-1.5 rounded-full text-[10px] font-black shadow-lg shadow-green-200 hover:bg-green-600 active:scale-95 transition-all flex items-center gap-1 border-2 border-green-100 animate-pulse">
                    <i class="fas fa-undo"></i> BUGÃœNE DÃ–N
                </button>
            </div>
            
            <div class="flex flex-col gap-3">
                <div class="w-full relative">
                    <select id="expCat" class="w-full p-3 bg-gray-50 rounded-xl font-bold text-xs text-gray-700 outline-none focus:ring-2 focus:ring-blue-100 transition-all border border-gray-200 appearance-none">
                        <!-- Categories will be injected here -->
                    </select>
                    <button onclick="openCategoryModal()" class="absolute right-0 top-0 h-full px-3 text-gray-400 hover:text-blue-500 rounded-r-xl border-l border-gray-200" title="Kategorileri DÃ¼zenle">
                        <i class="fas fa-pencil-alt text-xs"></i>
                    </button>
                    <div class="pointer-events-none absolute inset-y-0 right-8 flex items-center px-2 text-gray-700">
                        <i class="fas fa-chevron-down text-[10px]"></i>
                    </div>
                </div>

                 <div class="flex gap-2 items-center">
                      <input type="number" id="expAmt" placeholder="Tutar (â‚º)" onkeyup="if(event.key === 'Enter') document.getElementById('expDesc').focus()" class="w-full p-4 bg-gray-50 rounded-xl font-black text-xl outline-none focus:ring-4 focus:ring-blue-100 transition-all text-center placeholder-gray-300 animate-soft-pulse">
                 </div>

                <div class="flex gap-2 items-center">
                    <input type="text" id="expDesc" value="" placeholder="AÃ§Ä±klama (Opsiyonel)" onkeyup="if(event.key === 'Enter') addExpense()" class="flex-1 p-3 bg-gray-50 rounded-xl font-bold text-gray-600 outline-none focus:ring-2 focus:ring-blue-500 transition-all text-xs">
                    <input type="hidden" id="editExpIndex" value="-1">
                    <button id="addExpBtn" onclick="addExpense()" class="bg-blue-600 text-white w-12 h-12 rounded-xl hover:bg-blue-700 active:scale-90 transition-all shadow-lg shadow-blue-200 flex items-center justify-center shrink-0"><i class="fas fa-plus text-lg"></i></button>
                </div>
            </div>
        </div>

        <div class="glass-card p-5 rounded-[2rem] shadow-xl bg-white border border-gray-100">
            <h3 class="font-black text-lg text-gray-800 uppercase tracking-widest text-[10px] mb-3">Harcama GeÃ§miÅŸi</h3>
            <div id="historyList" class="pb-2"></div>
        </div>

        <div id="financialHealthSection" class="glass-card p-6 rounded-[2rem] space-y-6 bg-white border border-blue-50 shadow-xl mb-12 relative overflow-hidden transition-colors duration-500">
            <div class="relative z-10">
                <div class="flex flex-col items-center border-b border-gray-200/50 pb-6">
                    <h3 class="font-black text-2xl text-gray-800 mb-2">Finansal SaÄŸlÄ±k</h3>
                    <p class="text-[9px] text-gray-400 font-bold uppercase tracking-widest mb-3">Net VarlÄ±k (VarlÄ±k - BorÃ§)</p>
                    <div id="netStatusBadge" class="text-3xl font-black text-gray-800 px-6 py-3 bg-white/80 backdrop-blur rounded-[1.5rem] transition-colors shadow-sm">
                        <span id="netStatusVal">â‚º0</span>
                    </div>
                    <div class="flex items-center justify-center mt-4">
                        <div class="text-center"><span class="text-[9px] font-bold text-gray-500 uppercase tracking-widest">AylÄ±k Sabit Gider</span><br><span id="sumGiderTotalHealth" class="text-lg font-black text-red-600">â‚º0</span></div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                    <div class="space-y-3">
                        <div class="flex items-center gap-2 mb-2 pb-2 border-b border-red-100">
                            <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                            <span class="text-[10px] font-black text-red-600 uppercase tracking-widest">BorÃ§lar & Krediler</span>
                        </div>
                        <div id="detailedDebtsList" class="space-y-2 min-h-[50px]"></div>
                        <div class="mt-3">
                            <button id="btnShowdashDebtForm" onclick="toggleInlineAdd('dashDebt')" class="w-full py-2 text-[10px] font-bold text-gray-400 hover:text-gray-600 border border-dashed border-gray-300 rounded-lg transition-colors bg-white/50">+ Yeni BorÃ§ Ekle</button>
                            <div id="inlineAdddashDebtContainer" class="hidden mt-2 p-3 border border-red-100 bg-red-50/50 rounded-xl space-y-2 shadow-inner">
                                <label class="text-[9px] font-bold text-gray-500 uppercase tracking-widest">BorÃ§ TÃ¼rÃ¼</label>
                                <select id="dashDebtType" onchange="handleInlineTypeChange('dashDebt')" class="w-full p-2 bg-white rounded-lg text-[10px] font-bold border border-gray-200 outline-none focus:ring-2 focus:ring-blue-100">
                                    <option value="Kredi">Kredi</option>
                                    <option value="Kredi KartÄ±">Kredi KartÄ±</option>
                                    <option value="AltÄ±n">AltÄ±n</option>
                                    <option value="DÃ¶viz">DÃ¶viz</option>
                                    <option value="GÃ¼mÃ¼ÅŸ">GÃ¼mÃ¼ÅŸ</option>
                                    <option value="DiÄŸer">DiÄŸer</option>
                                </select>
                                <div id="dashDebtFields" class="space-y-2"></div>
                                <div class="flex gap-2 pt-1">
                                    <button onclick="cancelInlineAdd('dashDebt')" class="flex-1 bg-white border border-gray-200 text-gray-600 rounded-lg py-2 text-[10px] font-bold hover:bg-gray-50">Ä°ptal</button>
                                    <button onclick="saveInlineAdd('dashDebt')" class="flex-1 bg-red-500 text-white rounded-lg py-2 text-[10px] font-black hover:bg-red-600">Kaydet</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <div class="flex items-center gap-2 mb-2 pb-2 border-b border-green-100">
                            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                            <span class="text-[10px] font-black text-green-600 uppercase tracking-widest">VarlÄ±klar & Birikim</span>
                        </div>
                        <div id="detailedAssetsList" class="space-y-2 min-h-[50px]"></div>
                        <div class="mt-3">
                            <button id="btnShowdashAssetForm" onclick="toggleInlineAdd('dashAsset')" class="w-full py-2 text-[10px] font-bold text-gray-400 hover:text-gray-600 border border-dashed border-gray-300 rounded-lg transition-colors bg-white/50">+ Yeni VarlÄ±k Ekle</button>
                            <div id="inlineAdddashAssetContainer" class="hidden mt-2 p-3 border border-green-100 bg-green-50/50 rounded-xl space-y-2 shadow-inner">
                                <label class="text-[9px] font-bold text-gray-500 uppercase tracking-widest">VarlÄ±k TÃ¼rÃ¼</label>
                                <select id="dashAssetType" onchange="handleInlineTypeChange('dashAsset')" class="w-full p-2 bg-white rounded-lg text-[10px] font-bold border border-gray-200 outline-none focus:ring-2 focus:ring-blue-100">
                                    <option value="DiÄŸer">DiÄŸer (Standart TL)</option>
                                    <option value="AltÄ±n">AltÄ±n</option>
                                    <option value="DÃ¶viz">DÃ¶viz</option>
                                    <option value="GÃ¼mÃ¼ÅŸ">GÃ¼mÃ¼ÅŸ</option>
                                </select>
                                <div id="dashAssetFields" class="space-y-2"></div>
                                <div class="flex gap-2 pt-1">
                                    <button onclick="cancelInlineAdd('dashAsset')" class="flex-1 bg-white border border-gray-200 text-gray-600 rounded-lg py-2 text-[10px] font-bold hover:bg-gray-50">Ä°ptal</button>
                                    <button onclick="saveInlineAdd('dashAsset')" class="flex-1 bg-green-500 text-white rounded-lg py-2 text-[10px] font-black hover:bg-green-600">Kaydet</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="fixedExpensesSection" class="w-full pt-2"></div>
                <div class="text-center mt-4 pt-4 border-t border-gray-100/50 flex flex-col items-center gap-3">
                    <button onclick="openContactModal()" class="text-[10px] font-bold text-gray-400 hover:text-blue-500 transition-colors">
                        <i class="fas fa-comment-alt mr-1"></i> GÃ¶rÃ¼ÅŸ ve Ã–neri Bildir
                    </button>
                    <button onclick="initiateDeleteAccount()" class="text-[10px] font-bold text-red-400 hover:text-red-600 transition-colors">
                        <i class="fas fa-trash-alt mr-1"></i> TÃ¼m Verilerimi ve HesabÄ±mÄ± Sil
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. ANALÄ°Z EKRANI -->
    <div id="analysisScreen" class="max-w-4xl w-full hidden space-y-6 pb-32 animate-fade-in my-auto">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h2 class="text-xl font-black text-gray-800 tracking-tight">Finansal Analiz</h2>
                <div class="flex items-center gap-3 mt-2 relative">
                     <p class="text-[9px] text-gray-400 font-bold uppercase tracking-widest">Analiz DÃ¶nemi:</p>
                     <div class="relative cursor-pointer bg-gray-100 rounded-lg p-1.5 px-3 flex items-center gap-2 hover:bg-gray-200 transition-colors" onclick="try{document.getElementById('analysisDateFilter').showPicker()}catch(e){}">
                         <span id="analysisMonthDisplay" class="text-gray-700 text-[10px] font-black">SeÃ§iniz</span>
                         <i class="fas fa-chevron-down text-[8px] text-gray-400"></i>
                         <input type="month" id="analysisDateFilter" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="renderCharts()">
                     </div>
                </div>
                <p id="analysisPeriodLabel" class="text-[9px] text-blue-500 font-bold mt-1"></p>
            </div>
            <div class="flex flex-col gap-2 items-end">
                <button onclick="openReportForSelectedMonth()" class="text-[9px] font-black bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded-full uppercase tracking-widest shadow-sm hover:bg-indigo-200 flex items-center gap-1 transition-colors">
                    <i class="fas fa-file-invoice"></i> Raporu Oku
                </button>
                <button onclick="showDashboard()" class="text-[9px] font-black bg-gray-100 text-gray-600 border border-gray-200 px-3 py-1.5 rounded-full uppercase tracking-widest shadow-sm hover:bg-gray-200">Geri DÃ¶n</button>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="glass-card p-4 rounded-[2rem] bg-white border border-gray-100 shadow-lg"><h3 class="font-black text-sm text-gray-800 mb-2 text-center">VarlÄ±k vs BorÃ§</h3><div class="h-56"><canvas id="assetsChart"></canvas></div></div>
            <div class="glass-card p-4 rounded-[2rem] bg-white border border-gray-100 shadow-lg"><h3 class="font-black text-sm text-gray-800 mb-2 text-center">Harcama DaÄŸÄ±lÄ±mÄ±</h3><div class="h-56"><canvas id="expensesChart"></canvas></div></div>
        </div>
        
        <div class="glass-card p-4 rounded-[2rem] bg-white border border-gray-100 shadow-lg mt-4">
             <div class="flex flex-col sm:flex-row justify-between items-center mb-2 gap-2">
                 <h3 class="font-black text-sm text-gray-800 text-center flex-1">Net Durum DeÄŸiÅŸimi (Trend)</h3>
                 
                 <div class="flex gap-1 bg-gray-50 p-1 rounded-lg">
                    <button onclick="switchChartRange('6')" id="btnRange6" class="text-[9px] font-bold px-2 py-1 rounded hover:bg-white hover:shadow-sm text-gray-500 transition-all">6 Ay</button>
                    <button onclick="switchChartRange('12')" id="btnRange12" class="text-[9px] font-bold px-2 py-1 rounded hover:bg-white hover:shadow-sm text-gray-500 transition-all">1 YÄ±l</button>
                    <button onclick="switchChartRange('all')" id="btnRangeAll" class="text-[9px] font-bold px-2 py-1 rounded bg-white shadow-sm text-gray-800 border border-gray-100 transition-all">TÃ¼mÃ¼</button>
                 </div>

                 <div class="flex gap-2">
                     <button onclick="switchChartMode('TL')" id="btnChartTL" class="text-[9px] font-bold px-2 py-1 rounded bg-blue-100 text-blue-600">TL BazlÄ±</button>
                     <button onclick="switchChartMode('USD')" id="btnChartUSD" class="text-[9px] font-bold px-2 py-1 rounded bg-gray-100 text-gray-500 hover:bg-green-100 hover:text-green-600">USD BazlÄ±</button>
                 </div>
             </div>
             <div class="h-56"><canvas id="historyTrendChart"></canvas></div>
        </div>

        <div class="glass-card p-6 rounded-[2rem] bg-white border border-gray-100 shadow-lg">
            <h3 class="font-black text-lg text-gray-800 mb-3 border-b pb-2">GeÃ§miÅŸ KayÄ±t Ekle</h3>
            <div class="grid grid-cols-1 sm:grid-cols-5 gap-3 items-end">
                <div><label class="text-[9px] font-bold text-gray-400 uppercase tracking-widest">DÃ¶nem</label><input type="month" id="histDate" class="w-full p-2.5 bg-gray-50 rounded-xl font-bold text-xs outline-none"></div>
                <div><label class="text-[9px] font-bold text-gray-400 uppercase tracking-widest">VarlÄ±k (TL)</label><input type="number" id="histAssets" placeholder="0" class="w-full p-2.5 bg-gray-50 rounded-xl font-bold text-xs outline-none text-green-600"></div>
                <div><label class="text-[9px] font-bold text-gray-400 uppercase tracking-widest">BorÃ§ (TL)</label><input type="number" id="histDebts" placeholder="0" class="w-full p-2.5 bg-gray-50 rounded-xl font-bold text-xs outline-none text-red-600"></div>
                <div><label class="text-[9px] font-bold text-gray-400 uppercase tracking-widest">Dolar Kuru</label><input type="number" step="0.01" id="histUSDRate" placeholder="Ã–rn: 30.50" class="w-full p-2.5 bg-blue-50 rounded-xl font-bold text-xs outline-none text-blue-600"></div>
                
                <button onclick="addHistoryRecord()" class="bg-indigo-600 text-white font-black py-2.5 rounded-xl shadow-lg hover:bg-indigo-700 active:scale-95 transition-all text-xs">Kaydet</button>
            </div>
            <div class="mt-4">
                <h4 class="text-[10px] font-bold text-gray-500 mb-2 uppercase tracking-wide">Eklenen KayÄ±tlar</h4>
                <div class="overflow-x-auto">
                    <table class="w-full text-xs text-left">
                        <thead class="text-gray-400 border-b">
                            <tr>
                                <th class="pb-2">DÃ¶nem</th>
                                <th class="pb-2 text-right">VarlÄ±k</th>
                                <th class="pb-2 text-right">BorÃ§</th>
                                <th class="pb-2 text-right">Kur</th>
                                <th class="pb-2 text-center">Ä°ÅŸlem</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody" class="font-bold text-gray-700"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <nav id="bottomNav" class="bottom-nav hidden">
        <div class="nav-item gradient-text-family" onclick="openSettingsPanel()">
            <i class="fas fa-users"></i>
            <span>Aile</span>
        </div>
        <div class="nav-item gradient-text-analysis" onclick="showAnalysisScreen()">
            <i class="fas fa-chart-pie"></i>
            <span>Analiz</span>
        </div>
        <div class="nav-item" onclick="scrollToAddExpense()">
            <div class="nav-center-btn">
                <i class="fas fa-plus"></i>
            </div>
        </div>
        <div class="nav-item gradient-text-plan" onclick="startWizard(true)">
            <i class="fas fa-edit"></i>
            <span>Plan</span>
        </div>
        <div class="nav-item text-red-500" onclick="handleLogout()">
            <i class="fas fa-sign-out-alt"></i>
            <span>Ã‡Ä±kÄ±ÅŸ</span>
        </div>
    </nav>

    <div id="settingsModal" class="side-panel">
        <div class="p-6 h-full flex flex-col">
            <div class="flex justify-between items-center mb-6 pb-4 border-b">
                <h4 class="font-black text-xl text-gray-800 tracking-tight">Ayarlar & Aile</h4>
                <button onclick="closeSettingsPanel()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar pb-10 space-y-6">
                <div id="familyPanel" class="p-4 rounded-3xl flex flex-col bg-white border border-blue-100 shadow-sm">
                    <div class="flex justify-between items-center mb-3 border-b pb-3">
                        <h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Aile Sistemi</h4>
                        <button onclick="createInviteCode()" class="text-[9px] font-bold text-blue-500 bg-blue-50 px-2 py-1 rounded-md hover:bg-blue-100 transition-colors">Kod: <span id="displayInviteCode">-----</span></button>
                    </div>
                    <div class="flex flex-col gap-2 mb-2">
                        <input type="text" id="famInput" class="w-full p-2 bg-gray-50 rounded-lg font-bold text-xs outline-none border border-gray-100" placeholder="KullanÄ±cÄ± AdÄ±/E-posta">
                        <div class="flex gap-2">
                            <select id="famRole" class="flex-1 p-2 bg-white border border-gray-100 rounded-lg text-xs font-bold text-gray-600 outline-none">
                                <option value="full">Tam Yetki</option>
                                <option value="limited">SÄ±nÄ±rlÄ±</option>
                            </select>
                            <button onclick="addFamilyMember()" class="bg-orange-500 text-white font-black px-4 rounded-lg hover:bg-orange-600 transition-all text-xs">Ekle</button>
                        </div>
                    </div>
                    <div id="familyList" class="space-y-2 max-h-[150px] overflow-y-auto custom-scrollbar pr-1 mt-2"></div>
                </div>

                <div class="p-4 bg-gray-50 rounded-xl border border-gray-100 text-center">
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Mevcut Plan StatÃ¼sÃ¼</p>
                    <p class="font-black text-blue-600 text-xs" id="settingsCurrentPlanLabel">Kendi PlanÄ±nÄ±z (YÃ¶netici)</p>
                    <button id="btnLeavePlan" onclick="leaveCurrentPlan()" class="hidden mt-3 text-[10px] font-bold text-red-500 bg-red-50 px-3 py-1.5 rounded-lg w-full hover:bg-red-100 transition-colors">Ortak Plandan AyrÄ±l</button>
                </div>

                <div class="space-y-2">
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Davet Kodu Ä°le BaÅŸka Plana KatÄ±l</p>
                    <input type="text" id="settingsInviteCode" class="w-full p-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-100 outline-none font-bold text-gray-700 transition-all text-xs" placeholder="Davet Kodunu Girin">
                    <button onclick="joinPlanByCode()" class="w-full bg-blue-600 text-white font-black py-3 rounded-xl shadow-lg hover:bg-blue-700 active:scale-95 transition-all text-xs">KatÄ±l</button>
                </div>
                
                 <button onclick="openAdminPanel()" id="btnAdminSettings" class="hidden w-full text-xs font-black bg-red-500 text-white border border-red-600 px-4 py-3 rounded-xl uppercase tracking-widest shadow-sm hover:bg-red-600 mt-4"><i class="fas fa-shield-alt"></i> Admin Paneli</button>
            </div>
        </div>
    </div>

    <div id="adminModal" class="side-panel">
        <div class="p-6 h-full flex flex-col bg-slate-900 text-white">
            <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-700">
                <h4 class="font-black text-xl tracking-tight text-white"><i class="fas fa-shield-alt mr-2"></i> Admin Paneli</h4>
                <button onclick="closeAdminPanel()" class="text-slate-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
                <button onclick="loadAdminUsers()" class="text-slate-400 hover:text-white ml-2"><i class="fas fa-sync-alt"></i></button>
            </div>
            
            <div class="flex gap-2 mb-4 bg-slate-800 p-1 rounded-xl">
                <button onclick="switchAdminTab('users')" id="tabAdminUsers" class="flex-1 py-2 text-xs font-bold rounded-lg bg-blue-600 text-white shadow-sm transition-all">KullanÄ±cÄ±lar</button>
                <button onclick="switchAdminTab('messages')" id="tabAdminMessages" class="flex-1 py-2 text-xs font-bold rounded-lg text-slate-400 hover:text-white transition-all">Mesajlar</button>
                <button onclick="switchAdminTab('specials')" id="tabAdminSpecials" class="flex-1 py-2 text-xs font-bold rounded-lg text-slate-400 hover:text-white transition-all">Ã–zel GÃ¼n</button>
            </div>

            <div id="adminTabUsers" class="flex-1 flex flex-col min-h-0">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                        <p class="text-[9px] font-bold uppercase text-slate-400">KullanÄ±cÄ±lar</p>
                        <p class="text-2xl font-black text-white" id="adminTotalUsers">-</p>
                    </div>
                     <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                        <p class="text-[9px] font-bold uppercase text-slate-400">YÃ¶netilen Para</p>
                        <p class="text-xl font-black text-green-400" id="adminTotalMoney">-</p>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto custom-scrollbar pb-10">
                    <table class="w-full text-xs text-left">
                         <thead class="text-slate-500 font-bold uppercase border-b border-slate-700 sticky top-0 bg-slate-900">
                             <tr><th class="pb-3 pl-1">KullanÄ±cÄ±</th><th class="pb-3 text-right">Ä°ÅŸlem</th></tr>
                         </thead>
                         <tbody id="adminUserList" class="font-bold text-slate-300"></tbody>
                     </table>
                </div>
            </div>

            <div id="adminTabMessages" class="hidden flex-1 flex flex-col min-h-0">
                 <div class="flex-1 overflow-y-auto custom-scrollbar pb-10 space-y-3" id="adminMessageList"></div>
            </div>

            <div id="adminTabSpecials" class="hidden flex-1 flex flex-col min-h-0 space-y-4">
                <div class="bg-slate-800 p-3 rounded-xl border border-slate-700">
                     <p class="text-[10px] font-bold uppercase text-slate-400 mb-2">Ã–zel GÃ¼n MesajÄ± Ayarla</p>
                     <input type="date" id="adminSpecDate" class="w-full p-2 bg-slate-700 text-white rounded mb-2 text-xs font-bold border-none outline-none">
                     <input type="text" id="adminSpecTitle" placeholder="BaÅŸlÄ±k (Ã–rn: 29 Ekim)" class="w-full p-2 bg-slate-700 text-white rounded mb-2 text-xs font-bold border-none outline-none">
                     <textarea id="adminSpecMsg" rows="3" placeholder="Kutlama MesajÄ±..." class="w-full p-2 bg-slate-700 text-white rounded mb-2 text-xs font-bold border-none outline-none resize-none"></textarea>
                     <button onclick="saveSpecialDayConfig()" class="w-full bg-blue-600 py-2 rounded font-bold text-xs hover:bg-blue-500">Ã–zel GÃ¼nÃ¼ Kaydet</button>
                </div>
                
                <div class="flex-1 flex flex-col min-h-0 bg-slate-800 p-3 rounded-xl border border-slate-700">
                     <div class="flex justify-between items-center mb-2">
                        <p class="text-[10px] font-bold uppercase text-slate-400">Sistem MesajlarÄ± YÃ¶netimi</p>
                        <select id="adminMsgCat" class="bg-slate-700 text-white text-[10px] p-1 rounded border-none outline-none">
                            <option value="highSpend">YÃ¼ksek Harcama</option>
                            <option value="lowSavings">DÃ¼ÅŸÃ¼k Birikim</option>
                            <option value="streak">Seri (Streak)</option>
                        </select>
                     </div>
                     <div class="flex gap-2 mb-2">
                        <input type="text" id="adminNewSysMsg" class="flex-1 p-2 bg-slate-700 text-white rounded text-xs border-none outline-none" placeholder="Yeni Mesaj Ekle...">
                        <button onclick="addSystemMessage()" class="bg-green-600 px-3 rounded text-xs font-bold hover:bg-green-500"><i class="fas fa-plus"></i></button>
                     </div>
                     <div id="adminSysMsgList" class="flex-1 overflow-y-auto custom-scrollbar space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="editItemModal" class="side-panel">
        <div class="p-6 h-full flex flex-col">
            <div class="flex justify-between items-center mb-6 pb-4 border-b">
                <h4 class="font-black text-xl text-gray-800 tracking-tight">DÃ¼zenle</h4>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto custom-scrollbar pb-10">
                <div class="space-y-4">
                    <input type="text" id="editItemName" class="w-full p-4 bg-gray-50 rounded-xl font-bold text-sm border border-gray-100" placeholder="Ä°sim">
                    
                    <div id="editLoanContainer" class="hidden space-y-3 bg-red-50 p-3 rounded-xl border border-red-100">
                        <div class="flex gap-2">
                            <div class="flex-1">
                                <label class="text-[9px] font-bold text-gray-500 uppercase">AylÄ±k Taksit</label>
                                <input type="number" id="editLoanMonthly" class="w-full p-2 bg-white rounded-lg text-xs font-bold border border-red-100 outline-none" oninput="calcEditLoan()">
                            </div>
                            <div class="flex-1">
                                <label class="text-[9px] font-bold text-gray-500 uppercase">Kalan Ay</label>
                                <input type="number" id="editLoanMonths" class="w-full p-2 bg-white rounded-lg text-xs font-bold border border-red-100 outline-none" oninput="calcEditLoan()">
                            </div>
                        </div>
                        <div>
                            <label class="text-[9px] font-bold text-gray-500 uppercase">Sonraki Taksit Tarihi</label>
                            <input type="date" id="editLoanDate" class="w-full p-2 bg-white rounded-lg text-xs font-bold border border-red-100 outline-none">
                        </div>
                    </div>

                    <div id="editCCLimitContainer" class="hidden space-y-3 bg-purple-50 p-3 rounded-xl border border-purple-100">
                         <div class="flex gap-2">
                            <div class="flex-1">
                                <label class="text-[9px] font-bold text-gray-500 uppercase">Kart Limiti</label>
                                <input type="number" id="editCCLimit" class="w-full p-2 bg-white rounded-lg text-xs font-bold border border-purple-100 outline-none" oninput="calcEditCC()">
                            </div>
                            <div class="flex-1">
                                <label class="text-[9px] font-bold text-gray-500 uppercase">KullanÄ±labilir</label>
                                <input type="number" id="editCCAvail" class="w-full p-2 bg-white rounded-lg text-xs font-bold border border-purple-100 outline-none" oninput="calcEditCC()">
                            </div>
                        </div>
                    </div>

                    <div>
                         <label class="text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-1 block">Toplam Tutar</label>
                         <input type="number" id="editItemVal" class="w-full p-4 bg-gray-50 rounded-xl font-bold text-sm border border-gray-100" placeholder="Toplam Tutar">
                    </div>
                    
                    <div class="p-4 bg-blue-50 rounded-xl border border-blue-100 flex items-center gap-3">
                         <input type="checkbox" id="editExcludeNetWorth" class="w-5 h-5 rounded text-blue-600 focus:ring-blue-500">
                         <label for="editExcludeNetWorth" class="text-xs font-bold text-gray-600">Net VarlÄ±k HesabÄ±na Katma</label>
                    </div>
                    
                    <div id="editLoanSpecificContainer" class="hidden mt-2 p-4 bg-red-50 rounded-xl border border-red-100 flex items-center gap-3">
                         <input type="checkbox" id="editExcludeBudget" class="w-5 h-5 rounded text-red-600 focus:ring-red-500">
                         <label for="editExcludeBudget" class="text-xs font-bold text-gray-600">AylÄ±k BÃ¼tÃ§eye (Gidere) Katma</label>
                    </div>
                    
                    <input type="hidden" id="editItemType"><input type="hidden" id="editItemIndex">
                    <div class="flex gap-2 pt-4">
                        <button onclick="closeEditModal()" class="flex-1 py-3 bg-gray-100 text-gray-600 font-bold rounded-xl border border-gray-200">Ä°ptal</button>
                        <button onclick="saveEditedItem()" class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg shadow-blue-200">Kaydet</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="calcModal" class="side-panel">
        <div class="p-6 h-full flex flex-col">
            <div class="flex justify-between items-center mb-6 pb-4 border-b">
                <h4 class="font-black text-xl text-gray-800 tracking-tight">NasÄ±l HesaplandÄ±?</h4>
                <button onclick="closeCalcModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="calcModalContent" class="space-y-4 text-sm flex-1 overflow-y-auto custom-scrollbar pb-10"></div>
        </div>
    </div>

    <div id="balanceModal" class="side-panel">
        <div class="p-6 h-full flex flex-col">
            <div class="flex justify-between items-center mb-6 pb-4 border-b">
                <h4 class="font-black text-xl text-gray-800 tracking-tight">GerÃ§ek Bakiye</h4>
                <button onclick="closeBalanceModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="balanceModalContent" class="space-y-4 text-sm flex-1 overflow-y-auto custom-scrollbar pb-10"></div>
        </div>
    </div>
    
    <div id="recoveryPlanModal" class="side-panel">
        <div class="p-6 h-full flex flex-col">
            <div class="flex justify-between items-center mb-6 pb-4 border-b">
                <h4 class="font-black text-xl text-gray-800 tracking-tight">Hedefi Tutturmak Ä°Ã§in Gereken</h4>
                <button onclick="closeRecoveryPlanModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="recoveryPlanContent" class="flex-1 overflow-y-auto custom-scrollbar pb-10">
                <!-- Dinamik iÃ§erik JS ile gelecek -->
            </div>
        </div>
    </div>

    <div id="loanPlanModal" class="side-panel">
        <div class="p-6 h-full flex flex-col">
            <div class="flex justify-between items-center mb-6 pb-4 border-b">
                <div>
                    <span class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Kredi DetayÄ±</span>
                    <h4 class="font-black text-xl text-gray-800 tracking-tight leading-none" id="loanPlanTitle">Ã–deme PlanÄ±</h4>
                </div>
                <button onclick="closeLoanPlanModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto custom-scrollbar pb-10">
                 <table class="w-full text-xs text-left">
                     <thead class="text-gray-400 font-bold uppercase border-b sticky top-0 bg-white"><tr><th class="pb-3 pl-2">Tak.</th><th class="pb-3">Tarih</th><th class="pb-3 text-right">Tutar</th><th class="pb-3 text-center">Durum</th></tr></thead>
                     <tbody id="loanPlanBody" class="font-bold text-gray-600"></tbody>
                 </table>
            </div>
        </div>
    </div>

    <div id="categoryModal" class="side-panel">
        <div class="p-6 h-full flex flex-col">
             <div class="flex justify-between items-center mb-6 pb-4 border-b">
                <h4 class="font-black text-xl text-gray-800 tracking-tight">Kategoriler</h4>
                <button onclick="closeCategoryModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="flex gap-2 mb-4">
                <input type="text" id="newCatName" placeholder="Yeni Kategori Ekle" class="flex-1 p-3 bg-gray-50 border rounded-xl text-sm font-bold outline-none" onkeyup="if(event.key==='Enter') addNewCategory()">
                <button onclick="addNewCategory()" class="bg-blue-600 text-white w-12 rounded-xl flex items-center justify-center hover:bg-blue-700 shadow-lg"><i class="fas fa-plus"></i></button>
            </div>
            
            <div id="categoryList" class="flex-1 overflow-y-auto custom-scrollbar space-y-2 pb-10"></div>
        </div>
    </div>

    <div id="contactModal" class="side-panel">
        <div class="p-6 h-full flex flex-col">
            <div class="flex justify-between items-center mb-6 pb-4 border-b">
                <h4 class="font-black text-xl text-gray-800 tracking-tight">Bize UlaÅŸÄ±n</h4>
                <button onclick="closeContactModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="flex-1 flex flex-col gap-4">
                <p class="text-sm text-gray-500">GÃ¶rÃ¼ÅŸ, Ã¶neri veya ÅŸikayetlerinizi bizimle paylaÅŸÄ±n. Size en kÄ±sa sÃ¼rede dÃ¶nÃ¼ÅŸ yapacaÄŸÄ±z.</p>
                <input type="email" id="contactEmail" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-2xl text-sm font-bold text-gray-700 outline-none focus:ring-4 focus:ring-blue-100 transition-all" placeholder="E-posta Adresiniz (GiriÅŸ yapmadÄ±ysanÄ±z zorunlu)">
                <textarea id="contactMsg" rows="6" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-2xl text-sm font-bold text-gray-700 outline-none focus:ring-4 focus:ring-blue-100 transition-all resize-none" placeholder="MesajÄ±nÄ±z..."></textarea>
                <button onclick="sendContactMessage()" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl shadow-xl active:scale-95 transition-all hover:bg-blue-700">GÃ–NDER</button>
            </div>
        </div>
    </div>

    <!-- AYLIK RAPOR MODALI -->
    <div id="monthlyReportModal" class="fixed inset-0 z-[85] hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeMonthlyReport()"></div>
        <div class="bg-white rounded-[2rem] p-5 w-[90%] max-w-sm relative z-10 shadow-2xl animate-fade-in max-h-[80vh] flex flex-col border border-indigo-100 mb-20">
            <!-- Header -->
            <div class="text-center mb-4">
                <div class="w-16 h-16 bg-gradient-to-tr from-indigo-500 to-purple-500 text-white rounded-full flex items-center justify-center mx-auto mb-3 shadow-lg shadow-indigo-200 animate-bounce-slow">
                    <i class="fas fa-bullhorn text-2xl"></i>
                </div>
                <h3 class="text-2xl font-black text-gray-800 tracking-tight">AylÄ±k Ã–zet Raporun</h3>
                <p id="reportPeriodText" class="text-[10px] text-gray-500 font-bold uppercase tracking-widest mt-1">...</p>
            </div>
            
            <!-- Scrollable Content -->
            <div id="reportContent" class="flex-1 overflow-y-auto custom-scrollbar pr-2 space-y-4 text-sm text-gray-700 font-medium pb-2">
                <!-- Dinamik iÃ§erik JS ile buraya gelecek -->
            </div>
            
            <!-- Footer / Action -->
            <div class="mt-4 pt-4 border-t border-gray-100 space-y-2 shrink-0">
                <button onclick="closeMonthlyReport(); startWizard(true);" class="w-full py-3.5 bg-indigo-600 text-white font-black rounded-xl text-xs hover:bg-indigo-700 shadow-xl shadow-indigo-200 active:scale-95 transition-all flex items-center justify-center gap-2">
                    <i class="fas fa-edit text-sm"></i> Yeni Hedef Belirle (PlanÄ± GÃ¼ncelle)
                </button>
                <button onclick="closeMonthlyReport()" class="w-full py-2.5 bg-gray-50 text-gray-500 font-bold rounded-xl text-[10px] hover:bg-gray-100 transition-colors uppercase tracking-wider">
                    GeÃ§en Ayki Hedefle Devam Et
                </button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAyUQaeoVWnT4AuzSwD2M17-z1g2optqdA",
            authDomain: "hesapguvende-b07ca.firebaseapp.com",
            projectId: "hesapguvende-b07ca",
            storageBucket: "hesapguvende-b07ca.firebasestorage.app",
            messagingSenderId: "710002620092",
            appId: "1:710002620092:web:94f3ebb8dd2461af29c2b9",
            measurementId: "G-VE0EVVBM0V"
        };

        // --- YENÄ° MESAJ SETLERÄ° (VARSAYILAN) ---
        let messages_highSpend = [
            "CÃ¼zdan bugÃ¼n cardio yaptÄ±â€¦ nabÄ±z 180.",
            "Limit: â€˜Ben bu filmde yokumâ€™ dedi.",
            "BugÃ¼n harcama deÄŸil, sanat eseri Ã§Ä±karmÄ±ÅŸsÄ±n.",
            "KartÄ±n POS cihazÄ±yla duygusal baÄŸ kurmuÅŸ olabilir.",
            "BÃ¼tÃ§e planÄ±: â€˜Ben yarÄ±n geliyorumâ€™ diye kaÃ§tÄ±.",
            "Harcama grafiÄŸi roket gibiâ€¦ NASA aradÄ±.",
            "BugÃ¼n â€˜kÃ¼Ã§Ã¼k kaÃ§amakâ€™ deÄŸil, mini tatil olmuÅŸ.",
            "CÃ¼zdanÄ±n iÃ§ sesi: â€˜Ben aslÄ±nda inceydimâ€¦â€™",
            "Limitleri test ettin, tebrikler: stres testi baÅŸarÄ±lÄ±.",
            "BÃ¼tÃ§eye â€˜sÃ¼rpriz yumurtaâ€™ yaptÄ±n: iÃ§inden masraf Ã§Ä±ktÄ±.",
            "BugÃ¼n para â€˜ben gidiyorumâ€™ deyip valiz topladÄ±.",
            "Harcama modun: â€˜Bir tane daha sepet!â€™",
            "Kart ekstresi ÅŸu an sana bakÄ±p gÃ¶z kÄ±rpÄ±yor.",
            "BÃ¼tÃ§e: â€˜Ben ÅŸaka mÄ±ydÄ±m?â€™",
            "BugÃ¼n â€˜indirimâ€™ deÄŸil, â€˜iknaâ€™ kazanmÄ±ÅŸ.",
            "Harcamalar: â€˜Biz bir aile oldukâ€™ demiÅŸ.",
            "Limit Ã§izgisi aÅŸÄ±ldÄ±â€¦ uyarÄ± konisi koyuyorum ðŸš§",
            "BugÃ¼n cÃ¼zdan deÄŸil, sponsorluk anlaÅŸmasÄ± var sanki.",
            "Harcama sayacÄ± â€˜durâ€™ dedi, sen â€˜devamâ€™ dedin.",
            "BugÃ¼n paranÄ±n Ã¶zgÃ¼r iradesi elinden alÄ±nmÄ±ÅŸ olabilir."
        ];

        let messages_lowSavings = [
            "Hedefle arana mesafe girmiÅŸâ€¦ iliÅŸki terapisine gidelim mi?",
            "Birikim hedefi seni Ã¶zlemiÅŸ. Mesaj atayÄ±m mÄ±?",
            "Hedef uzakta ama imkÃ¢nsÄ±z deÄŸil: yÃ¼rÃ¼yÃ¼ÅŸe Ã§Ä±kÄ±yoruz.",
            "Birikim planÄ± â€˜neredesin?â€™ diye son gÃ¶rÃ¼lme attÄ±.",
            "Hedefe ÅŸu an Wi-Fi Ã§ekmiyor gibiâ€¦ yaklaÅŸalÄ±m.",
            "BugÃ¼n â€˜yaklaÅŸma gÃ¼nÃ¼â€™: hedefle barÄ±ÅŸ Ã§ubuÄŸu uzatÄ±yoruz.",
            "Birikim hedefin: â€˜Ben hÃ¢lÃ¢ buradayÄ±mâ€™ diye el sallÄ±yor.",
            "Mesafe moral bozmasÄ±n; kÃ¼Ã§Ã¼k adÄ±mlar bÃ¼yÃ¼k iÅŸler yapar.",
            "Hedefe uzaklÄ±k Ã¶lÃ§Ã¼mÃ¼: â€˜Bir tÄ±kâ€™ deÄŸil, birkaÃ§ tÄ±kâ€¦",
            "BugÃ¼n birikim deÄŸilse bile, en azÄ±ndan niyet artÄ± puan.",
            "Hedefe giden yol: â€˜Az harcaâ€™ tabelasÄ±yla baÅŸlÄ±yor.",
            "Birikim hedefinle arana â€˜kargo Ã¼cretiâ€™ girmiÅŸ olabilir.",
            "Hedef kaÃ§madÄ±; sadece sen biraz oyalanmÄ±ÅŸsÄ±n.",
            "BÃ¼tÃ§e pusulasÄ± ÅŸaÅŸmÄ±ÅŸ; kuzeyi yeniden buluyoruz.",
            "Birikim: â€˜Ben senin iyiliÄŸini dÃ¼ÅŸÃ¼nÃ¼yorumâ€™ modunda.",
            "Hedefe yaklaÅŸma challengeâ€™Ä±: bugÃ¼n kÃ¼Ã§Ã¼k bir zafer?",
            "Hedefle arayÄ± kapatmak iÃ§in â€˜mini resetâ€™ zamanÄ±.",
            "Birikim hedefi: â€˜Konum paylaÅŸâ€™ diyor.",
            "Mesafe var ama rota Ã§izilebilir: baÅŸlÄ±yoruz.",
            "BugÃ¼n hedefe 1 adÄ±m: bÃ¼yÃ¼k kahramanlÄ±klar bÃ¶yle baÅŸlar."
        ];

        let messages_streak = [
            "ÃœÃ§ gÃ¼n Ã¼st Ã¼ste! BÃ¼tÃ§e disiplini DLCâ€™si aÃ§Ä±ldÄ±.",
            "Sende bir â€˜finans ninjaâ€™ enerjisi var.",
            "Hedef serisi baÅŸladÄ±: streak mode ON ðŸ”¥",
            "CÃ¼zdanÄ±n bugÃ¼n sana gururla bakÄ±yor.",
            "BÃ¼tÃ§e planÄ±: â€˜Ä°ÅŸte aradÄ±ÄŸÄ±m insan!â€™",
            "ÃœÃ§ gÃ¼nâ€¦ bu artÄ±k tesadÃ¼f deÄŸil, karakter geliÅŸimi.",
            "Tasarruf kaslarÄ±n ÅŸiÅŸiyor, devam!",
            "Hedef tutturan insan aurasÄ±: %100 parlak.",
            "BÃ¼tÃ§e grafiÄŸi nihayet sakin bir diziye geÃ§ti.",
            "Bu gidiÅŸle paran seni iÅŸe alacak.",
            "Kontrol sende. Kart bile saygÄ± duyuyor.",
            "Disiplinin o kadar iyi ki Excel bile alkÄ±ÅŸlÄ±yor.",
            "Hedef serin â€˜efsaneâ€™ kategorisine gÃ¶z kÄ±rptÄ±.",
            "ÃœÃ§ gÃ¼n Ã¼st Ã¼ste: â€˜Ben yaparÄ±mâ€™ kanÄ±tÄ±.",
            "BÃ¼tÃ§enin direksiyonunda sen varsÄ±n. Korna Ã§alma, ilerle.",
            "Finansal zen: harcama dÃ¼rtÃ¼sÃ¼ sakinleÅŸtirildi.",
            "BugÃ¼n de tutturduysan, artÄ±k â€˜alÄ±ÅŸkanlÄ±kâ€™ oldu bu.",
            "CÃ¼zdanÄ±n hafiflediÄŸi iÃ§in deÄŸilâ€”rahatladÄ±ÄŸÄ± iÃ§in.",
            "Streak bozulmasÄ±n diye cÃ¼zdana nazar boncuÄŸu takÄ±yorum.",
            "Tebrikler: â€˜Hedef TutarlÄ± Ä°nsanâ€™ rozeti sende."
        ];

        // YENÄ°: NORMAL DURUM MESAJLARI (RANDOM Ä°Ã‡Ä°N)
        let messages_general = [
            "BÃ¼tÃ§en senin kontrolÃ¼nde, harika gidiyorsun!",
            "PlanlÄ± harcamak, Ã¶zgÃ¼rce yaÅŸamaktÄ±r.",
            "BugÃ¼n finansal hedeflerin iÃ§in ne yaptÄ±n?",
            "Tasarruf bir alÄ±ÅŸkanlÄ±ktÄ±r, sende bu Ä±ÅŸÄ±k var.",
            "Gelecekteki sen, bugÃ¼nkÃ¼ sana teÅŸekkÃ¼r edecek.",
            "Para bir araÃ§tÄ±r, direksiyon senin elinde.",
            "KÃ¼Ã§Ã¼k birikimler, bÃ¼yÃ¼k hayallerin tohumudur.",
            "BÃ¼tÃ§eye sadÄ±k kalmak, kendine verdiÄŸin sÃ¶zÃ¼ tutmaktÄ±r.",
            "Harcarken kazanmak: Ä°htiyaÃ§ mÄ±, istek mi? DoÄŸru karar!",
            "Finansal huzur, en gÃ¼zel yastÄ±ktÄ±r.",
            "BugÃ¼n cÃ¼zdanÄ±n sana gÃ¼lÃ¼msÃ¼yor.",
            "AdÄ±m adÄ±m hedefe: Ä°stikrarÄ±n anahtarÄ± sensin.",
            "BÃ¼tÃ§e yapmak kÄ±sÄ±tlanmak deÄŸil, yÃ¶netmektir.",
            "Her kuruÅŸun bir gÃ¶revi olsun.",
            "Finansal zeka: Ä°stekleri erteleyebilme gÃ¼cÃ¼dÃ¼r.",
            "YarÄ±nki rahatÄ±n iÃ§in bugÃ¼n biraz disiplin.",
            "BaÅŸarÄ±, her gÃ¼n tekrarlanan kÃ¼Ã§Ã¼k Ã§abalardÄ±r.",
            "ParanÄ± yÃ¶net, hayatÄ±nÄ± yÃ¶net.",
            "Zenginlik sahip olduklarÄ±n deÄŸil, yetinebildiklerindir.",
            "Finansal Ã¶zgÃ¼rlÃ¼k yolculuÄŸunda iyi yolculuklar!"
        ];

        let db, auth, currentUser = null;
        let currentPlanId = null; 
        let currentUserRole = 'owner';
        let isFirebaseReady = false;
        let isRegistering = false; 
        let assetsChartInstance = null;
        let expensesChartInstance = null;
        let trendChartInstance = null;
        let trendMode = 'TL';
        let trendRange = 'all'; 
        let adviceInterval = null;
        window.userInvites = [];
        let currentExpenseDateOffset = 0;
        let editingCategoryIndex = -1; 
        let originalAdminUid = null;

        // Sadece mobil cihazlarda geri tuÅŸuyla kapatma Ã¶zelliÄŸini aktifleÅŸtiriyoruz.
        // PC tarayÄ±cÄ±larÄ±nda history.back() sekmeyi tamamen kapatma/farklÄ± siteye atma sorunu yaratabilir.
        const isMobileView = () => window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod/i.test(navigator.userAgent);

        function getDaysInCurrentPeriod() {
            const now = new Date();
            const sd = state.salaryDay || 15;
            let start = new Date(now.getFullYear(), now.getMonth(), sd);
            if (now.getDate() < sd) {
                start.setMonth(start.getMonth() - 1);
            }
            let end = new Date(start);
            end.setMonth(end.getMonth() + 1);
            return Math.round((end - start) / (1000 * 60 * 60 * 24));
        }

        function formatPeriodMonth(yyyy_mm) {
            if (!yyyy_mm) return "-";
            const [year, month] = yyyy_mm.split('-').map(Number);
            const salaryDay = state.salaryDay || 15;
            const startDate = new Date(year, month - 1, salaryDay);
            const endDate = new Date(year, month, salaryDay);
            
            const startMonthName = startDate.toLocaleDateString('tr-TR', { month: 'long' });
            const endMonthName = new Date(endDate - 1).toLocaleDateString('tr-TR', { month: 'long' });
            const startYear = startDate.getFullYear();
            const endYear = new Date(endDate - 1).getFullYear();
            
            if (salaryDay === 1) return `${startMonthName} ${startYear}`;
            return startYear === endYear 
                ? `${startMonthName} - ${endMonthName} ${startYear}`
                : `${startMonthName} ${startYear} - ${endMonthName} ${endYear}`;
        }

        function pushPanelHistory() {
            if (!isMobileView()) return;
            if (!isPanelOpenInHistory) {
                history.pushState({ panelOpen: true }, "", "");
                isPanelOpenInHistory = true;
            }
        }

        function popPanelHistory() {
            if (!isMobileView()) return;
            if (isPanelOpenInHistory) {
                isPanelOpenInHistory = false;
                ignoreNextPop = true;
                history.back();
            }
        }

        window.addEventListener('popstate', function(e) {
            if (ignoreNextPop) {
                ignoreNextPop = false;
                return;
            }
            isPanelOpenInHistory = false;
            closeAllPopupsUIOnly();
        });

        function closeAllPopupsUIOnly() {
            document.getElementById('overlay').classList.remove('active'); 
            document.getElementById('customConfirmModal').classList.add('hidden');
            document.getElementById('appAlertModal').classList.add('hidden');
            document.getElementById('specialDayModal').classList.add('hidden');
            document.getElementById('monthlyReportModal').classList.add('hidden');
            document.getElementById('deleteAccountModal').classList.add('hidden');
            
            document.querySelectorAll('.side-panel').forEach(el => { 
                el.classList.remove('open'); 
                setTimeout(() => el.classList.add('hidden'), 300); 
            });
            
            editingCategoryIndex = -1;
        }

        function closeAllPopups() { 
            closeAllPopupsUIOnly();
            popPanelHistory();
        }
        // -----------------------------------

        function showAppAlert(message) {
            document.getElementById('appAlertMsg').innerText = message;
            const modal = document.getElementById('appAlertModal');
            modal.classList.remove('hidden');
        }
        function closeAppAlert() {
            document.getElementById('appAlertModal').classList.add('hidden');
        }

        function showSpecialDayModal(title, msg) {
            const seen = localStorage.getItem('seenSpecialDay_' + title);
            if(seen) return; 
            
            document.getElementById('specialDayTitle').innerText = title;
            document.getElementById('specialDayMsg').innerText = msg;
            
            const modal = document.getElementById('specialDayModal');
            modal.classList.remove('hidden');
            
            runConfetti();
        }
        
        function closeSpecialDayModal() {
            const title = document.getElementById('specialDayTitle').innerText;
            localStorage.setItem('seenSpecialDay_' + title, 'true');
            document.getElementById('specialDayModal').classList.add('hidden');
        }
        
        function runConfetti() {
            const canvas = document.getElementById('confettiCanvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            const particles = [];
            const colors = ['#FFD700', '#FF0000', '#FFFFFF', '#00FF00', '#0000FF'];
            
            for(let i=0; i<100; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height - canvas.height,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    size: Math.random() * 5 + 2,
                    speed: Math.random() * 3 + 2,
                    angle: Math.random() * 6.2
                });
            }
            
            function animate() {
                if(document.getElementById('specialDayModal').classList.contains('hidden')) return;
                ctx.clearRect(0,0,canvas.width,canvas.height);
                particles.forEach(p => {
                    p.y += p.speed;
                    p.x += Math.sin(p.angle);
                    if(p.y > canvas.height) p.y = -10;
                    ctx.fillStyle = p.color;
                    ctx.fillRect(p.x, p.y, p.size, p.size);
                });
                requestAnimationFrame(animate);
            }
            animate();
        }

        let pendingConfirmAction = null;

        function showConfirm(message, callback) {
            document.getElementById('customConfirmMsg').innerText = message;
            pendingConfirmAction = callback;
            const modal = document.getElementById('customConfirmModal');
            modal.classList.remove('hidden');

            const btn = document.getElementById('customConfirmBtn');
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            
            newBtn.onclick = () => {
                if (pendingConfirmAction) pendingConfirmAction();
                closeCustomConfirm();
            };
        }

        function closeCustomConfirm() {
            document.getElementById('customConfirmModal').classList.add('hidden');
            pendingConfirmAction = null;
        }

        const defaultState = {
            step: 1, salaryDay: 15,
            registrationDate: new Date().toISOString(),
            balanceCalcMethod: 'register', 
            customBalanceDate: null,
            incomes: [{ name: 'MaaÅŸ', val: null }], 
            bills: [
                { name: 'Kira', val: null }, { name: 'Aidat', val: null }, { name: 'Elektrik', val: null },
                { name: 'Su', val: null }, { name: 'DoÄŸalgaz', val: null }, { name: 'Ä°nternet', val: null },
                { name: 'Telefon', val: null }, { name: 'Dijital Ã–demeler', val: null }, { name: 'Bireysel Emeklilik (AylÄ±k)', val: null }
            ], 
            loans: [], debts: [], 
            otherDebts: [{ name: 'KMH / Avans Hesap (- Bakiye)', val: null }], 
            assets: [
                { name: 'Bankadaki Para', val: null }, { name: 'Cepteki Para', val: null }, { name: 'Bireysel Emeklilik (Toplam)', val: null }
            ],
            categories: ["Market / Manav", "Kasap", "AkaryakÄ±t", "DÄ±ÅŸarÄ±da Yemek", "Eczane / SaÄŸlÄ±k", "EÄŸlence", "EÄŸitim Ã–demeleri", "Vergi / HarÃ§ / Sigorta", "DiÄŸer"],
            manualDailyLimit: null, expenses: [], monthlyHistory: [], familyMembers: [], inviteCode: null, reports: {}
        };
        let state = JSON.parse(JSON.stringify(defaultState));

        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            isFirebaseReady = true;
            
            auth.onAuthStateChanged(async user => {
                if (user) {
                    currentUser = user;
                    const name = user.displayName || user.email.split('@')[0];
                    document.getElementById('dashWelcome').innerText = `HoÅŸgeldin, ${name}`;
                    
                    if (user.email.toLowerCase() === 'buraksancak@msn.com') {
                        document.getElementById('btnAdmin').classList.remove('hidden');
                        document.getElementById('btnAdminSettings').classList.remove('hidden');
                        loadAdminSystemMessages(); 
                        checkSpecialDayConfig();
                    } else {
                        document.getElementById('btnAdmin').classList.add('hidden');
                         document.getElementById('btnAdminSettings').classList.add('hidden');
                        checkSpecialDayConfig(); 
                    }
                    
                    fetchSystemMessages();

                    try {
                        const userDoc = await db.collection("users").doc(user.uid).get();
                        if(userDoc.exists && userDoc.data().pendingInvites) {
                            window.userInvites = userDoc.data().pendingInvites;
                        }
                    } catch(e) {}
                    
                    if (!originalAdminUid) await initUserPlan(); 
                    startAdviceRotator();
                    
                    document.getElementById('bottomNav').classList.remove('hidden');
                    
                } else {
                    currentUser = null;
                    clearInterval(adviceInterval);
                    showLoginScreen();
                    
                    document.getElementById('bottomNav').classList.add('hidden');
                }
            });
        } catch(e) { console.error("Firebase Init Error:", e); }

        function hideAll() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('wizardScreen').classList.add('hidden');
            document.getElementById('dashboardScreen').classList.add('hidden');
            document.getElementById('analysisScreen').classList.add('hidden');
        }

        async function fetchSystemMessages() {
            try {
                const doc = await db.collection('system_messages').doc('config').get();
                if (doc.exists) {
                    const data = doc.data();
                    if (data.highSpend && data.highSpend.length > 0) messages_highSpend = data.highSpend;
                    if (data.lowSavings && data.lowSavings.length > 0) messages_lowSavings = data.lowSavings;
                    if (data.streak && data.streak.length > 0) messages_streak = data.streak;
                }
            } catch(e) { console.log("Mesajlar Ã§ekilemedi, varsayÄ±lanlar kullanÄ±lÄ±yor."); }
        }

        function getRandomMessage(arr, type) { 
            if(!arr || arr.length === 0) return "...";
            
            const lastShown = localStorage.getItem('lastMsg_' + type);
            let candidates = arr;
            
            if (arr.length > 1 && lastShown) {
                candidates = arr.filter(m => m !== lastShown);
                if (candidates.length === 0) candidates = arr;
            }
            
            const selected = candidates[Math.floor(Math.random() * candidates.length)];
            localStorage.setItem('lastMsg_' + type, selected);
            return selected; 
        }

        async function checkSpecialDayConfig() {
            try {
                const doc = await db.collection('system_config').doc('special_day').get();
                if(doc.exists) {
                    const data = doc.data();
                    const today = new Date().toISOString().split('T')[0]; 
                    if (data.date === today) {
                        showSpecialDayModal(data.title, data.message);
                    }
                }
            } catch(e) {}
        }

        async function openAdminPanel() {
            closeSettingsPanel(); 
            document.getElementById('adminModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('adminModal').classList.add('open'), 10);
            document.getElementById('overlay').classList.add('active');
            
            pushPanelHistory();
            switchAdminTab('users');
        }

        function closeAdminPanel() {
            const modal = document.getElementById('adminModal');
            modal.classList.remove('open');
            setTimeout(() => modal.classList.add('hidden'), 300);
            if(!originalAdminUid) document.getElementById('overlay').classList.remove('active'); 
            popPanelHistory();
        }
        
        function switchAdminTab(tabName) {
            const btnUsers = document.getElementById('tabAdminUsers');
            const btnMsgs = document.getElementById('tabAdminMessages');
            const btnSpecs = document.getElementById('tabAdminSpecials');
            
            const divUsers = document.getElementById('adminTabUsers');
            const divMsgs = document.getElementById('adminTabMessages');
            const divSpecs = document.getElementById('adminTabSpecials');

            [btnUsers, btnMsgs, btnSpecs].forEach(b => b.className = "flex-1 py-2 text-xs font-bold rounded-lg text-slate-400 hover:text-white transition-all");
            [divUsers, divMsgs, divSpecs].forEach(d => d.classList.add('hidden'));

            if (tabName === 'users') {
                btnUsers.className = "flex-1 py-2 text-xs font-bold rounded-lg bg-blue-600 text-white shadow-sm transition-all";
                divUsers.classList.remove('hidden');
                loadAdminUsers();
            } else if (tabName === 'messages') {
                btnMsgs.className = "flex-1 py-2 text-xs font-bold rounded-lg bg-blue-600 text-white shadow-sm transition-all";
                divMsgs.classList.remove('hidden');
                loadAdminMessages();
            } else { 
                btnSpecs.className = "flex-1 py-2 text-xs font-bold rounded-lg bg-blue-600 text-white shadow-sm transition-all";
                divSpecs.classList.remove('hidden');
                loadAdminSystemMessagesListUI(); 
            }
        }

        async function loadAdminSystemMessages() {
            await fetchSystemMessages(); 
        }

        function loadAdminSystemMessagesListUI() {
            const cat = document.getElementById('adminMsgCat').value;
            const listDiv = document.getElementById('adminSysMsgList');
            let arr = [];
            if (cat === 'highSpend') arr = messages_highSpend;
            else if (cat === 'lowSavings') arr = messages_lowSavings;
            else arr = messages_streak;

            listDiv.innerHTML = arr.map((msg, i) => `
                <div class="flex justify-between items-center bg-slate-700 p-2 rounded text-xs text-slate-300">
                    <span>${msg}</span>
                    <button onclick="deleteSystemMessage('${cat}', ${i})" class="text-red-400 hover:text-white"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');
        }

        document.getElementById('adminMsgCat').addEventListener('change', loadAdminSystemMessagesListUI);

        async function addSystemMessage() {
            const cat = document.getElementById('adminMsgCat').value;
            const msg = document.getElementById('adminNewSysMsg').value.trim();
            if(!msg) return;

            if (cat === 'highSpend') messages_highSpend.push(msg);
            else if (cat === 'lowSavings') messages_lowSavings.push(msg);
            else messages_streak.push(msg);

            await db.collection('system_messages').doc('config').set({
                highSpend: messages_highSpend,
                lowSavings: messages_lowSavings,
                streak: messages_streak
            }, { merge: true });

            document.getElementById('adminNewSysMsg').value = '';
            loadAdminSystemMessagesListUI();
            showAppAlert("Mesaj eklendi.");
        }

        async function deleteSystemMessage(cat, idx) {
            if(!confirm("Silinsin mi?")) return;
            
            if (cat === 'highSpend') messages_highSpend.splice(idx, 1);
            else if (cat === 'lowSavings') messages_lowSavings.splice(idx, 1);
            else messages_streak.splice(idx, 1);

            await db.collection('system_messages').doc('config').set({
                highSpend: messages_highSpend,
                lowSavings: messages_lowSavings,
                streak: messages_streak
            }, { merge: true });

            loadAdminSystemMessagesListUI();
        }

        async function saveSpecialDayConfig() {
            const date = document.getElementById('adminSpecDate').value;
            const title = document.getElementById('adminSpecTitle').value;
            const msg = document.getElementById('adminSpecMsg').value;

            if(!date || !title || !msg) return showAppAlert("TÃ¼m alanlarÄ± doldurun");

            await db.collection('system_config').doc('special_day').set({
                date, title, message: msg
            });
            showAppAlert("Ã–zel gÃ¼n kaydedildi!");
        }

        function openContactModal() {
            document.getElementById('contactMsg').value = '';
            document.getElementById('contactEmail').value = currentUser ? currentUser.email : ''; 
            const modal = document.getElementById('contactModal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('open'), 10);
            document.getElementById('overlay').classList.add('active');
            
            pushPanelHistory();
        }

        function closeContactModal() {
            const modal = document.getElementById('contactModal');
            modal.classList.remove('open');
            setTimeout(() => modal.classList.add('hidden'), 300);
            document.getElementById('overlay').classList.remove('active'); 
            popPanelHistory();
        }

        async function sendContactMessage() {
            const msg = document.getElementById('contactMsg').value.trim();
            const emailInp = document.getElementById('contactEmail').value.trim();

            if (!msg) return showAppAlert("LÃ¼tfen bir mesaj yazÄ±n.");
            
            let senderEmail = "-";
            
            if (currentUser) {
                senderEmail = currentUser.email;
            } else {
                if (!emailInp || !emailInp.includes('@')) {
                    return showAppAlert("LÃ¼tfen geri dÃ¶nÃ¼ÅŸ yapabilmemiz iÃ§in geÃ§erli bir e-posta adresi girin.");
                }
                senderEmail = emailInp;
            }
            
            const btn = document.querySelector('#contactModal button');
            const origText = btn.innerText;
            btn.innerText = "GÃ¶nderiliyor...";
            btn.disabled = true;

            try {
                let sender = "Misafir";
                let uid = "-";

                if (currentUser) {
                    sender = currentUser.displayName || "KullanÄ±cÄ±";
                    uid = currentUser.uid;
                } else {
                    sender = senderEmail.split('@')[0]; 
                }

                await db.collection('messages').add({
                    content: msg,
                    senderName: sender,
                    senderEmail: senderEmail,
                    senderUid: uid,
                    date: new Date().toISOString(),
                    isRead: false
                });

                showAppAlert("MesajÄ±nÄ±z iletildi! TeÅŸekkÃ¼rler.");
                closeContactModal();
            } catch (e) {
                showAppAlert("Hata: " + e.message);
            } finally {
                btn.innerText = origText;
                btn.disabled = false;
            }
        }

        async function loadAdminUsers() {
            const list = document.getElementById('adminUserList');
            list.innerHTML = '<tr><td colspan="2" class="p-4 text-center"><div class="loader"></div></td></tr>';
            try {
                const snap = await db.collection('users').get();
                let totalUsers = 0;
                let totalMoney = 0;
                let html = '';

                snap.forEach(doc => {
                    const d = doc.data();
                    const assets = (d.assets || []).reduce((s,a)=>s+(a.val||0),0);
                    totalMoney += assets;
                    totalUsers++;

                    const name = d.username || d.email;
                    const regDate = d.registrationDate ? new Date(d.registrationDate).toLocaleDateString('tr-TR') : '-';

                    html += `
                    <tr class="border-b border-slate-800 hover:bg-slate-800/50">
                        <td class="py-3 pl-1">
                            <p class="font-bold text-white">${name}</p>
                            <p class="text-[9px] text-slate-500">${d.email}</p>
                            <p class="text-[9px] text-slate-600">KayÄ±t: ${regDate}</p>
                        </td>
                        <td class="py-3 text-right">
                            <button onclick="inspectUser('${doc.id}', '${name}')" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-500 text-xs font-bold shadow-lg shadow-blue-500/20 mr-2"><i class="fas fa-eye"></i></button>
                            <button onclick="deleteUserDoc('${doc.id}', '${name}')" class="bg-red-600 text-white p-2 rounded-lg hover:bg-red-500 text-xs font-bold shadow-lg shadow-red-500/20"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                });

                document.getElementById('adminTotalUsers').innerText = totalUsers;
                document.getElementById('adminTotalMoney').innerText = `â‚º${Math.floor(totalMoney).toLocaleString()}`;
                list.innerHTML = html;

            } catch(e) {
                list.innerHTML = `<tr><td colspan="2" class="text-red-500 p-4">Hata: ${e.message}</td></tr>`;
            }
        }

        async function deleteUserDoc(uid, name) {
            showConfirm(name + " adlÄ± kullanÄ±cÄ±nÄ±n tÃ¼m verileri silinecek?", async () => {
                try {
                    await db.collection('users').doc(uid).delete();
                    showAppAlert("KullanÄ±cÄ± verisi silindi.");
                    loadAdminUsers(); 
                } catch(e) {
                    showAppAlert("Hata: " + e.message);
                }
            });
        }
        
        async function loadAdminMessages() {
            const list = document.getElementById('adminMessageList');
            list.innerHTML = '<div class="text-center p-4"><div class="loader"></div></div>';
            
            try {
                const snap = await db.collection('messages').orderBy('date', 'desc').get();
                if (snap.empty) {
                    list.innerHTML = '<div class="text-center text-slate-500 text-xs p-4">HiÃ§ mesaj yok.</div>';
                    return;
                }
                
                let html = '';
                snap.forEach(doc => {
                    const m = doc.data();
                    const date = new Date(m.date).toLocaleString('tr-TR');
                    
                    html += `
                    <div class="bg-slate-800 p-3 rounded-xl border border-slate-700">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <p class="text-xs font-bold text-white">${m.senderName}</p>
                                <p class="text-[9px] text-slate-400">${m.senderEmail}</p>
                            </div>
                            <span class="text-[9px] text-slate-500">${date}</span>
                        </div>
                        <p class="text-xs text-slate-300 bg-slate-900/50 p-2 rounded-lg leading-relaxed">${m.content}</p>
                    </div>`;
                });
                
                list.innerHTML = html;
            } catch(e) {
                 list.innerHTML = `<div class="text-red-400 text-xs p-4">Hata: ${e.message}</div>`;
            }
        }

        async function inspectUser(targetUid, targetName) {
            if (!originalAdminUid) originalAdminUid = currentUser.uid;
            
            // Paneli asenkron iÅŸlemden Ã¶nce hemen kapatÄ±yoruz ki hem hÄ±zlÄ± hissettirsin hem de PC'de tarayÄ±cÄ± kafasÄ± karÄ±ÅŸmasÄ±n.
            closeAdminPanel();
            document.getElementById('dashWelcome').innerText = "YÃ¼kleniyor...";
            
            try {
                const doc = await db.collection("users").doc(targetUid).get();
                if (doc.exists) {
                    state = doc.data();
                    currentPlanId = targetUid; 
                    currentUserRole = 'owner'; 
                    
                    updateDashboardUI();
                    
                    document.getElementById('adminModeBanner').classList.remove('hidden');
                    document.getElementById('adminInspectName').innerText = targetName;
                    
                    document.getElementById('overlay').classList.remove('active');
                } else {
                    showAppAlert("KullanÄ±cÄ± verisi bulunamadÄ±.");
                    exitAdminInspect();
                }
            } catch(e) { 
                showAppAlert("Hata: " + e.message); 
                exitAdminInspect();
            }
        }

        async function exitAdminInspect() {
            if (originalAdminUid) {
                const doc = await db.collection("users").doc(originalAdminUid).get();
                state = doc.data();
                currentPlanId = originalAdminUid;
                originalAdminUid = null;
                
                document.getElementById('adminModeBanner').classList.add('hidden');
                updateDashboardUI();
            }
        }

        function showLoginScreen() { hideAll(); document.getElementById('loginScreen').classList.remove('hidden'); }
        function showDashboard() { hideAll(); document.getElementById('dashboardScreen').classList.remove('hidden'); updateDashboardUI(); }
        function showAnalysisScreen() { 
            hideAll(); 
            document.getElementById('analysisScreen').classList.remove('hidden'); 
            
            const today = new Date();
            let analysisDate = new Date(today);
            if (today.getDate() < (state.salaryDay || 15)) {
                analysisDate.setMonth(analysisDate.getMonth() - 1);
            }
            const yyyy = analysisDate.getFullYear();
            const mm = String(analysisDate.getMonth() + 1).padStart(2, '0');
            document.getElementById('analysisDateFilter').value = `${yyyy}-${mm}`;
            
            renderCharts(); 
            renderHistoryTable(); 
            renderTrendChart();   
        }

        function scrollToAddExpense() {
            showDashboard();
            const el = document.getElementById('addExpenseSection');
            if(el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => document.getElementById('expAmt').focus(), 500);
            }
        }

        function startAdviceRotator() {
        }

        function checkGamificationStatus() {
            const todayStr = new Date().toLocaleDateString('tr-TR');
            const dailyLimit = state.manualDailyLimit || 0;
            const spentToday = state.expenses.filter(e => e.date === todayStr).reduce((s,e)=>s+e.amount,0);
            
            if (spentToday > dailyLimit && dailyLimit > 0) {
                return getRandomMessage(messages_highSpend, 'highSpend');
            }

            let streak = 0;
            const now = new Date();
            for (let i = 1; i < 30; i++) {
                const d = new Date(); d.setDate(now.getDate() - i);
                const dStr = d.toLocaleDateString('tr-TR');
                const spentThatDay = state.expenses.filter(e => e.date === dStr).reduce((s,e)=>s+e.amount,0);
                if (spentThatDay <= dailyLimit) streak++;
                else break; 
            }
            if (streak >= 3) return getRandomMessage(messages_streak, 'streak');

            const nowTime = new Date();
            let startCalc = new Date(state.registrationDate);
            if(isNaN(startCalc.getTime())) startCalc = new Date();
            
            if (state.expenses.length > 0) {
                let minExpDate = new Date();
                state.expenses.forEach(e => {
                    let dParts = e.date.split('.');
                    if(dParts.length === 3) {
                        let d = new Date(dParts[2], dParts[1]-1, dParts[0]);
                        if (d < minExpDate) minExpDate = d;
                    }
                });
                
                if (minExpDate.getTime() < startCalc.getTime() - (1000 * 60 * 60 * 24)) {
                    const salaryDay = state.salaryDay || 15;
                    let lastSalaryDate = new Date(nowTime.getFullYear(), nowTime.getMonth(), salaryDay);
                    if (nowTime.getDate() < salaryDay) {
                        lastSalaryDate.setMonth(lastSalaryDate.getMonth() - 1);
                    }
                    startCalc = lastSalaryDate;
                }
            }

            const daysPassed = Math.max(1, Math.ceil(Math.abs(nowTime - startCalc) / (1000 * 60 * 60 * 24)));
            const totalSpent = state.expenses.reduce((s,e)=>s+e.amount,0);
            const cumulative = (dailyLimit * daysPassed) - totalSpent;
            
            if (cumulative < -(dailyLimit * 2)) {
                return getRandomMessage(messages_lowSavings, 'lowSavings');
            }

            return getRandomMessage(messages_general, 'general');
        }

        async function initUserPlan() {
            if (!currentUser) return;
            try {
                currentPlanId = currentUser.uid;
                currentUserRole = 'owner';
                
                const userDoc = await db.collection("users").doc(currentUser.uid).get();
                if(!userDoc.exists) {
                    await saveToCloud();
                } else {
                    const userData = userDoc.data();
                    if (userData.connectedPlanId) {
                        currentPlanId = userData.connectedPlanId;
                        if(currentPlanId !== currentUser.uid) {
                            const planDoc = await db.collection("users").doc(currentPlanId).get();
                            if(planDoc.exists) {
                                const planData = planDoc.data();
                                const member = planData.familyMembers ? planData.familyMembers.find(m => m.uid === currentUser.uid) : null;
                                currentUserRole = member ? member.role : 'limited';
                            } else {
                                currentPlanId = currentUser.uid;
                                currentUserRole = 'owner';
                                await db.collection("users").doc(currentUser.uid).update({ connectedPlanId: null });
                            }
                        }
                    }
                }
                loadFromCloud();
            } catch (e) { console.error("Plan Error:", e); }
        }

        function showLoginMode() {
            document.getElementById('loginTitle').innerText = "GiriÅŸ Yap";
            document.getElementById('loginSubtitle').innerText = "HesabÄ±na EriÅŸ";
            document.getElementById('loginBtn').classList.remove('hidden');
            document.getElementById('registerBtn').classList.add('hidden');
            document.getElementById('registerFields').classList.add('hidden');
            document.getElementById('regDailyLimit').classList.add('hidden');
            document.getElementById('emailInput').placeholder = "E-posta";
            document.getElementById('actionButtons').classList.remove('hidden');
            document.getElementById('backToLoginText').classList.add('hidden');
            document.getElementById('forgotPassText').classList.remove('hidden');
        }

        function showRegisterMode() {
            document.getElementById('loginTitle').innerText = "Ailene KatÄ±l";
            document.getElementById('loginSubtitle').innerText = "Davet Kodu Ä°le BaÄŸlan";
            document.getElementById('loginBtn').classList.add('hidden');
            document.getElementById('registerBtn').classList.remove('hidden');
            document.getElementById('registerFields').classList.remove('hidden');
            document.getElementById('regInviteCode').classList.remove('hidden');
            document.getElementById('regDailyLimit').classList.add('hidden');
            document.getElementById('emailInput').placeholder = "E-posta Adresi";
            document.getElementById('actionButtons').classList.add('hidden');
            document.getElementById('backToLoginText').classList.remove('hidden');
            document.getElementById('forgotPassText').classList.add('hidden');
        }

        function showQuickRegisterMode() {
            document.getElementById('loginTitle').innerText = "HÄ±zlÄ± BaÅŸlangÄ±Ã§";
            document.getElementById('loginSubtitle').innerText = "Sadece GÃ¼nlÃ¼k Harcama Takibi";
            document.getElementById('loginBtn').classList.add('hidden');
            document.getElementById('registerBtn').classList.remove('hidden');
            document.getElementById('registerFields').classList.remove('hidden');
            document.getElementById('regInviteCode').classList.add('hidden');
            document.getElementById('regDailyLimit').classList.remove('hidden');
            document.getElementById('emailInput').placeholder = "E-posta Adresi";
            document.getElementById('actionButtons').classList.add('hidden');
            document.getElementById('backToLoginText').classList.remove('hidden');
            document.getElementById('forgotPassText').classList.add('hidden');
        }

        async function firebaseLogin() {
            if(!isFirebaseReady) return;
            const emailInp = document.getElementById('emailInput').value.trim();
            const pass = document.getElementById('passwordInput').value;
            if(!emailInp || !pass) return showAppAlert("AlanlarÄ± doldurun.");
            const btn = document.getElementById('loginBtn');
            const orig = btn.innerHTML; btn.innerHTML = '<div class="loader"></div>';
            
            try {
                let email = emailInp;
                if (!email.includes('@')) {
                    const s = await db.collection('users').where('username', '==', email.toLowerCase()).limit(1).get();
                    if (s.empty) {
                        showAppAlert("KullanÄ±cÄ± adÄ± bulunamadÄ±. LÃ¼tfen e-posta adresinizi deneyin veya kontrol edin.");
                        btn.innerHTML = orig;
                        return;
                    }
                    email = s.docs[0].data().email;
                }
                await auth.signInWithEmailAndPassword(email, pass);
            } catch (e) { showAppAlert("Hata: " + e.message); btn.innerHTML = orig; }
        }

        async function firebaseRegister() {
            if(!isFirebaseReady) return;
            const user = document.getElementById('regUsernameInput').value.trim().toLowerCase();
            const email = document.getElementById('emailInput').value.trim();
            const pass = document.getElementById('passwordInput').value;
            const invite = document.getElementById('regInviteCode').value.trim().toUpperCase();
            
            const isQuickMode = !document.getElementById('regDailyLimit').classList.contains('hidden');
            const dailyLimitVal = parseFloat(document.getElementById('regDailyLimit').value);

            if(!email.includes('@') || !user || !pass) return showAppAlert("AlanlarÄ± doÄŸru doldurun.");
            if(isQuickMode && (!dailyLimitVal || dailyLimitVal <= 0)) return showAppAlert("LÃ¼tfen gÃ¼nlÃ¼k harcama hedefinizi girin.");
            
            const btn = document.getElementById('registerBtn');
            btn.innerHTML = '<div class="loader"></div> LÃ¼tfen Bekleyin...';
            isRegistering = true;
            
            try {
                const cred = await auth.createUserWithEmailAndPassword(email, pass);
                await cred.user.updateProfile({ displayName: user });

                const initState = JSON.parse(JSON.stringify(state)); 
                initState.email = email; initState.username = user;
                if(initState.registrationDate instanceof Date) initState.registrationDate = initState.registrationDate.toISOString();

                if (isQuickMode) {
                    initState.manualDailyLimit = dailyLimitVal;
                    initState.calculatedMonthlyPool = dailyLimitVal * 30;
                    initState.remainingAfterFixed = dailyLimitVal * 30;
                    initState.incomes = [{ name: 'Sanal BÃ¼tÃ§e (HÄ±zlÄ± BaÅŸlangÄ±Ã§)', val: dailyLimitVal * 30 }];
                } else if (invite) {
                    const snap = await db.collection('users').where('inviteCode', '==', invite).get();
                    if (!snap.empty) {
                        const owner = snap.docs[0];
                        initState.connectedPlanId = owner.id;
                        let members = owner.data().familyMembers || [];
                        members.push({ uid: cred.user.uid, name: user, role: 'full' });
                        await db.collection('users').doc(owner.id).update({ familyMembers: members });
                        showAppAlert("Davet kodunuz doÄŸrulandÄ±, plana eklendiniz.");
                    } else showAppAlert("GeÃ§ersiz davet kodu, kendi yeni planÄ±nÄ±z oluÅŸturuldu.");
                }

                await db.collection("users").doc(cred.user.uid).set(initState);
                isRegistering = false; 

                currentUser = cred.user;
                const userDoc = await db.collection("users").doc(cred.user.uid).get();
                if(userDoc.exists && userDoc.data().pendingInvites) window.userInvites = userDoc.data().pendingInvites;
                await initUserPlan();

            } catch (e) { isRegistering = false; showAppAlert("Hata: " + e.message); btn.innerHTML = "Ãœye Ol ve KatÄ±l"; }
        }

        function registerFromWizard() {
            const u = document.getElementById('wizRegName').value.trim();
            const e = document.getElementById('wizRegEmail').value.trim();
            const p = document.getElementById('wizRegPass').value;
            if(!u || !e || !p) return showAppAlert("TÃ¼m alanlarÄ± doldurun.");
            document.getElementById('regUsernameInput').value = u;
            document.getElementById('emailInput').value = e;
            document.getElementById('passwordInput').value = p;
            document.getElementById('regInviteCode').value = ""; 
            firebaseRegister();
        }

        function forgotPassword() {
            const email = document.getElementById('emailInput').value.trim();
            if (!email || !email.includes('@')) return showAppAlert("LÃ¼tfen geÃ§erli bir e-posta giriniz.");
            auth.sendPasswordResetEmail(email).then(() => showAppAlert("BaÄŸlantÄ± gÃ¶nderildi.")).catch(e => showAppAlert(e.message));
        }

        function handleLogout() {
            if(auth.currentUser) {
                showConfirm("HesabÄ±nÄ±zdan Ã§Ä±kÄ±ÅŸ yapmak istediÄŸinize emin misiniz?", () => {
                    auth.signOut().then(() => window.location.reload());
                });
            } else {
                window.location.reload();
            }
        }

        function initiateDeleteAccount() {
            if(currentUserRole !== 'owner') {
                return showAppAlert("Sadece plan yÃ¶neticisi kendi hesabÄ±nÄ± ve planÄ±nÄ± silebilir.");
            }
            showConfirm("HesabÄ±nÄ±zÄ± ve tÃ¼m verilerinizi KALICI OLARAK silmek istediÄŸinize emin misiniz? Bu iÅŸlem geri alÄ±namaz!", () => {
                document.getElementById('deleteAccountPassword').value = '';
                const modal = document.getElementById('deleteAccountModal');
                modal.classList.remove('hidden');
                pushPanelHistory();
            });
        }

        function closeDeleteAccountModal() {
            const modal = document.getElementById('deleteAccountModal');
            modal.classList.add('hidden');
            popPanelHistory();
        }

        async function confirmDeleteAccount() {
            if(!currentUser) return;
            const pass = document.getElementById('deleteAccountPassword').value;
            if(!pass) return showAppAlert("LÃ¼tfen parolanÄ±zÄ± girin.");
            
            const btn = document.getElementById('confirmDeleteBtn');
            const origTxt = btn.innerText;
            btn.innerText = "Siliniyor...";
            btn.disabled = true;

            try {
                const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, pass);
                await currentUser.reauthenticateWithCredential(credential);
                
                await db.collection('users').doc(currentUser.uid).delete();
                await currentUser.delete();
                
                showAppAlert("HesabÄ±nÄ±z ve tÃ¼m verileriniz baÅŸarÄ±yla silindi.");
                setTimeout(() => {
                    window.location.reload();
                }, 1500);

            } catch(error) {
                btn.innerText = origTxt;
                btn.disabled = false;
                if(error.code === 'auth/wrong-password') {
                    showAppAlert("HatalÄ± parola girdiniz.");
                } else {
                    showAppAlert("Hata: " + error.message);
                }
            }
        }

        function openSettingsPanel() {
            if(currentUserRole === 'owner') {
                document.getElementById('settingsCurrentPlanLabel').innerText = "Kendi PlanÄ±nÄ±z (YÃ¶netici)";
                document.getElementById('btnLeavePlan').classList.add('hidden');
            } else {
                document.getElementById('settingsCurrentPlanLabel').innerText = "Ortak Plan (Davetli Ãœye)";
                document.getElementById('btnLeavePlan').classList.remove('hidden');
            }
            document.getElementById('settingsInviteCode').value = '';
            
            const modal = document.getElementById('settingsModal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('open'), 10);
            document.getElementById('overlay').classList.add('active');
            
            pushPanelHistory();
            renderFamilyList();
        }
        function closeSettingsPanel() { 
             const modal = document.getElementById('settingsModal');
             modal.classList.remove('open');
             setTimeout(() => modal.classList.add('hidden'), 300);
             document.getElementById('overlay').classList.remove('active'); 
             popPanelHistory();
        }
        
        async function joinPlanByCode() {
            const code = document.getElementById('settingsInviteCode').value.trim().toUpperCase();
            if(!code) return;
            const snap = await db.collection('users').where('inviteCode', '==', code).get();
            if(snap.empty) return showAppAlert("GeÃ§ersiz davet kodu!");
            const ownerDoc = snap.docs[0];
            if(ownerDoc.id === currentUser.uid) return showAppAlert("Kendi planÄ±nÄ±za katÄ±lamazsÄ±nÄ±z.");
            
            let members = ownerDoc.data().familyMembers || [];
            members = members.filter(m => m.uid !== currentUser.uid);
            members.push({ uid: currentUser.uid, name: currentUser.displayName || currentUser.email.split('@')[0], role: 'full' });
            await db.collection('users').doc(ownerDoc.id).update({ familyMembers: members });
            await db.collection('users').doc(currentUser.uid).update({ connectedPlanId: ownerDoc.id });
            
            showAppAlert("Plana baÅŸarÄ±yla katÄ±ldÄ±nÄ±z!"); 
            setTimeout(() => window.location.reload(), 1500);
        }
        async function leaveCurrentPlan() {
            showConfirm("Mevcut plandan ayrÄ±lmak istediÄŸinize emin misiniz?", async () => {
                const ownerDoc = await db.collection('users').doc(currentPlanId).get();
                if(ownerDoc.exists) {
                    let members = ownerDoc.data().familyMembers || [];
                    members = members.filter(m => m.uid !== currentUser.uid);
                    await db.collection('users').doc(currentPlanId).update({ familyMembers: members });
                }
                await db.collection('users').doc(currentUser.uid).update({ connectedPlanId: null });
                showAppAlert("Plandan ayrÄ±ldÄ±nÄ±z."); 
                setTimeout(() => window.location.reload(), 1500);
            });
        }

        function createInviteCode() {
            if(currentUserRole !== 'owner' && currentUserRole !== 'full') return showAppAlert("Yetkiniz yok.");
            const code = Math.random().toString(36).substring(2, 7).toUpperCase();
            state.inviteCode = code; saveToCloud();
            document.getElementById('displayInviteCode').innerText = code;
        }

        async function addFamilyMember() {
            if(currentUserRole !== 'owner' && currentUserRole !== 'full') return showAppAlert("Yetkiniz yok.");
            const input = document.getElementById('famInput').value.trim().toLowerCase();
            const role = document.getElementById('famRole').value;
            if(!input) return;

            let snap = await db.collection('users').where('username', '==', input).limit(1).get();
            if(snap.empty) snap = await db.collection('users').where('email', '==', input).limit(1).get();
            if(snap.empty) return showAppAlert("KullanÄ±cÄ± sistemde bulunamadÄ±. LÃ¼tfen kayÄ±tlÄ± olduÄŸuna emin olun.");
            
            const target = snap.docs[0];
            if(target.id === currentUser.uid) return showAppAlert("Kendinizi ekleyemezsiniz.");

            await db.collection('users').doc(target.id).update({
                pendingInvites: firebase.firestore.FieldValue.arrayUnion({
                    planId: currentUser.uid,
                    planName: currentUser.displayName || currentUser.email.split('@')[0],
                    role: role
                })
            });
            
            document.getElementById('famInput').value = ''; 
            showAppAlert(`KullanÄ±cÄ±ya davet gÃ¶nderildi! Sisteme giriÅŸ yaptÄ±klarÄ±nda karÅŸÄ±larÄ±na Ã§Ä±kacaktÄ±r.`);
        }

        async function acceptInvite() {
            if(!window.userInvites || window.userInvites.length === 0) return;
            const invite = window.userInvites[0];
            
            const ownerDoc = await db.collection('users').doc(invite.planId).get();
            if(ownerDoc.exists) {
                let members = ownerDoc.data().familyMembers || [];
                members = members.filter(m => m.uid !== currentUser.uid);
                members.push({ uid: currentUser.uid, name: currentUser.displayName || currentUser.email.split('@')[0], role: invite.role });
                await db.collection('users').doc(invite.planId).update({ familyMembers: members });
            }
            
            await db.collection('users').doc(currentUser.uid).update({
                connectedPlanId: invite.planId,
                pendingInvites: firebase.firestore.FieldValue.arrayRemove(invite)
            });
            window.location.reload();
        }

        async function rejectInvite() {
            if(!window.userInvites || window.userInvites.length === 0) return;
            const invite = window.userInvites[0];
            await db.collection('users').doc(currentUser.uid).update({
                pendingInvites: firebase.firestore.FieldValue.arrayRemove(invite)
            });
            window.userInvites.shift();
            updateDashboardUI();
        }

        function renderFamilyList() {
            const list = document.getElementById('familyList');
            if(!state.familyMembers || state.familyMembers.length === 0) {
                list.innerHTML = '<p class="text-gray-400 text-[10px] text-center py-2">HenÃ¼z Ã¼ye yok.</p>'; return;
            }
            
            const canEdit = currentUserRole === 'owner';
            list.innerHTML = state.familyMembers.map((m, i) => `
                <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg text-xs">
                    <p class="font-bold text-gray-800">${m.name}</p>
                    <div class="flex items-center gap-2">
                        ${canEdit ? `
                        <select onchange="changeFamilyRole(${i}, this.value)" class="text-[10px] text-blue-600 font-bold bg-transparent outline-none cursor-pointer">
                            <option value="full" ${m.role==='full'?'selected':''}>Tam Yetki</option>
                            <option value="limited" ${m.role==='limited'?'selected':''}>SÄ±nÄ±rlÄ±</option>
                        </select>
                        <button onclick="removeFamilyMember(${i})" class="text-red-400 hover:text-red-600 ml-1"><i class="fas fa-trash"></i></button>
                        ` : `
                        <span class="text-[10px] text-blue-500 font-bold">${m.role === 'full' ? 'Tam' : 'SÄ±nÄ±rlÄ±'}</span>
                        `}
                    </div>
                </div>`).join('');
        }
        
        function changeFamilyRole(idx, newRole) { state.familyMembers[idx].role = newRole; saveToCloud(); }

        async function removeFamilyMember(idx) {
             const m = state.familyMembers[idx];
             showConfirm(`${m.name} plandan Ã§Ä±karÄ±lacak?`, async () => {
                 await db.collection('users').doc(m.uid).update({ connectedPlanId: null });
                 state.familyMembers.splice(idx, 1);
                 saveToCloud(); renderFamilyList();
             });
        }

        function loadFromCloud() {
            if(!currentUser || !currentPlanId) return;
            db.collection("users").doc(currentPlanId).get().then((doc) => {
                if (doc.exists) {
                    state = doc.data();
                    if(!state.incomes) state.incomes = [];
                    if(!state.bills) state.bills = [];
                    if(!state.loans) state.loans = [];
                    if(!state.debts) state.debts = [];
                    if(!state.otherDebts) state.otherDebts = [];
                    if(!state.assets) state.assets = [];
                    if(!state.expenses) state.expenses = [];
                    if(!state.monthlyHistory) state.monthlyHistory = [];
                    if(!state.familyMembers) state.familyMembers = [];
                    if(!state.reports) state.reports = {}; // Ensure reports object exists
                    
                    if(!state.categories || state.categories.length === 0) {
                        state.categories = ["Market / Manav", "Kasap", "AkaryakÄ±t", "DÄ±ÅŸarÄ±da Yemek", "Eczane / SaÄŸlÄ±k", "EÄŸlence", "EÄŸitim Ã–demeleri", "Vergi / HarÃ§ / Sigorta", "DiÄŸer"];
                    }
                    
                    showDashboard();
                }
            });
        }

        function saveToCloud() {
            if(!currentUser || !currentPlanId) return Promise.resolve();
            return db.collection("users").doc(currentPlanId).set(JSON.parse(JSON.stringify(state)), { merge: true }).then(() => {
                const ind = document.getElementById('saveIndicator');
                ind.style.opacity = '1'; setTimeout(() => ind.style.opacity = '0', 2000);
            });
        }
        function saveState() { if(currentUser && !isRegistering) saveToCloud(); }

        function applyPermissions() {
            const lbl = currentUserRole === 'owner' ? 'Plan Sahibi' : currentUserRole === 'full' ? 'Tam Yetki' : 'SÄ±nÄ±rlÄ± Yetki';
            document.getElementById('roleBadge').innerText = lbl;
            
            const dis = (currentUserRole === 'limited');
            document.getElementById('financialHealthSection').classList.toggle('hidden', dis);
            document.getElementById('btnAnalysis').classList.toggle('hidden', dis);
        }

        function updateDashboardUI() {
            applyPermissions();
            
            const inviteBanner = document.getElementById('inviteBanner');
            if (window.userInvites && window.userInvites.length > 0) {
                inviteBanner.classList.remove('hidden');
                document.getElementById('inviteBannerText').innerText = `${window.userInvites[0].planName} sizi planÄ±na davet ediyor.`;
            } else {
                inviteBanner.classList.add('hidden');
            }

            const now = new Date(); const todayStr = now.toLocaleDateString('tr-TR');
            
            let startCalc;
            const calcMethod = state.balanceCalcMethod || 'register';
            
            const btnSalary = document.getElementById('btnCalcSalary');
            const btnRegister = document.getElementById('btnCalcRegister');
            const btnCustom = document.getElementById('btnCalcCustom');
            const customDateDisplay = document.getElementById('customDateDisplay');
            
            [btnSalary, btnRegister].forEach(btn => {
                btn.className = "text-[7px] font-medium px-2 py-1 rounded-md text-slate-300 transition-all hover:bg-white/10";
            });
            btnCustom.className = "text-[7px] font-medium px-2 py-1 rounded-lg bg-white/5 hover:bg-white/10 text-slate-300 transition-all border border-white/10 pointer-events-none flex items-center gap-1 w-full justify-center";
            
            const activeBtnClass = "text-[7px] font-medium px-2 py-1 rounded-md bg-green-500 text-white shadow-md border border-green-400 transform scale-105";
            const activeCustomBtnClass = "text-[7px] font-medium px-2 py-1 rounded-lg bg-green-500 text-white shadow-md border border-green-400 transform scale-105 pointer-events-none flex items-center gap-1 w-full justify-center";

            let dailyLimitToUse = state.manualDailyLimit || 0;

            if (calcMethod === 'salary') {
                btnSalary.className = activeBtnClass;
                const salaryDay = state.salaryDay || 15;
                let lastSalaryDate = new Date(now.getFullYear(), now.getMonth(), salaryDay);
                if (now.getDate() < salaryDay) {
                    lastSalaryDate.setMonth(lastSalaryDate.getMonth() - 1);
                }
                startCalc = lastSalaryDate;
                startCalc.setHours(0,0,0,0);
            } else if (calcMethod === 'custom') {
                btnCustom.className = activeCustomBtnClass;
                startCalc = new Date(state.customBalanceDate || state.registrationDate);
                if(isNaN(startCalc.getTime())) startCalc = new Date();
                startCalc.setHours(0,0,0,0);
            } else {
                btnRegister.className = activeBtnClass;
                startCalc = new Date(state.registrationDate);
                if(isNaN(startCalc.getTime())) startCalc = new Date();
                startCalc.setHours(0,0,0,0);
            }

            if (startCalc) {
                if (calcMethod !== 'custom') {
                    customDateDisplay.innerText = "SeÃ§";
                } else {
                    customDateDisplay.innerText = startCalc.toLocaleDateString('tr-TR', {day:'2-digit', month:'2-digit', year:'numeric'});
                }
            } else {
                customDateDisplay.innerText = "SeÃ§";
            }

            const daysPassed = Math.max(1, Math.ceil(Math.abs(now - startCalc) / (1000 * 60 * 60 * 24))); 
            
            let totalSpent = 0;
            let spentToday = 0;
            let spentTodayInBudget = 0;
            
            state.expenses.forEach(e => {
                const dParts = e.date.split('.');
                if(dParts.length === 3) {
                    const d = new Date(dParts[2], dParts[1]-1, dParts[0]);
                    d.setHours(0,0,0,0);
                    
                    if (e.date === todayStr) {
                        spentToday += e.amount;
                        spentTodayInBudget += e.amount;
                    }

                    if (d >= startCalc) {
                        totalSpent += e.amount;
                    }
                }
            });

            const cumulative = (dailyLimitToUse * daysPassed) - totalSpent;
            
            document.getElementById('displayDailyLimit').innerText = `â‚º${Math.floor(dailyLimitToUse - spentTodayInBudget).toLocaleString()}`;
            const cumEl = document.getElementById('displayCumulativeLimit');
            cumEl.innerText = `â‚º${Math.floor(cumulative).toLocaleString()}`;
            
            cumEl.classList.remove('text-red-400', 'text-green-400', 'text-white');
            if (cumulative < 0) cumEl.classList.add('text-red-500');
            else if (cumulative > 0) cumEl.classList.add('text-green-500');
            else cumEl.classList.add('text-white');

            document.getElementById('todayTotal').innerText = `BugÃ¼n: â‚º${Math.floor(spentToday).toLocaleString()}`;
            
            let targetDate = new Date(now.getFullYear(), now.getMonth(), state.salaryDay||15);
            if (now.getDate() >= (state.salaryDay||15)) targetDate.setMonth(targetDate.getMonth()+1);
            document.getElementById('displayRemainingDays').innerText = `${Math.ceil((targetDate - now)/(1000*60*60*24))} GÃ¼n`;

            // Hedefi Tutturmak Ä°Ã§in Gereken Hesaplama
            const sd = state.salaryDay || 15;
            let periodStart = new Date(now.getFullYear(), now.getMonth(), sd);
            if (now.getDate() < sd) {
                periodStart.setMonth(periodStart.getMonth() - 1);
            }
            periodStart.setHours(0,0,0,0);
            
            let nextSalaryDate = new Date(periodStart);
            nextSalaryDate.setMonth(nextSalaryDate.getMonth() + 1);
            
            const daysInPeriod = Math.round((nextSalaryDate - periodStart) / (1000 * 60 * 60 * 24));
            const remainingDaysInPeriod = Math.max(1, Math.ceil((nextSalaryDate - now) / (1000 * 60 * 60 * 24)));
            
            let spentInPeriod = 0;
            state.expenses.forEach(e => {
                const dParts = e.date.split('.');
                if(dParts.length === 3) {
                    const d = new Date(dParts[2], dParts[1]-1, dParts[0]);
                    d.setHours(0,0,0,0);
                    if (d >= periodStart && d < nextSalaryDate) {
                        spentInPeriod += e.amount;
                    }
                }
            });

            const totalPeriodBudget = (state.manualDailyLimit || 0) * daysInPeriod;
            const remainingPeriodBudget = totalPeriodBudget - spentInPeriod;
            const requiredDailyLimit = remainingDaysInPeriod > 0 ? (remainingPeriodBudget / remainingDaysInPeriod) : 0;
            
            const reqDailyEl = document.getElementById('displayRequiredDaily');
            reqDailyEl.innerText = `â‚º${Math.floor(requiredDailyLimit).toLocaleString()}`;
            reqDailyEl.classList.remove('text-blue-400', 'text-red-400');
            if (requiredDailyLimit < 0) {
                reqDailyEl.classList.add('text-red-400');
            } else {
                reqDailyEl.classList.add('text-blue-400');
            }

            const assets = state.assets.filter(a => !a.excludeFromNetWorth).reduce((s,a)=>s+(a.val||0),0);
            const loans = state.loans.filter(l=>!l.excludeFromDebt).reduce((s,l)=>s+(l.totalDebt||0),0);
            const cards = state.debts.filter(d => !d.excludeFromNetWorth).reduce((s,d)=>s+(d.val||0),0);
            const others = state.otherDebts.filter(d => !d.excludeFromNetWorth).reduce((s,d)=>s+(d.val||0),0);
            const totalDebt = loans + cards + others;
            const net = assets - totalDebt;
            
            const daysInCurrentMonth = getDaysInCurrentPeriod();
            
            const normalBills = state.bills.reduce((s, b) => s + (b.val||0), 0);
            
            const loansTreatedAsBills = state.loans.filter(l => l.excludeFromDebt && !l.excludeFromBudget).reduce((s, l) => s + (l.monthly || 0), 0);
            const standardLoans = state.loans.filter(l => !l.excludeFromDebt && !l.excludeFromBudget).reduce((s, l) => s + (l.monthly || 0), 0);

            const totalFix = normalBills + loansTreatedAsBills;
            const totalInc = state.incomes.reduce((s, i) => s + (i.val||0), 0);
            
            const grossNet = totalInc - totalFix; 
            const realNet = grossNet - standardLoans;
            
            let monthlySpend = (state.manualDailyLimit || 0) * daysInCurrentMonth;
            
            const calcSavings = Math.max(0, grossNet - monthlySpend);
            
            const totalMonthlyOutflow = totalFix + standardLoans;

            document.getElementById('sumSavings').innerText = `â‚º${Math.floor(calcSavings).toLocaleString()}`;
            document.getElementById('sumGiderTotalHealth').innerText = `â‚º${Math.floor(totalMonthlyOutflow).toLocaleString()}`;
            document.getElementById('netStatusVal').innerText = `${net>=0?'+':'-'}â‚º${Math.abs(Math.floor(net)).toLocaleString()}`;
            
            const healthSection = document.getElementById('financialHealthSection');

            if (net < 0) {
                document.getElementById('netStatusBadge').className = `text-3xl font-black text-red-600 px-6 py-3 bg-white/90 backdrop-blur rounded-[1.5rem] transition-colors shadow-sm border border-red-100`;
                healthSection.classList.remove('bg-white', 'border-blue-50', 'bg-green-50/30', 'border-green-100');
                healthSection.classList.add('bg-red-50/30', 'border-red-100');
            } else {
                document.getElementById('netStatusBadge').className = `text-3xl font-black text-green-600 px-6 py-3 bg-white/90 backdrop-blur rounded-[1.5rem] transition-colors shadow-sm border border-green-100`;
                healthSection.classList.remove('bg-white', 'border-blue-50', 'bg-red-50/30', 'border-red-100');
                healthSection.classList.add('bg-green-50/30', 'border-green-100');
            }

            document.getElementById('displayInviteCode').innerText = state.inviteCode || '-----';
            
            const motivationalMsg = checkGamificationStatus();
            document.getElementById('motivationText').innerText = motivationalMsg;
            document.getElementById('motivationArea').classList.remove('hidden');

            renderFamilyList();
            renderDetailedHealthLists();
            
            updateExpenseDateLabel();
            renderCategoryOptions(); 

            // Otomatik AylÄ±k Rapor KontrolÃ¼
            checkMonthlyReport();
        }
        
        function setBalanceMethod(method) {
            state.balanceCalcMethod = method;
            saveToCloud();
            updateDashboardUI();
        }
        
        function setCustomBalanceDate(val) {
            if(!val) return;
            state.customBalanceDate = val;
            state.balanceCalcMethod = 'custom';
            saveToCloud();
            updateDashboardUI();
        }

        function changeExpenseDate(delta) {
            currentExpenseDateOffset += delta;
            
            if (currentExpenseDateOffset < 0) currentExpenseDateOffset = 0;
            updateExpenseDateLabel();
        }

        function updateExpenseDateLabel() {
            const lbl = document.getElementById('expenseDateLabel');
            const d = new Date();
            d.setDate(d.getDate() - currentExpenseDateOffset);
            
            const options = { day: 'numeric', month: 'long', weekday: 'long' };
            const formattedDate = d.toLocaleDateString('tr-TR', options);
            
            let mainText = "";
            let subText = "";
            
            if (currentExpenseDateOffset === 0) {
                mainText = `BugÃ¼n`;
                subText = `(${formattedDate})`;
            } else if (currentExpenseDateOffset === 1) {
                mainText = `DÃ¼n`;
                subText = `(${formattedDate})`;
            } else {
                const day = d.getDate();
                const monthStr = d.toLocaleDateString('tr-TR', { month: 'long' });
                const dayName = d.toLocaleDateString('tr-TR', { weekday: 'long' });
                mainText = `${day} ${monthStr}`;
                subText = `(${dayName})`;
            }
            
            lbl.innerHTML = `
                <span class="text-[12px] font-black text-red-600 block leading-tight">${mainText}</span>
                <span class="text-[9px] font-bold text-red-400 block leading-tight mt-0.5">${subText}</span>
            `;
            
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            document.getElementById('expDateInputHidden').value = `${yyyy}-${mm}-${dd}`;

            const btnContainer = document.getElementById('returnToTodayBtnContainer');
            if(btnContainer) {
                if (currentExpenseDateOffset > 0) {
                    btnContainer.classList.remove('hidden');
                } else {
                    btnContainer.classList.add('hidden');
                }
            }
            
            renderHistoryList();
        }

        function returnToToday() {
            currentExpenseDateOffset = 0;
            updateExpenseDateLabel();
        }
        
        function setSpecificDate(val) {
            if (!val) return;
            const selected = new Date(val);
            const today = new Date();
            selected.setHours(0,0,0,0);
            today.setHours(0,0,0,0);
            
            const diffTime = today - selected;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            
            if (diffDays >= 0) {
                currentExpenseDateOffset = diffDays;
                updateExpenseDateLabel();
            } else {
                showAppAlert("GeleceÄŸe harcama giremezsiniz!");
                currentExpenseDateOffset = 0;
                updateExpenseDateLabel();
            }
        }

        function renderCategoryOptions() {
            const sel = document.getElementById('expCat');
            if (!state.categories) {
                state.categories = ["Market / Manav", "Kasap", "AkaryakÄ±t", "DÄ±ÅŸarÄ±da Yemek", "Eczane / SaÄŸlÄ±k", "EÄŸlence", "EÄŸitim Ã–demeleri", "Vergi / HarÃ§ / Sigorta", "DiÄŸer"];
            }
            
            sel.innerHTML = state.categories.map(c => `<option value="${c}">${c}</option>`).join('');
            
            const list = document.getElementById('categoryList');
            list.innerHTML = state.categories.map((c, i) => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl">
                    <div class="flex-1">
                        ${editingCategoryIndex === i 
                            ? `<div class="flex gap-2">
                                 <input type="text" id="catEditInput_${i}" value="${c}" class="w-full p-2 border border-blue-200 rounded-lg text-sm" onkeyup="if(event.key==='Enter') saveCategoryEdit(${i})">
                                 <button onclick="saveCategoryEdit(${i})" class="text-green-600 hover:text-green-800"><i class="fas fa-check"></i></button>
                                 <button onclick="cancelCategoryEdit()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                               </div>`
                            : `<span class="text-sm font-bold text-gray-700">${c}</span>`
                        }
                    </div>
                    ${editingCategoryIndex !== i ? 
                    `<div class="flex gap-2">
                        <button onclick="startCategoryEdit(${i})" class="text-blue-400 hover:text-blue-600"><i class="fas fa-pen"></i></button>
                        <button onclick="deleteCategory(${i})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                    </div>` : ''}
                </div>
            `).join('');
        }

        function openCategoryModal() {
            renderCategoryOptions();
            const modal = document.getElementById('categoryModal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('open'), 10);
            document.getElementById('overlay').classList.add('active');
            
            pushPanelHistory();
        }

        function closeCategoryModal() {
            editingCategoryIndex = -1; 
            const modal = document.getElementById('categoryModal');
            modal.classList.remove('open');
            setTimeout(() => modal.classList.add('hidden'), 300);
            document.getElementById('overlay').classList.remove('active');
            renderCategoryOptions(); 
            popPanelHistory();
        }

        function addNewCategory() {
            const inp = document.getElementById('newCatName');
            const val = inp.value.trim();
            if (val && !state.categories.includes(val)) {
                state.categories.push(val);
                inp.value = '';
                saveToCloud();
                renderCategoryOptions();
            }
        }
        
        function startCategoryEdit(idx) {
            editingCategoryIndex = idx;
            renderCategoryOptions();
            setTimeout(() => document.getElementById(`catEditInput_${idx}`).focus(), 50);
        }
        
        function cancelCategoryEdit() {
            editingCategoryIndex = -1;
            renderCategoryOptions();
        }
        
        function saveCategoryEdit(idx) {
            const input = document.getElementById(`catEditInput_${idx}`);
            const newVal = input.value.trim();
            if (newVal && newVal !== state.categories[idx]) {
                const oldVal = state.categories[idx];
                state.categories[idx] = newVal;
                
                state.expenses.forEach(exp => {
                    if (exp.category === oldVal) {
                        exp.category = newVal;
                    }
                });
                
                saveToCloud();
                editingCategoryIndex = -1;
                renderCategoryOptions();
                updateDashboardUI(); 
            } else {
                cancelCategoryEdit();
            }
        }

        function deleteCategory(idx) {
            showConfirm("Bu kategoriyi silmek istediÄŸinize emin misiniz?", () => {
                state.categories.splice(idx, 1);
                saveToCloud();
                renderCategoryOptions();
            });
        }

        const subTypes = {
            'AltÄ±n': ['Gr. (24 Ayar)', 'Gr & Ajda (22 Ayar)', 'Ã‡eyrek', 'YarÄ±m', 'Tam'],
            'DÃ¶viz': ['Dolar', 'Euro', 'GBP', 'Ä°sviÃ§re FrangÄ±'],
            'GÃ¼mÃ¼ÅŸ': ['GÃ¼mÃ¼ÅŸ']
        };

        function toggleInlineAdd(prefix) {
            const container = document.getElementById(`inlineAdd${prefix}Container`);
            const btn = document.getElementById(`btnShow${prefix}Form`);
            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                btn.classList.add('hidden');
                
                if (prefix === 'dashDebt' || prefix === 'wiz_debt') document.getElementById(`${prefix}Type`).value = 'Kredi';
                if (prefix === 'dashAsset' || prefix === 'wiz_asset') document.getElementById(`${prefix}Type`).value = 'DiÄŸer';
                if (prefix === 'wiz_loan') document.getElementById(`${prefix}Type`).value = 'Kredi';
                if (prefix === 'wiz_card') document.getElementById(`${prefix}Type`).value = 'Kredi KartÄ±';
                
                handleInlineTypeChange(prefix);
            }
        }

        function cancelInlineAdd(prefix) {
            document.getElementById(`inlineAdd${prefix}Container`).classList.add('hidden');
            document.getElementById(`btnShow${prefix}Form`).classList.remove('hidden');
        }

        function handleInlineTypeChange(prefix) {
            const typeEl = document.getElementById(`${prefix}Type`);
            const type = typeEl ? typeEl.value : 'DiÄŸer';
            const fieldsDiv = document.getElementById(`${prefix}Fields`);
            if(!fieldsDiv) return;
            
            const cmnCls = "w-full p-2.5 bg-white rounded-lg text-xs font-bold border border-gray-200 outline-none focus:ring-2 focus:ring-blue-100";
            
            let html = '';
            if (type === 'Kredi') {
                html = `<input type="text" id="${prefix}_name" placeholder="Kredi AdÄ±" class="${cmnCls} mb-2">
                        <div class="flex gap-2 mb-2">
                            <input type="number" id="${prefix}_monthly" placeholder="AylÄ±k Taksit" class="${cmnCls} w-1/2" oninput="calcInlineLoan('${prefix}')">
                            <input type="number" id="${prefix}_months" placeholder="Kalan Ay" class="${cmnCls} w-1/2" oninput="calcInlineLoan('${prefix}')">
                        </div>
                        <div class="mb-2">
                            <label class="text-[9px] font-bold text-gray-400 uppercase">SÄ±radaki Taksit Tarihi</label>
                            <input type="date" id="${prefix}_date" class="${cmnCls}">
                        </div>
                        <input type="number" id="${prefix}_total" placeholder="Toplam BorÃ§" class="${cmnCls} mb-2">
                        
                        <div class="space-y-2 bg-red-50 p-2 rounded-lg border border-red-100">
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="${prefix}_incDebt" checked class="w-4 h-4 text-red-600 rounded focus:ring-red-500">
                                <label for="${prefix}_incDebt" class="text-[10px] font-bold text-gray-600">Genel BorÃ§ ToplamÄ±na Eklensin</label>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="${prefix}_incBudget" checked class="w-4 h-4 text-red-600 rounded focus:ring-red-500">
                                <label for="${prefix}_incBudget" class="text-[10px] font-bold text-gray-600">AylÄ±k BÃ¼tÃ§eden (Sabit Gider) DÃ¼ÅŸÃ¼lsÃ¼n</label>
                            </div>
                        </div>`;
            } else if (type === 'Kredi KartÄ±') {
                html = `<input type="text" id="${prefix}_name" placeholder="Kart AdÄ± (Ã–rn: Bonus)" class="${cmnCls} mb-2">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Hesaplama Modu</span>
                            <select id="${prefix}_cc_mode" onchange="toggleInlineCCMode('${prefix}')" class="p-1 bg-blue-50 text-blue-600 rounded text-xs font-bold outline-none border border-blue-100">
                                <option value="manual">Direkt BorÃ§ Gir</option>
                                <option value="limit">Limit - KullanÄ±labilir</option>
                            </select>
                        </div>
                        <div id="${prefix}_cc_manual_div">
                            <input type="number" id="${prefix}_total" placeholder="GÃ¼ncel BorÃ§ (TL)" class="${cmnCls}">
                        </div>
                        <div id="${prefix}_cc_limit_div" class="hidden space-y-2">
                            <div class="flex gap-2">
                                <input type="number" id="${prefix}_cc_limit" placeholder="Kart Limiti" class="${cmnCls} w-1/2" oninput="calcInlineCC('${prefix}')">
                                <input type="number" id="${prefix}_cc_avail" placeholder="KullanÄ±labilir" class="${cmnCls} w-1/2" oninput="calcInlineCC('${prefix}')">
                            </div>
                            <div class="text-right text-xs font-bold text-gray-500">Hesaplanan: <span id="${prefix}_cc_debt_display" class="text-purple-600">0</span> TL</div>
                            <input type="hidden" id="${prefix}_cc_calc_total" value="0">
                        </div>`;
            } else if (type === 'DiÄŸer') {
                html = `<input type="text" id="${prefix}_name" placeholder="Kalem AdÄ±" class="${cmnCls} mb-2">
                        <input type="number" id="${prefix}_total" placeholder="Tutar (TL)" class="${cmnCls}">`;
            } else {
                const options = subTypes[type].map(s => `<option value="${s}">${s}</option>`).join('');
                html = `<select id="${prefix}_sub" class="${cmnCls} mb-2" onchange="fetchInlineRate('${prefix}', '${type}')">${options}</select>
                        <input type="text" id="${prefix}_name" placeholder="Ã–zel Ä°sim (Opsiyonel)" class="${cmnCls} mb-2">
                        <div class="flex gap-2 mb-2">
                            <input type="number" id="${prefix}_amount" placeholder="Miktar (Adet/Gr)" class="${cmnCls} w-1/2" oninput="calcInlineMarket('${prefix}')">
                            <input type="number" step="any" id="${prefix}_rate" placeholder="Birim Kur" class="${cmnCls} w-1/2 border-blue-200" title="Kur" oninput="calcInlineMarket('${prefix}')">
                        </div>
                        <div class="mb-2">
                            <label class="text-[9px] font-bold text-gray-400 uppercase block mb-1">Veya Direkt Toplam Tutar Girin (TL)</label>
                            <input type="number" id="${prefix}_total" placeholder="Toplam Tutar (TL)" class="${cmnCls} border-green-200">
                        </div>`;
                setTimeout(() => fetchInlineRate(prefix, type), 50);
            }
            fieldsDiv.innerHTML = html;
        }

        function toggleInlineCCMode(prefix) {
            const mode = document.getElementById(`${prefix}_cc_mode`).value;
            const manDiv = document.getElementById(`${prefix}_cc_manual_div`);
            const limDiv = document.getElementById(`${prefix}_cc_limit_div`);
            if (mode === 'limit') { manDiv.classList.add('hidden'); limDiv.classList.remove('hidden'); } 
            else { limDiv.classList.add('hidden'); manDiv.classList.remove('hidden'); }
        }

        function calcInlineCC(prefix) {
            const limit = parseFloat(document.getElementById(`${prefix}_cc_limit`).value) || 0;
            const avail = parseFloat(document.getElementById(`${prefix}_cc_avail`).value) || 0;
            const debt = Math.max(0, limit - avail);
            document.getElementById(`${prefix}_cc_calc_total`).value = debt;
            document.getElementById(`${prefix}_cc_debt_display`).innerText = debt.toLocaleString(undefined, {maximumFractionDigits:2});
        }

        function calcInlineLoan(prefix) {
            const monthly = parseFloat(document.getElementById(`${prefix}_monthly`).value) || 0;
            const months = parseFloat(document.getElementById(`${prefix}_months`).value) || 0;
            document.getElementById(`${prefix}_total`).value = monthly * months;
        }

        function calcInlineMarket(prefix) {
            const amount = parseFloat(document.getElementById(`${prefix}_amount`).value) || 0;
            const rate = parseFloat(document.getElementById(`${prefix}_rate`).value) || 0;
            const totalInput = document.getElementById(`${prefix}_total`);
            if(totalInput && amount > 0 && rate > 0) {
                totalInput.value = (amount * rate).toFixed(2);
            }
        }

        const apiMapping = {
            'Gr. (24 Ayar)': 'Gram AltÄ±n', 'Gr & Ajda (22 Ayar)': '22 Ayar Bilezik', 'Ã‡eyrek': 'Ã‡eyrek AltÄ±n', 'YarÄ±m': 'YarÄ±m AltÄ±n', 'Tam': 'Tam AltÄ±n',
            'Dolar': 'USD', 'Euro': 'EUR', 'GBP': 'GBP', 'Ä°sviÃ§re FrangÄ±': 'CHF', 'GÃ¼mÃ¼ÅŸ': 'GÃ¼mÃ¼ÅŸ'
        };

        async function fetchInlineRate(prefix, mainType) {
            const subInput = document.getElementById(`${prefix}_sub`);
            const sub = subInput ? subInput.value : mainType;
            const rateInput = document.getElementById(`${prefix}_rate`);
            if(!rateInput) return;

            rateInput.placeholder = "Kur Ã§ekiliyor...";
            try {
                const res = await fetch('https://finans.truncgil.com/today.json');
                const data = await res.json();
                let rateData = data[apiMapping[sub]]; 
                if(rateData) {
                    let rateStr = rateData.AlÄ±ÅŸ || rateData.SatÄ±ÅŸ; 
                    let rate = parseFloat(rateStr.toString().replace(/\./g, '').replace(',', '.'));
                    rateInput.value = rate;
                    calcInlineMarket(prefix);
                } else {
                    rateInput.placeholder = "Kur bilgisi bulunamadÄ±";
                }
            } catch(e) { rateInput.placeholder = "Kur alÄ±namadÄ±, elle girin"; }
        }

        function saveInlineAdd(prefix) {
            const typeEl = document.getElementById(`${prefix}Type`);
            const type = typeEl ? typeEl.value : 'DiÄŸer';
            
            let finalVal = 0;
            let finalName = document.getElementById(`${prefix}_name`) ? document.getElementById(`${prefix}_name`).value.trim() : '';

            let targetArray = 'otherDebts';
            if (prefix.includes('Asset') || prefix.includes('asset')) targetArray = 'assets';
            if (type === 'Kredi') targetArray = 'loans';
            if (type === 'Kredi KartÄ±') targetArray = 'debts';

            let itemObj = {};

            if (type === 'Kredi') {
                finalName = finalName || 'Kredi';
                const monthly = parseFloat(document.getElementById(`${prefix}_monthly`).value) || 0;
                const months = parseFloat(document.getElementById(`${prefix}_months`).value) || 0;
                finalVal = parseFloat(document.getElementById(`${prefix}_total`).value) || (monthly * months);
                const lDate = document.getElementById(`${prefix}_date`).value || new Date().toISOString().slice(0,10);
                
                const incDebtEl = document.getElementById(`${prefix}_incDebt`);
                const incBudgetEl = document.getElementById(`${prefix}_incBudget`);
                
                const excludeFromDebt = incDebtEl ? !incDebtEl.checked : false;
                const excludeFromBudget = incBudgetEl ? !incBudgetEl.checked : false;

                itemObj = { name: finalName, totalDebt: finalVal, monthly: monthly, totalMonths: months, startDate: lDate, excludeFromBudget: excludeFromBudget, excludeFromDebt: excludeFromDebt };
            } else if (type === 'Kredi KartÄ±') {
                const mode = document.getElementById(`${prefix}_cc_mode`).value;
                if (mode === 'limit') {
                    let limit = parseFloat(document.getElementById(`${prefix}_cc_limit`).value) || 0;
                    let avail = parseFloat(document.getElementById(`${prefix}_cc_avail`).value) || 0;
                    finalVal = Math.max(0, limit - avail);
                    itemObj = { name: finalName || 'Kredi KartÄ±', val: finalVal, calcMode: true, limit: limit, avail: avail };
                } else {
                    finalVal = parseFloat(document.getElementById(`${prefix}_total`).value) || 0;
                    itemObj = { name: finalName || 'Kredi KartÄ±', val: finalVal, calcMode: false };
                }
            } else if (type === 'DiÄŸer') {
                finalVal = parseFloat(document.getElementById(`${prefix}_total`).value) || 0;
                itemObj = { name: finalName || 'DiÄŸer Kalem', val: finalVal };
            } else {
                const sub = document.getElementById(`${prefix}_sub`).value;
                const amount = parseFloat(document.getElementById(`${prefix}_amount`).value) || 0;
                finalVal = parseFloat(document.getElementById(`${prefix}_total`).value) || 0;
                
                if (!finalName) {
                    finalName = amount > 0 ? `${amount} ${sub}` : `${sub}`;
                }
                itemObj = { name: finalName, val: finalVal };
            }

            state[targetArray].unshift(itemObj); 
            saveToCloud();
            
            cancelInlineAdd(prefix);
            if (prefix.startsWith('dash')) updateDashboardUI();
            else renderWizardLists();
        }

        function addExpense() {
            const amtInp = document.getElementById('expAmt');
            const descInp = document.getElementById('expDesc');
            const catInp = document.getElementById('expCat'); 
            const editIndex = parseInt(document.getElementById('editExpIndex').value);
            const amt = parseFloat(amtInp.value);
            
            if(!amt) return amtInp.focus();

            const myStr = currentUser?.displayName || currentUser?.email?.split('@')[0] || 'Ben';
            
            const d = new Date();
            d.setDate(d.getDate() - currentExpenseDateOffset);
            let finalDate = d.toLocaleDateString('tr-TR');
            
            const selectedCat = catInp.value;
            let finalDesc = descInp.value.trim();
            if (!finalDesc && selectedCat !== 'DiÄŸer') {
                finalDesc = selectedCat;
            } else if (!finalDesc) {
                finalDesc = 'DiÄŸer';
            }

            if(editIndex > -1 && currentUserRole === 'limited') {
                if(state.expenses[editIndex].addedBy !== myStr && state.expenses[editIndex].addedBy !== 'Ben') {
                    return showAppAlert("Sadece kendi harcamalarÄ±nÄ±zÄ± dÃ¼zenleyebilirsiniz.");
                }
            }

            if(editIndex > -1) {
                state.expenses[editIndex].amount = amt;
                state.expenses[editIndex].desc = finalDesc;
                state.expenses[editIndex].category = selectedCat; 
                
                document.getElementById('editExpIndex').value = "-1";
                document.getElementById('addExpBtn').innerHTML = '<i class="fas fa-plus text-lg"></i>';
                document.getElementById('addExpBtn').classList.replace('bg-green-600', 'bg-blue-600');
            } else {
                state.expenses.unshift({ 
                    amount: amt, 
                    desc: finalDesc,
                    category: selectedCat, 
                    date: finalDate, 
                    addedBy: myStr, ts: Date.now()
                });

                const now = new Date();
                const expDate = new Date(d); 
                expDate.setHours(0,0,0,0);
                const regDate = new Date(state.registrationDate);
                regDate.setHours(0,0,0,0);

                if (expDate < regDate && state.balanceCalcMethod !== 'salary') {
                    setBalanceMethod('salary');
                    showAppAlert("GeÃ§miÅŸ tarihli iÅŸlem girildiÄŸi iÃ§in hesaplama 'Gelir GÃ¼nÃ¼' moduna alÄ±ndÄ±.");
                }
            }
            
            amtInp.value = ''; descInp.value = ''; 
            updateExpenseDateLabel();
            
            saveToCloud(); updateDashboardUI();
        }
        
        function editExpense(idx) {
            const exp = state.expenses[idx];
            document.getElementById('expAmt').value = exp.amount;
            document.getElementById('expDesc').value = exp.desc;
            const catInp = document.getElementById('expCat');
            if (exp.category) {
                catInp.value = exp.category;
            } else {
                catInp.value = 'DiÄŸer';
            }
            
            document.getElementById('editExpIndex').value = idx;
            document.getElementById('addExpBtn').innerHTML = '<i class="fas fa-check text-lg"></i>';
            document.getElementById('addExpBtn').classList.replace('bg-blue-600', 'bg-green-600');
            scrollToAddExpense();
        }

        function deleteExpense(idx) {
            showConfirm("Bu harcamayÄ± silmek istediÄŸinize emin misiniz?", () => { 
                state.expenses.splice(idx, 1); 
                saveToCloud(); 
                updateDashboardUI(); 
            });
        }

        function renderHistoryList() {
            const list = document.getElementById('historyList');
            if(!list) return;
            
            const myName = currentUser?.displayName || currentUser?.email?.split('@')[0] || 'Ben';
            
            const d = new Date();
            d.setDate(d.getDate() - currentExpenseDateOffset);
            const targetDateStr = d.toLocaleDateString('tr-TR');
            const todayStr = new Date().toLocaleDateString('tr-TR');

            const expensesForDate = state.expenses
                .map((e, i) => ({ ...e, originalIndex: i }))
                .filter(e => e.date === targetDateStr)
                .sort((a, b) => b.ts - a.ts);

            let html = `
            <div class="mb-2">
                <div class="text-center mb-3">
                    <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest bg-gray-100 px-3 py-1 rounded-lg">
                        ${targetDateStr === todayStr ? 'BugÃ¼nkÃ¼ Harcamalar' : targetDateStr + ' HarcamalarÄ±'}
                    </span>
                </div>
                <div class="space-y-2">`;
            
            if (expensesForDate && expensesForDate.length > 0) {
                expensesForDate.forEach(e => {
                    const canEdit = currentUserRole === 'owner' || currentUserRole === 'full' || e.addedBy === myName || e.addedBy === 'Ben';
                    const initials = e.addedBy.substring(0, 2).toUpperCase();
                    html += `
                        <div class="flex justify-between items-center p-2.5 bg-white border border-gray-100 rounded-xl hover:shadow-md transition-all group">
                            <div class="flex items-center gap-2">
                                <div class="w-7 h-7 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 font-black text-[10px] uppercase border border-gray-200">
                                    ${initials}
                                </div>
                                <div>
                                    <p class="font-black text-gray-800 text-xs">${e.desc}</p>
                                    <p class="text-[9px] text-gray-400 font-bold uppercase tracking-wide">
                                        ${e.category && e.category !== 'DiÄŸer' ? `<span class="bg-blue-50 text-blue-600 px-1 rounded mr-1">${e.category}</span>` : ''} 
                                        ${e.addedBy}
                                    </p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="font-black text-red-500 text-sm">-â‚º${Math.floor(e.amount).toLocaleString()}</span>
                                ${canEdit ? `<div class="flex gap-1"><button onclick="editExpense(${e.originalIndex})" class="text-blue-300 hover:text-blue-500"><i class="fas fa-pen text-xs"></i></button><button onclick="deleteExpense(${e.originalIndex})" class="text-gray-200 hover:text-red-500"><i class="fas fa-trash-alt text-xs"></i></button></div>` : ''}
                            </div>
                        </div>`;
                });
            } else {
                html += `<div class="text-center text-gray-400 text-xs py-4 italic">Bu tarihte harcama yok.</div>`;
            }
            html += `</div></div>`;
            list.innerHTML = html;
        }

        function renderDetailedHealthLists() { 
            const createRow = (name, amount, type, idx, extraClass='', clickAction='', isExcluded=false) => {
                const isFaded = (!amount || amount === 0);
                const fadeClass = isFaded ? 'opacity-40 grayscale hover:opacity-100 hover:grayscale-0 transition-all' : '';
                
                return `
                <div class="flex justify-between items-center p-2.5 rounded-xl text-[10px] font-bold text-gray-600 bg-gray-50 border border-gray-100 shadow-sm group ${extraClass} ${isExcluded ? 'opacity-50 grayscale' : ''} ${fadeClass}" ${clickAction ? `onclick="${clickAction}" style="cursor:pointer"` : ''}>
                    <span>${name}</span>
                    <div class="flex items-center gap-2">
                        <span class="font-black text-gray-800 text-xs">â‚º${Math.floor(amount || 0).toLocaleString()}</span>
                        <div class="flex gap-1 opacity-60 group-hover:opacity-100 transition-opacity">
                            <button onclick="event.stopPropagation(); openEditModal('${type}', ${idx})" class="text-blue-400 hover:text-blue-600"><i class="fas fa-pen text-xs"></i></button>
                            ${idx !== 'total' ? `<button onclick="event.stopPropagation(); deleteHealthItem('${type}', ${idx})" class="text-red-300 hover:text-red-500"><i class="fas fa-trash text-xs"></i></button>` : ''}
                        </div>
                    </div>
                </div>`; 
            };
            
            const activeBills = state.bills; 
            const totalBills = activeBills.reduce((s, b) => s + (b.val||0), 0);
            const billsHTML = activeBills.map((b) => createRow(b.name, b.val||0, 'bills', state.bills.indexOf(b), 'bg-white')).join('');
            
            const billsAccordion = `
            <div class="border border-blue-100 rounded-2xl overflow-hidden bg-blue-50/50 shadow-sm mb-4">
                <div onclick="document.getElementById('billsDetails').classList.toggle('open');" class="flex justify-between items-center p-3 cursor-pointer hover:bg-blue-100/50 transition-colors">
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center"><i class="fas fa-file-invoice-dollar text-xs"></i></div>
                        <span class="text-[10px] font-black text-blue-900 uppercase tracking-wide">AylÄ±k Sabit Giderler</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="font-black text-blue-900 text-sm">â‚º${totalBills.toLocaleString()}</span>
                        <i class="fas fa-chevron-down text-blue-400 text-xs"></i>
                    </div>
                </div>
                <div id="billsDetails" class="health-detail space-y-2 px-3 pb-3">
                    ${billsHTML || '<div class="text-[10px] text-gray-400 text-center py-2">KayÄ±tlÄ± sabit gider yok.</div>'}
                    <button onclick="addNewHealthItem('bills')" class="w-full py-2 text-[10px] font-bold text-blue-500 hover:text-blue-700 bg-white border border-dashed border-blue-200 rounded-xl transition-colors">+ Yeni Sabit Gider Ekle</button>
                </div>
            </div>`;
            document.getElementById('fixedExpensesSection').innerHTML = billsAccordion;

            let debtHTML = ''; 
            
            const activeLoans = state.loans;
            const totalLoanDebt = activeLoans.reduce((s,l) => s + (l.excludeFromDebt ? 0 : (l.totalDebt||0)), 0);
            
            if (activeLoans.length > 0) {
                 const loansHTML = activeLoans.map(l => {
                    const isExcluded = l.excludeFromDebt;
                    return createRow(l.name + (isExcluded ? ' <span class="text-[8px] text-red-400 font-bold ml-1 bg-red-50 px-1 rounded">(Dahil DeÄŸil)</span>' : ''), l.totalDebt||0, 'loans', state.loans.indexOf(l), 'bg-white', `openLoanPlanModal(${state.loans.indexOf(l)})`, isExcluded);
                 }).join('');

                 debtHTML += `
                 <div class="border border-red-100 rounded-2xl overflow-hidden bg-red-50/50 shadow-sm mb-2">
                    <div onclick="document.getElementById('loanDetails').classList.toggle('open');" class="flex justify-between items-center p-2.5 cursor-pointer hover:bg-red-100/50 transition-colors">
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 bg-red-100 text-red-600 rounded-full flex items-center justify-center"><i class="fas fa-hand-holding-usd text-xs"></i></div>
                            <span class="text-[9px] font-black text-red-900 uppercase tracking-wide">Toplam Kredi Borcu</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="font-black text-red-900 text-xs">â‚º${totalLoanDebt.toLocaleString()}</span>
                            <i class="fas fa-chevron-down text-red-400 text-xs"></i>
                        </div>
                    </div>
                    <div id="loanDetails" class="health-detail space-y-2 px-2.5 pb-2.5">
                        ${loansHTML}
                    </div>
                </div>`;
            }

            const activeCards = state.debts;
            const totalCardDebt = activeCards.reduce((s,d) => s + (d.excludeFromNetWorth ? 0 : (d.val||0)), 0);
            
            if (activeCards.length > 0) {
                 const cardsHTML = activeCards.map(d => createRow(d.name + (d.excludeFromNetWorth ? ' <span class="text-[8px] text-red-400 font-bold ml-1 bg-red-50 px-1 rounded">(Dahil DeÄŸil)</span>' : ''), d.val||0, 'debts', state.debts.indexOf(d), 'bg-white', '', d.excludeFromNetWorth)).join('');
                 
                 debtHTML += `
                 <div class="border border-purple-100 rounded-2xl overflow-hidden bg-purple-50/50 shadow-sm mb-2">
                    <div onclick="document.getElementById('cardDetails').classList.toggle('open');" class="flex justify-between items-center p-2.5 cursor-pointer hover:bg-purple-100/50 transition-colors">
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center"><i class="fas fa-credit-card text-xs"></i></div>
                            <span class="text-[9px] font-black text-purple-900 uppercase tracking-wide">Kredi KartlarÄ± ToplamÄ±</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="font-black text-purple-900 text-xs">â‚º${totalCardDebt.toLocaleString()}</span>
                            <i class="fas fa-chevron-down text-purple-400 text-xs"></i>
                        </div>
                    </div>
                    <div id="cardDetails" class="health-detail space-y-2 px-2.5 pb-2.5">
                        ${cardsHTML}
                    </div>
                </div>`;
            }

            const sortedOtherDebts = [...state.otherDebts].sort((a,b) => (b.val||0) - (a.val||0));
            sortedOtherDebts.forEach((d) => {
                 const originalIndex = state.otherDebts.indexOf(d);
                 debtHTML += createRow(d.name + (d.excludeFromNetWorth ? ' <span class="text-[8px] text-red-400 font-bold ml-1 bg-red-50 px-1 rounded">(Dahil DeÄŸil)</span>' : ''), d.val||0, 'otherDebts', originalIndex, '', '', d.excludeFromNetWorth);
            }); 
            
            document.getElementById('detailedDebtsList').innerHTML = debtHTML || '<span class="text-gray-300 text-[10px]">KayÄ±tlÄ± borÃ§ yok</span>'; 
            
            const sortedAssets = [...state.assets].sort((a,b) => (b.val||0) - (a.val||0));
            let assetHTML = sortedAssets.map((a) => {
                const originalIndex = state.assets.indexOf(a);
                return createRow(a.name + (a.excludeFromNetWorth ? ' <span class="text-[8px] text-red-400 font-bold ml-1 bg-red-50 px-1 rounded">(Dahil DeÄŸil)</span>' : ''), a.val||0, 'assets', originalIndex, '', '', a.excludeFromNetWorth);
            }).join(''); 
            document.getElementById('detailedAssetsList').innerHTML = assetHTML || '<span class="text-gray-300 text-[10px]">KayÄ±tlÄ± varlÄ±k yok</span>'; 
        }

        function addNewHealthItem(type) { 
            const name = prompt("Yeni Kalem AdÄ±:"); 
            if(name) { 
                const val = parseFloat(prompt("Tutar:")) || 0; 
                let newItem = {name, val:val};
                if(type === 'loans') newItem = {name, totalDebt:val, monthly:0, totalMonths:1, startDate: new Date().toISOString().slice(0,10)};
                else if(type === 'debts') newItem = {name, val:val, calcMode: false};
                
                state[type].unshift(newItem); 
                saveToCloud(); updateDashboardUI(); 
            } 
        }
        
        function openEditModal(type, index) { 
            const item = state[type][index]; 
            document.getElementById('editItemName').value = item.name; 
            document.getElementById('editItemVal').value = item.val || item.totalDebt || 0; 
            document.getElementById('editItemType').value = type; 
            document.getElementById('editItemIndex').value = index; 
            
            const chk = document.getElementById('editExcludeNetWorth');
            if (type === 'loans') chk.checked = item.excludeFromDebt || false;
            else chk.checked = item.excludeFromNetWorth || false;
            
            const loanSpecificContainer = document.getElementById('editLoanSpecificContainer');
            const loanContainer = document.getElementById('editLoanContainer');
            const ccContainer = document.getElementById('editCCLimitContainer');
            
            loanSpecificContainer.classList.add('hidden');
            loanContainer.classList.add('hidden');
            ccContainer.classList.add('hidden');

            if (type === 'loans') {
                loanSpecificContainer.classList.remove('hidden');
                document.getElementById('editExcludeBudget').checked = item.excludeFromBudget || false;
                
                loanContainer.classList.remove('hidden');
                document.getElementById('editLoanMonthly').value = item.monthly || 0;
                document.getElementById('editLoanMonths').value = item.totalMonths || 0;
                document.getElementById('editLoanDate').value = item.startDate || '';
            } 
            else if (type === 'debts' && item.calcMode) {
                ccContainer.classList.remove('hidden');
                document.getElementById('editCCLimit').value = item.limit || 0;
                document.getElementById('editCCAvail').value = item.avail || 0;
            }
            
            const modal = document.getElementById('editItemModal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('open'), 10);
            document.getElementById('overlay').classList.add('active'); 
            
            pushPanelHistory();
        }
        
        function calcEditLoan() {
            const m = parseFloat(document.getElementById('editLoanMonthly').value) || 0;
            const c = parseFloat(document.getElementById('editLoanMonths').value) || 0;
            document.getElementById('editItemVal').value = m * c;
        }
        
        function calcEditCC() {
            const l = parseFloat(document.getElementById('editCCLimit').value) || 0;
            const a = parseFloat(document.getElementById('editCCAvail').value) || 0;
            document.getElementById('editItemVal').value = Math.max(0, l - a);
        }
        
        function saveEditedItem() { 
            const type = document.getElementById('editItemType').value; 
            const idx = parseInt(document.getElementById('editItemIndex').value); 
            const name = document.getElementById('editItemName').value; 
            const val = parseFloat(document.getElementById('editItemVal').value); 
            const excluded = document.getElementById('editExcludeNetWorth').checked;

            if(state[type][idx]) { 
                state[type][idx].name = name; 
                
                if(type === 'loans') {
                    state[type][idx].totalDebt = val; 
                    state[type][idx].excludeFromDebt = excluded;
                    state[type][idx].excludeFromBudget = document.getElementById('editExcludeBudget').checked;
                    
                    state[type][idx].monthly = parseFloat(document.getElementById('editLoanMonthly').value) || 0;
                    state[type][idx].totalMonths = parseFloat(document.getElementById('editLoanMonths').value) || 0;
                    state[type][idx].startDate = document.getElementById('editLoanDate').value;
                } else if (type === 'debts') {
                    state[type][idx].val = val;
                    state[type][idx].excludeFromNetWorth = excluded;
                    
                    if (state[type][idx].calcMode) {
                        state[type][idx].limit = parseFloat(document.getElementById('editCCLimit').value) || 0;
                        state[type][idx].avail = parseFloat(document.getElementById('editCCAvail').value) || 0;
                    }
                } else { 
                    state[type][idx].val = val; 
                    state[type][idx].excludeFromNetWorth = excluded;
                }
                
                saveToCloud(); 
                
                if (!document.getElementById('wizardScreen').classList.contains('hidden')) {
                    renderWizardLists();
                } else {
                    updateDashboardUI();
                }
                
                closeEditModal(); 
            } 
        }
        function closeEditModal() { 
            const modal = document.getElementById('editItemModal');
            modal.classList.remove('open');
            setTimeout(() => modal.classList.add('hidden'), 300);
            document.getElementById('overlay').classList.remove('active'); 
            popPanelHistory();
        }
        function deleteHealthItem(type, idx) { 
            showConfirm('Bu kalemi tamamen silmek istediÄŸinize emin misiniz?', () => { 
                state[type].splice(idx, 1); 
                saveToCloud(); 
                updateDashboardUI(); 
            }); 
        }

        function renderCharts() {
            const ctx1 = document.getElementById('assetsChart').getContext('2d');
            const ctx2 = document.getElementById('expensesChart').getContext('2d');
            if(assetsChartInstance) assetsChartInstance.destroy();
            if(expensesChartInstance) expensesChartInstance.destroy();
            
            const filterVal = document.getElementById('analysisDateFilter').value; 
            let filteredExpenses = state.expenses;
            
            if (filterVal) {
                const [year, month] = filterVal.split('-').map(Number);
                const salaryDay = state.salaryDay || 15;
                
                const startDate = new Date(year, month - 1, salaryDay);
                const endDate = new Date(year, month, salaryDay);
                
                const startStr = startDate.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
                const endStr = new Date(endDate - 1).toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
                document.getElementById('analysisPeriodLabel').innerText = `DÃ¶nem: ${startStr} - ${endStr}`;
                document.getElementById('analysisMonthDisplay').innerText = formatPeriodMonth(filterVal);
                
                filteredExpenses = state.expenses.filter(e => {
                    const parts = e.date.split('.'); 
                    const d = new Date(parts[2], parts[1] - 1, parts[0]);
                    return d >= startDate && d < endDate;
                });
            }

            const assets = state.assets.reduce((s,a)=>s+(a.val||0),0);
            const debts = state.loans.filter(l=>!l.excludeFromDebt).reduce((s,l)=>s+(l.totalDebt||0),0) + state.debts.reduce((s,d)=>s+(d.val||0),0) + state.otherDebts.reduce((s,d)=>s+(d.val||0),0);
            
            const expenseMap = {};
            filteredExpenses.forEach(e => {
                let key = e.category; 
                if (!key || key === 'DiÄŸer') {
                    key = 'DiÄŸer / Ã–zel';
                }
                expenseMap[key] = (expenseMap[key] || 0) + e.amount; 
            });

            const sortedKeys = Object.keys(expenseMap).sort((a,b) => expenseMap[b] - expenseMap[a]);
            const sortedData = sortedKeys.map(k => expenseMap[k]);

            assetsChartInstance = new Chart(ctx1, { type: 'doughnut', data: { labels: ['VarlÄ±klar', 'BorÃ§lar'], datasets: [{ data: [assets, debts], backgroundColor: ['#22c55e', '#ef4444'], borderWidth: 0 }] }, options: { cutout: '70%', plugins: { legend: { position: 'bottom' } } } });
            expensesChartInstance = new Chart(ctx2, { 
                type: 'bar', 
                data: { 
                    labels: sortedKeys.slice(0, 8), 
                    datasets: [{ 
                        label: 'Harcama', 
                        data: sortedData.slice(0, 8), 
                        backgroundColor: '#3b82f6', 
                        borderRadius: 5 
                    }] 
                }, 
                options: { 
                    scales: { y: { beginAtZero: true } }, 
                    plugins: { legend: { display: false } } 
                } 
            });
        }

        function switchChartMode(mode) {
            trendMode = mode;
            const btnTL = document.getElementById('btnChartTL');
            const btnUSD = document.getElementById('btnChartUSD');
            
            if (mode === 'TL') {
                btnTL.className = "text-[9px] font-bold px-2 py-1 rounded bg-blue-100 text-blue-600";
                btnUSD.className = "text-[9px] font-bold px-2 py-1 rounded bg-gray-100 text-gray-500 hover:bg-green-100 hover:text-green-600";
            } else {
                btnTL.className = "text-[9px] font-bold px-2 py-1 rounded bg-gray-100 text-gray-500 hover:bg-blue-100 hover:text-blue-600";
                btnUSD.className = "text-[9px] font-bold px-2 py-1 rounded bg-green-100 text-green-600";
            }
            renderTrendChart();
        }

        function switchChartRange(range) {
            trendRange = range;
            document.getElementById('btnRange6').className = "text-[9px] font-bold px-2 py-1 rounded hover:bg-white hover:shadow-sm text-gray-500 transition-all " + (range === '6' ? 'bg-white shadow-sm text-gray-800 border border-gray-100' : '');
            document.getElementById('btnRange12').className = "text-[9px] font-bold px-2 py-1 rounded hover:bg-white hover:shadow-sm text-gray-500 transition-all " + (range === '12' ? 'bg-white shadow-sm text-gray-800 border border-gray-100' : '');
            document.getElementById('btnRangeAll').className = "text-[9px] font-bold px-2 py-1 rounded hover:bg-white hover:shadow-sm text-gray-500 transition-all " + (range === 'all' ? 'bg-white shadow-sm text-gray-800 border border-gray-100' : '');
            
            renderTrendChart();
        }

        function renderTrendChart() {
            const ctx = document.getElementById('historyTrendChart').getContext('2d');
            if (trendChartInstance) trendChartInstance.destroy();

            let sortedHistory = [...state.monthlyHistory].sort((a, b) => {
                return a.date.localeCompare(b.date);
            });

            if (trendRange === '6') {
                sortedHistory = sortedHistory.slice(-6);
            } else if (trendRange === '12') {
                sortedHistory = sortedHistory.slice(-12);
            }

            const labels = sortedHistory.map(h => formatPeriodMonth(h.date));
            
            const data = sortedHistory.map(h => {
                let val = (h.assets || 0) - (h.debts || 0);
                if (trendMode === 'USD' && h.usdRate && h.usdRate > 0) {
                    val = val / h.usdRate;
                }
                return val;
            });

            const bgColors = data.map(v => v >= 0 ? '#22c55e' : '#ef4444');

            trendChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: trendMode === 'TL' ? 'Net VarlÄ±k (TL)' : 'Net VarlÄ±k ($)',
                        data: data,
                        backgroundColor: bgColors,
                        borderRadius: 5
                    }]
                },
                options: {
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return (trendMode === 'USD' ? '$' : 'â‚º') + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) {
                                        label += (trendMode === 'USD' ? '$' : 'â‚º') + context.parsed.y.toLocaleString(undefined, {maximumFractionDigits: 0});
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        function addHistoryRecord() {
            const date = document.getElementById('histDate').value; 
            const assets = parseFloat(document.getElementById('histAssets').value); 
            const debts = parseFloat(document.getElementById('histDebts').value);
            const rate = parseFloat(document.getElementById('histUSDRate').value);

            if(!date) return showAppAlert("Tarih seÃ§in");
            
            state.monthlyHistory.push({
                date, 
                assets: assets||0, 
                debts: debts||0,
                usdRate: rate||0 
            }); 
            
            saveToCloud(); 
            showAppAlert("KayÄ±t Eklendi");
            
            document.getElementById('histDate').value = '';
            document.getElementById('histAssets').value = '';
            document.getElementById('histDebts').value = '';
            document.getElementById('histUSDRate').value = '';
            
            renderHistoryTable();
            renderTrendChart();
        }

        function renderHistoryTable() {
            const tbody = document.getElementById('historyTableBody');
            if(!tbody) return;
            
            const sorted = [...state.monthlyHistory].sort((a,b) => b.date.localeCompare(a.date));
            
            tbody.innerHTML = sorted.map((h, i) => {
                const originalIndex = state.monthlyHistory.findIndex(item => item === h);
                return `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-2">${formatPeriodMonth(h.date)}</td>
                    <td class="py-2 text-right text-green-600">â‚º${(h.assets||0).toLocaleString()}</td>
                    <td class="py-2 text-right text-red-600">â‚º${(h.debts||0).toLocaleString()}</td>
                    <td class="py-2 text-right text-blue-600">${h.usdRate ? '$'+h.usdRate : '-'}</td>
                    <td class="py-2 text-center">
                        <button onclick="deleteHistoryItem(${originalIndex})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `}).join('');
        }

        function deleteHistoryItem(index) {
            showConfirm("Bu geÃ§miÅŸ kaydÄ± silmek istediÄŸinize emin misiniz?", () => {
                state.monthlyHistory.splice(index, 1);
                saveToCloud();
                renderHistoryTable();
                renderTrendChart();
            });
        }

        function openLoanPlanModal(loanIndex) {
            const loan = state.loans[loanIndex];
            if (!loan) return;
            document.getElementById('loanPlanTitle').innerText = loan.name;
            const tbody = document.getElementById('loanPlanBody');
            tbody.innerHTML = '';
            
            let currentDate = new Date(loan.startDate || new Date());
            const monthly = loan.monthly || 0;
            const totalMonths = loan.totalMonths || 0;
            const now = new Date();

            for(let i=1; i<=totalMonths; i++) {
                const dateStr = currentDate.toLocaleDateString('tr-TR', { month: 'long', year: 'numeric', day: 'numeric' });
                const isPaid = currentDate < now && (currentDate.getMonth() !== now.getMonth() || currentDate.getFullYear() !== now.getFullYear());
                
                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-100 last:border-0 hover:bg-red-50 transition-colors";
                tr.innerHTML = `
                    <td class="py-3 pl-2">${i}/${totalMonths}</td>
                    <td class="py-3">${dateStr}</td>
                    <td class="py-3 text-right">â‚º${Math.floor(monthly).toLocaleString()}</td>
                    <td class="py-3 text-center"><span class="${isPaid ? 'text-green-500 bg-green-50' : 'text-gray-400 bg-gray-100'} px-2 py-1 rounded text-[10px] uppercase font-black tracking-wider">${isPaid ? 'Ã–dendi' : 'Bekliyor'}</span></td>
                `;
                tbody.appendChild(tr);
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
            
            const modal = document.getElementById('loanPlanModal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('open'), 10);
            document.getElementById('overlay').classList.add('active');
            
            pushPanelHistory();
        }

        function closeLoanPlanModal() {
            const modal = document.getElementById('loanPlanModal');
            modal.classList.remove('open');
            setTimeout(() => modal.classList.add('hidden'), 300);
            document.getElementById('overlay').classList.remove('active'); 
            popPanelHistory();
        }

        function openBalanceModal() {
            const now = new Date(); const todayStr = now.toLocaleDateString('tr-TR');
            
            let startCalc;
            const calcMethod = state.balanceCalcMethod || 'register';
            
            const btnSalary = document.getElementById('btnCalcSalary');
            const btnRegister = document.getElementById('btnCalcRegister');
            const btnCustom = document.getElementById('btnCalcCustom');
            const customDateDisplay = document.getElementById('customDateDisplay');
            
            [btnSalary, btnRegister].forEach(btn => {
                btn.className = "text-[7px] font-medium px-2 py-1 rounded-md text-slate-300 transition-all hover:bg-white/10";
            });
            btnCustom.className = "text-[7px] font-medium px-2 py-1 rounded-lg bg-white/5 hover:bg-white/10 text-slate-300 transition-all border border-white/10 pointer-events-none flex items-center gap-1 w-full justify-center";
            
            const activeBtnClass = "text-[7px] font-medium px-2 py-1 rounded-md bg-green-500 text-white shadow-md border border-green-400 transform scale-105";
            const activeCustomBtnClass = "text-[7px] font-medium px-2 py-1 rounded-lg bg-green-500 text-white shadow-md border border-green-400 transform scale-105 pointer-events-none flex items-center gap-1 w-full justify-center";

            let dailyLimitToUse = state.manualDailyLimit || 0;

            if (calcMethod === 'salary') {
                btnSalary.className = activeBtnClass;
                const salaryDay = state.salaryDay || 15;
                let lastSalaryDate = new Date(now.getFullYear(), now.getMonth(), salaryDay);
                if (now.getDate() < salaryDay) {
                    lastSalaryDate.setMonth(lastSalaryDate.getMonth() - 1);
                }
                startCalc = lastSalaryDate;
                startCalc.setHours(0,0,0,0);
            } else if (calcMethod === 'custom') {
                btnCustom.className = activeCustomBtnClass;
                startCalc = new Date(state.customBalanceDate || state.registrationDate);
                if(isNaN(startCalc.getTime())) startCalc = new Date();
                startCalc.setHours(0,0,0,0);
            } else if (calcMethod === 'recovery') {
                startCalc = new Date(state.recoveryStartDate || state.registrationDate);
                if(isNaN(startCalc.getTime())) startCalc = new Date();
                startCalc.setHours(0,0,0,0);
                dailyLimitToUse = state.recoveryDailyLimit || state.manualDailyLimit || 0;
            } else {
                btnRegister.className = activeBtnClass;
                startCalc = new Date(state.registrationDate);
                if(isNaN(startCalc.getTime())) startCalc = new Date();
                startCalc.setHours(0,0,0,0);
            }

            if (startCalc) {
                if (calcMethod === 'recovery') {
                    customDateDisplay.innerText = "SeÃ§";
                } else {
                    customDateDisplay.innerText = startCalc.toLocaleDateString('tr-TR', {day:'2-digit', month:'2-digit', year:'numeric'});
                }
            } else {
                customDateDisplay.innerText = "SeÃ§";
            }

            const daysPassed = Math.max(1, Math.ceil(Math.abs(now - startCalc) / (1000 * 60 * 60 * 24))); 
            
            let totalSpent = 0;
            const spentToday = state.expenses.filter(e => e.date === todayStr).reduce((s,e)=>s+e.amount,0);
            
            state.expenses.forEach(e => {
                const dParts = e.date.split('.');
                if(dParts.length === 3) {
                    const d = new Date(dParts[2], dParts[1]-1, dParts[0]);
                    d.setHours(0,0,0,0);
                    
                    if (calcMethod === 'recovery' && state.recoveryStartTs) {
                        if (e.ts >= state.recoveryStartTs) {
                            totalSpent += e.amount;
                        }
                    } else {
                        if (d >= startCalc) {
                            totalSpent += e.amount;
                        }
                    }
                }
            });

            let isSalaryBased = (calcMethod === 'salary');
            let isRecovery = (calcMethod === 'recovery');

            const accumulatedLimit = dailyLimitToUse * daysPassed;
            const balance = accumulatedLimit - totalSpent;

            const html = `
                <div class="space-y-4">
                    ${isRecovery ? `
                    <div class="bg-blue-100 text-blue-800 p-3 rounded-xl border border-blue-200 text-center mb-2 animate-pulse">
                        <i class="fas fa-magic"></i> <strong>Hedefe DÃ¶nÃ¼ÅŸ (Kurtarma) Modu Aktif</strong>
                    </div>
                    ` : ''}
                    <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100 text-center">
                        <p class="text-[10px] font-bold text-blue-400 uppercase tracking-widest mb-1">Åžu Anki Durum</p>
                        <p class="text-3xl font-black ${balance >= 0 ? 'text-green-600' : 'text-red-600'}">â‚º${Math.floor(balance).toLocaleString()}</p>
                    </div>
                    
                    <div class="space-y-3 pt-2">
                        <div class="flex justify-between items-center text-xs font-bold text-gray-600 border-b border-gray-100 pb-2">
                            <span>Hesap BaÅŸlangÄ±cÄ±</span>
                            <span class="text-gray-800">${startCalc.toLocaleDateString('tr-TR')} ${isSalaryBased ? '<span class="text-[9px] bg-yellow-100 text-yellow-700 px-1 rounded ml-1">MaaÅŸ GÃ¼nÃ¼</span>' : (isRecovery ? '<span class="text-[9px] bg-blue-100 text-blue-700 px-1 rounded ml-1">BugÃ¼n (Kurtarma)</span>' : (calcMethod === 'custom' ? '<span class="text-[9px] bg-blue-100 text-blue-700 px-1 rounded ml-1">Ã–zel Tarih</span>' : '<span class="text-[9px] bg-gray-100 text-gray-500 px-1 rounded ml-1">KayÄ±t Tarihi</span>'))}</span>
                        </div>
                        <div class="flex justify-between items-center text-xs font-bold text-gray-600 border-b border-gray-100 pb-2">
                            <span>GeÃ§en GÃ¼n</span>
                            <span class="text-gray-800">${daysPassed} GÃ¼n</span>
                        </div>
                        <div class="flex justify-between items-center text-xs font-bold text-green-600 border-b border-gray-100 pb-2">
                            <span>Biriken Limit (${daysPassed} x â‚º${Math.floor(dailyLimitToUse)})</span>
                            <span>+ â‚º${Math.floor(accumulatedLimit).toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-center text-xs font-bold text-red-500 border-b border-gray-100 pb-2">
                            <span>Toplam Harcanan</span>
                            <span>- â‚º${Math.floor(totalSpent).toLocaleString()}</span>
                        </div>
                    </div>

                    <div class="p-3 bg-gray-50 rounded-xl text-[10px] text-gray-500 leading-relaxed">
                        <p><strong>GerÃ§ek Bakiye MantÄ±ÄŸÄ±:</strong><br>
                        Sistem, belirlediÄŸiniz gÃ¼nlÃ¼k limiti her yeni gÃ¼nde kumbaranÄ±za ekler. HarcamalarÄ±nÄ±z bu kumbaradan dÃ¼ÅŸÃ¼lÃ¼r. Kalan tutar, ay sonuna kadar "fazladan" harcayabileceÄŸiniz veya biriktirebileceÄŸiniz net tutardÄ±r.</p>
                        ${isSalaryBased ? '<p class="mt-2 text-blue-500">Not: GeÃ§miÅŸe dÃ¶nÃ¼k harcama girdiÄŸiniz iÃ§in hesaplama son maaÅŸ gÃ¼nÃ¼nÃ¼zden baÅŸlatÄ±lmÄ±ÅŸtÄ±r.</p>' : ''}
                        ${isRecovery ? '<p class="mt-2 text-blue-500">Not: Hedefe DÃ¶nÃ¼ÅŸ Modunda, plana baÅŸladÄ±ÄŸÄ±nÄ±z <strong>saniyeden Ã¶nceki</strong> tÃ¼m harcamalar geÃ§miÅŸte bÄ±rakÄ±lÄ±r. Bakiye sadece bu andan sonraki harcamalarÄ±nÄ±zla hesaplanÄ±r.</p>' : ''}
                    </div>
                </div>
            `;
            
            document.getElementById('balanceModalContent').innerHTML = html;
            const modal = document.getElementById('balanceModal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('open'), 10);
            document.getElementById('overlay').classList.add('active');
            
            pushPanelHistory();
        }

        function closeBalanceModal() {
            const modal = document.getElementById('balanceModal');
            modal.classList.remove('open');
            setTimeout(() => modal.classList.add('hidden'), 300);
            document.getElementById('overlay').classList.remove('active'); 
            popPanelHistory();
        }
        
        function openRecoveryPlanModal(customStartDateStr = null) {
            const now = new Date();
            let startCalcDate;

            // EÄŸer Ã¶zel bir tarih seÃ§ildiyse onu kullan, yoksa varsayÄ±lan maaÅŸ gÃ¼nÃ¼nÃ¼ hesapla
            if (typeof customStartDateStr === 'string' && customStartDateStr.trim() !== '') {
                startCalcDate = new Date(customStartDateStr);
            } else {
                const salaryDay = state.salaryDay || 15;
                startCalcDate = new Date(now.getFullYear(), now.getMonth(), salaryDay);
                if (now.getDate() < salaryDay) {
                    startCalcDate.setMonth(startCalcDate.getMonth() - 1);
                }
            }
            startCalcDate.setHours(0,0,0,0);
            
            let nextSalaryDate = new Date(startCalcDate);
            nextSalaryDate.setMonth(nextSalaryDate.getMonth() + 1);
            
            const daysInMonth = Math.round((nextSalaryDate - startCalcDate) / (1000 * 60 * 60 * 24));
            const remainingDays = Math.max(1, Math.ceil((nextSalaryDate - now) / (1000 * 60 * 60 * 24)));
            
            let spentSinceSalary = 0;
            state.expenses.forEach(e => {
                const parts = e.date.split('.');
                if(parts.length === 3) {
                    const d = new Date(parts[2], parts[1]-1, parts[0]);
                    d.setHours(0,0,0,0);
                    if (d >= startCalcDate && d < nextSalaryDate) {
                        spentSinceSalary += e.amount;
                    }
                }
            });

            const totalBudget = (state.manualDailyLimit || 0) * daysInMonth;
            const remainingBudget = totalBudget - spentSinceSalary;
            
            let newDailyLimit = remainingBudget / remainingDays;
            
            const startStrForInput = `${startCalcDate.getFullYear()}-${String(startCalcDate.getMonth()+1).padStart(2,'0')}-${String(startCalcDate.getDate()).padStart(2,'0')}`;
            
            let html = '';
            if (newDailyLimit <= 0) {
                html = `
                    <div class="text-center space-y-4">
                        <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-2 shadow-inner"><i class="fas fa-exclamation-triangle text-2xl"></i></div>
                        <h3 class="text-xl font-black text-gray-800 tracking-tight">Hedef AÅŸÄ±lmÄ±ÅŸ</h3>
                        
                        <div class="flex justify-between items-center text-xs font-bold text-gray-600 border-b border-gray-100 pb-2 mb-2 text-left">
                            <span>DÃ¶nem BaÅŸlangÄ±cÄ±:</span>
                            <label class="relative overflow-hidden inline-flex cursor-pointer items-center">
                                <input type="date" value="${startStrForInput}" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20" onchange="openRecoveryPlanModal(this.value)">
                                <button class="bg-gray-100 px-2 py-0.5 rounded text-gray-800 flex items-center gap-1 shadow-sm">${startCalcDate.toLocaleDateString('tr-TR')} <i class="fas fa-edit text-[9px] text-gray-400"></i></button>
                            </label>
                        </div>

                        <p class="text-xs text-gray-500 font-bold leading-relaxed bg-gray-50 p-4 rounded-xl">SeÃ§ili dÃ¶nemdeki toplam harcama hedefinizi (<strong class="text-gray-800">â‚º${Math.floor(totalBudget).toLocaleString()}</strong>) Ã§oktan aÅŸmÄ±ÅŸsÄ±nÄ±z. (Åžu ana kadar harcanan: <strong class="text-red-500">â‚º${Math.floor(spentSinceSalary).toLocaleString()}</strong>)</p>
                        <p class="text-[10px] text-gray-400 font-bold">Bu dÃ¶nem hedefi tutturmak iÃ§in maalesef harcama bÃ¼tÃ§eniz kalmadÄ±. Birikim hedeflerinizden kÄ±smak veya ek gelir yaratmak gerekebilir.</p>
                        <button onclick="closeRecoveryPlanModal()" class="w-full py-3 bg-gray-100 text-gray-600 font-black rounded-xl text-xs hover:bg-gray-200 transition-colors mt-2">AnladÄ±m</button>
                    </div>
                `;
            } else {
                html = `
                    <div class="space-y-4">
                        <div class="text-center mb-4">
                            <div class="w-16 h-16 bg-blue-100 text-blue-500 rounded-full flex items-center justify-center mx-auto mb-2 shadow-inner"><i class="fas fa-bullseye text-2xl"></i></div>
                            <h3 class="text-xl font-black text-gray-800 tracking-tight mb-1">Hedefe DÃ¶nÃ¼ÅŸ PlanÄ±</h3>
                            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Kalan GÃ¼nler Ä°Ã§in Rota</p>
                        </div>

                        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-5 rounded-[2rem] border border-blue-100 text-center shadow-inner">
                            <p class="text-[10px] font-bold text-blue-500 uppercase tracking-widest mb-2">Hedef Ä°Ã§in GÃ¼nlÃ¼k Limitiniz</p>
                            <p class="text-4xl font-black text-blue-600 tracking-tighter">â‚º${Math.floor(newDailyLimit).toLocaleString()}</p>
                        </div>
                        
                        <div class="space-y-2 pt-2 bg-white p-4 rounded-2xl border border-gray-100 shadow-sm">
                            <div class="flex justify-between items-center text-xs font-bold text-gray-600 border-b border-gray-50 pb-2">
                                <span>DÃ¶nem BaÅŸlangÄ±cÄ±</span>
                                <label class="relative overflow-hidden inline-flex cursor-pointer items-center">
                                    <input type="date" value="${startStrForInput}" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20" onchange="openRecoveryPlanModal(this.value)">
                                    <button class="bg-gray-100 px-2 py-0.5 rounded text-gray-800 flex items-center gap-1 shadow-sm">${startCalcDate.toLocaleDateString('tr-TR')} <i class="fas fa-edit text-[9px] text-gray-400"></i></button>
                                </label>
                            </div>
                            <div class="flex justify-between items-center text-xs font-bold text-gray-600 border-b border-gray-50 pb-2">
                                <span>DÃ¶nem Sonuna Kalan</span>
                                <span class="text-gray-800 bg-gray-100 px-2 py-0.5 rounded">${remainingDays} GÃ¼n</span>
                            </div>
                            <div class="flex justify-between items-center text-xs font-bold text-gray-600 border-b border-gray-50 pb-2">
                                <span>TÃ¼m DÃ¶nem BÃ¼tÃ§esi</span>
                                <span class="text-gray-800">â‚º${Math.floor(totalBudget).toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-xs font-bold text-red-500 border-b border-gray-50 pb-2">
                                <span>Harcanan</span>
                                <span>- â‚º${Math.floor(spentSinceSalary).toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-xs font-black text-green-600 pt-1">
                                <span>Kalan BÃ¼tÃ§e</span>
                                <span class="bg-green-50 px-2 py-0.5 rounded">â‚º${Math.floor(remainingBudget).toLocaleString()}</span>
                            </div>
                        </div>

                        <p class="text-[10px] text-gray-500 bg-yellow-50/50 p-4 rounded-xl leading-relaxed border border-yellow-100 font-bold">
                            <i class="fas fa-info-circle text-yellow-500 mr-1"></i> <strong>NasÄ±l Ã‡alÄ±ÅŸÄ±r?</strong><br>EÄŸer "Plana Aktar" derseniz, <strong class="text-red-500">ÅŸu saniyeye kadar olan</strong> tÃ¼m harcamalarÄ±nÄ±z ana bÃ¼tÃ§eden dÃ¼ÅŸÃ¼lerek geÃ§miÅŸte bÄ±rakÄ±lÄ±r. <strong class="text-blue-600">Bu andan itibaren</strong> dÃ¶nem sonuna kadar her gÃ¼n <strong>â‚º${Math.floor(newDailyLimit).toLocaleString()}</strong> harcayarak hedefinizi tutturabilirsiniz.
                        </p>

                        <button onclick="applyRecoveryPlan(${newDailyLimit})" class="w-full py-4 bg-blue-600 text-white font-black rounded-xl text-xs hover:bg-blue-700 shadow-xl shadow-blue-200 active:scale-95 transition-all flex items-center justify-center gap-2 mt-2">
                            <i class="fas fa-magic"></i> Plana Aktar (Åžu Andan Ä°tibaren)
                        </button>
                    </div>
                `;
            }
            
            document.getElementById('recoveryPlanContent').innerHTML = html;
            const modal = document.getElementById('recoveryPlanModal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('open'), 10);
            document.getElementById('overlay').classList.add('active');
            pushPanelHistory();
        }
        
        function closeRecoveryPlanModal() {
            const modal = document.getElementById('recoveryPlanModal');
            modal.classList.remove('open');
            setTimeout(() => modal.classList.add('hidden'), 300);
            document.getElementById('overlay').classList.remove('active'); 
            popPanelHistory();
        }
        
        function applyRecoveryPlan(limit) {
            state.balanceCalcMethod = 'recovery';
            state.recoveryDailyLimit = limit;
            state.recoveryStartDate = new Date().toISOString();
            state.recoveryStartTs = Date.now(); // TÄ±klanÄ±lan anlÄ±k zaman damgasÄ± eklendi.
            saveToCloud();
            
            closeRecoveryPlanModal();
            updateDashboardUI();
            showAppAlert("Hedefe DÃ¶nÃ¼ÅŸ planÄ±nÄ±z baÅŸarÄ±yla aktif edildi! GÃ¼nlÃ¼k limitiniz kalan gÃ¼nlere gÃ¶re gÃ¼ncellendi.");
        }

        function startWizard(isEditMode) {
            hideAll(); document.getElementById('wizardScreen').classList.remove('hidden');
            if(!isEditMode) { state = JSON.parse(JSON.stringify(defaultState)); state.registrationDate = new Date().toISOString(); }
            state.step = 1; renderWizard();
        }
        
        function wizardNext() { 
            if (state.step === 8) { 
                if(document.getElementById('wizRegEmail')) {
                    const u = document.getElementById('wizRegName').value.trim();
                    const e = document.getElementById('wizRegEmail').value.trim();
                    const p = document.getElementById('wizRegPass').value;
                    if(!u || !e || !p) {
                         showAppAlert("TÃ¼m alanlarÄ± doldurun.");
                         return;
                    }
                    registerFromWizard(); 
                } else { 
                    saveState(); 
                    showDashboard(); 
                } 
                return; 
            } 
            state.step++; renderWizard(); 
        } 

        function wizardBack() { if (state.step > 1) { state.step--; renderWizard(); } else { if(currentUser) showDashboard(); else showLoginScreen(); } }
        
        function getStandardLoans() {
             return state.loans.filter(l => !l.excludeFromDebt && !l.excludeFromBudget).reduce((s, l) => s + (l.monthly || 0), 0);
        }

        function renderWizardLists() {
            const keys = ["", "incomes", "bills", "loans", "debts", "otherDebts", "assets"];
            const key = keys[state.step];
            if (!key) return; 

            const container = document.getElementById(`wiz_${key}_list`);
            if (!container) return;

            if (state[key].length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 text-xs py-4">HenÃ¼z kalem eklenmedi.</div>';
                return;
            }

            let html = '';
            state[key].forEach((item, i) => {
                let valDisplay = '';
                let inputHtml = '';

                const isFaded = !item.val && item.val !== 0; 
                const fadeClass = isFaded ? 'opacity-40 grayscale' : '';

                if (key === 'loans') {
                    valDisplay = `â‚º${Math.floor(item.totalDebt).toLocaleString()}`;
                    inputHtml = `
                        <div class="flex-1">
                            <p class="font-bold text-gray-700 text-xs">${item.name}</p>
                            <p class="text-[9px] text-gray-400">${item.totalMonths} Ay x â‚º${item.monthly}</p>
                        </div>
                        <input type="number" id="wiz_loan_t_${i}" value="${Math.ceil(item.totalDebt)}" onchange="updateLoanData(${i}, 'totalDebt', this.value)" class="w-20 p-2 bg-white border rounded-lg text-xs font-bold text-right outline-none">
                    `;
                } else if (key === 'debts') {
                    valDisplay = `â‚º${Math.floor(item.val).toLocaleString()}`;
                    inputHtml = `
                        <div class="flex-1">
                            <p class="font-bold text-gray-700 text-xs">${item.name}</p>
                            ${item.limit ? `<p class="text-[9px] text-gray-400">Limit: â‚º${item.limit}</p>` : ''}
                        </div>
                        <input type="number" value="${item.val}" onchange="state.debts[${i}].val=parseFloat(this.value)||0; saveState();" class="w-20 p-2 bg-white border rounded-lg text-xs font-bold text-right outline-none">
                    `;
                } else {
                    valDisplay = `â‚º${Math.floor(item.val).toLocaleString()}`;
                    inputHtml = `
                        <input type="text" value="${item.name}" placeholder="Kalem Ä°smi" onchange="state.${key}[${i}].name=this.value; saveState();" class="flex-1 p-2 bg-white border rounded-lg text-xs font-bold outline-none mr-2">
                        <input type="number" value="${item.val}" placeholder="0" onchange="state.${key}[${i}].val=parseFloat(this.value)||0; saveState();" class="w-24 p-2 bg-white border rounded-lg text-xs font-bold text-right outline-none">
                    `;
                }

                html += `
                    <div class="flex items-center gap-2 mb-2 bg-gray-50 p-2 rounded-xl border border-gray-100 ${fadeClass} hover:opacity-100 hover:grayscale-0 transition-all">
                        ${inputHtml}
                        <button onclick="openEditModal('${key}', ${i})" class="w-8 h-8 flex items-center justify-center bg-blue-50 text-blue-500 rounded-lg hover:bg-blue-100 transition-colors mr-1"><i class="fas fa-pen text-xs"></i></button>
                        <button onclick="removeItem('${key}', ${i})" class="w-8 h-8 flex items-center justify-center bg-red-50 text-red-500 rounded-lg hover:bg-red-100 transition-colors"><i class="fas fa-trash text-xs"></i></button>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function addSimpleWizItem(key, listId) {
            state[key].push({ name: '', val: null }); 
            saveState();
            renderWizardLists();
        }

        function renderWizard() {
            const content = document.getElementById('wizardContent');
            document.getElementById('stepCount').innerText = `${state.step}/8`;
            document.getElementById('wizardProgress').innerHTML = Array(8).fill(0).map((_,i) => `<div class="h-1.5 flex-1 rounded-full ${i+1<=state.step?'bg-blue-600':'bg-gray-200'} transition-all"></div>`).join('');
            
            if(state.step === 8) {
                if(!currentUser) {
                    content.innerHTML = `<div class="text-center mb-6"><h3 class="text-2xl font-black">PlanÄ±n HazÄ±r!</h3></div><div class="space-y-4"><input type="text" id="wizRegName" class="w-full p-4 bg-gray-50 rounded-2xl border" placeholder="KullanÄ±cÄ± AdÄ±"><input type="email" id="wizRegEmail" class="w-full p-4 bg-gray-50 rounded-2xl border" placeholder="E-posta"><input type="password" id="wizRegPass" class="w-full p-4 bg-gray-50 rounded-2xl border" placeholder="Åžifre"></div>`;
                    document.getElementById('wizNextBtn').innerText = "KaydÄ± Tamamla";
                } else {
                    content.innerHTML = `<div class="text-center py-10"><h3 class="text-2xl font-black text-gray-800">TamamlandÄ±</h3></div>`; document.getElementById('wizNextBtn').innerText = "PlanÄ± GÃ¼ncelle";
                }
            } else if(state.step === 7) {
                const totalInc = state.incomes.reduce((s, i) => s + (i.val||0), 0);
                const normalBills = state.bills.reduce((s, b) => s + (b.val||0), 0);
                const loansTreatedAsBills = state.loans.filter(l => l.excludeFromDebt && !l.excludeFromBudget).reduce((s, l) => s + (l.monthly || 0), 0);
                const totalFix = normalBills + loansTreatedAsBills;
                const standardLoans = getStandardLoans();
                
                const grossNet = totalInc - totalFix; 
                const realNet = grossNet - standardLoans;
                const daysInMonth = getDaysInCurrentPeriod();

                state.remainingAfterFixed = grossNet; 
                if(!state.manualDailyLimit) state.manualDailyLimit = Math.max(0, grossNet / daysInMonth);
                
                content.innerHTML = `
                    <h3 class="text-xl font-black mb-2">BÃ¼tÃ§e PlanÄ±</h3>
                    <div class="text-center mb-6">
                        <p class="text-gray-400 text-[10px] uppercase tracking-widest">DaÄŸÄ±tÄ±labilir Gelir</p>
                        <div class="flex items-center justify-center gap-2">
                             <p class="text-3xl font-black text-blue-600">â‚º${Math.floor(grossNet).toLocaleString()}</p>
                             <button onclick="openCalcModal()" class="text-[10px] bg-blue-100 text-blue-600 px-2 py-1 rounded-lg font-bold hover:bg-blue-200 transition-colors">Detay</button>
                        </div>
                        
                        ${standardLoans > 0 ? `<div class="mt-4 p-3 bg-red-50 border border-red-100 rounded-xl text-left shadow-sm">
                            <div class="flex items-center gap-2 mb-1"><i class="fas fa-info-circle text-red-400"></i><span class="text-[10px] font-bold text-red-400 uppercase">Bilgilendirme</span></div>
                            <p class="text-[10px] text-gray-600 font-medium leading-relaxed">Kredi Ã¶demeleriniz borÃ§tan dÃ¼ÅŸÃ¼leceÄŸinden bu hesabÄ±n iÃ§indedir. Kredileriniz Ã¶dendikten sonra kalan net tutarÄ±nÄ±z: <span class="text-red-600 font-black text-xs">â‚º${Math.floor(realNet).toLocaleString()}</span></p>
                        </div>` : ''}
                    </div>
                    <div class="space-y-6">
                        <div class="p-4 bg-white border border-gray-200 rounded-[2rem] shadow-sm text-center">
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 block">GÃ¼nlÃ¼k Harcama Hedefi</label>
                            <input type="number" id="idealDailyLimitInput" oninput="updateFromDailyLimitInput(this.value)" class="w-32 text-center text-3xl font-black text-blue-600 border-b-2 outline-none pb-2" placeholder="0">
                            <span class="text-[9px] text-gray-300 font-bold block mt-1">(Bu ay ${daysInMonth} gÃ¼n Ã¼zerinden hesaplanÄ±yor)</span>
                        </div>
                        <div class="space-y-2"><div class="flex justify-between text-[10px] font-bold text-gray-500"><span>Birikim %</span><span>Harcama %</span></div><input type="range" id="allocationSlider" min="0" max="100" oninput="handleSliderChange(this.value)" class="w-full h-3 bg-gray-200 rounded-lg cursor-pointer"></div>
                        <div class="flex justify-between gap-4">
                            <div class="flex-1 text-center p-3 bg-green-50 rounded-2xl"><p class="text-[9px] font-bold text-green-400 block mb-1">AYLIK BÄ°RÄ°KÄ°M</p><div class="relative"><span class="absolute left-2 top-1.5 text-green-700 font-bold">â‚º</span><input type="number" id="manualSavingsInput" oninput="updateFromSavingsInput(this.value)" class="w-full bg-transparent text-center font-black text-lg text-green-700 outline-none pl-4" placeholder="0"></div></div>
                            <div class="flex-1 text-center p-3 bg-blue-50 rounded-2xl"><p class="text-[9px] font-bold text-blue-400 block mb-1">AYLIK HARCAMA</p><div class="relative"><span class="absolute left-2 top-1.5 text-blue-700 font-bold">â‚º</span><input type="number" id="allocSpendingInput" oninput="updateFromSpendingInput(this.value)" class="w-full bg-transparent text-center font-black text-lg text-blue-700 outline-none pl-4" placeholder="0"></div></div>
                        </div>
                    </div>`;
                setTimeout(() => applyAllocationFromLimit(state.manualDailyLimit), 50); document.getElementById('wizNextBtn').innerText = "Devam Et";
            } else {
                const titles = ["", "Gelirler", "Sabit Giderler", "Banka Kredileri", "Kredi KartlarÄ±", "DiÄŸer BorÃ§lar", "VarlÄ±klar"];
                const colors = ["", "green", "red", "red", "purple", "red", "green"]; const keys = ["", "incomes", "bills", "loans", "debts", "otherDebts", "assets"]; const key = keys[state.step];
                
                const iconHtml = (state.step === 1) ? `<i class="fas fa-wallet text-green-500 mr-2 text-xl"></i>` : '';
                
                content.innerHTML = `<h3 class="text-xl font-black mb-4 text-${colors[state.step]}-600 flex items-center">${iconHtml} ${titles[state.step]}</h3><div id="wiz_${key}_list" class="custom-scrollbar overflow-y-auto max-h-[300px] mb-4"></div>`;
                
                if (state.step === 3) {
                    content.innerHTML += `<button id="btnShowwiz_loanForm" onclick="toggleInlineAdd('wiz_loan')" class="w-full py-3 border-2 border-dashed border-red-200 rounded-2xl text-red-500 font-bold text-xs">+ Yeni Kredi Ekle</button><div id="inlineAddwiz_loanContainer" class="hidden p-4 border border-red-100 bg-red-50 rounded-xl space-y-3"><input type="hidden" id="wiz_loanType" value="Kredi"><div id="wiz_loanFields" class="space-y-2"></div><div class="flex gap-2"><button onclick="cancelInlineAdd('wiz_loan')" class="flex-1 py-2 bg-white text-gray-600 rounded-lg text-xs font-bold border">Ä°ptal</button><button onclick="saveInlineAdd('wiz_loan')" class="flex-1 py-2 bg-red-500 text-white rounded-lg text-xs font-black">Ekle</button></div></div>`;
                } else if (state.step === 4) {
                    content.innerHTML += `<button id="btnShowwiz_cardForm" onclick="toggleInlineAdd('wiz_card')" class="w-full py-3 border-2 border-dashed border-purple-200 rounded-2xl text-purple-500 font-bold text-xs">+ Yeni Kart Ekle</button><div id="inlineAddwiz_cardContainer" class="hidden p-4 border border-purple-100 bg-purple-50 rounded-xl space-y-3"><input type="hidden" id="wiz_cardType" value="Kredi KartÄ±"><div id="wiz_cardFields" class="space-y-2"></div><div class="flex gap-2"><button onclick="cancelInlineAdd('wiz_card')" class="flex-1 py-2 bg-white text-gray-600 rounded-lg text-xs font-bold border">Ä°ptal</button><button onclick="saveInlineAdd('wiz_card')" class="flex-1 py-2 bg-purple-500 text-white rounded-lg text-xs font-black">Ekle</button></div></div>`;
                } else if (state.step === 5) {
                    content.innerHTML += `<button id="btnShowwiz_debtForm" onclick="toggleInlineAdd('wiz_debt')" class="w-full py-3 border-2 border-dashed border-red-200 rounded-2xl text-red-500 font-bold text-xs">+ Yeni BorÃ§ Ekle</button><div id="inlineAddwiz_debtContainer" class="hidden p-4 border border-red-100 bg-red-50 rounded-xl space-y-3"><select id="wiz_debtType" onchange="handleInlineTypeChange('wiz_debt')" class="w-full p-2.5 bg-white rounded-lg text-xs font-bold border border-gray-200 outline-none"><option value="DiÄŸer">DiÄŸer (Standart TL)</option><option value="AltÄ±n">AltÄ±n</option><option value="DÃ¶viz">DÃ¶viz</option><option value="GÃ¼mÃ¼ÅŸ">GÃ¼mÃ¼ÅŸ</option></select><div id="wiz_debtFields" class="space-y-2"></div><div class="flex gap-2"><button onclick="cancelInlineAdd('wiz_debt')" class="flex-1 py-2 bg-white text-gray-600 rounded-lg text-xs font-bold border">Ä°ptal</button><button onclick="saveInlineAdd('wiz_debt')" class="flex-1 py-2 bg-red-500 text-white rounded-lg text-xs font-black">Ekle</button></div></div>`;
                } else if (state.step === 6) {
                    content.innerHTML += `<button id="btnShowwiz_assetForm" onclick="toggleInlineAdd('wiz_asset')" class="w-full py-3 border-2 border-dashed border-green-200 rounded-2xl text-green-500 font-bold text-xs">+ Yeni VarlÄ±k Ekle</button><div id="inlineAddwiz_assetContainer" class="hidden p-4 border border-green-100 bg-green-50 rounded-xl space-y-3"><select id="wiz_assetType" onchange="handleInlineTypeChange('wiz_asset')" class="w-full p-2.5 bg-white rounded-lg text-xs font-bold border border-gray-200 outline-none"><option value="DiÄŸer">DiÄŸer (Standart TL)</option><option value="AltÄ±n">AltÄ±n</option><option value="DÃ¶viz">DÃ¶viz</option><option value="GÃ¼mÃ¼ÅŸ">GÃ¼mÃ¼ÅŸ</option></select><div id="wiz_assetFields" class="space-y-2"></div><div class="flex gap-2"><button onclick="cancelInlineAdd('wiz_asset')" class="flex-1 py-2 bg-white text-gray-600 rounded-lg text-xs font-bold border">Ä°ptal</button><button onclick="saveInlineAdd('wiz_asset')" class="flex-1 py-2 bg-green-500 text-white rounded-lg text-xs font-black">Ekle</button></div></div>`;
                } else {
                     content.innerHTML += `<button onclick="addSimpleWizItem('${key}', 'wiz_${key}_list')" class="w-full py-3 border-2 border-dashed border-${colors[state.step]}-200 rounded-2xl text-${colors[state.step]}-500 font-bold mt-4 text-xs">+ Kalem Ekle</button>`;
                }
                if (state.step === 1) content.innerHTML += `<div class="pt-4 mt-6 border-t"><p class="text-[10px] font-bold text-gray-400 uppercase mb-2">MaaÅŸ GÃ¼nÃ¼</p><input type="number" id="wiz_salary_day_val" oninput="state.salaryDay=this.value" value="${state.salaryDay || 15}" class="w-20 p-3 bg-gray-50 rounded-xl font-black text-center text-xl" placeholder="15"></div>`;
            }
            renderWizardLists();
        }
        
        function updateFromDailyLimitInput(v) { 
            state.manualDailyLimit = parseFloat(v)||0; 
            applyAllocationFromLimit(state.manualDailyLimit); 
        }
        function handleSliderChange(v) { 
            const daysInMonth = getDaysInCurrentPeriod();
            const spend = state.remainingAfterFixed * (v / 100); 
            document.getElementById('idealDailyLimitInput').value = Math.floor(spend / daysInMonth); 
            updateFromDailyLimitInput(spend / daysInMonth); 
        }
        function applyAllocationFromLimit(daily) { 
            const daysInMonth = getDaysInCurrentPeriod();
            const spend = daily * daysInMonth; 
            const save = Math.max(0, state.remainingAfterFixed - spend); 
            
            document.getElementById('manualSavingsInput').value = Math.floor(save); 
            document.getElementById('allocSpendingInput').value = Math.floor(spend); 
            
            if(state.remainingAfterFixed > 0) document.getElementById('allocationSlider').value = (spend / state.remainingAfterFixed) * 100; 
            
            state.calculatedMonthlyPool = spend; 
            state.calculatedMonthlySavings = save; 
        }
        function updateFromSavingsInput(v) { 
            const daysInMonth = getDaysInCurrentPeriod();
            const save = parseFloat(v) || 0; 
            const spend = Math.max(0, state.remainingAfterFixed - save); 
            
            document.getElementById('idealDailyLimitInput').value = Math.floor(spend / daysInMonth); 
            document.getElementById('allocSpendingInput').value = Math.floor(spend); 
            
            if(state.remainingAfterFixed > 0) document.getElementById('allocationSlider').value = (spend / state.remainingAfterFixed) * 100; 
            
            state.calculatedMonthlyPool = spend; 
            state.calculatedMonthlySavings = save; 
            state.manualDailyLimit = spend / daysInMonth; 
        }
        function updateFromSpendingInput(v) { 
            const daysInMonth = getDaysInCurrentPeriod();
            const spend = parseFloat(v) || 0; 
            const save = Math.max(0, state.remainingAfterFixed - spend); 
            
            document.getElementById('idealDailyLimitInput').value = Math.floor(spend / daysInMonth); 
            document.getElementById('manualSavingsInput').value = Math.floor(save); 
            
            if(state.remainingAfterFixed > 0) document.getElementById('allocationSlider').value = (spend / state.remainingAfterFixed) * 100; 
            
            state.calculatedMonthlyPool = spend; 
            state.calculatedMonthlySavings = save; 
            state.manualDailyLimit = spend / daysInMonth; 
        }
        
        function removeItem(key, i) { state[key].splice(i, 1); renderWizardLists(); }
        function updateLoanData(i, f, v) { state.loans[i][f] = parseFloat(v)||0; const l = state.loans[i]; if(f==='monthly' && l.totalMonths>0) l.totalDebt = l.monthly*l.totalMonths; else if(f==='totalMonths' && l.monthly>0) l.totalDebt = l.monthly*l.totalMonths; else if(f==='totalDebt' && l.totalMonths>0) l.monthly = l.totalDebt/l.totalMonths; document.getElementById(`wiz_loan_t_${i}`).value = Math.ceil(l.totalDebt); }
        
        function openCalcModal() { 
            const totalInc = state.incomes.reduce((s, i) => s + (i.val||0), 0); 
            const normalBills = state.bills.reduce((s, b) => s + (b.val||0), 0);
            
            const loansTreatedAsBills = state.loans.filter(l => l.excludeFromDebt && !l.excludeFromBudget).reduce((s, l) => s + (l.monthly || 0), 0);
            const totalFix = normalBills + loansTreatedAsBills;
            const standardLoans = state.loans.filter(l => !l.excludeFromDebt && !l.excludeFromBudget).reduce((s, l) => s + (l.monthly || 0), 0);
            
            const grossNet = totalInc - totalFix;
            const netIncome = grossNet - standardLoans;
            
            const daysInMonth = getDaysInCurrentPeriod();
            const daily = state.manualDailyLimit || 0;
            const monthlySpend = daily * daysInMonth;
            
            const savings = grossNet - monthlySpend;

            let incomeList = state.incomes.map(i => `<div class="flex justify-between text-xs text-green-600 pl-2"><span>${i.name}</span><span>+â‚º${(i.val||0).toLocaleString()}</span></div>`).join('');
            let billList = state.bills.filter(b => b.val > 0).map(b => `<div class="flex justify-between text-xs text-red-500 pl-2"><span>${b.name}</span><span>-â‚º${b.val.toLocaleString()}</span></div>`).join('');
            let hiddenLoanList = state.loans.filter(l => l.excludeFromDebt && !l.excludeFromBudget).map(l => `<div class="flex justify-between text-xs text-red-500 pl-2"><span>${l.name} (Gizli Taksit)</span><span>-â‚º${(l.monthly||0).toLocaleString()}</span></div>`).join('');
            
            document.getElementById('calcModalContent').innerHTML = `
                <div class="space-y-4">
                    <div class="bg-green-50 p-4 rounded-2xl border border-green-100">
                        <div class="flex justify-between font-black text-green-800 mb-2"><span>Toplam Gelir</span><span>+ â‚º${totalInc.toLocaleString()}</span></div>
                        <div class="space-y-1 border-t border-green-200 pt-2">${incomeList || '<span class="text-xs italic opacity-50">Gelir kalemi yok</span>'}</div>
                    </div>

                    <div class="bg-red-50 p-4 rounded-2xl border border-red-100">
                        <div class="flex justify-between font-black text-red-800 mb-2"><span>Sabit Giderler (Fatura & Gizli Kredi)</span><span>- â‚º${totalFix.toLocaleString()}</span></div>
                        <div class="space-y-1 border-t border-red-200 pt-2">
                            ${billList}
                            ${hiddenLoanList}
                            ${(!billList && !hiddenLoanList) ? '<span class="text-xs italic opacity-50">Gider kalemi yok</span>' : ''}
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2 py-2">
                        <div class="h-px bg-gray-200 flex-1"></div>
                        <span class="text-xs font-bold text-gray-400 uppercase">Ara Toplam</span>
                        <div class="h-px bg-gray-200 flex-1"></div>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-2xl border border-gray-200 space-y-2">
                        <div class="flex justify-between text-sm font-bold text-gray-600"><span>DaÄŸÄ±tÄ±labilir Gelir:</span><span>â‚º${Math.floor(grossNet).toLocaleString()}</span></div>
                        
                        <div class="border-t border-gray-200 pt-2 flex justify-between text-base font-black text-blue-600"><span>Harcanabilir BÃ¼tÃ§e (Harcama):</span><span>- â‚º${Math.floor(monthlySpend).toLocaleString()}</span></div>
                        <div class="flex justify-between text-sm font-bold text-green-600 border-t border-gray-200 pt-2"><span>Hedeflenen Birikim (Kredi Dahil):</span><span>= â‚º${Math.floor(savings).toLocaleString()}</span></div>
                        
                        ${standardLoans > 0 ? `
                        <div class="mt-2 text-[10px] text-gray-400 italic">
                             * Bu birikimin â‚º${standardLoans.toLocaleString()} kadarÄ± kredi Ã¶demesidir.
                        </div>
                        ` : ''}
                    </div>

                    <div class="text-center pt-2">
                        <p class="text-[10px] text-gray-400 uppercase tracking-widest mb-1">GÃ¼nlÃ¼k Limit HesabÄ±</p>
                        <p class="text-xs font-bold text-gray-500">â‚º${Math.floor(monthlySpend).toLocaleString()} / ${daysInMonth} GÃ¼n</p>
                        <p class="text-2xl font-black text-blue-600 mt-1">â‚º${Math.floor(daily).toLocaleString()}</p>
                    </div>
                </div>`; 
            
            const modal = document.getElementById('calcModal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('open'), 10);
            document.getElementById('overlay').classList.add('active'); 
            
            pushPanelHistory();
        }
        function closeCalcModal() { 
            const modal = document.getElementById('calcModal');
            modal.classList.remove('open');
            setTimeout(() => modal.classList.add('hidden'), 300);
            document.getElementById('overlay').classList.remove('active'); 
            popPanelHistory();
        }

        // --- AYLIK OTOMATÄ°K RAPORLAMA SÄ°STEMÄ° ---
        
        function checkMonthlyReport() {
            if (!state.registrationDate || !currentUser) return;
            
            const now = new Date();
            const salaryDay = state.salaryDay || 15;
            
            let currentPeriodStart = new Date(now.getFullYear(), now.getMonth(), salaryDay);
            if (now.getDate() < salaryDay) {
                currentPeriodStart.setMonth(currentPeriodStart.getMonth() - 1);
            }
            currentPeriodStart.setHours(0,0,0,0);
            
            let prevPeriodStart = new Date(currentPeriodStart);
            prevPeriodStart.setMonth(prevPeriodStart.getMonth() - 1);
            let prevPeriodEnd = new Date(currentPeriodStart);
            
            const yyyy = prevPeriodStart.getFullYear();
            const mm = String(prevPeriodStart.getMonth() + 1).padStart(2, '0');
            const reportKey = `${yyyy}-${mm}`;
            
            if (!state.reports) state.reports = {};
            
            const regDate = new Date(state.registrationDate);
            if (!state.reports[reportKey] && regDate < prevPeriodEnd) {
                generateAndSaveReport(reportKey, prevPeriodStart, prevPeriodEnd);
            }
        }

        function generateAndSaveReport(reportKey, startDate, endDate) {
            const periodExpenses = state.expenses.filter(e => {
                const parts = e.date.split('.');
                if(parts.length === 3) {
                    const d = new Date(parts[2], parts[1]-1, parts[0]);
                    d.setHours(0,0,0,0);
                    return d >= startDate && d < endDate;
                }
                return false;
            });
            
            const daysTotal = Math.round((endDate - startDate) / (1000*60*60*24));
            const uniqueDates = new Set(periodExpenses.map(e => e.date));
            const daysEntered = uniqueDates.size;
            
            const totalSpent = periodExpenses.reduce((sum, e) => sum + e.amount, 0);
            
            const catTotals = {};
            periodExpenses.forEach(e => {
                let cat = e.category && e.category !== 'DiÄŸer' ? e.category : 'DiÄŸer / Ã–zel';
                catTotals[cat] = (catTotals[cat] || 0) + e.amount;
            });
            
            const topCategories = Object.entries(catTotals)
                .sort((a,b) => b[1] - a[1])
                .slice(0, 3)
                .map(([name, amt]) => {
                    const pct = totalSpent > 0 ? Math.round((amt / totalSpent) * 100) : 0;
                    return { name, pct };
                });
            
            const dailyLimit = state.manualDailyLimit || 0;
            const averageDaily = daysTotal > 0 ? (totalSpent / daysTotal) : 0;
            
            const limitTotal = dailyLimit * daysTotal;
            const diff = limitTotal - totalSpent; 
            
            const totalInc = (state.incomes||[]).reduce((s, i) => s + (i.val||0), 0); 
            const normalBills = (state.bills||[]).reduce((s, b) => s + (b.val||0), 0);
            const loansTreatedAsBills = (state.loans||[]).filter(l => l.excludeFromDebt && !l.excludeFromBudget).reduce((s, l) => s + (l.monthly || 0), 0);
            const totalFix = normalBills + loansTreatedAsBills;
            const targetSavings = Math.max(0, (totalInc - totalFix) - limitTotal); 
            
            const actualSavings = targetSavings + diff;
            
            const startStr = startDate.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long' });
            const endStr = new Date(endDate - 1).toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
            
            const reportData = {
                periodLabel: `${startStr} - ${endStr}`,
                daysTotal, daysEntered, topCategories, dailyLimit, averageDaily, diff, targetSavings, actualSavings, totalSpent
            };
            
            state.reports[reportKey] = reportData;
            saveToCloud();
            
            displayReportModal(reportData);
        }

        function displayReportModal(data) {
            document.getElementById('reportPeriodText').innerText = data.periodLabel;
            
            let catHtml = '';
            if (data.topCategories.length > 0) {
                catHtml = data.topCategories.map(c => `<li class="flex justify-between items-center bg-gray-50 p-2.5 rounded-lg border border-gray-100"><span class="font-bold">${c.name}</span><span class="font-black text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded">%${c.pct}</span></li>`).join('');
                catHtml = `<ul class="space-y-1.5 mb-2 mt-3">${catHtml}</ul>`;
            } else {
                catHtml = '<p class="text-xs text-gray-400 italic mt-3 bg-gray-50 p-2 rounded text-center">Bu dÃ¶nemde hiÃ§ harcama kaydÄ± girmedin.</p>';
            }
            
            let diffHtml = '';
            if (data.diff >= 0) {
                diffHtml = `<div class="bg-green-50 text-green-800 p-4 rounded-xl border border-green-200 text-center">
                    <p class="font-black text-green-600 mb-1"><i class="fas fa-trophy text-lg"></i> Hedef Tutturuldu!</p>
                    <p class="text-xs">GÃ¼nlÃ¼k hedefine uydun ve bu ay toplamda <strong class="text-base bg-green-200 px-1 rounded">â‚º${Math.floor(data.diff).toLocaleString()}</strong> fazladan bakiye (kÃ¢r) yarattÄ±n.</p>
                </div>`;
            } else {
                diffHtml = `<div class="bg-red-50 text-red-800 p-4 rounded-xl border border-red-200 text-center">
                    <p class="font-black text-red-600 mb-1"><i class="fas fa-exclamation-triangle text-lg"></i> Hedefi AÅŸtÄ±k</p>
                    <p class="text-xs">Maalesef bu ayki toplam harcama hedefini <strong class="text-base bg-red-200 px-1 rounded">â‚º${Math.floor(Math.abs(data.diff)).toLocaleString()}</strong> kadar Ä±skaladÄ±n.</p>
                </div>`;
            }

            const html = `
                <div class="text-center bg-gradient-to-r from-blue-50 to-indigo-50 text-indigo-800 p-3 rounded-xl border border-indigo-100 shadow-sm">
                    Bu ay tam <span class="text-indigo-600 font-black text-lg mx-1">${data.daysTotal}</span> gÃ¼ndÃ¼r beraberdik. Toplam <span class="text-indigo-600 font-black text-lg mx-1">${data.daysEntered}</span> gÃ¼n uygulamaya veri girdin.
                </div>
                
                <div>
                    <p class="font-black text-gray-800 text-sm border-b pb-1">HarcamalarÄ±nÄ±n YÄ±ldÄ±zlarÄ± (Ä°lk 3)</p>
                    ${catHtml}
                </div>
                
                <div class="grid grid-cols-2 gap-3 text-center mt-2">
                    <div class="bg-white shadow-sm p-3 rounded-xl border border-gray-100">
                        <p class="text-[9px] text-gray-400 uppercase tracking-widest font-black mb-1">GÃ¼nlÃ¼k Hedefin</p>
                        <p class="text-lg font-black text-blue-600">â‚º${Math.floor(data.dailyLimit).toLocaleString()}</p>
                    </div>
                    <div class="bg-white shadow-sm p-3 rounded-xl border border-gray-100">
                        <p class="text-[9px] text-gray-400 uppercase tracking-widest font-black mb-1">GerÃ§ekleÅŸen Ort.</p>
                        <p class="text-lg font-black text-gray-800">â‚º${Math.floor(data.averageDaily).toLocaleString()}</p>
                    </div>
                </div>
                
                ${diffHtml}
                
                <div class="bg-slate-800 text-white p-4 rounded-xl shadow-inner mt-2">
                    <div class="flex justify-between items-center border-b border-slate-600 pb-2 mb-2">
                        <span class="text-xs text-slate-300">Birikim Hedefin:</span>
                        <span class="font-bold">â‚º${Math.floor(data.targetSavings).toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-slate-100 font-bold">YapabildiÄŸin Birikim:</span>
                        <span class="font-black text-xl text-green-400">â‚º${Math.floor(data.actualSavings).toLocaleString()}</span>
                    </div>
                </div>
            `;
            
            document.getElementById('reportContent').innerHTML = html;
            document.getElementById('monthlyReportModal').classList.remove('hidden');
            
            pushPanelHistory();
        }

        function openReportForSelectedMonth() {
            const filterVal = document.getElementById('analysisDateFilter').value; 
            if (!filterVal) return showAppAlert("LÃ¼tfen Ã¶nce bir dÃ¶nem seÃ§in.");
            
            if (state.reports && state.reports[filterVal]) {
                displayReportModal(state.reports[filterVal]);
            } else {
                showAppAlert("SeÃ§tiÄŸiniz bu dÃ¶neme ait henÃ¼z oluÅŸturulmuÅŸ bir Ã¶zet rapor bulunmuyor.");
            }
        }
    </script>
</body>
</html>

