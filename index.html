// --- 8 ADIMLI SİHİRBAZ (WIZARD) FONKSİYONLARI ---
        function startWizard(isEdit) {
            hideAll();
            document.getElementById('wizardScreen').classList.remove('hidden');
            state.step = 1;
            renderWizardStep();
        }

        function wizardNext() {
            if(state.step < 8) {
                state.step++;
                renderWizardStep();
            } else {
                finishWizard();
            }
        }

        function wizardBack() {
            if(state.step > 1) {
                state.step--;
                renderWizardStep();
            } else {
                document.getElementById('wizardScreen').classList.add('hidden');
                if(currentUser) showDashboard();
                else showLoginScreen();
            }
        }

        function renderWizardLists() {
            renderWizardStep();
        }

        function renderWizardStep() {
            const content = document.getElementById('wizardContent');
            const progress = document.getElementById('wizardProgress');
            const stepCount = document.getElementById('stepCount');
            const nextBtn = document.getElementById('wizNextBtn');
            const steps = 8; // Kodu 8 adıma geri çıkardık

            stepCount.innerText = `Adım ${state.step}/${steps}`;

            let pHtml = '';
            for(let i=1; i<=steps; i++) {
                pHtml += `<div class="h-1.5 rounded-full flex-1 transition-all ${i <= state.step ? 'bg-blue-600' : 'bg-gray-200'}"></div>`;
            }
            progress.innerHTML = pHtml;

            let html = '';

            if(state.step === 1) { // 1. GELİRLER
                html = `
                    <div class="text-center mb-6">
                        <div class="w-12 h-12 bg-green-100 text-green-600 rounded-2xl flex items-center justify-center mx-auto mb-2 text-xl"><i class="fas fa-wallet"></i></div>
                        <h3 class="font-black text-xl text-gray-800">Aylık Gelirler</h3>
                        <p class="text-xs text-gray-400">Elinize geçen tüm net gelirleri yazın.</p>
                    </div>
                    <div class="space-y-3 overflow-y-auto max-h-[250px] p-1 custom-scrollbar">
                        ${state.incomes.map((inc, i) => `
                            <div class="flex gap-2">
                                <input type="text" value="${inc.name}" onchange="state.incomes[${i}].name=this.value" class="w-1/2 p-3 bg-gray-50 rounded-xl font-bold text-xs text-gray-600 focus:bg-white border border-transparent focus:border-blue-100 outline-none">
                                <input type="number" value="${inc.val}" onchange="state.incomes[${i}].val=parseFloat(this.value)" placeholder="0" class="w-1/2 p-3 bg-gray-50 rounded-xl font-black text-xs text-gray-800 focus:bg-white border border-transparent focus:border-blue-100 outline-none">
                            </div>
                        `).join('')}
                        <button onclick="state.incomes.push({name:'Ek Gelir', val:0}); renderWizardStep()" class="w-full py-3 border border-dashed border-gray-300 text-gray-400 rounded-xl text-xs font-bold hover:text-green-600 hover:border-green-200 transition-colors">+ Gelir Kalemi Ekle</button>
                    </div>
                `;
                nextBtn.innerHTML = 'Devam Et';
                nextBtn.onclick = wizardNext;
            }
            else if(state.step === 2) { // 2. SABİT GİDERLER
                html = `
                    <div class="text-center mb-6">
                        <div class="w-12 h-12 bg-red-100 text-red-600 rounded-2xl flex items-center justify-center mx-auto mb-2 text-xl"><i class="fas fa-file-invoice"></i></div>
                        <h3 class="font-black text-xl text-gray-800">Sabit Giderler</h3>
                        <p class="text-xs text-gray-400">Kira, faturalar ve düzenli ödemeler.</p>
                    </div>
                    <div class="space-y-3 overflow-y-auto max-h-[250px] p-1 custom-scrollbar">
                        ${state.bills.map((bill, i) => `
                            <div class="flex gap-2 items-center">
                                <div class="w-1/2 p-3 bg-gray-100 rounded-xl font-bold text-xs text-gray-500">${bill.name}</div>
                                <input type="number" value="${bill.val}" onchange="state.bills[${i}].val=parseFloat(this.value)" placeholder="0" class="w-1/2 p-3 bg-white border border-gray-200 rounded-xl font-black text-xs text-gray-800 focus:border-blue-300 outline-none">
                            </div>
                        `).join('')}
                    </div>
                `;
                nextBtn.innerHTML = 'Devam Et';
            }
            else if(state.step === 3) { // 3. KREDİLER
                html = `
                    <div class="text-center mb-6">
                        <div class="w-12 h-12 bg-orange-100 text-orange-600 rounded-2xl flex items-center justify-center mx-auto mb-2 text-xl"><i class="fas fa-hand-holding-usd"></i></div>
                        <h3 class="font-black text-xl text-gray-800">Krediler</h3>
                        <p class="text-xs text-gray-400">Varsa aktif kredilerinizi ekleyin.</p>
                    </div>
                    <div class="space-y-2 mb-4 overflow-y-auto max-h-[150px] custom-scrollbar">
                        ${state.loans.length === 0 ? '<p class="text-center text-xs text-gray-300 italic">Kredi eklenmedi.</p>' : ''}
                        ${state.loans.map((l, i) => `
                            <div class="flex justify-between items-center p-3 bg-white border border-orange-100 rounded-xl shadow-sm">
                                <div><p class="font-bold text-xs text-gray-800">${l.name}</p><p class="text-[9px] text-gray-400">Kalan: ${l.totalMonths} Ay</p></div>
                                <div class="text-right"><p class="font-black text-orange-500 text-xs">₺${l.monthly}/ay</p><button onclick="state.loans.splice(${i},1); renderWizardStep()" class="text-[9px] text-red-400 underline mt-1">Sil</button></div>
                            </div>
                        `).join('')}
                    </div>
                    <button id="btnShowwizLoanForm" onclick="toggleInlineAdd('wizLoan')" class="w-full py-3 bg-orange-50 text-orange-600 font-bold rounded-xl text-xs hover:bg-orange-100 transition-colors">Yeni Kredi Ekle</button>
                    <div id="inlineAddwizLoanContainer" class="hidden mt-2 p-4 border border-orange-100 bg-white rounded-xl shadow-lg relative z-10">
                        <input type="hidden" id="wizLoanType" value="Kredi">
                        <div id="wizLoanFields"></div>
                        <div class="flex gap-2 mt-3">
                             <button onclick="cancelInlineAdd('wizLoan')" class="flex-1 bg-gray-100 text-gray-600 rounded-lg py-2 text-xs font-bold">İptal</button>
                             <button onclick="saveInlineAdd('wizLoan')" class="flex-1 bg-orange-500 text-white rounded-lg py-2 text-xs font-bold">Kaydet</button>
                        </div>
                    </div>
                `;
                setTimeout(() => { if(document.getElementById('wizLoanFields')) handleInlineTypeChange('wizLoan'); }, 50);
                nextBtn.innerHTML = 'Devam Et';
            }
            else if(state.step === 4) { // 4. KREDİ KARTLARI
                html = `
                    <div class="text-center mb-6">
                        <div class="w-12 h-12 bg-purple-100 text-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-2 text-xl"><i class="fas fa-credit-card"></i></div>
                        <h3 class="font-black text-xl text-gray-800">Kredi Kartları</h3>
                        <p class="text-xs text-gray-400">Güncel kredi kartı borçlarınızı ekleyin.</p>
                    </div>
                    <div class="space-y-2 mb-4 overflow-y-auto max-h-[150px] custom-scrollbar">
                        ${state.debts.length === 0 ? '<p class="text-center text-xs text-gray-300 italic">Kredi kartı eklenmedi.</p>' : ''}
                        ${state.debts.map((d, i) => `<div class="p-3 bg-white border border-purple-100 rounded-xl flex justify-between items-center text-xs"><span class="font-bold text-gray-700">${d.name}</span><div class="text-right"><span class="font-black text-purple-600">₺${d.val}</span><br><button onclick="state.debts.splice(${i},1); renderWizardStep()" class="text-[9px] text-red-400 underline">Sil</button></div></div>`).join('')}
                    </div>
                     <button id="btnShowwizDebtForm" onclick="toggleInlineAdd('wizDebt')" class="w-full py-3 bg-purple-50 text-purple-600 font-bold rounded-xl text-xs hover:bg-purple-100 transition-colors">Kart Ekle</button>
                     <div id="inlineAddwizDebtContainer" class="hidden mt-2 p-4 border border-purple-100 bg-white rounded-xl shadow-lg relative z-10">
                        <input type="hidden" id="wizDebtType" value="Kredi Kartı">
                        <div id="wizDebtFields"></div>
                        <div class="flex gap-2 mt-3">
                             <button onclick="cancelInlineAdd('wizDebt')" class="flex-1 bg-gray-100 text-gray-600 rounded-lg py-2 text-xs font-bold">İptal</button>
                             <button onclick="saveInlineAdd('wizDebt')" class="flex-1 bg-purple-500 text-white rounded-lg py-2 text-xs font-bold">Kaydet</button>
                        </div>
                    </div>
                `;
                setTimeout(() => { if(document.getElementById('wizDebtFields')) handleInlineTypeChange('wizDebt'); }, 50);
                nextBtn.innerHTML = 'Devam Et';
            }
            else if(state.step === 5) { // 5. DİĞER BORÇLAR
                html = `
                    <div class="text-center mb-6">
                        <div class="w-12 h-12 bg-red-50 text-red-500 rounded-2xl flex items-center justify-center mx-auto mb-2 text-xl"><i class="fas fa-file-signature"></i></div>
                        <h3 class="font-black text-xl text-gray-800">Elden / Diğer Borçlar</h3>
                        <p class="text-xs text-gray-400">Şahıslara veya kurumlara olan diğer borçlar.</p>
                    </div>
                    <div class="space-y-2 mb-4 overflow-y-auto max-h-[150px] custom-scrollbar">
                        ${state.otherDebts.length === 0 ? '<p class="text-center text-xs text-gray-300 italic">Borç eklenmedi.</p>' : ''}
                        ${state.otherDebts.map((d, i) => `<div class="p-3 bg-white border border-red-100 rounded-xl flex justify-between items-center text-xs"><span class="font-bold text-gray-700">${d.name}</span><div class="text-right"><span class="font-black text-red-600">₺${d.val}</span><br><button onclick="state.otherDebts.splice(${i},1); renderWizardStep()" class="text-[9px] text-red-400 underline">Sil</button></div></div>`).join('')}
                    </div>
                     <button id="btnShowwizOtherDebtForm" onclick="toggleInlineAdd('wizOtherDebt')" class="w-full py-3 bg-red-50 text-red-600 font-bold rounded-xl text-xs hover:bg-red-100 transition-colors">Borç Ekle</button>
                     <div id="inlineAddwizOtherDebtContainer" class="hidden mt-2 p-4 border border-red-100 bg-white rounded-xl shadow-lg relative z-10">
                        <input type="hidden" id="wizOtherDebtType" value="Diğer">
                        <div id="wizOtherDebtFields"></div>
                        <div class="flex gap-2 mt-3">
                             <button onclick="cancelInlineAdd('wizOtherDebt')" class="flex-1 bg-gray-100 text-gray-600 rounded-lg py-2 text-xs font-bold">İptal</button>
                             <button onclick="saveInlineAdd('wizOtherDebt')" class="flex-1 bg-red-500 text-white rounded-lg py-2 text-xs font-bold">Kaydet</button>
                        </div>
                    </div>
                `;
                setTimeout(() => { if(document.getElementById('wizOtherDebtFields')) handleInlineTypeChange('wizOtherDebt'); }, 50);
                nextBtn.innerHTML = 'Devam Et';
            }
            else if(state.step === 6) { // 6. VARLIKLAR
                html = `
                    <div class="text-center mb-6">
                        <div class="w-12 h-12 bg-yellow-100 text-yellow-600 rounded-2xl flex items-center justify-center mx-auto mb-2 text-xl"><i class="fas fa-coins"></i></div>
                        <h3 class="font-black text-xl text-gray-800">Varlıklar & Birikim</h3>
                        <p class="text-xs text-gray-400">Nakit, altın, döviz ve birikimler.</p>
                    </div>
                    <div class="space-y-2 mb-4 overflow-y-auto max-h-[150px] custom-scrollbar">
                        ${state.assets.length === 0 ? '<p class="text-center text-xs text-gray-300 italic">Varlık eklenmedi.</p>' : ''}
                        ${state.assets.map((a, i) => `<div class="p-3 bg-white border border-yellow-100 rounded-xl flex justify-between items-center text-xs"><span class="font-bold text-gray-700">${a.name}</span><div class="text-right"><span class="font-black text-yellow-600">₺${a.val}</span><br><button onclick="state.assets.splice(${i},1); renderWizardStep()" class="text-[9px] text-red-400 underline">Sil</button></div></div>`).join('')}
                    </div>
                     <button id="btnShowwizAssetForm" onclick="toggleInlineAdd('wizAsset')" class="w-full py-3 bg-yellow-50 text-yellow-600 font-bold rounded-xl text-xs hover:bg-yellow-100 transition-colors">Varlık Ekle</button>
                     <div id="inlineAddwizAssetContainer" class="hidden mt-2 p-4 border border-yellow-100 bg-white rounded-xl shadow-lg relative z-10">
                        <label class="text-[10px] font-bold text-gray-500 uppercase">Tür</label>
                        <select id="wizAssetType" onchange="handleInlineTypeChange('wizAsset')" class="w-full p-2 mb-2 bg-gray-50 rounded-lg text-xs font-bold border border-gray-200">
                            <option value="Diğer">Nakit (TL)</option>
                            <option value="Altın">Altın</option>
                            <option value="Döviz">Döviz</option>
                            <option value="BES">BES</option>
                        </select>
                        <div id="wizAssetFields"></div>
                        <div class="flex gap-2 mt-3">
                             <button onclick="cancelInlineAdd('wizAsset')" class="flex-1 bg-gray-100 text-gray-600 rounded-lg py-2 text-xs font-bold">İptal</button>
                             <button onclick="saveInlineAdd('wizAsset')" class="flex-1 bg-yellow-500 text-white rounded-lg py-2 text-xs font-bold">Kaydet</button>
                        </div>
                    </div>
                `;
                setTimeout(() => { if(document.getElementById('wizAssetFields')) handleInlineTypeChange('wizAsset'); }, 50);
                nextBtn.innerHTML = 'Devam Et';
            }
            else if(state.step === 7) { // 7. AYARLAR
                html = `
                    <div class="text-center mb-6">
                        <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-2 text-xl"><i class="fas fa-calendar-alt"></i></div>
                        <h3 class="font-black text-xl text-gray-800">Bütçe Ayarları</h3>
                        <p class="text-xs text-gray-400">Döngünüzü belirleyelim.</p>
                    </div>
                    <div class="space-y-4 mt-4">
                        <div class="p-4 bg-blue-50 border border-blue-100 rounded-2xl">
                            <label class="block text-[10px] font-bold text-blue-500 uppercase mb-2">Maaş / Düzenli Gelir Gününüz</label>
                            <input type="number" id="wizSalaryDay" min="1" max="31" value="${state.salaryDay || 15}" onchange="state.salaryDay = parseInt(this.value)" class="w-full p-3 bg-white rounded-xl font-black text-gray-800 outline-none border border-transparent focus:border-blue-300">
                            <p class="text-[9px] text-blue-400 mt-2">Bütçe döngünüz ve aylık sıfırlamalar bu güne göre hesaplanır.</p>
                        </div>
                    </div>
                `;
                nextBtn.innerHTML = 'Devam Et';
            }
            else if(state.step === 8) { // 8. SONUÇ VE KAYIT
                html = `
                    <div class="text-center mb-6">
                        <div class="w-12 h-12 bg-green-500 text-white rounded-2xl flex items-center justify-center mx-auto mb-2 text-xl shadow-lg"><i class="fas fa-check-circle"></i></div>
                        <h3 class="font-black text-xl text-gray-800">Harika! Planın Hazır</h3>
                        <p class="text-xs text-gray-400">Verilerini kaydetmek için son adım.</p>
                    </div>
                    
                    ${!currentUser ? `
                    <div class="p-4 border border-gray-100 bg-gray-50 rounded-2xl space-y-3">
                        <p class="text-[10px] font-bold text-gray-500 uppercase text-center">Planı Kaydetmek İçin Üye Ol</p>
                        <input type="text" id="wizRegName" placeholder="Kullanıcı Adı" class="w-full p-3 bg-white border border-gray-200 rounded-xl outline-none font-bold text-xs">
                        <input type="email" id="wizRegEmail" placeholder="E-posta" class="w-full p-3 bg-white border border-gray-200 rounded-xl outline-none font-bold text-xs">
                        <input type="password" id="wizRegPass" placeholder="Şifre" class="w-full p-3 bg-white border border-gray-200 rounded-xl outline-none font-bold text-xs">
                    </div>` : `
                    <div class="p-4 bg-green-50 rounded-2xl text-center border border-green-100">
                        <p class="text-green-700 font-bold text-sm">Zaten giriş yapmış durumdasınız.</p>
                        <p class="text-green-600 text-xs mt-1">Sadece bitir butonuna tıklayarak yeni bütçenizi aktif edebilirsiniz.</p>
                    </div>
                    `}
                `;
                nextBtn.innerHTML = 'Bitir ve Başla';
                nextBtn.onclick = finishWizard;
            }

            content.innerHTML = html;
        }

        function finishWizard() {
            const totalInc = state.incomes.reduce((s,i)=>s+(i.val||0),0);
            const totalBills = state.bills.reduce((s,i)=>s+(i.val||0),0);
            const totalLoansMonthly = state.loans.reduce((s,i)=>s+(i.monthly||0),0);
            
            const safeInc = totalInc - (totalBills + totalLoansMonthly);
            const days = 30; // Ortalama
            
            let dailyLimit = 0;
            if(safeInc > 0) {
                dailyLimit = safeInc / days;
            }
            
            state.manualDailyLimit = dailyLimit;
            
            if(!currentUser) {
                const u = document.getElementById('wizRegName').value.trim();
                const e = document.getElementById('wizRegEmail').value.trim();
                const p = document.getElementById('wizRegPass').value;
                if(!u || !e || !p) return alert("Planı kaydetmek için lütfen üyelik alanlarını doldurun.");
                
                document.getElementById('regUsernameInput').value = u;
                document.getElementById('emailInput').value = e;
                document.getElementById('passwordInput').value = p;
                document.getElementById('regInviteCode').value = ""; 
                
                document.getElementById('wizardScreen').classList.add('hidden');
                firebaseRegister(); // Bu fonksiyon içinde register olup dashboard'a geçiş yapacak
            } else {
                document.getElementById('wizardScreen').classList.add('hidden');
                saveToCloud().then(() => {
                    showDashboard();
                });
            }
        }
